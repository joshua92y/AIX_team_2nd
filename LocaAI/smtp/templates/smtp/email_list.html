{% extends 'base.html' %}
{% load static %}

{% block title %}이메일 목록{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>이메일 목록</h2>
        </div>
        <div class="col text-end">
            <a href="{% url 'smtp:email_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> 새 이메일 작성
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#all" data-bs-toggle="tab">전체</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#sent" data-bs-toggle="tab">전송됨</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#failed" data-bs-toggle="tab">실패</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="all">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>제목</th>
                                    <th>수신자</th>
                                    <th>상태</th>
                                    <th>전송일시</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for email in emails %}
                                <tr>
                                    <td>{{ email.subject }}</td>
                                    <td>{{ email.recipient }}</td>
                                    <td>
                                        <span class="badge {% if email.status == 'sent' %}bg-success{% elif email.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {{ email.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ email.sent_at|default:"-" }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'smtp:email_detail' email.id %}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if email.status == 'failed' %}
                                            <button class="btn btn-sm btn-warning retry-btn" data-email-id="{{ email.id }}">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">이메일이 없습니다.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 재전송 버튼 클릭 이벤트
    document.querySelectorAll('.retry-btn').forEach(button => {
        button.addEventListener('click', function() {
            const emailId = this.dataset.emailId;
            if (confirm('이메일을 재전송하시겠습니까?')) {
                fetch(`/api/smtp/messages/${emailId}/retry/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('이메일이 재전송되었습니다.');
                        location.reload();
                    } else {
                        alert('재전송 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다: ' + error);
                });
            }
        });
    });
});

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
{% endblock %} 