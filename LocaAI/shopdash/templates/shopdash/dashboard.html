{% extends 'base.html' %}
{% load static %}

{% block title %}ShopDash - ìƒê¶Œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
    /* ê¸°ì¡´ ì‚¬ì´íŠ¸ ìƒ‰ìƒ ë³€ìˆ˜ ì‚¬ìš© */
    :root {
        --primary-color: #4154f1;
        --heading-color: #012970;
        --text-color: #444444;
        --surface-color: #ffffff;
        --light-bg: #f9f9f9;
    }

    /* í˜ì´ì§€ íƒ€ì´í‹€ ì„¹ì…˜ */
    .page-title {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--heading-color) 100%);
        color: white;
        padding: 80px 0 60px 0;
        position: relative;
        overflow: hidden;
    }

    .page-title::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="1000,100 1000,0 0,100"/></svg>');
        background-size: cover;
    }

    .page-title h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: white;
        font-family: var(--heading-font);
    }

    .page-title p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 0;
    }

    /* í†µê³„ ì¹´ë“œ */
    .stats-card {
        background: var(--surface-color);
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        border: 1px solid rgba(65, 84, 241, 0.1);
        transition: all 0.3s ease;
        height: 100%;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(65, 84, 241, 0.15);
        border-color: var(--primary-color);
    }

    .stats-card .icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 24px;
        color: white;
    }

    .stats-card .icon.blue { background: var(--primary-color); }
    .stats-card .icon.green { background: #059652; }
    .stats-card .icon.orange { background: #ff6b35; }
    .stats-card .icon.purple { background: #8e44ad; }

    .stats-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--heading-color);
        margin-bottom: 10px;
        font-family: var(--heading-font);
    }

    .stats-card p {
        color: var(--text-color);
        margin: 0;
        font-size: 1rem;
    }

    /* ì°¨íŠ¸ ì¹´ë“œ */
    .chart-card {
        background: var(--surface-color);
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        border: 1px solid rgba(65, 84, 241, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .chart-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(65, 84, 241, 0.12);
    }

    .chart-card .card-header {
        background: var(--light-bg);
        border-bottom: 1px solid rgba(65, 84, 241, 0.1);
        padding: 20px 25px;
    }

    .chart-card .card-title {
        color: var(--heading-color);
        font-weight: 600;
        margin: 0;
        font-family: var(--heading-font);
        font-size: 1.1rem;
    }

    .chart-card .card-body {
        padding: 25px;
    }

    /* ì„¹ì…˜ ì œëª© */
    .section-title {
        text-align: center;
        margin-bottom: 60px;
    }

    .section-title h2 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--heading-color);
        margin-bottom: 20px;
        font-family: var(--heading-font);
        position: relative;
        display: inline-block;
    }

    .section-title h2::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: var(--primary-color);
        border-radius: 2px;
    }

    .section-title p {
        color: var(--text-color);
        font-size: 1.1rem;
        margin: 0;
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(65, 84, 241, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* ìƒìœ„ ì—…ì¢… í†µê³„ */
    .top-business-stats {
        padding: 20px;
        background: var(--light-bg);
        border-radius: 8px;
        height: 100%;
    }

    .business-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(65, 84, 241, 0.1);
    }

    .business-detail-item:last-child {
        border-bottom: none;
    }

    .business-rank {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.8rem;
        font-weight: 700;
        color: white;
        margin-right: 10px;
    }

    .business-rank.rank-1 { background: var(--primary-color); }
    .business-rank.rank-2 { background: #059652; }
    .business-rank.rank-3 { background: #ff6b35; }

    .business-name {
        font-weight: 600;
        color: var(--heading-color);
        flex: 1;
    }

    .business-rate {
        font-weight: 700;
        color: var(--primary-color);
    }

    .business-stats-small {
        font-size: 0.85rem;
        color: var(--text-color);
        margin-top: 4px;
    }

    /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
    .map-container {
        height: 600px;
        width: 100%;
        background: var(--light-bg);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-color);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
        .page-title h1 {
            font-size: 2rem;
        }
        
        .page-title p {
            font-size: 1rem;
        }
        
        .section-title h2 {
            font-size: 2rem;
        }
        
        .stats-card {
            margin-bottom: 30px;
        }
    }

    /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .main-content {
        background: var(--light-bg);
        min-height: 100vh;
        padding: 0;
    }

    .content-section {
        background: var(--surface-color);
        margin: 0;
        padding: 60px 0;
    }

    .content-section:nth-child(even) {
        background: var(--light-bg);
    }

    /* ì•„ì´ì½˜ ìƒ‰ìƒ */
    .text-primary { color: var(--primary-color) !important; }
    .text-success { color: #059652 !important; }
    .text-warning { color: #ff6b35 !important; }
    .text-info { color: #17a2b8 !important; }
    .text-danger { color: #dc3545 !important; }
    .text-purple { color: #8e44ad !important; }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
    <div class="page-title" data-aos="fade-down">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1>
                        <i class="bi bi-graph-up-arrow me-3"></i>
                        ShopDash
                    </h1>
                    <p>
                        <span data-lang="KOR">ì„œìš¸ì‹œ ìƒê¶Œ ë¶„ì„ ë° ì°½ì—… ì§€ì› ëŒ€ì‹œë³´ë“œ - ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ì œê³µ</span>
                        <span data-lang="ENG">Seoul Commercial District Analysis and Startup Support Dashboard - Real-time Data-driven Insights</span>
                        <span data-lang="ESP">Panel de anÃ¡lisis comercial y apoyo al emprendimiento en SeÃºl - InformaciÃ³n basada en datos en tiempo real</span>
                    </p>
                </div>
                <div class="col-lg-4 text-end">
                    <i class="bi bi-shop" style="font-size: 6rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì¹´ë“œ ì„¹ì…˜ -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">í•µì‹¬ ì§€í‘œ</span>
                    <span data-lang="ENG">Key Indicators</span>
                    <span data-lang="ESP">Indicadores Clave</span>
                </h2>
                <p>
                    <span data-lang="KOR">ì„œìš¸ì‹œ ìƒê¶Œ ë¶„ì„ì˜ ì£¼ìš” í†µê³„ ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</span>
                    <span data-lang="ENG">View key statistical data of Seoul's commercial district analysis at a glance</span>
                    <span data-lang="ESP">Consulte de un vistazo los datos estadÃ­sticos clave del anÃ¡lisis comercial de SeÃºl</span>
                </p>
            </div>
            
            <!-- ê²½ê³  ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="warning-message" class="alert alert-warning" style="display: none;" data-aos="fade-up">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="warning-text"></span>
            </div>
            
            <div class="row" data-aos="fade-up" data-aos-delay="100">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon blue">
                            <i class="bi bi-clipboard-data"></i>
                        </div>
                        <h3 id="total-analysis">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">ì´ ë¶„ì„ ê±´ìˆ˜</span>
                            <span data-lang="ENG">Total Analyses</span>
                            <span data-lang="ESP">Total de AnÃ¡lisis</span>
                        </p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon green">
                            <i class="bi bi-percent"></i>
                        </div>
                        <h3 id="avg-survival-rate">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">í‰ê·  ìƒì¡´ë¥ </span>
                            <span data-lang="ENG">Average Survival Rate</span>
                            <span data-lang="ESP">Tasa Promedio de Supervivencia</span>
                        </p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon orange">
                            <i class="bi bi-shop"></i>
                        </div>
                        <h3 id="total-businesses">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">ì„œìš¸ì‹œ ì „ì²´ ì—…ì†Œ ìˆ˜</span>
                            <span data-lang="ENG">Total Number of Businesses in Seoul</span>
                            <span data-lang="ESP">NÃºmero Total de Negocios en SeÃºl</span>
                        </p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon purple">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <h3 id="active-districts">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">ë¶„ì„ í™œë°œ ì§€ì—­</span>
                            <span data-lang="ENG">Most Analyzed Areas</span>
                            <span data-lang="ESP">Zonas MÃ¡s Analizadas</span>
                        </p>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì§€ì—­ë³„ ë¶„ì„ í˜„í™© -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">ì§€ì—­ë³„ ë¶„ì„ í˜„í™©</span>
                    <span data-lang="ENG">Analysis Status by Region</span>
                    <span data-lang="ESP">Estado del AnÃ¡lisis por RegiÃ³n</span>
                </h2>
                <p>
                    <span data-lang="KOR">í–‰ì •ë™ ë‹¨ìœ„ë¡œ ì„¸ë¶„í™”ëœ ìƒê¶Œ ë¶„ì„ ë°ì´í„°</span>
                    <span data-lang="ENG">Detailed commercial district analysis data by administrative district</span>
                    <span data-lang="ESP">Datos detallados de anÃ¡lisis comercial por distrito administrativo</span>
                </p>
            </div>
            
            <div class="row">
                <!-- ê±°ì£¼ì¸êµ¬ ìƒìœ„ì§€ì—­ -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-people-fill text-primary me-2"></i>
                                <span data-lang="KOR">ê±°ì£¼ì¸êµ¬ ìƒìœ„ì§€ì—­ (í–‰ì •ë™ë³„)</span>
                                <span data-lang="ENG" style="display:none;">Top Residential Population Areas (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Ãreas principales de poblaciÃ³n residente (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="populationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ë¶„ì„ í™œë°œì§€ì—­ -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="200">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                            <i class="bi bi-activity text-success me-2"></i>
                            <span data-lang="KOR">ë¶„ì„ í™œë°œì§€ì—­</span>
                            <span data-lang="ENG" style="display:none;">Active Analysis Areas</span>
                            <span data-lang="ESP" style="display:none;">Ãreas de anÃ¡lisis activo</span>
                        </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="businessActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì§ì¥ì¸êµ¬ ìƒìœ„ì§€ì—­ -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="300">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-briefcase-fill text-warning me-2"></i>
                                <span data-lang="KOR">ì§ì¥ì¸êµ¬ ìƒìœ„ì§€ì—­ (í–‰ì •ë™ë³„)</span>
                                <span data-lang="ENG" style="display:none;">Top Workplace Population Areas (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Ãreas con mayor poblaciÃ³n trabajadora (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="workingPopulationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì™¸êµ­ì¸ ì—¬í–‰ê° ë§ì€ ì§€ì—­ -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="400">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-airplane text-info me-2"></i>
                                <span data-lang="KOR">ì™¸êµ­ì¸ ì—¬í–‰ê° ë§ì€ ì§€ì—­ (í–‰ì •ë™ë³„)</span>
                                <span data-lang="ENG" style="display:none;">Areas with Many Foreign Tourists (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Ãreas con muchos turistas extranjeros (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="foreignVisitorChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—…ì¢… ë¶„ì„ -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">ì—…ì¢… ë¶„ì„</span>
                    <span data-lang="ENG" style="display:none;">Industry Analysis</span>
                    <span data-lang="ESP" style="display:none;">AnÃ¡lisis por sector</span>
                </h2>
                <p>
                    <span data-lang="KOR">ì„œìš¸ì‹œ ì—…ì¢…ë³„ ë¶„í¬ì™€ ìƒì¡´ë¥  ë¶„ì„</span>
                    <span data-lang="ENG" style="display:none;">Distribution and survival rate analysis by industry in Seoul</span>
                    <span data-lang="ESP" style="display:none;">DistribuciÃ³n y anÃ¡lisis de la tasa de supervivencia por sector en SeÃºl</span>
                </p>
            </div>
            
            <div class="row">
                <!-- ì—…ì¢…ë³„ ë¶„í¬ -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-pie-chart-fill text-danger me-2"></i>
                                <span data-lang="KOR">ì—…ì¢…ë³„ ë¶„í¬</span>
                                <span data-lang="ENG" style="display:none;">Distribution by Industry</span>
                                <span data-lang="ESP" style="display:none;">DistribuciÃ³n por sector</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="businessTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- í‰ê· ìƒì¡´ë¥  ìƒìœ„ì§€ì—­ -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="200">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-trophy-fill text-purple me-2"></i>
                                <span data-lang="KOR">í‰ê· ìƒì¡´ë¥  ìƒìœ„ì§€ì—­ (í–‰ì •ë™ë³„)</span>
                                <span data-lang="ENG" style="display:none;">Top Areas by Average Survival Rate (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Ãreas principales por tasa promedio de supervivencia (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="survivalRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í‰ê·  ìƒì¡´ë¥  ìƒìœ„ ì—…ì¢… TOP3 -->
            <div class="row">
                <div class="col-12 mb-4" data-aos="fade-up" data-aos-delay="300">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-star-fill text-warning me-2"></i>
                                <span data-lang="KOR">í‰ê·  ìƒì¡´ë¥  ìƒìœ„ ì—…ì¢… TOP3</span>
                                <span data-lang="ENG" style="display:none;">Top 3 Industries by Average Survival Rate</span>
                                <span data-lang="ESP" style="display:none;">Top 3 Industrias por tasa promedio de supervivencia</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="chart-container">
                                        <canvas id="topBusinessSurvivalChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="top-business-stats">
                                        <h6 class="mb-3">
                                            <span data-lang="KOR">ìƒì„¸ ì •ë³´</span>
                                            <span data-lang="ENG" style="display:none;">Detailed Information</span>
                                            <span data-lang="ESP" style="display:none;">InformaciÃ³n Detallada</span>
                                        </h6>
                                        <div id="topBusinessDetails">
                                            <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                                                <div class="loading-spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì§€ë„ ì„¹ì…˜ -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">ì„œìš¸ì‹œ ìƒê¶Œ ë¶„ì„ ì§€ë„</span>
                    <span data-lang="ENG" style="display:none;">Seoul Commercial Area Analysis Map</span>
                    <span data-lang="ESP" style="display:none;">Mapa de anÃ¡lisis comercial de SeÃºl</span>
                </h2>
                <p>
                    <span data-lang="KOR">êµ¬ë³„ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³ , í´ë¦­í•˜ì—¬ í–‰ì •ë™ë³„ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
                    <span data-lang="ENG" style="display:none;">Check data by district and click to see detailed info by administrative neighborhood</span>
                    <span data-lang="ESP" style="display:none;">Ver datos por distrito y haga clic para ver informaciÃ³n detallada por barrio administrativo</span>
                </p>
            </div>
            
            <div class="row">
                <div class="col-12" data-aos="fade-up" data-aos-delay="100">
                    <div class="chart-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-1">
                                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                                        <span data-lang="KOR">ëŒ€í™”í˜• ì„œìš¸ì‹œ ì§€ë„</span>
                                        <span data-lang="ENG">Interactive Seoul Map</span>
                                        <span data-lang="ESP">Mapa interactivo de SeÃºl</span>
                                    </h5>
                                    <div class="card-subtitle text-muted">
                                        <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                            <span data-lang="KOR">ë§ˆìš°ìŠ¤ ì˜¤ë²„: êµ¬ë³„ ì •ë³´ í™•ì¸ | í´ë¦­: í–‰ì •ë™ ìƒì„¸ë³´ê¸° | ë§ˆìš°ìŠ¤ íœ : í™•ëŒ€/ì¶•ì†Œ</span>
                                            <span data-lang="ENG">Mouse over: View district info | Click: See administrative detail | Mouse wheel: Zoom in/out</span>
                                            <span data-lang="ESP">Pasar el mouse: Ver info del distrito | Clic: Ver detalle administrativo | Rueda del mouse: Acercar/alejar</span>
                                        </small>
                                    </div>
                                </div>
                                <div class="map-controls">
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="map-back-btn" title="ë’¤ë¡œê°€ê¸°">
                                        <i class="bi bi-arrow-left"></i>
                                        <span data-lang="KOR">ë’¤ë¡œ</span>
                                        <span data-lang="ENG">Back</span>
                                        <span data-lang="ESP">AtrÃ¡s</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="map-reset-btn" title="ì§€ë„ ì´ˆê¸°í™”">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        <span data-lang="KOR">ì´ˆê¸°í™”</span>
                                        <span data-lang="ENG">Reset</span>
                                        <span data-lang="ESP">Restablecer</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="map" class="map-container" style="height: 600px; position: relative;">
                                <!-- ì§€ë„ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<!-- OpenLayers ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js"></script>
<!-- Proj4js ì¢Œí‘œê³„ ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>

<!-- ShopDash ë‹¤êµ­ì–´í™” -->
<script src="{% static 'js/shopdash-i18n.js' %}"></script>

<!-- ì„œìš¸ì‹œ ìƒê¶Œ ë¶„ì„ ì§€ë„ -->
<script src="{% static 'js/shopdash_map.js' %}"></script>

<script>
// AOS ì´ˆê¸°í™”
AOS.init({
    duration: 800,
    easing: 'ease-in-out',
    once: true,
    offset: 100
});

// ì°¨íŠ¸ ê¸°ë³¸ ì„¤ì •
Chart.defaults.font.family = "'Nunito', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#444444';

// ì „ì—­ ë³€ìˆ˜
let charts = {};
let isLoadingCharts = false;
let lastLanguageChange = 0;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
});

// ğŸš€ ShopDash ë‹¤êµ­ì–´í™” ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ ì‹œ ì°¨íŠ¸ ë¡œë“œ
window.addEventListener('shopDashI18nReady', function(event) {
    console.log('ğŸ¯ ShopDash ë‹¤êµ­ì–´í™” ì¤€ë¹„ ì™„ë£Œ ê°ì§€:', event.detail);
    console.log('translateBusinessType ì¡´ì¬ ì—¬ë¶€:', typeof translateBusinessType);
    console.log('getCurrentShopDashLanguage ì¡´ì¬ ì—¬ë¶€:', typeof getCurrentShopDashLanguage);
    
    // ì´ˆê¸° ì°¨íŠ¸ ë¡œë“œ (1íšŒë§Œ)
    if (!isLoadingCharts) {
        isLoadingCharts = true;
        loadAllCharts();
        
        setTimeout(() => {
            isLoadingCharts = false;
        }, 3000);
    }
});

// ğŸ”„ ë°±ì—…: ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ íƒ€ì´ë¨¸ ê¸°ë°˜ ë¡œë”©
setTimeout(() => {
    if (!isLoadingCharts) {
        console.log('â° ë°±ì—… íƒ€ì´ë¨¸ë¡œ ì°¨íŠ¸ ë¡œë“œ ì‹œë„...');
        console.log('translateBusinessType ì¡´ì¬ ì—¬ë¶€:', typeof translateBusinessType);
        console.log('getCurrentShopDashLanguage ì¡´ì¬ ì—¬ë¶€:', typeof getCurrentShopDashLanguage);
        
        isLoadingCharts = true;
        loadAllCharts();
        
        setTimeout(() => {
            isLoadingCharts = false;
        }, 3000);
    }
}, 2000); // 2ì´ˆ í›„ ë°±ì—… ë¡œë”©

// ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
function loadDashboardStats() {
    fetch('/shopdash/api/stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-analysis').textContent = data.total_analysis.toLocaleString();
            document.getElementById('avg-survival-rate').textContent = data.avg_survival_rate + '%';
            document.getElementById('total-businesses').textContent = data.total_businesses.toLocaleString();
            document.getElementById('active-districts').textContent = data.active_districts.toLocaleString();
            
            // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            if (data.warning_message && data.warning_message.trim() !== '') {
                document.getElementById('warning-text').textContent = data.warning_message;
                document.getElementById('warning-message').style.display = 'block';
            }
        })
        .catch(error => {
            console.error(getShopDashText('statsLoadFailed') + ':', error);
            document.getElementById('total-analysis').textContent = '0';
            document.getElementById('avg-survival-rate').textContent = '0%';
            document.getElementById('total-businesses').textContent = '0';
            document.getElementById('active-districts').textContent = '0';
        });
}

// ëª¨ë“  ì°¨íŠ¸ ë¡œë“œ
function loadAllCharts() {
    console.log('ğŸ”„ ShopDash ì°¨íŠ¸ ì „ì²´ ë¡œë“œ ì‹œì‘...');
    const chartConfigs = [
        { id: 'populationChart', url: '/shopdash/api/population/', type: 'bar', color: '#4154f1' },
        { id: 'businessActivityChart', url: '/shopdash/api/business-activity/', type: 'bar', color: '#059652' },
        { id: 'workingPopulationChart', url: '/shopdash/api/working-population/', type: 'bar', color: '#ff6b35' },
        { id: 'foreignVisitorChart', url: '/shopdash/api/foreign-visitors/', type: 'bar', color: '#17a2b8' },
        { id: 'businessTypeChart', url: '/shopdash/api/business-types/', type: 'doughnut', color: null },
        { id: 'survivalRateChart', url: '/shopdash/api/survival-rate/', type: 'bar', color: '#8e44ad' },
        { id: 'topBusinessSurvivalChart', url: '/shopdash/api/top-business-survival/', type: 'bar', color: '#ffc107' }
    ];

    chartConfigs.forEach(config => {
        loadChart(config.id, config.url, config.type, config.color);
    });
}

// ğŸŒ ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡í•˜ì—¬ shopdash-i18n.jsì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ í•¨
window.loadAllCharts = loadAllCharts;

// ê°œë³„ ì°¨íŠ¸ ë¡œë“œ
function loadChart(chartId, apiUrl, chartType, primaryColor) {
    // í‰ê·  ìƒì¡´ë¥  ìƒìœ„ ì—…ì¢… TOP3 ì°¨íŠ¸ëŠ” ë³„ë„ ì²˜ë¦¬
    if (chartId === 'topBusinessSurvivalChart') {
        loadTopBusinessSurvivalChart();
        return;
    }

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById(chartId).getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            
            // ì—…ì¢…ë³„ ë¶„í¬ ì°¨íŠ¸ì˜ ê²½ìš° ì—…ì¢…ëª… ë²ˆì—­
            if (chartId === 'businessTypeChart' && data.labels) {
                console.log('ğŸ“Š ì—…ì¢…ë³„ ë¶„í¬ ì°¨íŠ¸ - ë²ˆì—­ ì „ ì—…ì¢…ëª…ë“¤:', data.labels);
                console.log('ğŸ” translateBusinessType í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:', typeof translateBusinessType);
                console.log('ğŸŒ í˜„ì¬ ì–¸ì–´:', typeof getCurrentShopDashLanguage === 'function' ? getCurrentShopDashLanguage() : 'getCurrentShopDashLanguage í•¨ìˆ˜ ì—†ìŒ');
                
                if (typeof translateBusinessType === 'function') {
                    data.labels = data.labels.map((label, index) => {
                        console.log(`ğŸ”„ ë²ˆì—­ ì‹œë„ [${index}]: "${label}"`);
                        try {
                            const translated = translateBusinessType(label);
                            console.log(`âœ… ë²ˆì—­ ê²°ê³¼ [${index}]: "${label}" â†’ "${translated}"`);
                            return translated;
                        } catch (error) {
                            console.error(`âŒ ë²ˆì—­ ì—ëŸ¬ [${index}]: "${label}"`, error);
                            return label;
                        }
                    });
                } else {
                    console.error('âŒ translateBusinessType í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
                console.log('âœ… ì—…ì¢…ë³„ ë¶„í¬ ì°¨íŠ¸ - ë²ˆì—­ í›„ ì—…ì¢…ëª…ë“¤:', data.labels);
            }
            
            // ìƒ‰ìƒ ì„¤ì •
            if (chartType === 'doughnut') {
                // ë„ë„› ì°¨íŠ¸ìš© ë‹¤ì–‘í•œ ìƒ‰ìƒ
                data.datasets[0].backgroundColor = [
                    '#4154f1', '#059652', '#ff6b35', '#17a2b8', '#8e44ad',
                    '#dc3545', '#ffc107', '#6f42c1', '#20c997', '#fd7e14'
                ];
                data.datasets[0].borderWidth = 2;
                data.datasets[0].borderColor = '#ffffff';
            } else {
                // ë§‰ëŒ€ ì°¨íŠ¸ìš© ë‹¨ì¼ ìƒ‰ìƒ
                data.datasets[0].backgroundColor = primaryColor + '20';
                data.datasets[0].borderColor = primaryColor;
                data.datasets[0].borderWidth = 2;
            }
            
            const config = {
                type: chartType,
                data: data,
                options: getChartOptions(chartType, chartId)
            };
            
            charts[chartId] = new Chart(ctx, config);
            
            // ìƒì¡´ë¥  ì°¨íŠ¸ì— ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            if (chartId === 'survivalRateChart' && data.warning_message && data.warning_message.trim() !== '') {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mt-2';
                warningDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.warning_message}`;
                document.querySelector('#survivalRateChart').closest('.chart-card').querySelector('.card-body').appendChild(warningDiv);
            }
        })
        .catch(error => {
            console.error(`${chartId} ${getShopDashText('chartLoadFailed')}:`, error);
        });
}

// í‰ê·  ìƒì¡´ë¥  ìƒìœ„ ì—…ì¢… TOP3 ì°¨íŠ¸ ì „ìš© ë¡œë“œ í•¨ìˆ˜
function loadTopBusinessSurvivalChart() {
    fetch('/shopdash/api/top-business-survival/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('topBusinessSurvivalChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
            if (charts['topBusinessSurvivalChart']) {
                charts['topBusinessSurvivalChart'].destroy();
            }
            
            // ì—…ì¢…ëª… ë²ˆì—­
            if (data.labels) {
                console.log('ğŸ“Š ìƒìœ„ ì—…ì¢… ìƒì¡´ë¥  ì°¨íŠ¸ - ë²ˆì—­ ì „ ì—…ì¢…ëª…ë“¤:', data.labels);
                console.log('ğŸ” translateBusinessType í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:', typeof translateBusinessType);
                
                if (typeof translateBusinessType === 'function') {
                    data.labels = data.labels.map((label, index) => {
                        console.log(`ğŸ”„ ìƒìœ„ ì—…ì¢… ë²ˆì—­ ì‹œë„ [${index}]: "${label}"`);
                        try {
                            const translated = translateBusinessType(label);
                            console.log(`âœ… ìƒìœ„ ì—…ì¢… ë²ˆì—­ ê²°ê³¼ [${index}]: "${label}" â†’ "${translated}"`);
                            return translated;
                        } catch (error) {
                            console.error(`âŒ ìƒìœ„ ì—…ì¢… ë²ˆì—­ ì—ëŸ¬ [${index}]: "${label}"`, error);
                            return label;
                        }
                    });
                } else {
                    console.error('âŒ ìƒìœ„ ì—…ì¢… ì°¨íŠ¸: translateBusinessType í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
                console.log('âœ… ìƒìœ„ ì—…ì¢… ìƒì¡´ë¥  ì°¨íŠ¸ - ë²ˆì—­ í›„ ì—…ì¢…ëª…ë“¤:', data.labels);
            }
            
            // ì°¨íŠ¸ ìƒì„±
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(1, 41, 112, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4154f1',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const analysisCount = (data.analysis_counts && data.analysis_counts[index]) || 0;
                                    const avgArea = (data.avg_area && data.avg_area[index]) || 0;
                                    const storeCount = (data.store_counts && data.store_counts[index]) || 0;
                                    
                                    return getLocalizedTooltipText(analysisCount, avgArea, storeCount);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            };
            
            charts['topBusinessSurvivalChart'] = new Chart(ctx, config);
            
            // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
            updateTopBusinessDetails(data);
            
            // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ì—…ì¢…ë³„ ìƒì¡´ë¥  ì°¨íŠ¸ìš©)
            if (data.warning_message && data.warning_message.trim() !== '') {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mt-2';
                warningDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.warning_message}`;
                document.querySelector('#topBusinessSurvivalChart').closest('.chart-card').querySelector('.card-body').appendChild(warningDiv);
            }
        })
        .catch(error => {
            console.error(getShopDashText('chartLoadFailed') + ':', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ìƒì„¸ ì •ë³´ í‘œì‹œ
            document.getElementById('topBusinessDetails').innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-exclamation-triangle mb-2"></i>
                    <p>${getShopDashText('cannotLoadData')}</p>
                </div>
            `;
        });
}

// ìƒìœ„ ì—…ì¢… ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
function updateTopBusinessDetails(data) {
    const detailsContainer = document.getElementById('topBusinessDetails');
    
    if (!data || !data.labels || !data.datasets || !data.datasets[0] || !data.datasets[0].data) {
        detailsContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-exclamation-triangle mb-2"></i>
                <p>${getShopDashText('cannotLoadData')}</p>
            </div>
        `;
        return;
    }
    
    let detailsHtml = '';
    data.labels.forEach((label, index) => {
        const rank = index + 1;
        const rate = data.datasets[0].data[index] || 0;
        const analysisCount = (data.analysis_counts && data.analysis_counts[index]) || 0;
        const avgArea = (data.avg_area && data.avg_area[index]) || 0;
        const storeCount = (data.store_counts && data.store_counts[index]) || 0;
        
        // ì›ë³¸ ë ˆì´ë¸”ì—ì„œ ë²ˆì—­ëœ ì—…ì¢…ëª… ê°€ì ¸ì˜¤ê¸°
        const originalLabel = data.original_labels ? data.original_labels[index] : label;
        const translatedLabel = translateBusinessType(originalLabel);
        
        detailsHtml += `
            <div class="business-detail-item">
                <div class="d-flex align-items-center">
                    <span class="business-rank rank-${rank}">${rank}</span>
                    <div class="business-name">${translatedLabel}</div>
                </div>
                <div class="text-end">
                    <div class="business-rate">${rate}%</div>
                    <div class="business-stats-small">
                        ${analysisCount}${getShopDashText('cases')} ${getShopDashText('analysisCount')} / ${getShopDashText('avgArea')} ${avgArea}${getShopDashText('sqm')}<br>
                        ${formatShopDashText(getShopDashText('totalStores'), {count: storeCount.toLocaleString()})}
                    </div>
                </div>
            </div>
        `;
    });
    
    detailsContainer.innerHTML = detailsHtml;
}

// ì°¨íŠ¸ ì˜µì…˜ ì„¤ì •
function getChartOptions(chartType, chartId) {
    const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: chartType === 'doughnut',
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        family: "'Nunito', sans-serif",
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(1, 41, 112, 0.9)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#4154f1',
                borderWidth: 1,
                cornerRadius: 8,
                titleFont: {
                    family: "'Nunito', sans-serif",
                    weight: 'bold'
                },
                bodyFont: {
                    family: "'Nunito', sans-serif"
                }
            }
        }
    };

    if (chartType === 'bar') {
        baseOptions.scales = {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(65, 84, 241, 0.1)',
                    borderColor: 'rgba(65, 84, 241, 0.2)'
                },
                ticks: {
                    color: '#444444',
                    font: {
                        family: "'Nunito', sans-serif"
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#444444',
                    font: {
                        family: "'Nunito', sans-serif"
                    },
                    maxRotation: 45
                }
            }
        };
    }

    return baseOptions;
}

// ì–¸ì–´ ë³€ê²½ ê°ì§€ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function handleLanguageChange() {
    const now = Date.now();
    
    // ì´ì „ ì–¸ì–´ ë³€ê²½ìœ¼ë¡œë¶€í„° ìµœì†Œ 2ì´ˆ ì´ìƒ ê²½ê³¼í•´ì•¼ í•¨
    if (now - lastLanguageChange < 2000 || isLoadingCharts) {
        return;
    }
    
    lastLanguageChange = now;
    isLoadingCharts = true;
    
    console.log('ShopDash ì–¸ì–´ ë³€ê²½ ê°ì§€ë¨ - ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘');
    
    // ì°¨íŠ¸ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ì—…ì¢…ëª… ë²ˆì—­ ì ìš©
    setTimeout(() => {
        loadAllCharts();
        
        // ë¡œë”© ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
        setTimeout(() => {
            isLoadingCharts = false;
        }, 3000);
    }, 500);
}

// ì–¸ì–´ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ê¸°ì¡´ ì „ì—­ ì–¸ì–´ ë³€ê²½ í•¨ìˆ˜ì—ì„œ í˜¸ì¶œ)
if (typeof window.funcChangeLang === 'function') {
    const originalFuncChangeLang = window.funcChangeLang;
    window.funcChangeLang = function(lang) {
        originalFuncChangeLang(lang);
        handleLanguageChange();
    };
}

// ì—ëŸ¬ ì²˜ë¦¬
window.addEventListener('error', function(e) {
    console.error('JavaScript ì—ëŸ¬:', e.error);
});
</script>
{% endblock %} 