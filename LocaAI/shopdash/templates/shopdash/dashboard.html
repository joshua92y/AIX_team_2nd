{% extends 'base.html' %}
{% load static %}

{% block title %}ShopDash - 상권 분석 대시보드{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
    /* 기존 사이트 색상 변수 사용 */
    :root {
        --primary-color: #4154f1;
        --heading-color: #012970;
        --text-color: #444444;
        --surface-color: #ffffff;
        --light-bg: #f9f9f9;
    }

    /* 페이지 타이틀 섹션 */
    .page-title {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--heading-color) 100%);
        color: white;
        padding: 80px 0 60px 0;
        position: relative;
        overflow: hidden;
    }

    .page-title::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="1000,100 1000,0 0,100"/></svg>');
        background-size: cover;
    }

    .page-title h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: white;
        font-family: var(--heading-font);
    }

    .page-title p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 0;
    }

    /* 통계 카드 */
    .stats-card {
        background: var(--surface-color);
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        border: 1px solid rgba(65, 84, 241, 0.1);
        transition: all 0.3s ease;
        height: 100%;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(65, 84, 241, 0.15);
        border-color: var(--primary-color);
    }

    .stats-card .icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 24px;
        color: white;
    }

    .stats-card .icon.blue { background: var(--primary-color); }
    .stats-card .icon.green { background: #059652; }
    .stats-card .icon.orange { background: #ff6b35; }
    .stats-card .icon.purple { background: #8e44ad; }

    .stats-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--heading-color);
        margin-bottom: 10px;
        font-family: var(--heading-font);
    }

    .stats-card p {
        color: var(--text-color);
        margin: 0;
        font-size: 1rem;
    }

    /* 차트 카드 */
    .chart-card {
        background: var(--surface-color);
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        border: 1px solid rgba(65, 84, 241, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .chart-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(65, 84, 241, 0.12);
    }

    .chart-card .card-header {
        background: var(--light-bg);
        border-bottom: 1px solid rgba(65, 84, 241, 0.1);
        padding: 20px 25px;
    }

    .chart-card .card-title {
        color: var(--heading-color);
        font-weight: 600;
        margin: 0;
        font-family: var(--heading-font);
        font-size: 1.1rem;
    }

    .chart-card .card-body {
        padding: 25px;
    }

    /* 섹션 제목 */
    .section-title {
        text-align: center;
        margin-bottom: 60px;
    }

    .section-title h2 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--heading-color);
        margin-bottom: 20px;
        font-family: var(--heading-font);
        position: relative;
        display: inline-block;
    }

    .section-title h2::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: var(--primary-color);
        border-radius: 2px;
    }

    .section-title p {
        color: var(--text-color);
        font-size: 1.1rem;
        margin: 0;
    }

    /* 로딩 스피너 */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(65, 84, 241, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 차트 컨테이너 */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* 상위 업종 통계 */
    .top-business-stats {
        padding: 20px;
        background: var(--light-bg);
        border-radius: 8px;
        height: 100%;
    }

    .business-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(65, 84, 241, 0.1);
    }

    .business-detail-item:last-child {
        border-bottom: none;
    }

    .business-rank {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.8rem;
        font-weight: 700;
        color: white;
        margin-right: 10px;
    }

    .business-rank.rank-1 { background: var(--primary-color); }
    .business-rank.rank-2 { background: #059652; }
    .business-rank.rank-3 { background: #ff6b35; }

    .business-name {
        font-weight: 600;
        color: var(--heading-color);
        flex: 1;
    }

    .business-rate {
        font-weight: 700;
        color: var(--primary-color);
    }

    .business-stats-small {
        font-size: 0.85rem;
        color: var(--text-color);
        margin-top: 4px;
    }

    /* 지도 컨테이너 */
    .map-container {
        height: 600px;
        width: 100%;
        background: var(--light-bg);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-color);
    }

    /* 반응형 */
    @media (max-width: 768px) {
        .page-title h1 {
            font-size: 2rem;
        }
        
        .page-title p {
            font-size: 1rem;
        }
        
        .section-title h2 {
            font-size: 2rem;
        }
        
        .stats-card {
            margin-bottom: 30px;
        }
    }

    /* 메인 컨텐츠 영역 */
    .main-content {
        background: var(--light-bg);
        min-height: 100vh;
        padding: 0;
    }

    .content-section {
        background: var(--surface-color);
        margin: 0;
        padding: 60px 0;
    }

    .content-section:nth-child(even) {
        background: var(--light-bg);
    }

    /* 아이콘 색상 */
    .text-primary { color: var(--primary-color) !important; }
    .text-success { color: #059652 !important; }
    .text-warning { color: #ff6b35 !important; }
    .text-info { color: #17a2b8 !important; }
    .text-danger { color: #dc3545 !important; }
    .text-purple { color: #8e44ad !important; }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <!-- 페이지 타이틀 -->
    <div class="page-title" data-aos="fade-down">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1>
                        <i class="bi bi-graph-up-arrow me-3"></i>
                        ShopDash
                    </h1>
                    <p>
                        <span data-lang="KOR">서울시 상권 분석 및 창업 지원 대시보드 - 실시간 데이터 기반 인사이트 제공</span>
                        <span data-lang="ENG">Seoul Commercial District Analysis and Startup Support Dashboard - Real-time Data-driven Insights</span>
                        <span data-lang="ESP">Panel de análisis comercial y apoyo al emprendimiento en Seúl - Información basada en datos en tiempo real</span>
                    </p>
                </div>
                <div class="col-lg-4 text-end">
                    <i class="bi bi-shop" style="font-size: 6rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 통계 카드 섹션 -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">핵심 지표</span>
                    <span data-lang="ENG">Key Indicators</span>
                    <span data-lang="ESP">Indicadores Clave</span>
                </h2>
                <p>
                    <span data-lang="KOR">서울시 상권 분석의 주요 통계 정보를 한눈에 확인하세요</span>
                    <span data-lang="ENG">View key statistical data of Seoul's commercial district analysis at a glance</span>
                    <span data-lang="ESP">Consulte de un vistazo los datos estadísticos clave del análisis comercial de Seúl</span>
                </p>
            </div>
            
            <!-- 경고 메시지 영역 -->
            <div id="warning-message" class="alert alert-warning" style="display: none;" data-aos="fade-up">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="warning-text"></span>
            </div>
            
            <div class="row" data-aos="fade-up" data-aos-delay="100">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon blue">
                            <i class="bi bi-clipboard-data"></i>
                        </div>
                        <h3 id="total-analysis">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">총 분석 건수</span>
                            <span data-lang="ENG">Total Analyses</span>
                            <span data-lang="ESP">Total de Análisis</span>
                        </p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon green">
                            <i class="bi bi-percent"></i>
                        </div>
                        <h3 id="avg-survival-rate">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">평균 생존률</span>
                            <span data-lang="ENG">Average Survival Rate</span>
                            <span data-lang="ESP">Tasa Promedio de Supervivencia</span>
                        </p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon orange">
                            <i class="bi bi-shop"></i>
                        </div>
                        <h3 id="total-businesses">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">서울시 전체 업소 수</span>
                            <span data-lang="ENG">Total Number of Businesses in Seoul</span>
                            <span data-lang="ESP">Número Total de Negocios en Seúl</span>
                        </p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="icon purple">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <h3 id="active-districts">
                            <span class="loading-spinner"></span>
                        </h3>
                        <p>
                            <span data-lang="KOR">분석 활발 지역</span>
                            <span data-lang="ENG">Most Analyzed Areas</span>
                            <span data-lang="ESP">Zonas Más Analizadas</span>
                        </p>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 지역별 분석 현황 -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">지역별 분석 현황</span>
                    <span data-lang="ENG">Analysis Status by Region</span>
                    <span data-lang="ESP">Estado del Análisis por Región</span>
                </h2>
                <p>
                    <span data-lang="KOR">행정동 단위로 세분화된 상권 분석 데이터</span>
                    <span data-lang="ENG">Detailed commercial district analysis data by administrative district</span>
                    <span data-lang="ESP">Datos detallados de análisis comercial por distrito administrativo</span>
                </p>
            </div>
            
            <div class="row">
                <!-- 거주인구 상위지역 -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-people-fill text-primary me-2"></i>
                                <span data-lang="KOR">거주인구 상위지역 (행정동별)</span>
                                <span data-lang="ENG" style="display:none;">Top Residential Population Areas (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Áreas principales de población residente (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="populationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 분석 활발지역 -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="200">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                            <i class="bi bi-activity text-success me-2"></i>
                            <span data-lang="KOR">분석 활발지역</span>
                            <span data-lang="ENG" style="display:none;">Active Analysis Areas</span>
                            <span data-lang="ESP" style="display:none;">Áreas de análisis activo</span>
                        </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="businessActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 직장인구 상위지역 -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="300">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-briefcase-fill text-warning me-2"></i>
                                <span data-lang="KOR">직장인구 상위지역 (행정동별)</span>
                                <span data-lang="ENG" style="display:none;">Top Workplace Population Areas (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Áreas con mayor población trabajadora (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="workingPopulationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 외국인 여행객 많은 지역 -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="400">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-airplane text-info me-2"></i>
                                <span data-lang="KOR">외국인 여행객 많은 지역 (행정동별)</span>
                                <span data-lang="ENG" style="display:none;">Areas with Many Foreign Tourists (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Áreas con muchos turistas extranjeros (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="foreignVisitorChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 업종 분석 -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">업종 분석</span>
                    <span data-lang="ENG" style="display:none;">Industry Analysis</span>
                    <span data-lang="ESP" style="display:none;">Análisis por sector</span>
                </h2>
                <p>
                    <span data-lang="KOR">서울시 업종별 분포와 생존률 분석</span>
                    <span data-lang="ENG" style="display:none;">Distribution and survival rate analysis by industry in Seoul</span>
                    <span data-lang="ESP" style="display:none;">Distribución y análisis de la tasa de supervivencia por sector en Seúl</span>
                </p>
            </div>
            
            <div class="row">
                <!-- 업종별 분포 -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-pie-chart-fill text-danger me-2"></i>
                                <span data-lang="KOR">업종별 분포</span>
                                <span data-lang="ENG" style="display:none;">Distribution by Industry</span>
                                <span data-lang="ESP" style="display:none;">Distribución por sector</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="businessTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 평균생존률 상위지역 -->
                <div class="col-lg-6 mb-4" data-aos="fade-up" data-aos-delay="200">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-trophy-fill text-purple me-2"></i>
                                <span data-lang="KOR">평균생존률 상위지역 (행정동별)</span>
                                <span data-lang="ENG" style="display:none;">Top Areas by Average Survival Rate (by Administrative District)</span>
                                <span data-lang="ESP" style="display:none;">Áreas principales por tasa promedio de supervivencia (por distrito administrativo)</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="survivalRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 평균 생존률 상위 업종 TOP3 -->
            <div class="row">
                <div class="col-12 mb-4" data-aos="fade-up" data-aos-delay="300">
                    <div class="chart-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-star-fill text-warning me-2"></i>
                                <span data-lang="KOR">평균 생존률 상위 업종 TOP3</span>
                                <span data-lang="ENG" style="display:none;">Top 3 Industries by Average Survival Rate</span>
                                <span data-lang="ESP" style="display:none;">Top 3 Industrias por tasa promedio de supervivencia</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="chart-container">
                                        <canvas id="topBusinessSurvivalChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="top-business-stats">
                                        <h6 class="mb-3">
                                            <span data-lang="KOR">상세 정보</span>
                                            <span data-lang="ENG" style="display:none;">Detailed Information</span>
                                            <span data-lang="ESP" style="display:none;">Información Detallada</span>
                                        </h6>
                                        <div id="topBusinessDetails">
                                            <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                                                <div class="loading-spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 지도 섹션 -->
    <div class="content-section">
        <div class="container">
            <div class="section-title" data-aos="fade-up">
                <h2>
                    <span data-lang="KOR">서울시 상권 분석 지도</span>
                    <span data-lang="ENG" style="display:none;">Seoul Commercial Area Analysis Map</span>
                    <span data-lang="ESP" style="display:none;">Mapa de análisis comercial de Seúl</span>
                </h2>
                <p>
                    <span data-lang="KOR">구별 데이터를 확인하고, 클릭하여 행정동별 상세 정보를 확인하세요</span>
                    <span data-lang="ENG" style="display:none;">Check data by district and click to see detailed info by administrative neighborhood</span>
                    <span data-lang="ESP" style="display:none;">Ver datos por distrito y haga clic para ver información detallada por barrio administrativo</span>
                </p>
            </div>
            
            <div class="row">
                <div class="col-12" data-aos="fade-up" data-aos-delay="100">
                    <div class="chart-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-1">
                                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                                        <span data-lang="KOR">대화형 서울시 지도</span>
                                        <span data-lang="ENG">Interactive Seoul Map</span>
                                        <span data-lang="ESP">Mapa interactivo de Seúl</span>
                                    </h5>
                                    <div class="card-subtitle text-muted">
                                        <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                            <span data-lang="KOR">마우스 오버: 구별 정보 확인 | 클릭: 행정동 상세보기 | 마우스 휠: 확대/축소</span>
                                            <span data-lang="ENG">Mouse over: View district info | Click: See administrative detail | Mouse wheel: Zoom in/out</span>
                                            <span data-lang="ESP">Pasar el mouse: Ver info del distrito | Clic: Ver detalle administrativo | Rueda del mouse: Acercar/alejar</span>
                                        </small>
                                    </div>
                                </div>
                                <div class="map-controls">
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="map-back-btn" title="뒤로가기">
                                        <i class="bi bi-arrow-left"></i>
                                        <span data-lang="KOR">뒤로</span>
                                        <span data-lang="ENG">Back</span>
                                        <span data-lang="ESP">Atrás</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="map-reset-btn" title="지도 초기화">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        <span data-lang="KOR">초기화</span>
                                        <span data-lang="ENG">Reset</span>
                                        <span data-lang="ESP">Restablecer</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="map" class="map-container" style="height: 600px; position: relative;">
                                <!-- 지도가 여기에 로드됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<!-- OpenLayers 지도 라이브러리 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.1/ol.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/ol@10.6.1/dist/ol.js"></script>
<!-- Proj4js 좌표계 변환 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>

<!-- ShopDash 다국어화 -->
<script src="{% static 'js/shopdash-i18n.js' %}"></script>

<!-- 서울시 상권 분석 지도 -->
<script src="{% static 'js/shopdash_map.js' %}"></script>

<script>
// AOS 초기화
AOS.init({
    duration: 800,
    easing: 'ease-in-out',
    once: true,
    offset: 100
});

// 차트 기본 설정
Chart.defaults.font.family = "'Nunito', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#444444';

// 전역 변수
let charts = {};

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadAllCharts();
});

// 대시보드 통계 로드
function loadDashboardStats() {
    fetch('/shopdash/api/stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-analysis').textContent = data.total_analysis.toLocaleString();
            document.getElementById('avg-survival-rate').textContent = data.avg_survival_rate + '%';
            document.getElementById('total-businesses').textContent = data.total_businesses.toLocaleString();
            document.getElementById('active-districts').textContent = data.active_districts.toLocaleString();
            
            // 경고 메시지 표시
            if (data.warning_message && data.warning_message.trim() !== '') {
                document.getElementById('warning-text').textContent = data.warning_message;
                document.getElementById('warning-message').style.display = 'block';
            }
        })
        .catch(error => {
            console.error(getShopDashText('statsLoadFailed') + ':', error);
            document.getElementById('total-analysis').textContent = '0';
            document.getElementById('avg-survival-rate').textContent = '0%';
            document.getElementById('total-businesses').textContent = '0';
            document.getElementById('active-districts').textContent = '0';
        });
}

// 모든 차트 로드
function loadAllCharts() {
    const chartConfigs = [
        { id: 'populationChart', url: '/shopdash/api/population/', type: 'bar', color: '#4154f1' },
        { id: 'businessActivityChart', url: '/shopdash/api/business-activity/', type: 'bar', color: '#059652' },
        { id: 'workingPopulationChart', url: '/shopdash/api/working-population/', type: 'bar', color: '#ff6b35' },
        { id: 'foreignVisitorChart', url: '/shopdash/api/foreign-visitors/', type: 'bar', color: '#17a2b8' },
        { id: 'businessTypeChart', url: '/shopdash/api/business-types/', type: 'doughnut', color: null },
        { id: 'survivalRateChart', url: '/shopdash/api/survival-rate/', type: 'bar', color: '#8e44ad' },
        { id: 'topBusinessSurvivalChart', url: '/shopdash/api/top-business-survival/', type: 'bar', color: '#ffc107' }
    ];

    chartConfigs.forEach(config => {
        loadChart(config.id, config.url, config.type, config.color);
    });
}

// 개별 차트 로드
function loadChart(chartId, apiUrl, chartType, primaryColor) {
    // 평균 생존률 상위 업종 TOP3 차트는 별도 처리
    if (chartId === 'topBusinessSurvivalChart') {
        loadTopBusinessSurvivalChart();
        return;
    }

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById(chartId).getContext('2d');
            
            // 기존 차트가 있으면 제거
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            
            // 업종별 분포 차트의 경우 업종명 번역
            if (chartId === 'businessTypeChart' && data.labels) {
                data.labels = data.labels.map(label => translateBusinessType(label));
            }
            
            // 색상 설정
            if (chartType === 'doughnut') {
                // 도넛 차트용 다양한 색상
                data.datasets[0].backgroundColor = [
                    '#4154f1', '#059652', '#ff6b35', '#17a2b8', '#8e44ad',
                    '#dc3545', '#ffc107', '#6f42c1', '#20c997', '#fd7e14'
                ];
                data.datasets[0].borderWidth = 2;
                data.datasets[0].borderColor = '#ffffff';
            } else {
                // 막대 차트용 단일 색상
                data.datasets[0].backgroundColor = primaryColor + '20';
                data.datasets[0].borderColor = primaryColor;
                data.datasets[0].borderWidth = 2;
            }
            
            const config = {
                type: chartType,
                data: data,
                options: getChartOptions(chartType, chartId)
            };
            
            charts[chartId] = new Chart(ctx, config);
            
            // 생존률 차트에 경고 메시지 표시
            if (chartId === 'survivalRateChart' && data.warning_message && data.warning_message.trim() !== '') {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mt-2';
                warningDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.warning_message}`;
                document.querySelector('#survivalRateChart').closest('.chart-card').querySelector('.card-body').appendChild(warningDiv);
            }
        })
        .catch(error => {
            console.error(`${chartId} ${getShopDashText('chartLoadFailed')}:`, error);
        });
}

// 평균 생존률 상위 업종 TOP3 차트 전용 로드 함수
function loadTopBusinessSurvivalChart() {
    fetch('/shopdash/api/top-business-survival/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('topBusinessSurvivalChart').getContext('2d');
            
            // 기존 차트가 있으면 제거
            if (charts['topBusinessSurvivalChart']) {
                charts['topBusinessSurvivalChart'].destroy();
            }
            
            // 업종명 번역
            if (data.labels) {
                data.labels = data.labels.map(label => translateBusinessType(label));
            }
            
            // 차트 생성
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(1, 41, 112, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4154f1',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const analysisCount = (data.analysis_counts && data.analysis_counts[index]) || 0;
                                    const avgArea = (data.avg_area && data.avg_area[index]) || 0;
                                    const storeCount = (data.store_counts && data.store_counts[index]) || 0;
                                    
                                    return getLocalizedTooltipText(analysisCount, avgArea, storeCount);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            };
            
            charts['topBusinessSurvivalChart'] = new Chart(ctx, config);
            
            // 상세 정보 업데이트
            updateTopBusinessDetails(data);
            
            // 경고 메시지 표시 (업종별 생존률 차트용)
            if (data.warning_message && data.warning_message.trim() !== '') {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mt-2';
                warningDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.warning_message}`;
                document.querySelector('#topBusinessSurvivalChart').closest('.chart-card').querySelector('.card-body').appendChild(warningDiv);
            }
        })
        .catch(error => {
            console.error(getShopDashText('chartLoadFailed') + ':', error);
            // 에러 발생 시 기본 상세 정보 표시
            document.getElementById('topBusinessDetails').innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-exclamation-triangle mb-2"></i>
                    <p>${getShopDashText('cannotLoadData')}</p>
                </div>
            `;
        });
}

// 상위 업종 상세 정보 업데이트
function updateTopBusinessDetails(data) {
    const detailsContainer = document.getElementById('topBusinessDetails');
    
    if (!data || !data.labels || !data.datasets || !data.datasets[0] || !data.datasets[0].data) {
        detailsContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-exclamation-triangle mb-2"></i>
                <p>${getShopDashText('cannotLoadData')}</p>
            </div>
        `;
        return;
    }
    
    let detailsHtml = '';
    data.labels.forEach((label, index) => {
        const rank = index + 1;
        const rate = data.datasets[0].data[index] || 0;
        const analysisCount = (data.analysis_counts && data.analysis_counts[index]) || 0;
        const avgArea = (data.avg_area && data.avg_area[index]) || 0;
        const storeCount = (data.store_counts && data.store_counts[index]) || 0;
        
        // 원본 레이블에서 번역된 업종명 가져오기
        const originalLabel = data.original_labels ? data.original_labels[index] : label;
        const translatedLabel = translateBusinessType(originalLabel);
        
        detailsHtml += `
            <div class="business-detail-item">
                <div class="d-flex align-items-center">
                    <span class="business-rank rank-${rank}">${rank}</span>
                    <div class="business-name">${translatedLabel}</div>
                </div>
                <div class="text-end">
                    <div class="business-rate">${rate}%</div>
                    <div class="business-stats-small">
                        ${analysisCount}${getShopDashText('cases')} ${getShopDashText('analysisCount')} / ${getShopDashText('avgArea')} ${avgArea}${getShopDashText('sqm')}<br>
                        ${formatShopDashText(getShopDashText('totalStores'), {count: storeCount.toLocaleString()})}
                    </div>
                </div>
            </div>
        `;
    });
    
    detailsContainer.innerHTML = detailsHtml;
}

// 차트 옵션 설정
function getChartOptions(chartType, chartId) {
    const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: chartType === 'doughnut',
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        family: "'Nunito', sans-serif",
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(1, 41, 112, 0.9)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#4154f1',
                borderWidth: 1,
                cornerRadius: 8,
                titleFont: {
                    family: "'Nunito', sans-serif",
                    weight: 'bold'
                },
                bodyFont: {
                    family: "'Nunito', sans-serif"
                }
            }
        }
    };

    if (chartType === 'bar') {
        baseOptions.scales = {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(65, 84, 241, 0.1)',
                    borderColor: 'rgba(65, 84, 241, 0.2)'
                },
                ticks: {
                    color: '#444444',
                    font: {
                        family: "'Nunito', sans-serif"
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#444444',
                    font: {
                        family: "'Nunito', sans-serif"
                    },
                    maxRotation: 45
                }
            }
        };
    }

    return baseOptions;
}

// 언어 변경 감지 및 차트 업데이트
function handleLanguageChange() {
    console.log('ShopDash 언어 변경 감지됨');
    
    // 짧은 지연 후 차트 다시 로드하여 업종명 번역 적용
    setTimeout(() => {
        loadAllCharts();
    }, 200);
}

// 언어 변경 이벤트 리스너 등록
window.addEventListener('languageChanged', handleLanguageChange);

// 페이지 로드 완료 시 언어 변경 감지 설정
document.addEventListener('DOMContentLoaded', function() {
    // MutationObserver로 언어 변경 감지
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && 
                (mutation.target.hasAttribute('data-lang') || 
                 mutation.target.style.display !== undefined)) {
                // 언어 관련 변경이 감지되면 차트 업데이트
                handleLanguageChange();
            }
        });
    });
    
    // data-lang 속성을 가진 모든 요소 감시
    document.querySelectorAll('[data-lang]').forEach(element => {
        observer.observe(element, { 
            attributes: true, 
            attributeFilter: ['style', 'data-lang'] 
        });
    });
});

// 에러 처리
window.addEventListener('error', function(e) {
    console.error('JavaScript 에러:', e.error);
});
</script>
{% endblock %} 