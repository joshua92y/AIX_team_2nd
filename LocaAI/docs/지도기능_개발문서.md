# 서울시 상권분석 지도 기능 개발 문서

## 📋 개요

서울시 25개 구별 및 행정동별 상권 정보를 시각화하는 인터랙티브 지도 기능입니다. OpenLayers를 기반으로 구현되었으며, 구별 정보 표시, 행정동 드릴다운, 업체 수 집계 등의 기능을 제공합니다.

## 🎯 주요 기능

### 1. 구별 지도 표시
- 서울시 25개 구의 경계면 표시
- 마우스 오버 시 구별 정보 팝업 (업체 수)
- 구 클릭 시 해당 구의 행정동으로 드릴다운

### 2. 행정동 드릴다운
- 구 클릭 시 해당 구의 행정동들을 상세 표시
- 행정동별 상세 정보 (거주인구, 직장인구, 업체수, 주요업종)
- 평균 생존률 및 가장 많은 업종 정보 제공

### 3. 스마트 팝업
- 화면 위치에 따른 자동 팝업 위치 조정
- 상단 30% 영역에서는 마우스 아래쪽에 표시
- 하단 영역에서는 마우스 위쪽에 표시

## 🛠 기술 스택

### Frontend
- **OpenLayers 9.2.4**: 웹 지도 라이브러리
- **Proj4js 2.9.2**: 좌표계 변환
- **JavaScript ES6+**: 모던 JavaScript 문법
- **CSS3**: 스타일링 및 애니메이션

### Backend
- **Django**: 웹 프레임워크
- **PostGIS**: 공간 데이터베이스
- **GeoDjango**: Django의 지리정보 확장

### 좌표계
- **EPSG:5186**: 한국 중부원점 TM 좌표계 (원본 데이터)
- **EPSG:3857**: Web Mercator (지도 표시용)

## 📁 파일 구조

```
LocaAI/
├── shopdash/
│   ├── views.py                    # 지도 API 엔드포인트
│   ├── urls.py                     # URL 패턴
│   └── templates/shopdash/
│       └── dashboard.html          # 지도 컨테이너 포함 템플릿
├── static/js/
│   └── shopdash_map.js            # 지도 JavaScript 구현
├── GeoDB/
│   ├── models.py                   # SeoulDistrict, AdministrativeDistrict 모델
│   ├── admin.py                    # 관리자 인터페이스
│   ├── migrations/
│   │   └── 0005_seouldistrict.py  # SeoulDistrict 테이블 생성
│   └── management/commands/
│       ├── import_seoul_districts.py  # 구별 데이터 임포트
│       └── import_dong_store.py       # 상점 데이터 임포트
└── docs/
    └── 지도기능_개발문서.md       # 이 문서
```

## 🗄 데이터베이스 구조

### 1. seoul_district 테이블
```sql
CREATE TABLE seoul_district (
    id SERIAL PRIMARY KEY,
    adm_sect_c VARCHAR(10) UNIQUE,     -- 행정구역코드 (11110: 종로구)
    sgg_nm VARCHAR(100),               -- 구명 (서울특별시 종로구)
    sgg_oid FLOAT,                     -- 구 OID
    col_adm_se VARCHAR(10),            -- 행정구분
    geom GEOMETRY(MULTIPOLYGON, 5186), -- 구경계면
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 2. 행정동구역 테이블
```sql
CREATE TABLE "행정동구역" (
    fid SERIAL PRIMARY KEY,
    emd_cd VARCHAR(8),                 -- 행정동코드 (8자리)
    emd_eng_nm VARCHAR(100),           -- 영문행정동명
    emd_kor_nm VARCHAR(100),           -- 한글행정동명
    geom GEOMETRY(MULTIPOLYGON, 5186)  -- 행정구역경계
);
```

### 3. dong_store 테이블
```sql
CREATE TABLE dong_store (
    id SERIAL PRIMARY KEY,
    emd_kor_nm VARCHAR(100),           -- 행정동명
    uptaenm VARCHAR(100),              -- 업종명 (대문자)
    -- 기타 상점 정보 필드들
);
```

## 🔌 API 엔드포인트

### 1. 구별 GeoJSON API
```
GET /shopdash/api/seoul-districts/
```
**응답 예시:**
```json
{
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "properties": {
                "adm_sect_c": "11110",
                "sgg_nm": "서울특별시 종로구",
                "district_name": "종로구",
                "business_count": 2910
            },
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": [...]
            }
        }
    ]
}
```

### 2. 행정동 GeoJSON API
```
GET /shopdash/api/dong-geojson/?gu_code=11680
```
**응답 예시:**
```json
{
    "type": "FeatureCollection", 
    "features": [
        {
            "type": "Feature",
            "properties": {
                "emd_cd": "11680101",
                "emd_kor_nm": "신사동",
                "dong_life": 45230,
                "dong_work": 31661,
                "total_businesses": 1247,
                "avg_survival_rate": 73.2,
                "top_business_type": "음식점",
                "top_business_count": 324
            },
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": [...]
            }
        }
    ]
}
```

## 💻 주요 클래스 및 메서드

### SeoulCommercialMap 클래스

```javascript
class SeoulCommercialMap {
    constructor(containerId)           // 지도 초기화
    setupProjections()                 // 좌표계 설정
    createMap()                        // OpenLayers 지도 생성
    createPopup()                      // 팝업 오버레이 생성
    loadDistrictLayer()                // 구별 레이어 로드
    setupSelection()                   // 선택 이벤트 설정
    handleDistrictHover(event)         // 구별 마우스오버 처리
    handleDongHover(event)             // 행정동 마우스오버 처리
    showPopup(coordinate, properties)  // 구별 팝업 표시
    showDongPopup(coordinate, properties) // 행정동 팝업 표시
    setSmartPopupPosition(coordinate)  // 스마트 팝업 위치 설정
    zoomToDistrict(feature, guCode)    // 구 확대 및 행정동 표시
    loadDongLayer(guCode)              // 행정동 레이어 로드
    returnToDistrictView()             // 구별 뷰로 복귀
}
```

## 🎨 스타일링

### 구별 레이어 스타일
```javascript
new ol.style.Style({
    stroke: new ol.style.Stroke({
        color: '#4154f1',
        width: 2
    }),
    fill: new ol.style.Fill({
        color: 'rgba(65, 84, 241, 0.1)'
    })
})
```

### 행정동 레이어 스타일
```javascript
new ol.style.Style({
    stroke: new ol.style.Stroke({
        color: '#2196F3',
        width: 2
    }),
    fill: new ol.style.Fill({
        color: 'rgba(33, 150, 243, 0.1)'
    })
})
```

### 팝업 CSS
```css
.ol-popup {
    position: absolute;
    background-color: white;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    padding: 15px 20px;
    border-radius: 12px;
    border: none;
    min-width: 200px;
    max-width: 300px;
    font-family: 'Nunito', sans-serif;
}

.ol-popup[data-position="bottom"]:after {
    border-top-color: white;
    border-bottom: none;
}

.ol-popup[data-position="top"]:after {
    border-bottom-color: white;
    border-top: none;
}
```

## 🔧 설정 및 설치

### 1. 필요한 라이브러리 추가
```html
<!-- OpenLayers -->
<script src="https://cdn.jsdelivr.net/npm/ol@9.2.4/dist/ol.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@9.2.4/ol.css">

<!-- Proj4js -->
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>
```

### 2. Django 설정
```python
# settings.py
INSTALLED_APPS = [
    'django.contrib.gis',
    'GeoDB',
    'shopdash',
]

DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.postgis',
        # 기타 데이터베이스 설정
    }
}
```

### 3. URL 설정
```python
# shopdash/urls.py
urlpatterns = [
    path('api/seoul-districts/', views.get_seoul_districts_geojson, name='seoul_districts_geojson'),
    path('api/dong-geojson/', views.get_dong_geojson, name='dong_geojson'),
]
```

## 📊 데이터 집계 쿼리

### 구별 업체 수 집계
```sql
SELECT COUNT(*) FROM dong_store ds
JOIN "행정동구역" ad ON ds.emd_kor_nm = ad.emd_kor_nm
WHERE ad.emd_cd LIKE '11680%'  -- 강남구 예시
```

### 행정동별 주요 업종 집계
```sql
SELECT 
    ds.UPTAENM, 
    COUNT(*) as count
FROM dong_store ds
JOIN "행정동구역" ad ON ds.emd_kor_nm = ad.emd_kor_nm
WHERE ad.emd_cd = '11680101'  -- 신사동 예시
GROUP BY ds.UPTAENM
ORDER BY count DESC
LIMIT 1
```

## 🐛 트러블슈팅

### 1. SeoulDistrict 모델 import 오류
**문제**: `cannot import name 'SeoulDistrict' from 'GeoDB.models'`
**해결**: `python manage.py migrate` 실행하여 migration 적용

### 2. 좌표계 변환 오류
**문제**: 지도에 데이터가 표시되지 않음
**해결**: EPSG:5186 좌표계 정의 확인 및 proj4 설정

### 3. 팝업 위치 문제
**문제**: 팝업이 화면 상단에서 지도를 이동시킴
**해결**: `setSmartPopupPosition()` 메서드로 동적 위치 조정

### 4. 차트 데이터 오류
**문제**: `Cannot read properties of undefined (reading '0')`
**해결**: JavaScript에서 안전한 데이터 접근을 위한 null 체크 추가

## 🚀 향후 개선 사항

### 1. 성능 최적화
- 벡터 타일 서비스 도입
- 레이어 캐싱 구현
- 데이터 압축 최적화

### 2. 기능 확장
- 검색 기능 추가
- 필터링 옵션 제공
- 히트맵 시각화

### 3. 사용자 경험 개선
- 로딩 인디케이터 개선
- 터치 제스처 지원
- 반응형 디자인 강화

## 📝 참고 자료

- [OpenLayers Documentation](https://openlayers.org/en/latest/doc/)
- [Proj4js Documentation](http://proj4js.org/)
- [GeoDjango Documentation](https://docs.djangoproject.com/en/stable/ref/contrib/gis/)
- [PostGIS Documentation](https://postgis.net/documentation/)

---

**작성일**: 2025년 6월 20일  
**작성자**: SSH 팀  
**버전**: 1.0.0 