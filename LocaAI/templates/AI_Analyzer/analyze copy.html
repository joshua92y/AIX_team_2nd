{% extends 'base.html' %}
{% load static %}

{% block title %}ìƒê¶Œ ë¶„ì„{% endblock %}

{% block content %}
{% include 'includes/header.html' %}

  <style>
    /* ê¸°ë³¸ primary ë²„íŠ¼ disabled ì‹œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .btn-primary.custom {
      color: #fff;
      background-color: #0d6efd; /* ì›ë˜ primary ìƒ‰ */
      opacity: 0.65;  /* íˆ¬ëª…ë„ ì¡°ì ˆë¡œ íë¦¿í•˜ê²Œ í‘œì‹œ */
    }
    
    /* ë¶„ì„ ì§„í–‰ ìƒí™© ìŠ¤íƒ€ì¼ */
    .analysis-progress {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      margin-top: 1rem;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .progress-step.active {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .progress-step.completed {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #22c55e;
    }
    
    .progress-step.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }
    
    .progress-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
    }
    
    .progress-step.active .progress-icon {
      background: #667eea;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .progress-step.completed .progress-icon {
      background: #22c55e;
      color: white;
    }
    
    .progress-step.error .progress-icon {
      background: #ef4444;
      color: white;
    }
    
    .progress-step:not(.active):not(.completed):not(.error) .progress-icon {
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .progress-text {
      flex: 1;
    }
    
    .progress-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .progress-detail {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .overall-progress {
      margin-bottom: 1.5rem;
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* ê³µì‹œì§€ê°€ ì¹´ë“œ í°íŠ¸ í¬ê¸° ì¡°ì • */
    #totalLandValue {
      font-size: 1.8rem !important;
      line-height: 1.2;
    }
    
    @media (max-width: 768px) {
      #totalLandValue {
        font-size: 1.5rem !important;
      }
    }

    /* ì±—ë´‡ ìŠ¤íƒ€ì¼ */
    .chat-interface-container {
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .chat-messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .chat-welcome-message {
      text-align: center;
      padding: 1rem;
    }

    .message-entry {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
    }

    .message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: 80%;
      word-wrap: break-word;
    }

    .user-message {
      align-items: flex-end;
    }

    .user-message .message-bubble {
      background-color: #007bff;
      color: white;
    }

    .bot-message {
      align-items: flex-start;
    }

    .bot-message .message-bubble {
      background-color: #e9ecef;
      color: #212529;
    }

    .typing-indicator-message .message-bubble {
      background-color: #e9ecef;
      color: #6c757d;
    }

    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: white;
      border-radius: 0.5rem;
    }

    .chat-input-area textarea {
      flex: 1;
      resize: none;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }

    .chat-input-area button {
      padding: 0.5rem 1rem;
    }
  </style>

  <!-- Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- í•œêµ­ì–´ í°íŠ¸ ì§€ì› -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/customfonts.js"></script>
  <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Marked.js for markdown rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.0/marked.min.js"></script>

  <!-- user_infoì™€ previous_docs ë°ì´í„°ë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì¶”ê°€ -->
  <script type="application/json" id="user-info-data">{{ user_info_json|safe }}</script>
  <script type="application/json" id="previous-docs-data">{{ previous_docs_json|safe }}</script>

  <div class="container my-6" style="margin-top: 20px; margin-bottom: 100px;">
    {% if user_info %}
      <!-- ğŸ“ ê¸°ì¡´ ë¶„ì„ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ (ë¡œê·¸ì¸ëœ ì‚¬ìš©ì, ê¸°ì¡´ ë¶„ì„ ê¸°ë¡ ìˆìŒ) -->
      <div id="existingAnalysisSection">
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="card p-4 shadow-sm mb-4">
          <h4 class="mb-3">ğŸ“ ë‚´ ìµœê·¼ ë¶„ì„ ê¸°ë¡</h4>
              {% if previous_docs.count > 0 %}
            <ul class="list-group">
              {% for doc in previous_docs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                        <strong>ë¶„ì„ ID: {{ doc.analysis_result.id }}</strong><br>
                        <small>ì£¼ì†Œ: {{ doc.analysis_result.request.address }}</small><br>
                        <small>ë¶„ì„ì¼: {{ doc.analysis_result.created_at|date:"Y-m-d H:i" }}</small><br>
                        <small>ìƒì¡´ í™•ë¥ : {{ doc.analysis_result.survival_percentage }}%</small>
                  </div>
                      <button class="btn btn-sm btn-outline-primary" data-analysis-id="{{ doc.analysis_result.id }}" data-session-id="{{ doc.id }}" onclick="loadAnalysisAndChatSession(this.dataset.analysisId, this.dataset.sessionId)">ê²°ê³¼ë³´ê¸°</button>
                </li>
              {% endfor %}
            </ul>
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ -->
                <nav aria-label="Page navigation example" class="mt-3">
                  <ul class="pagination justify-content-center">
                    {% if previous_docs.has_previous %}
                      <li class="page-item"><a class="page-link" href="?page={{ previous_docs.previous_page_number }}">ì´ì „</a></li>
                    {% endif %}
                    {% for i in previous_docs.paginator.page_range %}
                      {% if previous_docs.number == i %}
                        <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
          {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
          {% endif %}
                    {% endfor %}
                    {% if previous_docs.has_next %}
                      <li class="page-item"><a class="page-link" href="?page={{ previous_docs.next_page_number }}">ë‹¤ìŒ</a></li>
                    {% endif %}
                  </ul>
                </nav>
                <div class="d-grid gap-2 mt-3">
                  <button class="btn btn-primary" id="startNewAnalysisBtn" onclick="startNewAnalysisRoutine()">ìƒˆë¡œìš´ ìƒê¶Œ ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
        </div>
              {% else %}
                <div class="alert alert-info text-center" role="alert">
                  ì•„ì§ ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ìƒê¶Œ ë¶„ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”!
      </div>
                <div class="d-grid gap-2 mt-3">
                  <button class="btn btn-primary" id="startAnalysisChatBtn">ìƒˆ ìƒê¶Œ ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
    </div>
              {% endif %}
                  </div>
              </div>
            </div>
          </div>
          
      <!-- ì±—ë´‡ê³¼ ë¶„ì„ ë¦¬í¬íŠ¸ ì„¹ì…˜ (ê¸°ì¡´ ë¶„ì„ ë¡œë“œ ë˜ëŠ” ì‹ ê·œ ë¶„ì„ ì™„ë£Œ í›„ í‘œì‹œ) -->
      <div id="analysisReportAndChatSection" style="display: none;">
        <div class="row mt-5">
          <!-- ë¶„ì„ ê²°ê³¼ ë¡œë”©/ëŒ€ê¸° ìƒíƒœ -->
          <div id="analysisWaiting" class="col-lg-12 text-center" style="display: none;">
            <div class="card p-4 shadow-sm">
              <h4 class="mb-3">ğŸ“ˆ ìƒê¶Œ ë¶„ì„ ê²°ê³¼ ëŒ€ê¸° ì¤‘...</h4>
              <p>ì¢Œì¸¡ì—ì„œ ê¸°ì¡´ ë¶„ì„ ê¸°ë¡ì„ ì„ íƒí•˜ê±°ë‚˜, ìƒˆë¡œìš´ ë¶„ì„ì„ ì‹œì‘í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
          </div>
          
          <!-- ë¶„ì„ ì§„í–‰ ìƒí™© (ê¸°ì¡´ ë¶„ì„ ë¡œë“œ ì‹œ) -->
          <div id="analysisProgress" class="col-lg-12 analysis-progress" style="display: none;">
            <h5 class="mb-4 text-center">ğŸ“Š ìƒê¶Œ ë¶„ì„ ì§„í–‰ ì¤‘...</h5>
            <div class="overall-progress mb-3">
              <div class="progress" role="progressbar" aria-label="Overall Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 8px;">
                <div id="overallProgressBar" class="progress-bar" style="width: 0%"></div>
              </div>
              <p class="text-end mt-2"><span id="overallPercent">0%</span> ì™„ë£Œ</p>
              </div>
            <div class="progress-steps">
              <div id="step-population" class="progress-step">
                <div class="progress-icon"><i class="bi bi-people"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ìƒí™œì¸êµ¬ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-working" class="progress-step">
                <div class="progress-icon"><i class="bi bi-person-workspace"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ì§ì¥ì¸êµ¬ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-foreign" class="progress-step">
                <div class="progress-icon"><i class="bi bi-globe"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ì™¸êµ­ì¸ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-facilities" class="progress-step">
                <div class="progress-icon"><i class="bi bi-building"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ì£¼ë³€ì‹œì„¤ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-competition" class="progress-step">
                <div class="progress-icon"><i class="bi bi-shop"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ê²½ìŸì—…ì²´ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-land" class="progress-step">
                <div class="progress-icon"><i class="bi bi-cash-stack"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ê³µì‹œì§€ê°€ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-ai" class="progress-step">
                <div class="progress-icon"><i class="bi bi-robot"></i></div>
                <div class="progress-text">
                  <div class="progress-title">AI ì˜ˆì¸¡ ë¶„ì„</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
              <div id="step-complete" class="progress-step">
                <div class="progress-icon"><i class="bi bi-check-circle"></i></div>
                <div class="progress-text">
                  <div class="progress-title">ë¶„ì„ ì™„ë£Œ</div>
                  <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
              </div>
            </div>
            <div class="alert alert-danger mt-3" id="analysisError" style="display: none;">
              <h5><i class="bi bi-exclamation-triangle me-2"></i>ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h5>
              <p id="analysisErrorMessage"></p>
              <button class="btn btn-primary" onclick="retryAnalysis(currentRequestId, false)"><i class="bi bi-arrow-clockwise me-1"></i>ë‹¤ì‹œ ì‹œë„</button>
            </div>
          </div>
          
          <!-- ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸ -->
          <div id="analysisResults" class="col-lg-6 mb-4" style="display: none;">
            <div class="card shadow-sm p-4 h-100">
              <h4 class="mb-4">ğŸ“Š ìƒê¶Œ ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸</h4>

              <div class="mb-3">
                <h5>ìš”ì²­ ì •ë³´</h5>
                <p><strong>ì£¼ì†Œ:</strong> <span id="resultAddress"></span></p>
                <p><strong>ì—…ì¢…:</strong> <span id="resultBusinessType"></span></p>
                <p><strong>ë©´ì :</strong> <span id="resultArea"></span>mÂ²</p>
                <p><strong>ì„œë¹„ìŠ¤ ìœ í˜•:</strong> <span id="resultServiceType"></span></p>
            </div>

              <hr>

              <div class="mb-3">
                <h5>í•µì‹¬ ì§€í‘œ (ë°˜ê²½ 300m)</h5>
                <div class="row">
                <div class="col-md-6">
                    <p><strong>ìƒí™œì¸êµ¬:</strong> <span id="lifePop300"></span>ëª…</p>
                    </div>
                  <div class="col-md-6">
                    <p><strong>ì§ì¥ì¸êµ¬:</strong> <span id="workingPop300"></span>ëª…</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>ê²½ìŸì—…ì²´:</strong> <span id="competitor300"></span>ê°œ</p>
                </div>
                <div class="col-md-6">
                    <p><strong>ê³µì‹œì§€ê°€:</strong> <span id="totalLandValue"></span></p>
                    </div>
                  </div>
                </div>

              <hr>

              <div class="mb-3">
                <h5>AI ì˜ˆì¸¡ ìƒì¡´ í™•ë¥ </h5>
                <h2 class="display-4 text-center mb-3"><span id="survivalPercentage"></span></h2>
                <div class="progress mb-2" role="progressbar" aria-label="Survival Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 20px;">
                  <div id="survivalBar" class="progress-bar" style="width: 0%"></div>
              </div>
                <div id="survivalAnalysis" class="alert mt-3 text-center"></div>
            </div>

              <hr>

              <div class="mb-3">
                <h5>ê²½ìŸ ë¶„ì„</h5>
                <p><strong>ë™ì¼ ì—…ì¢… ê²½ìŸ ì í¬ ìˆ˜ (300m):</strong> <span id="competitorCount"></span>ê°œ</p>
                <p><strong>ì¸ê·¼ ì—…ì¢… ì í¬ ìˆ˜ (300m):</strong> <span id="adjacentBiz"></span>ê°œ</p>
                <p><strong>ê²½ìŸ ì—…ì²´ ë¹„ìœ¨ (300m):</strong> <span id="competitorRatio"></span></p>
                <div class="progress mb-2" role="progressbar" aria-label="Competition Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 20px;">
                  <div id="competitionBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-center mt-2">ê²½ìŸ ìˆ˜ì¤€: <span id="competitionLevel"></span></div>
                <p class="mt-3"><strong>ì—…ì¢… ë‹¤ì–‘ì„± (300m):</strong> <span id="businessDiversity"></span></p>
                </div>

              <hr>

              <div class="mb-3">
                <h5>ê°•ì  ë° ìœ ì˜ì‚¬í•­</h5>
                <h6><i class="bi bi-check-circle-fill text-success me-2"></i>ê°•ì </h6>
                <ul id="strengthsList" class="list-unstyled"></ul>
                <h6><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>ìœ ì˜ì‚¬í•­</h6>
                <ul id="cautionsList" class="list-unstyled"></ul>
              </div>
              
              <div class="d-grid gap-2 mt-4">
                <button class="btn btn-info" onclick="showPdfPreview(currentRequestId)"><i class="bi bi-file-earmark-pdf me-2"></i>ìƒê¶Œ ë¶„ì„ ë³´ê³ ì„œ (ë¯¸ë¦¬ë³´ê¸°)</button>
                  </div>
              </div>
            </div>

          <!-- ì±—ë´‡ ì¸í„°í˜ì´ìŠ¤ -->
          <div class="col-lg-6 mb-4" id="chatInterfaceContainer" style="display: none;">
            <div class="card shadow-sm p-4 h-100 d-flex flex-column">
              <h4 class="mb-4">ğŸ’¬ ìƒê¶Œ ë¶„ì„ ì±—ë´‡</h4>
              <div id="chatMessagesArea" class="chat-messages-area flex-grow-1 mb-3">
                <!-- Chat messages will be appended here -->
                <div class="chat-welcome-message bot-message">
                  <div class="message-bubble">
                    ìƒê¶Œ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ì €ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!
                    <br><br>
                    ì˜ˆì‹œ ì§ˆë¬¸:
                    <ul>
                      <li>ì´ ìƒê¶Œì˜ ìœ ë™ ì¸êµ¬ íŠ¹ì§•ì€ ì–´ë–¤ê°€ìš”?</li>
                      <li>ì£¼ë³€ ê²½ìŸ ì—…ì²´ëŠ” ëª‡ ê°œì¸ê°€ìš”?</li>
                      <li>ì´ ì—…ì¢…ì˜ ìƒì¡´ í™•ë¥ ì´ ì˜ë¯¸í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?</li>
                  </ul>
                </div>
                </div>
              </div>
              <div id="typingIndicator" class="typing-indicator-message mb-2" style="display: none;">
                <div class="message-bubble">
                  AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
            </div>
            </div>
              <div class="chat-input-area d-flex">
                <input type="text" id="messageInput" class="form-control flex-grow-1" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" id="sendButton">ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>
          </div>
          </div>

    {% else %}
      <!-- ğŸš€ ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘ ì„¹ì…˜ (ë¡œê·¸ì¸ ì•ˆ ëœ ì‚¬ìš©ì ë˜ëŠ” ê¸°ì¡´ ë¶„ì„ ê¸°ë¡ ì—†ëŠ” ë¡œê·¸ì¸ëœ ì‚¬ìš©ì) -->
      <div id="newAnalysisSection">
        <div class="row mt-5">
          <div class="col-lg-12">
            <div class="card p-4 shadow-sm mb-4">
              <h4 class="mb-3">ğŸš€ ìƒˆë¡œìš´ ìƒê¶Œ ë¶„ì„ ì‹œì‘í•˜ê¸°</h4>
              <p class="text-center lead">ì±—ë´‡ê³¼ ëŒ€í™”í•˜ë©° ìƒê¶Œ ë¶„ì„ì— í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

              <div id="initialChatMessagesArea" class="chat-messages-area mb-3" style="height: 300px;">
                <div class="chat-welcome-message bot-message">
                  <div class="message-bubble">
                    ì•ˆë…•í•˜ì„¸ìš”! ìƒê¶Œ ë¶„ì„ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.
        </div>
      </div>
    </div>
              
              <div id="analysisInputForm" style="display: block;">
                <!-- 1. ì—…ì¢… ì…ë ¥ -->
                <div id="businessTypeStep" class="chat-step mb-3">
                  <label for="business_type_id" class="form-label">ğŸ“Š ì–´ë–¤ ì—…ì¢…ì˜ ìƒê¶Œì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?</label>
                  <select class="form-select" id="business_type_id">
                    <option value="">ì—…ì¢…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="35">í•œì‹</option>
                    <option value="16">ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)</option>
                    <option value="24">ì¤‘êµ­ì‹</option>
                    <option value="21">ì¼ì‹</option>
                    <option value="14">ë¶„ì‹</option>
                    <option value="6">ê¹€ë°¥(ë„ì‹œë½)</option>
                    <option value="30">í†µë‹­(ì¹˜í‚¨)</option>
                    <option value="36">í˜¸í”„/í†µë‹­</option>
                    <option value="7">ê¹Œí˜</option>
                    <option value="27">ì»¤í”¼ìˆ</option>
                    <option value="10">ë–¡ì¹´í˜</option>
                    <option value="22">ì „í†µì°»ì§‘</option>
                    <option value="9">ë‹¤ë°©</option>
                    <option value="15">ë·”í˜ì‹</option>
                    <option value="1">ê²½ì–‘ì‹</option>
                    <option value="18">ì™¸êµ­ìŒì‹ì „ë¬¸ì (ì¸ë„, íƒœêµ­ ë“±)</option>
                    <option value="31">íŒ¨ë°€ë¦¬ë ˆìŠ¤í† ë‘</option>
                    <option value="32">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option>
                    <option value="17">ì•„ì´ìŠ¤í¬ë¦¼</option>
                    <option value="8">ëƒ‰ë©´ì§‘</option>
                    <option value="13">ë³µì–´ì·¨ê¸‰</option>
                    <option value="29">íƒ•ë¥˜(ë³´ì‹ ìš©)</option>
                    <option value="5">ê¸°íƒ€ íœ´ê²ŒìŒì‹ì </option>
                    <option value="20">ì¼ë°˜ì¡°ë¦¬íŒë§¤</option>
                    <option value="23">ì •ì¢…/ëŒ€í¬ì§‘/ì†Œì£¼ë°©</option>
                    <option value="0">ê°ì„±ì£¼ì </option>
                    <option value="11">ë¼ì´ë¸Œì¹´í˜</option>
                    <option value="2">ê´€ê´‘í˜¸í…”</option>
                    <option value="3">ê·¹ì¥</option>
                    <option value="19">ìœ ì›ì§€</option>
                    <option value="12">ë°±í™”ì </option>
                    <option value="25">ì² ë„ì—­êµ¬ë‚´</option>
                    <option value="26">ì¶œì¥ì¡°ë¦¬</option>
                    <option value="28">í‚¤ì¦ˆì¹´í˜</option>
                    <option value="33">í¸ì˜ì </option>
                    <option value="34">í‘¸ë“œíŠ¸ëŸ­</option>
                    <option value="4">ê¸°íƒ€</option>
                  </select>
                  <button class="btn btn-primary mt-2" onclick="proceedToAddressStep()">ë‹¤ìŒ</button>
</div>

                <!-- 2. ì£¼ì†Œ ì…ë ¥ -->
                <div id="addressStep" class="chat-step mb-3" style="display: none;">
                  <label for="address" class="form-label">ğŸ“ ë¶„ì„í•  ìƒê¶Œì˜ ì£¼ì†Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="address" placeholder="ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”" readonly>
                    <input type="hidden" id="latitude">
                    <input type="hidden" id="longitude">
                    <input type="hidden" id="x_coord">
                    <input type="hidden" id="y_coord">
                    <button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()"><i class="bi bi-search"></i> ì£¼ì†Œ ê²€ìƒ‰</button>
        </div>
                  <button class="btn btn-primary mt-2" id="nextAddressStepBtn" onclick="proceedToAreaStep()" disabled>ë‹¤ìŒ</button>
          </div>
          
                <!-- 3. ì í¬ ë©´ì  ì…ë ¥ -->
                <div id="areaStep" class="chat-step mb-3" style="display: none;">
                  <label for="area" class="form-label">ğŸ“ ì í¬ ë©´ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ë‹¨ìœ„: mÂ²).</label>
                  <input type="number" class="form-control" id="area" placeholder="ì˜ˆ: 50">
                  <button class="btn btn-primary mt-2" onclick="proceedToServiceTypeStep()">ë‹¤ìŒ</button>
          </div>
          
                <!-- 4. ì£¼ë¥˜ íŒë§¤ ì—¬ë¶€ -->
                <div id="serviceTypeStep" class="chat-step mb-3" style="display: none;">
                  <label for="service_type" class="form-label">ğŸ» ì£¼ë¥˜ íŒë§¤ ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</label>
                  <select class="form-select" id="service_type">
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="1">íŒë§¤í•¨ (ì¼ë°˜ìŒì‹ì )</option>
                    <option value="0">íŒë§¤ ì•ˆí•¨ (íœ´ê²ŒìŒì‹ì )</option>
                  </select>
                  <button class="btn btn-primary mt-2" onclick="proceedToConfirmStep()">ë‹¤ìŒ</button>
            </div>
            
                <!-- 5. ìµœì¢… í™•ì¸ ë° ë¶„ì„ ì‹œì‘ -->
                <div id="confirmStep" class="chat-step mb-3" style="display: none;">
                  <div class="alert alert-info" role="alert">
                    ì…ë ¥í•˜ì‹  ì •ë³´ë¡œ ìƒê¶Œ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                </div>
                  <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="getFormData()">ğŸ“ˆ ìƒê¶Œ ë¶„ì„í•˜ê¸°</button>
                </div>
              </div>
            </div>
            
              <!-- ì‹ ê·œ ë¶„ì„ ì§„í–‰ ìƒí™© -->
              <div id="newAnalysisProgress" class="analysis-progress" style="display: none;">
                <h5 class="mb-4 text-center">ğŸ“Š ìƒê¶Œ ë¶„ì„ ì§„í–‰ ì¤‘...</h5>
                <div class="overall-progress mb-3">
                  <div class="progress" role="progressbar" aria-label="Overall Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 8px;">
                    <div id="newOverallProgressBar" class="progress-bar" style="width: 0%"></div>
              </div>
                  <p class="text-end mt-2"><span id="newOverallPercent">0%</span> ì™„ë£Œ</p>
            </div>
                <div class="progress-steps">
                  <div id="new-step-population" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-people"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ìƒí™œì¸êµ¬ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                    </div>
                  </div>
                  <div id="new-step-working" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-person-workspace"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ì§ì¥ì¸êµ¬ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
                    </div>
                  <div id="new-step-foreign" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-globe"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ì™¸êµ­ì¸ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                  </div>
                </div>
                  <div id="new-step-facilities" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-building"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ì£¼ë³€ì‹œì„¤ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                    </div>
                  </div>
                  <div id="new-step-competition" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-shop"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ê²½ìŸì—…ì²´ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                </div>
                    </div>
                  <div id="new-step-land" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-cash-stack"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ê³µì‹œì§€ê°€ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                  </div>
                </div>
                  <div id="new-step-ai" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-robot"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">AI ì˜ˆì¸¡ ë¶„ì„</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
              </div>
            </div>
                  <div id="new-step-complete" class="progress-step">
                    <div class="progress-icon"><i class="bi bi-check-circle"></i></div>
                    <div class="progress-text">
                      <div class="progress-title">ë¶„ì„ ì™„ë£Œ</div>
                      <div class="progress-detail">ì¤€ë¹„ ì¤‘...</div>
                  </div>
                  </div>
                </div>
                <div class="alert alert-danger mt-3" id="newAnalysisError" style="display: none;">
                  <h5><i class="bi bi-exclamation-triangle me-2"></i>ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h5>
                  <p id="newAnalysisErrorMessage"></p>
                  <button class="btn btn-primary" onclick="retryAnalysis(currentRequestId, true)"><i class="bi bi-arrow-clockwise me-1"></i>ë‹¤ì‹œ ì‹œë„</button>
              </div>
                  </div>

              <!-- ì‹ ê·œ ë¶„ì„ ì±—ë´‡ ì…ë ¥ ì˜ì—­ -->
              <div id="newAnalysisChatInputArea" class="chat-input-area mt-3" style="display: none;">
                <input type="text" id="newMessageInput" class="form-control flex-grow-1" placeholder="ì±—ë´‡ì—ê²Œ ì§ˆë¬¸í•˜ê±°ë‚˜ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" id="newSendButton">ë³´ë‚´ê¸°</button>
                  </div>
              <div id="newAnalysisTypingIndicator" class="typing-indicator-message mb-2" style="display: none;">
                <div class="message-bubble">
                  AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
              </div>
            </div>
            
            </div>
          </div>
        </div>
          </div>
    {% endif %}

  </div> <!-- /container -->

  <!-- PDF ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfPreviewModalLabel">ìƒê¶Œ ë¶„ì„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="previewLoading" class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
          <div id="previewError" class="alert alert-danger text-center" style="display: none;">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>ì˜¤ë¥˜ ë°œìƒ</h5>
            <p id="previewErrorMessage"></p>
            <button class="btn btn-primary mt-3" onclick="showPdfPreview(currentPreviewRequestId)">ë‹¤ì‹œ ì‹œë„</button>
          </div>
          <div id="previewContent" style="display: none; background-color: #ffffff; padding: 20px; border-radius: 8px;">
            <div class="text-center mb-4">
              <h2 class="fw-bold text-primary">AI ìƒê¶Œ ë¶„ì„ ë³´ê³ ì„œ</h2>
              <p class="text-muted">AI ê¸°ë°˜ ìƒê¶Œ ë¶„ì„ ê²°ê³¼</p>
            </div>
            <hr class="mb-4">
            
            <div class="row mb-4">
                      <div class="col-md-6">
                <h6>ê¸°ë³¸ ì •ë³´</h6>
                <p><strong>ì£¼ì†Œ:</strong> <span id="previewAddr"></span></p>
                <p><strong>ì—…ì¢…:</strong> <span id="previewBizType"></span></p>
                <p><strong>ë©´ì :</strong> <span id="previewAreaSize"></span> mÂ²</p>
                <p><strong>ë¶„ì„ì¼:</strong> <span id="previewAnalysisDate"></span></p>
                      </div>
              <div class="col-md-6 text-end">
                <h6>ìƒì¡´ í™•ë¥  ì˜ˆì¸¡</h6>
                <h1 class="text-primary"><span id="previewSurvivalRate"></span></h1>
                <div class="progress mb-2" style="height: 15px;">
                  <div id="previewSurvivalProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                <p id="previewSurvivalComment" class="text-muted mb-0"></p>
              </div>
            </div>
            
            <div class="card mb-4 bg-light">
              <div class="card-body">
                <h6 class="card-title text-primary">í•µì‹¬ ì§€í‘œ (ë°˜ê²½ 300m)</h6>
                <div class="row">
                  <div class="col-md-6"><p>ìƒí™œì¸êµ¬: <strong id="previewLifePopulation"></strong></p></div>
                  <div class="col-md-6"><p>ì§ì¥ì¸êµ¬: <strong id="previewWorkingPopulation"></strong></p></div>
                  <div class="col-md-6"><p>ê²½ìŸì—…ì²´: <strong id="previewCompetitors"></strong></p></div>
                  <div class="col-md-6"><p>ê³µì‹œì§€ê°€: <strong id="previewLandPrice"></strong></p></div>
                  </div>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-6" id="previewStrengthsList">
                <h6><i class="bi bi-check-circle-fill text-success me-2"></i>ê°•ì </h6>
                <ul class="list-unstyled"></ul>
                  </div>
              <div class="col-md-6" id="previewCautionsList">
                <h6><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>ìœ ì˜ì‚¬í•­</h6>
                <ul class="list-unstyled"></ul>
              </div>
            </div>
            
            <hr class="mt-5 mb-3">
            <p class="text-muted text-center" style="font-size: 0.85em;">ë³¸ ë³´ê³ ì„œëŠ” AI ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, ì‹¤ì œ ì‹œì¥ ìƒí™©ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íˆ¬ì ê²°ì • ì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. <br>ë³´ê³ ì„œ ìƒì„±ì¼: <span id="previewReportGeneratedDate"></span></p>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary" id="previewDownloadPdfBtn" onclick="downloadPreviewPDF()"><i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)</button>
          <button type="button" class="btn btn-info" id="previewDownloadLightPdfBtn" onclick="downloadPreviewLightweightPDF()"><i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)</button>
        </div>
      </div>
    </div>
  </div>
  

{% endblock content %}  

{% block extra_js %}
  <!-- chat_main.jsì™€ chat_list.js ë¡œë“œ -->
  <script src="{% static 'js/chat_list.js' %}"></script>
  <script src="{% static 'js/chat_main.js' %}"></script>
  <!-- analyze_main.js ë¡œë“œ -->
  <script src="{% static 'js/analyze_main.js' %}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // analyze_main.jsì˜ _eventBind í•¨ìˆ˜ê°€ ëª¨ë“  ì´ˆê¸°í™” ë¡œì§ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ,
      // ì—¬ê¸°ì„œ DOMContentLoaded ë¦¬ìŠ¤ë„ˆ ë‚´ì—ì„œ ì§ì ‘ ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      // PDF ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ëª¨ë‹¬ ë‚´ë¶€ì— ìˆìŒ)
      const pdfPreviewModal = document.getElementById('pdfPreviewModal');
      if (pdfPreviewModal) {
        pdfPreviewModal.addEventListener('hidden.bs.modal', function () {
          // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì´ˆê¸°í™” ë˜ëŠ” ì •ë¦¬ ì‘ì—… (í•„ìš”ì‹œ)
        });
      }
    });
  </script>
{% endblock extra_js %}