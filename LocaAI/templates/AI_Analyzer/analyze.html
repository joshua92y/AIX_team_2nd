{% extends 'base.html' %}
{% load static %}

<<<<<<< HEAD
{% block title %}ìƒê¶Œë¶„ì„ LocaAI{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/chat_styles.css' %}">
{% endblock css %}

{% block header %}
{% include 'includes/header.html' %}
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.0/marked.min.js"></script>
{% endblock header %}

{% block analyzes_list %}
<div class="container-fluid mt-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">LocaAI ìƒê¶Œë¶„ì„</h3>
    <div class="btn-group" id="navigationButtons" style="display: none;">
      <button type="button" class="btn btn-outline-secondary" onclick="backToAnalysisList()">
        <i class="fas fa-arrow-left me-1"></i>ëª©ë¡ìœ¼ë¡œ
      </button>
      <button type="button" class="btn btn-outline-primary" onclick="startNewAnalysis()">
        <i class="fas fa-plus me-1"></i>ìƒˆ ë¶„ì„
      </button>
    </div>
  </div>
  
  <div id="main-analysis-container">
    <div id="user-check-section" style="display: none">
      <div id="analysis-list-section" style="display: none">
        <h5 class="mb-3">ğŸ“Š ìµœê·¼ ë¶„ì„ ëª©ë¡</h5>
        <ul id="analysisList" class="list-group mb-3"></ul>
        <nav id="analysisPagination" aria-label="ë¶„ì„ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë„¤ì´ì…˜"></nav>
      </div>
    </div>
  </div>
</div>
{% endblock analyzes_list %}

{% block analysis_report %}
<div id="analysis-report-section" style="display: none">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-8">
        <div id="analysisReportContainer" class="card p-3"></div>
      </div>
      <div class="col-lg-4">
        <div class="chat-interface-container">
          <div class="chat-messages-area" id="chatMessagesArea"></div>
          <div id="typingIndicator" class="message-entry typing-indicator-message" style="display: none;">
            <div class="message-bubble">
              ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...
              <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
            </div>
          </div>
          <div class="chat-input-area">
            <textarea id="messageInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
            <button id="sendButton" class="btn btn-primary" type="button">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock analysis_report %}

{% block chat_history %}
<div id="analysis-chat-section" style="display: none">
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">ğŸ’¬ ê´€ë ¨ ëŒ€í™” ë‚´ìš©</h6>
            <div class="btn-group">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="exportChatBtn">
                <i class="fas fa-download me-1"></i>ë‚´ë³´ë‚´ê¸°
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm" id="addSearchBtn">
                <i class="fas fa-search me-1"></i>ê²€ìƒ‰
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="chatHistoryContainer" class="chat-messages-area"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock chat_history %}

{% block new_analysis %}
<div id="new-analysis-sequence" style="display: none">
  <!-- ì…ë ¥ í¼: ì—…ì¢…/ì£¼ì†Œ/ë©´ì /ì£¼ë¥˜ ì—¬ë¶€/ì‹œì‘ ë²„íŠ¼ -->
</div>
{% endblock new_analysis %}

{% block chatbot %}
<!-- ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ëŠ” analysis_report ì„¹ì…˜ì— í†µí•©ë¨ -->
{% endblock chatbot %}

{% block footer %}
{% csrf_token %}
<script type="application/json" id="user-info-data">{{ user_info_json|safe }}</script>
<script type="application/json" id="previous-docs-data">{{ previous_docs_json|safe }}</script>
{% endblock footer %}

{% block js %}
<script type="module" src="{% static 'js/main_service.js' %}"></script>
<script>
  // ì „ì—­ í•¨ìˆ˜ë“¤ (ëª¨ë“ˆì—ì„œ exportí•œ í•¨ìˆ˜ë“¤ì„ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ)
  document.addEventListener('DOMContentLoaded', function() {
    // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
    window.showNavigationButtons = function(show = true) {
      const navButtons = document.getElementById('navigationButtons');
      if (navButtons) {
        navButtons.style.display = show ? 'block' : 'none';
      }
    };
    
    // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    const exportChatBtn = document.getElementById('exportChatBtn');
    if (exportChatBtn) {
      exportChatBtn.addEventListener('click', function() {
        const currentSession = window.stateManager?.getStateValue('currentSession');
        if (currentSession?.id) {
          window.exportChatHistory?.(currentSession.id);
        } else {
          alert('ë‚´ë³´ë‚¼ ì±„íŒ… íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      });
    }
    
    // ì±„íŒ… íˆìŠ¤í† ë¦¬ ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
    const addSearchBtn = document.getElementById('addSearchBtn');
    if (addSearchBtn) {
      addSearchBtn.addEventListener('click', function() {
        window.addChatHistorySearch?.();
      });
    }
  });
</script>
{% endblock js %}