{% extends 'base.html' %}
{% load static %}

{% block title %}상권 분석{% endblock %}

{% block content %}


  <!-- AI Analyzer CSS 파일들 -->
  <link rel="stylesheet" href="{% static 'css/ai_analyzer/analyze-base.css' %}">
  <link rel="stylesheet" href="{% static 'css/ai_analyzer/analyze-progress.css' %}">
  <link rel="stylesheet" href="{% static 'css/ai_analyzer/analyze-chatbot.css' %}">
  <link rel="stylesheet" href="{% static 'css/ai_analyzer/analyze-pip.css' %}">

  <!-- Daum 우편번호 서비스 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <!-- jsPDF 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- 한국어 폰트 지원 -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/customfonts.js"></script>
  <!-- html2canvas 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Chart.js 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 마크다운 렌더링 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- AI Analyzer Data 로드 (최우선) -->
  <script src="{% static 'js/ai_analyzer/analyze-data.js' %}"></script>
  
  <!-- AI Analyzer Utils 로드 -->
  <script src="{% static 'js/ai_analyzer/analyze-utils.js' %}"></script>
  
  <!-- AI Analyzer Address 로드 -->
  <script src="{% static 'js/ai_analyzer/analyze-address.js' %}"></script>
  
  <!-- AI Analyzer PIP 로드 -->
  <script src="{% static 'js/ai_analyzer/analyze-pip.js' %}"></script>
  
  <!-- AI Analyzer PDF 로드 -->
  <script src="{% static 'js/ai_analyzer/analyze-pdf.js' %}"></script>
  
  <!-- AI Analyzer Chatbot 로드 -->
  <script src="{% static 'js/ai_analyzer/analyze-chatbot.js' %}"></script>
  
  <!-- AI Analyzer Explainable AI 로드 (회원용 XGBoost 설명) -->
  <script src="{% static 'js/ai_analyzer/analyze-explainable.js' %}"></script>
  
  <!-- AI Analyzer Core 로드 -->
  <script src="{% static 'js/ai_analyzer/analyze-core.js' %}"></script>

    <script>
    // Django 템플릿에서 JavaScript 변수로 사용자 인증 상태 전달
    const USER_AUTHENTICATED = {% if user.is_authenticated %}true{% else %}false{% endif %};
    const USER_ID = {% if user.is_authenticated %}'{{ user.id }}'{% else %}null{% endif %};
    const CSRF_TOKEN = '{{ csrf_token }}';
  </script>

  <script>
    window.currentAnalysisData = null;
    let currentRequestId = null;
    
    $(document).ready(function() {
      // 초기화
      $('.result-section').hide();
      $('#analysisResults').hide();
      
      // PIP 이벤트 리스너는 동적 생성 시 추가됨
    });

    $(window).on('load', function() {
      _eventBind();
    });

    // 페이지 내 이벤트 바인딩
    function _eventBind() {
      // 모듈 로드 후 챗봇 초기화 (지연 실행)
      setTimeout(function() {
        // 챗봇 초기 상태 설정
        if (typeof window.initializeChatbotState === 'function') {
          window.initializeChatbotState();
        }
        
        // WebSocket 초기화 (로그인한 사용자만)
        if (USER_AUTHENTICATED && typeof window.initializeChatSocket === 'function') {
          window.initializeChatSocket();
        }
      }, 100);
    }

    // ===========================================
    // 모든 주요 기능들은 다음 모듈들에서 로드됨:
    // - analyze-core.js: 상권분석 메인 로직
    // - analyze-chatbot.js: 챗봇 및 WebSocket  
    // - analyze-pip.js: PIP 모달 관리
    // - analyze-pdf.js: PDF 생성
    // - analyze-address.js: 주소 검색
    // - analyze-utils.js: 공통 유틸리티
    // ===========================================
    
    // 전역 변수 선언
    // ... existing code ...
  </script>

  <!-- Page Title -->
  <div class="container my-6" style="margin-top: 20px; margin-bottom: 100px; ">
    
    <!-- 상권 분석 정보 입력 -->
    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card p-4 shadow-sm">
          <h3 class="mb-3">
            <span data-lang="KOR">상권 정보입력</span>
            <span data-lang="ENG" style="display: none;">Enter Commercial Area Info</span>
            <span data-lang="ESP" style="display: none;">Ingresar Información del Área Comercial</span>
          </h3>

          <form>
            <div class="row g-3">
              <!-- 업종 선택 -->
              <div class="col-md-3">
                <label for="business_type_id" class="form-label">
                  <span data-lang="KOR">업종</span>
                  <span data-lang="ENG" style="display: none;">Industry</span>
                  <span data-lang="ESP" style="display: none;">Industria</span>
                </label>
                <select class="form-select" id="business_type_id" name="business_type_id" required>
                  <!-- 업종 옵션은 analyze-data.js에서 동적 생성 -->
                </select>
                
                <!-- 영어/스페인어 업종 선택은 analyze-data.js에서 동적 처리 -->
              </div>

              <!-- 주소 입력 -->
              <div class="col-md-3">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="x_coord" name="x_coord">
                <input type="hidden" id="y_coord" name="y_coord">
                
                <label for="address" class="form-label" data-lang="KOR">주소</label>
                <label for="address" class="form-label" data-lang="ENG" style="display: none;">Address</label>
                <label for="address" class="form-label" data-lang="ESP" style="display: none;">Dirección</label>
                
                <div class="input-group">
                  <input type="text" class="form-control lang-input" id="address" name="address" placeholder="주소를 입력해주세요" data-lang="KOR">
                  <button class="btn btn-outline-secondary lang-btn" type="button" onclick="openAddressSearch()" data-lang="KOR">검색</button>
                  
                  <input type="text" class="form-control lang-input" id="addressEng" name="address" placeholder="Please enter your address" data-lang="ENG" style="display: none;">
                  <button class="btn btn-outline-secondary lang-btn" type="button" onclick="openAddressSearch()" data-lang="ENG" style="display: none;">Search</button>
                  
                  <input type="text" class="form-control lang-input" id="addressEsp" name="address" placeholder="Por favor ingrese la dirección" data-lang="ESP" style="display: none;">
                  <button class="btn btn-outline-secondary lang-btn" type="button" onclick="openAddressSearch()" data-lang="ESP" style="display: none;">Buscar</button>
                </div>
              </div>

              <!-- 점포 면적 입력 -->
              <div class="col-md-3">
                <label for="area" class="form-label" data-lang="KOR">점포 면적 (㎡)</label>
                <label for="area" class="form-label" data-lang="ENG" style="display: none;">Store Area (㎡)</label>
                <label for="area" class="form-label" data-lang="ESP" style="display: none;">Área del local (㎡)</label>
                <input type="number" class="form-control" id="area" name="area" placeholder="예: 33.2" required>
              </div>

              <!-- 주류 판매 여부 선택 -->
              <div class="col-md-3">
                <label for="service_type" class="form-label">주류 판매 여부</label>
                <select class="form-select" id="service_type" name="service_type" required>
                  <option selected disabled>선택</option>
                  <option value="1">판매함</option>
                  <option value="0">판매 안함</option>
                </select>
              </div>
            </div>

            <!-- 버튼 -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-primary custom px-5" onclick="getFormData();">
                상권 분석하기
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>  <!-- 상권 정보 입력 카드 끝 -->

    <!-- 📁 최근 분석 결과 (로그인한 사용자만) -->
    {% if user.is_authenticated %}
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="accordion mb-4" id="analysisHistoryAccordion">
          <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="analysisHistoryHeading">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#analysisHistoryCollapse" aria-expanded="false" aria-controls="analysisHistoryCollapse">
                <i class="bi bi-person-check me-2"></i>
                <strong>
                  <span data-lang="KOR">📁 내 최근 분석 기록</span>
                  <span data-lang="ENG" style="display: none;">📁 My Recent Analyses</span>
                  <span data-lang="ESP" style="display: none;">📁 Mis análisis recientes</span>
                </strong>
                <small class="text-muted ms-2">({{ user.username }}님의 개인 기록{% if previous_docs %} - {{ previous_docs|length }}개{% endif %})</small>
              </button>
            </h2>
            <div id="analysisHistoryCollapse" class="accordion-collapse collapse" aria-labelledby="analysisHistoryHeading" data-bs-parent="#analysisHistoryAccordion">
              <div class="accordion-body">
          {% if previous_docs %}
                  <ul class="list-group list-group-flush">
              {% for doc in previous_docs %}
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                  <div>
                          <strong>분석 ID: {{ doc.request.id }}</strong>
                          <span class="badge bg-{% if doc.survival_percentage >= 80 %}success{% elif doc.survival_percentage >= 60 %}warning{% else %}danger{% endif %} ms-2">
                            {{ doc.survival_percentage|floatformat:1 }}%
                          </span>
                          <br>
                          <small class="text-muted">
                            <i class="bi bi-geo-alt me-1"></i>{{ doc.request.address|truncatechars:50 }}
                          </small><br>
                          <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>{{ doc.created_at|date:"Y-m-d H:i" }}
                            <i class="bi bi-shop ms-3 me-1"></i>{{ doc.request.business_type.name }}
                          </small>
                  </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="showPdfPreview({{ doc.request.id }})">
                          <i class="bi bi-eye me-1"></i>결과보기
                        </button>
                </li>
              {% endfor %}
            </ul>
                  {% if previous_docs|length > 5 %}
                    <div class="text-center mt-3">
                      <small class="text-muted">최근 {{ previous_docs|length }}개 기록 중 일부만 표시됩니다.</small>
                    </div>
                  {% endif %}
          {% else %}
                  <div class="text-center p-3">
                    <i class="bi bi-folder2-open text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">아직 분석 결과가 없습니다.</p>
                    <p class="text-muted small">위의 양식을 작성하여 첫 번째 상권 분석을 시작해보세요!</p>
                  </div>
          {% endif %}
        </div>
      </div>
    </div>
        </div>
      </div>
    </div>
    {% else %}
    <!-- 로그인하지 않은 사용자를 위한 안내 -->
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="card p-4 shadow-sm mb-4 border-warning">
          <h4 class="mb-3 text-warning">
            <i class="bi bi-person-x me-2"></i>개인 분석 기록
          </h4>
          <div class="text-center p-3">
            <i class="bi bi-lock text-warning" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">분석 기록을 보려면 로그인이 필요합니다.</p>
            <a href="{% url 'custom_auth:login' %}?next={{ request.get_full_path }}" class="btn btn-warning">
              <i class="bi bi-box-arrow-in-right me-1"></i>로그인하기
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  
    <!-- 본문: 분석 결과 + 챗봇 -->
    <div class="row">
      <!-- 왼쪽: 분석 리포트 -->
      <div class="col-lg-8 mb-4 analysis-container">
        <div class="card p-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">
              <span data-lang="KOR">상권 분석 결과</span>
              <span data-lang="ENG" style="display: none;">Commercial Area Analysis Result</span>
              <span data-lang="ESP" style="display: none;">Resultado del Análisis Comercial</span>
            </h4>
            <!-- 모달 버튼 -->
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#explanationModal">
              <span data-lang="KOR">상권 분석 도움말</span>
              <span data-lang="ENG" style="display: none;">Commercial Analysis Guide</span>
              <span data-lang="ESP" style="display: none;">Guía de Análisis Comercial</span>
            </button>
            
            <!-- Bootstrap 모달 -->
            <div class="modal fade" id="explanationModal" tabindex="-1" aria-labelledby="explanationModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="explanationModalLabel">
                      <span data-lang="KOR">상권 분석이란 무엇인가?</span>
                      <span data-lang="ENG" style="display: none;">What is Commercial Area Analysis?</span>
                      <span data-lang="ESP" style="display: none;">¿Qué es el Análisis de Zona Comercial?</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                  </div>
                  <div class="modal-body">
                    <div data-lang="KOR">
                      상권분석은 특정 지역 내 점포나 사업장의 경제적 환경과 소비자 특성을 체계적으로 조사하여<br>
                      사업 성공 가능성을 높이기 위한 중요한 과정입니다.<br><br>
              
                      <strong>왜 상권분석이 필요한가요?</strong><br>
                      - 상권의 소비 패턴과 유동 인구를 파악하여 효율적인 마케팅 전략을 세울 수 있습니다.<br>
                      - 경쟁 업체 현황과 고객 수요를 분석해 적절한 입지와 서비스를 결정할 수 있습니다.<br>
                      - 투자 위험을 최소화하고 안정적인 매출을 기대할 수 있습니다.<br><br>
              
                      <strong>AI 기반 상권분석은 다음을 제공합니다:</strong><br>
                      - 점포의 생존 확률 예측<br>
                      - SHAP 요인 분석<br><br>
              
                      성공적인 창업과 운영을 위해<br>
                      정확한 정보를 바탕으로 전략을 세워보세요!
                    </div>
                    
                    <div data-lang="ENG" style="display: none;">
                      Commercial area analysis is an important process that systematically investigates the economic environment and consumer characteristics of stores or businesses in a specific area to increase the chances of business success.<br><br>
              
                      <strong>Why is commercial area analysis necessary?</strong><br>
                      - You can identify consumption patterns and foot traffic in the commercial area to establish efficient marketing strategies.<br>
                      - You can analyze competitor status and customer demand to determine appropriate location and services.<br>
                      - You can minimize investment risks and expect stable sales.<br><br>
              
                      <strong>AI-based commercial area analysis provides:</strong><br>
                      - Store survival probability prediction<br>
                      - SHAP factor analysis<br><br>
              
                      For successful startup and operation,<br>
                      develop strategies based on accurate information!
                    </div>
                    
                    <div data-lang="ESP" style="display: none;">
                      El análisis de zona comercial es un proceso importante que investiga sistemáticamente el entorno económico y las características del consumidor de tiendas o negocios en un área específica para aumentar las posibilidades de éxito empresarial.<br><br>
              
                      <strong>¿Por qué es necesario el análisis de zona comercial?</strong><br>
                      - Puede identificar patrones de consumo y tráfico peatonal en la zona comercial para establecer estrategias de marketing eficientes.<br>
                      - Puede analizar el estado de la competencia y la demanda del cliente para determinar la ubicación y servicios apropiados.<br>
                      - Puede minimizar los riesgos de inversión y esperar ventas estables.<br><br>
              
                      <strong>El análisis de zona comercial basado en IA proporciona:</strong><br>
                      - Predicción de probabilidad de supervivencia de la tienda<br>
                      - Análisis de factores SHAP<br><br>
              
                      Para una startup y operación exitosa,<br>
                      ¡desarrolle estrategias basadas en información precisa!
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                      <span data-lang="KOR">닫기</span>
                      <span data-lang="ENG" style="display: none;">Close</span>
                      <span data-lang="ESP" style="display: none;">Cerrar</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 분석 대기 메시지 -->
          <div id="analysisWaiting">
            <div class="text-center p-4">
              <i class="bi bi-analytics text-muted" style="font-size: 3rem;"></i>
              <h5 class="mt-3 text-muted">상권 분석을 시작하세요</h5>
              <p class="text-muted">
                <span data-lang="KOR">
                  위의 정보를 입력하고 '상권 분석하기' 버튼을 클릭하면<br>이 영역에 분석 결과가 표시됩니다.
                </span>
                <span data-lang="ENG" style="display: none;">
                  Enter the information above and click the 'Analyze Commercial Area' button<br>to display analysis results in this area.
                </span>
                <span data-lang="ESP" style="display: none;">
                  Ingrese la información anterior y haga clic en el botón 'Analizar Zona Comercial'<br>para mostrar los resultados del análisis en esta área.
                </span>
              </p>
              <button class="btn btn-outline-secondary mt-3" disabled>
                <i class="bi bi-file-earmark-pdf me-2"></i>
                <span data-lang="KOR">PDF로 저장</span>
                <span data-lang="ENG" style="display: none;">Save as PDF</span>
                <span data-lang="ESP" style="display: none;">Guardar como PDF</span>
              </button>
            </div>
          </div>
          
          <!-- 분석 진행 상황 UI (컴포넌트 include) -->
          {% include 'AI_Analyzer/components/progress_steps.html' %}
          
          <!-- 분석 결과 내용 (초기에는 숨김) -->
          <div id="analysisResults" style="display: none;">
            
            <!-- 위치 정보 -->
            <div class="alert alert-info mb-4">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-2">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    <span id="resultAddress"></span>
                  </h5>
                  <div class="row">
                    <div class="col-md-4">
                      <strong>업종:</strong> <span id="resultBusinessType"></span>
                    </div>
                    <div class="col-md-4">
                      <strong>면적:</strong> <span id="resultArea"></span>㎡
                    </div>
                    <div class="col-md-4">
                      <strong>유형:</strong> <span id="resultServiceType"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <small class="text-muted">분석완료</small>
                </div>
              </div>
            </div>

            <!-- 핵심 지표 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-speedometer me-2"></i>
                <span data-lang="KOR">핵심 지표</span>
                <span data-lang="ENG" style="display: none;">Key Indicators</span>
                <span data-lang="ESP" style="display: none;">Indicadores Clave</span>
              </h5>
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="lifePop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">
                        <span data-lang="KOR">300m 내 생활인구</span>
                        <span data-lang="ENG" style="display: none;">Resident Pop. within 300m</span>
                        <span data-lang="ESP" style="display: none;">Pobl. Residente dentro de 300m</span>
                      </small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="workingPop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m 내 직장인구</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="competitor300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">동일업종 경쟁업체</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="totalLandValue" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">총 공시지가</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI 예측 생존 확률 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-cpu me-2"></i>AI 예측 분석
              </h5>
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="text-center">
                    <div class="display-1 fw-bold mb-3" id="survivalPercentage">-%</div>
                    <h4 class="mb-3">장기 생존 확률</h4>
                    <div class="progress" style="height: 25px;">
                      <div id="survivalBar" class="progress-bar" style="width: 0%; transition: width 0.6s ease;"></div>
                    </div>
                    <div class="mt-2">
                      <span id="survivalBarText" class="badge fs-6" style="font-size: 1rem; font-weight: 500;">분석중...</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="p-3">
                    <h6 class="mb-3">AI 분석 결과</h6>
                    <div id="survivalAnalysis" class="alert">
                      <!-- AI 분석 결과가 여기에 표시됩니다 -->
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      AI 모델이 25개 지표를 종합 분석한 결과입니다.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- 상권 경쟁 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-shop me-2"></i>상권 경쟁 분석 (300m 반경)
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-3">
                  <h6>경쟁업체 수</h6>
                  <div class="h4 text-danger" id="competitorCount">-</div>
                </div>
                <div class="col-md-3">
                  <h6>전체 요식업체</h6>
                  <div class="h4 text-info" id="adjacentBiz">-</div>
                </div>
                <div class="col-md-3">
                  <h6>경쟁업체 비율</h6>
                  <div class="h4 text-warning" id="competitorRatio">-%</div>
                </div>
                <div class="col-md-3">
                  <h6>업종 다양성</h6>
                  <div class="h4 text-success" id="businessDiversity">-</div>
                </div>
              </div>
              
              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">경쟁 강도 분석</h6>
                  <span id="competitionLevel" class="badge fs-6" style="font-size: 1.1rem; font-weight: 500;">분석중...</span>
                  </div>
                <div class="progress" style="height: 40px;">
                  <div id="competitionBar" class="progress-bar" style="width: 0%; transition: width 0.6s ease;"></div>
                </div>
                <small class="text-muted mt-2 d-block">
                  경쟁업체 비율이 20% 이하면 낮음, 20-50%는 보통, 50% 이상은 높음으로 분류됩니다.
                </small>
              </div>
            </div>

            <!-- 인구 구성 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-people me-2"></i>인구 구성 분석 (1000m 반경)
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-3">연령대별 인구 비율</h6>
                      <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="ageChart" style="max-height: 300px; max-width: 100%;"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title mb-3">연령대별 상세 정보</h6>
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FF6384;" id="age20Percent">-%</div>
                            <small class="text-muted">20대</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #36A2EB;" id="age30Percent">-%</div>
                            <small class="text-muted">30대</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FFCE56;" id="age40Percent">-%</div>
                            <small class="text-muted">40대</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #4BC0C0;" id="age50Percent">-%</div>
                            <small class="text-muted">50대</small>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #9966FF;" id="age60Percent">-%</div>
                            <small class="text-muted">60대 이상</small>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3 text-center">
                        <small class="text-muted">
                          <i class="bi bi-info-circle me-1"></i>
                          1000m 반경 내 생활인구 기준
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 외국인 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-globe me-2"></i>외국인 분석
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-airplane text-primary mb-2" style="font-size: 2rem;"></i>
                      <h6>단기체류 외국인</h6>
                      <div class="h4 text-primary" id="tempForeign1000">-</div>
                      <small class="text-muted">1000m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-house text-success mb-2" style="font-size: 2rem;"></i>
                      <h6>장기체류 외국인</h6>
                      <div class="h4 text-success" id="longForeign300">-</div>
                      <small class="text-muted">300m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-flag text-warning mb-2" style="font-size: 2rem;"></i>
                      <h6>장기체류 중국인 비율</h6>
                      <div class="h4 text-warning" id="longForeignCNRatio300">-</div>
                      <small class="text-muted">1000m 반경</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 분석 요약 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-lightbulb me-2"></i>AI 분석 요약
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">
                    <i class="bi bi-check-circle me-2"></i>강점
                  </h6>
                  <ul id="strengthsList">
                    <!-- 강점 목록이 여기에 표시됩니다 -->
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>주의사항
                  </h6>
                  <ul id="cautionsList">
                    <!-- 주의사항 목록이 여기에 표시됩니다 -->
                  </ul>
                </div>
              </div>
            </div>

            <!-- PDF 저장 버튼 -->
            <div class="text-center">
              <button id="pdfSaveBtn" class="btn btn-primary" onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>PDF로 저장
              </button>
              <div id="guestPdfMessage" style="display: none;" class="alert alert-info mt-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>비회원 제한:</strong> PDF 저장 기능은 회원만 사용할 수 있습니다. 
                <a href="{% url 'custom_auth:login' %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-primary ms-2">로그인하기</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 분석결과 챗봇 -->
      <div class="col-lg-4">
        <div class="card p-4 shadow-sm chatbot-sticky" style="height: 750px; max-height: 750px; overflow: hidden;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">분석결과 상담</h5>
            <span class="badge bg-secondary" id="chatbotStatus">대기중</span>
          </div>
          
          <!-- 챗봇 컨테이너 -->
          <div id="chatbotContainer" class="d-flex flex-column h-100">
            
            <!-- 비활성화 상태 (기본) - 간단한 안내만 -->
            <div id="chatbotInactive" class="text-center d-flex flex-column justify-content-center h-100">
              <i class="bi bi-chat-dots text-muted mb-3" style="font-size: 4rem;"></i>
              <h5 class="text-muted mb-3">분석결과 상담 AI</h5>
              {% if not user.is_authenticated %}
                <p class="text-muted mb-3">상권 분석 결과에 대해<br>AI와 상담하려면 로그인이 필요합니다.</p>
                <a href="{% url 'custom_auth:login' %}?next={{ request.get_full_path }}" class="btn btn-primary btn-sm">
                  <i class="bi bi-box-arrow-in-right me-2"></i>로그인하기
                </a>
              {% else %}
                <p class="text-muted mb-3">상권 분석을 완료하면<br>AI 상담 서비스를 이용할 수 있습니다.</p>
                <div class="d-flex align-items-center justify-content-center">
                  <i class="bi bi-lock me-2 text-secondary"></i>
                  <span class="text-secondary small">분석 완료 후 자동 활성화</span>
                </div>
              {% endif %}
          </div>

            <!-- 활성화 상태 (분석 완료 후) - 완전한 챗봇 UI -->
            <div id="chatbotActive" class="d-flex flex-column h-100" style="display: none !important;">
              
              <!-- 추천 질문 버튼 -->
              <div class="mb-3">
                <small class="text-muted">💡 추천 질문</small>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-primary me-1 mb-1" onclick="fillExampleQuestion('이 상권의 생존 확률이 높은 이유는 무엇인가요?')">
                    <i class="bi bi-graph-up me-1"></i>생존 확률
                  </button>
                  <button class="btn btn-sm btn-outline-warning me-1 mb-1" onclick="fillExampleQuestion('경쟁업체가 많은 편인가요?')">
                    <i class="bi bi-shop me-1"></i>경쟁 현황
                  </button>
                  <button class="btn btn-sm btn-outline-success me-1 mb-1" onclick="fillExampleQuestion('창업 시 주의해야 할 점은 무엇인가요?')">
                    <i class="bi bi-exclamation-triangle me-1"></i>주의사항
                  </button>
                </div>
          </div>

              <!-- 채팅 메시지 영역 -->
              <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3 border rounded p-3" style="background-color: #f8f9fa; min-height: 420px;">
                <div class="d-flex align-items-start mb-3">
                  <div class="bg-gradient bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; min-width: 36px;">
                    <i class="bi bi-robot text-white" style="font-size: 16px;"></i>
        </div>
                  <div class="flex-grow-1">
                    <div class="bg-white rounded-3 p-3 shadow-sm border">
                      <div class="d-flex align-items-center mb-2">
                        <strong class="text-primary me-2">분석결과 상담 AI</strong>
                        <span class="badge bg-success-subtle text-success">온라인</span>
                      </div>
                      <p class="mb-0">안녕하세요! 🎯 방금 완료된 상권 분석 결과에 대해 궁금한 점이 있으시면 언제든 물어보세요.<br><br>
                      <strong>상담 가능한 내용:</strong><br>
                      • 📊 AI 생존 확률 해석<br>
                      • 👥 인구 및 고객층 분석<br>
                      • 🏪 경쟁업체 현황<br>
                      • 💰 수익성 전망<br>
                      • 🚀 창업 전략 조언</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 입력 영역 -->
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">
                    <i class="bi bi-shield-check me-1"></i>
                    현재 분석 세션 결과를 기반으로 답변
                  </small>
                  <button class="btn btn-sm btn-outline-secondary" onclick="openChatbotPIP()" title="확대 보기">
                    <i class="bi bi-arrows-fullscreen"></i>
                  </button>
                </div>
                <div class="input-group">
                  <input type="text" id="chatInput" class="form-control" placeholder="분석 결과에 대해 궁금한 점을 물어보세요..." disabled>
                  <button class="btn btn-primary" id="chatSendBtn" type="button" disabled>
                    <i class="bi bi-send-fill"></i>
                  </button>
                </div>
                <div id="chatConnectionStatus" class="mt-2" style="display: none;">
                  <small class="text-primary">
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    AI 연결 중...
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF 미리보기 모달 (분석 기록용) -->
  <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfPreviewModalLabel">
            <i class="bi bi-file-earmark-pdf me-2"></i>분석 결과 미리보기
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
          <div id="previewLoading" class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">로딩 중...</span>
            </div>
            <h6>분석 결과를 불러오고 있습니다...</h6>
            <p class="text-muted">잠시만 기다려 주세요.</p>
          </div>
          
          <div id="previewError" style="display: none;" class="text-center">
            <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h6>분석 결과를 불러올 수 없습니다</h6>
            <p class="text-muted" id="previewErrorMessage">잠시 후 다시 시도해 주세요.</p>
          </div>
          
          <!-- PDF 스타일 미리보기 내용 -->
          <div id="previewContent" style="display: none; background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Nanum Gothic', Arial, sans-serif;">
            <!-- 헤더 -->
            <div class="text-center mb-4" style="border-bottom: 3px solid #1e3a8a; padding-bottom: 20px;">
              <h2 class="text-primary mb-1" style="font-weight: 800; font-size: 24px;">AI 상권분석 보고서</h2>
              <p class="text-muted mb-0" style="font-size: 14px;">인공지능 기반 상업지구 분석 결과</p>
            </div>
            
            <!-- 기본 정보 -->
            <div class="mb-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #1e3a8a;">
              <h5 class="text-primary mb-3"><i class="bi bi-geo-alt me-2"></i>분석 대상 정보</h5>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>주소:</strong> <span id="previewAddr">-</span></p>
                  <p><strong>업종:</strong> <span id="previewBizType">-</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>면적:</strong> <span id="previewAreaSize">-</span>㎡</p>
                  <p><strong>분석일시:</strong> <span id="previewAnalysisDate">-</span></p>
                </div>
              </div>
            </div>
            
            <!-- AI 생존 확률 -->
            <div class="mb-4" style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <h5 class="text-success mb-3"><i class="bi bi-robot me-2"></i>AI 생존 확률</h5>
              <div class="display-4 mb-3 text-primary" id="previewSurvivalRate" style="font-weight: 800;">-%</div>
              <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar" id="previewSurvivalProgressBar" role="progressbar" style="width: 0%"></div>
              </div>
              <p class="text-muted mb-0" id="previewSurvivalComment">분석 중...</p>
            </div>
            
            <!-- 핵심 지표 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-speedometer me-2"></i>핵심 지표</h5>
              <div class="row">
                <div class="col-md-3">
                  <div class="card border-info h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">생활인구</h6>
                      <p class="card-text fw-bold text-primary" id="previewLifePopulation">-</p>
                      <small class="text-muted">300m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-warning h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">직장인구</h6>
                      <p class="card-text fw-bold text-primary" id="previewWorkingPopulation">-</p>
                      <small class="text-muted">300m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-danger h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">경쟁업체</h6>
                      <p class="card-text fw-bold text-primary" id="previewCompetitors">-</p>
                      <small class="text-muted">300m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-secondary h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">공시지가</h6>
                      <p class="card-text fw-bold text-primary" id="previewLandPrice">-</p>
                      <small class="text-muted">총 공시지가</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 경쟁강도 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-shop me-2"></i>경쟁강도 분석</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title">경쟁업체 현황</h6>
                      <div class="row g-2 text-center">
                        <div class="col-6">
                          <div class="p-2 border rounded">
                            <div class="h5 text-danger" id="previewCompetitorCount">-</div>
                            <small class="text-muted">동일업종</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="p-2 border rounded">
                            <div class="h5 text-warning" id="previewAdjacentBiz">-</div>
                            <small class="text-muted">인접업체</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title">경쟁 강도</h6>
                      <div class="progress mb-2" style="height: 30px;">
                                                 <div id="previewCompetitionBar" class="progress-bar" style="width: 0%;"></div>
                      </div>
                      <div class="text-center">
                        <span id="previewCompetitionLevel" class="badge fs-6">분석중...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 외국인 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-globe me-2"></i>외국인 분석</h5>
              <div class="row g-3 text-center">
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-airplane text-primary mb-2" style="font-size: 1.5rem;"></i>
                      <h6>단기체류 외국인</h6>
                      <div class="h5 text-primary" id="previewTempForeign">-</div>
                      <small class="text-muted">1000m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-house text-success mb-2" style="font-size: 1.5rem;"></i>
                      <h6>장기체류 외국인</h6>
                      <div class="h5 text-success" id="previewLongForeign">-</div>
                      <small class="text-muted">300m 반경</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-flag text-warning mb-2" style="font-size: 1.5rem;"></i>
                      <h6>중국인 비율</h6>
                      <div class="h5 text-warning" id="previewChinaRatio">-</div>
                      <small class="text-muted">1000m 반경</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 연령대별 인구 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-people me-2"></i>연령대별 인구 분석 (1000m 반경)</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-3">연령대별 인구 비율</h6>
                      <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="previewAgeChart" style="max-height: 250px; max-width: 100%;"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title mb-3">연령대별 상세 정보</h6>
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FF6384;" id="previewAge20">-%</div>
                            <small class="text-muted">20대</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #36A2EB;" id="previewAge30">-%</div>
                            <small class="text-muted">30대</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FFCE56;" id="previewAge40">-%</div>
                            <small class="text-muted">40대</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #4BC0C0;" id="previewAge50">-%</div>
                            <small class="text-muted">50대</small>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #9966FF;" id="previewAge60">-%</div>
                            <small class="text-muted">60대 이상</small>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3 text-center">
                        <small class="text-muted">
                          <i class="bi bi-info-circle me-1"></i>
                          1000m 반경 내 생활인구 기준
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 강점/주의사항 -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>강점</h6>
                  </div>
                  <div class="card-body" id="previewStrengthsList">
                    <ul class="list-unstyled mb-0">
                      <li class="text-muted">분석 중...</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>주의사항</h6>
                  </div>
                  <div class="card-body" id="previewCautionsList">
                    <ul class="list-unstyled mb-0">
                      <li class="text-muted">분석 중...</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 보고서 하단 -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                본 보고서는 AI 기반 상권분석 시스템에 의해 생성되었습니다.<br>
                분석 기준일: <span id="previewReportGeneratedDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="previewDownloadPdfBtn" onclick="downloadPreviewPDF()" style="display: none;">
              <i class="bi bi-download me-2"></i>고품질 PDF (이미지)
            </button>
            <button type="button" class="btn btn-outline-primary" id="previewDownloadLightPdfBtn" onclick="downloadPreviewLightweightPDF()" style="display: none;">
              <i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF 다운로드 모달 -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel">
            <i class="bi bi-file-earmark-pdf me-2"></i>AI 상권분석 보고서 미리보기
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="pdfGenerating" style="display: none;" class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">생성 중...</span>
            </div>
            <h6>PDF 보고서를 생성하고 있습니다...</h6>
            <p class="text-muted">잠시만 기다려 주세요.</p>
          </div>
          
          <div id="pdfError" style="display: none;" class="text-center">
            <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h6>PDF 생성 중 오류가 발생했습니다</h6>
            <p class="text-muted" id="pdfErrorMessage">잠시 후 다시 시도해 주세요.</p>
          </div>
          
          <!-- PDF 미리보기 내용 -->
          <div id="pdfPreviewContainer" style="background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="text-center mb-4">
              <h2 class="text-primary mb-1" style="font-weight: 700;">AI 상권분석 보고서</h2>
              <p class="text-muted mb-0">인공지능 기반 상업지구 분석 결과</p>
              <hr class="my-3" style="border-color: #1e3a8a; border-width: 2px;">
            </div>
            
            <!-- 기본 정보 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>분석 대상 정보</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>주소:</strong> <span id="previewAddress">-</span></p>
                        <p><strong>업종:</strong> <span id="previewBusinessType">-</span></p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>면적:</strong> <span id="previewArea">-</span></p>
                        <p><strong>분석일시:</strong> <span id="previewDate">-</span></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- AI 생존 확률 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-success">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI 생존 확률</h5>
                  </div>
                  <div class="card-body text-center">
                    <div class="display-4 mb-3" id="previewSurvival">-%</div>
                    <div class="progress mb-3" style="height: 20px;">
                      <div class="progress-bar" id="previewSurvivalBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-muted mb-0" id="previewSurvivalText">분석 중...</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 핵심 지표 -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card border-info h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">생활인구</h6>
                    <p class="card-text fw-bold" id="previewLifePop">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-warning h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">직장인구</h6>
                    <p class="card-text fw-bold" id="previewWorkingPop">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-danger h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">경쟁업체</h6>
                    <p class="card-text fw-bold" id="previewCompetitor">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-secondary h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">공시지가</h6>
                    <p class="card-text fw-bold" id="previewLandValue">-</p>
                    <small class="text-muted">총 공시지가</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 경쟁강도 분석 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-warning">
                  <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-shop me-2"></i>경쟁강도 분석</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>경쟁업체 현황</h6>
                        <div class="row g-2 text-center mb-3">
                          <div class="col-6">
                            <div class="p-2 border rounded">
                              <div class="h6 text-danger" id="pdfPreviewCompetitorCount">-</div>
                              <small class="text-muted">동일업종</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="p-2 border rounded">
                              <div class="h6 text-warning" id="pdfPreviewAdjacentBiz">-</div>
                              <small class="text-muted">인접업체</small>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <h6>경쟁 강도</h6>
                        <div class="progress mb-2" style="height: 25px;">
                                                     <div id="pdfPreviewCompetitionBar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="text-center">
                          <span id="pdfPreviewCompetitionLevel" class="badge fs-6">분석중...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 외국인 분석 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-info">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-globe me-2"></i>외국인 분석</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3 text-center">
                      <div class="col-md-4">
                        <div class="p-3 border rounded">
                          <i class="bi bi-airplane text-primary mb-2" style="font-size: 1.5rem;"></i>
                          <h6>단기체류 외국인</h6>
                          <div class="h6 text-primary" id="pdfPreviewTempForeign">-</div>
                          <small class="text-muted">1000m 반경</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="p-3 border rounded">
                          <i class="bi bi-house text-success mb-2" style="font-size: 1.5rem;"></i>
                          <h6>장기체류 외국인</h6>
                          <div class="h6 text-success" id="pdfPreviewLongForeign">-</div>
                          <small class="text-muted">300m 반경</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="p-3 border rounded">
                          <i class="bi bi-flag text-warning mb-2" style="font-size: 1.5rem;"></i>
                          <h6>중국인 비율</h6>
                          <div class="h6 text-warning" id="pdfPreviewChinaRatio">-</div>
                          <small class="text-muted">1000m 반경</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 연령대별 인구 분석 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-secondary">
                  <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>연령대별 인구 분석 (1000m 반경)</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-2 text-center">
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-danger" id="pdfPreviewAge20">-%</div>
                          <small class="text-muted">20대</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-primary" id="pdfPreviewAge30">-%</div>
                          <small class="text-muted">30대</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-warning" id="pdfPreviewAge40">-%</div>
                          <small class="text-muted">40대</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-info" id="pdfPreviewAge50">-%</div>
                          <small class="text-muted">50대</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-secondary" id="pdfPreviewAge60">-%</div>
                          <small class="text-muted">60대+</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 강점/주의사항 -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>강점</h6>
                  </div>
                  <div class="card-body" id="previewStrengths">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>주의사항</h6>
                  </div>
                  <div class="card-body" id="previewCautions">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 보고서 하단 -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                본 보고서는 AI 기반 상권분석 시스템에 의해 생성되었습니다.<br>
                분석 기준일: <span id="previewReportDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="downloadPdfBtn" onclick="downloadPDF()">
              <i class="bi bi-download me-2"></i>고품질 PDF (이미지)
            </button>
            <button type="button" class="btn btn-outline-primary" id="downloadLightPdfBtn" onclick="downloadLightweightPDF()">
              <i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)
            </button>
          </div>
          <button type="button" class="btn btn-primary" id="retryPdfBtn" onclick="downloadPDF()" style="display: none;">
            <i class="bi bi-arrow-clockwise me-2"></i>다시 시도
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 주소 검색 PIP 팝업 모달 -->
  <div id="addressSearchModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; pointer-events: none;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
      <!-- 모달 헤더 -->
      <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; background: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h5 style="margin: 0; color: #333;">
          <i class="bi bi-search me-2"></i>주소 검색
          <button onclick="closeAddressSearch()" style="float: right; background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; margin-left: 20px;">&times;</button>
        </h5>
      </div>
      
      <!-- 주소 검색 컨테이너 -->
      <div id="addressSearchContainer" style="width: 90%; max-width: 600px; height: 80%; max-height: 500px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin-top: 60px; z-index: 10002; position: relative; pointer-events: auto;"></div>
      
      <!-- 닫기 버튼 (배경 클릭) -->
      <div onclick="closeAddressSearch()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; display: none;"></div>
    </div>
  </div>

  <!-- 챗봇 PIP 확대 모달 (동적 생성) -->
  
{% endblock %}  