{% extends 'base.html' %}
{% load static %}

{% block title %}ìƒê¶Œ ë¶„ì„{% endblock %}

{% block content %}
{% include 'includes/header.html' %}



  <style>
    /* ê¸°ë³¸ primary ë²„íŠ¼ disabled ì‹œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .btn-primary.custom {
      color: #fff;
      background-color: #0d6efd; /* ì›ë˜ primary ìƒ‰ */
      opacity: 0.65;  /* íˆ¬ëª…ë„ ì¡°ì ˆë¡œ íë¦¿í•˜ê²Œ í‘œì‹œ */
    }
    
    /* Progress Bar ê°•í™” CSS - ì™„ì „íˆ ì±„ì›Œì§€ë„ë¡ */
    .progress-bar {
      height: 100% !important;
      min-height: 100% !important;
      max-height: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: inherit !important;
      line-height: 1 !important;
      box-sizing: border-box !important;
    }
    
    .progress-bar span {
      line-height: 1 !important;
      white-space: nowrap !important;
      color: white !important;
      font-weight: 500 !important;
    }
    
    /* Progress ì»¨í…Œì´ë„ˆ ì„¤ì • */
    .progress {
      overflow: hidden !important;
      border-radius: 8px !important;
      background-color: #e9ecef !important;
    }
    
    /* ë¶„ì„ ì§„í–‰ ìƒí™© ìŠ¤íƒ€ì¼ */
    .analysis-progress {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      margin-top: 1rem;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .progress-step.active {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .progress-step.completed {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #22c55e;
    }
    
    .progress-step.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }
    
    .progress-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
    }
    
    .progress-step.active .progress-icon {
      background: #667eea;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .progress-step.completed .progress-icon {
      background: #22c55e;
      color: white;
    }
    
    .progress-step.error .progress-icon {
      background: #ef4444;
      color: white;
    }
    
    .progress-step:not(.active):not(.completed):not(.error) .progress-icon {
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .progress-text {
      flex: 1;
    }
    
    .progress-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .progress-detail {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .overall-progress {
      margin-bottom: 1.5rem;
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* ê³µì‹œì§€ê°€ ì¹´ë“œ í°íŠ¸ í¬ê¸° ì¡°ì • */
    #totalLandValue {
      font-size: 1.8rem !important;
      line-height: 1.2;
    }
    
    @media (max-width: 768px) {
      #totalLandValue {
        font-size: 1.5rem !important;
      }
    }
    
    /* ì±—ë´‡ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
    #chatMessages .bg-white h1,
    #chatMessages .bg-white h2,
    #chatMessages .bg-white h3,
    #chatMessages .bg-white h4,
    #chatMessages .bg-white h5,
    #chatMessages .bg-white h6 {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #1e3a8a;
    }
    
    #chatMessages .bg-white p {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }
    
    #chatMessages .bg-white ul,
    #chatMessages .bg-white ol {
      margin-bottom: 0.5rem;
      padding-left: 1.2rem;
    }
    
    #chatMessages .bg-white li {
      margin-bottom: 0.2rem;
    }
    
    #chatMessages .bg-white strong {
      font-weight: 600;
      color: #1e40af;
    }
    
    #chatMessages .bg-white code {
      background-color: #f1f5f9;
      padding: 0.1rem 0.3rem;
      border-radius: 0.25rem;
      font-size: 0.85em;
      color: #dc2626;
    }
    
    /* PIP ì±„íŒ… íˆìŠ¤í† ë¦¬ hover íš¨ê³¼ */
    .hover-bg-light:hover {
      background-color: #f8f9fa !important;
      cursor: pointer;
    }
    
    .cursor-pointer {
      cursor: pointer;
    }
    
    /* PIP ì±„íŒ… íˆìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ */
    .chat-history-item .hover-effect {
      transition: all 0.2s ease-in-out;
    }
    
    .chat-history-item:hover .hover-effect:not(.bg-primary) {
      background-color: #e9ecef !important;
      transform: translateX(2px);
    }
    
    .chat-history-item.active .hover-effect {
      box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
    }

    #chatMessages .bg-white pre {
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
    }
    
    /* ë¶„ì„ê²°ê³¼ ìƒë‹´ ì„¹ì…˜ sticky ìŠ¤íƒ€ì¼ */
    .chatbot-sticky {
      position: sticky;
      top: 20px;
      z-index: 100;
      transition: all 0.3s ease;
    }
    
    /* ìƒê¶Œë¶„ì„ê²°ê³¼ ì„¹ì…˜ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .analysis-container {
      position: relative;
    }
    
    /* ë°˜ì‘í˜• ë””ìì¸ - ëª¨ë°”ì¼ì—ì„œëŠ” sticky ë¹„í™œì„±í™” */
    @media (max-width: 991.98px) {
      .chatbot-sticky {
        position: static;
        top: auto;
        z-index: auto;
      }
    }
    
    #chatMessages .bg-white pre {
      border-radius: 0.5rem;
      padding: 0.75rem;
      overflow-x: auto;
      margin: 0.5rem 0;
    }
    
    #chatMessages .bg-white blockquote {
      border-left: 4px solid #3b82f6;
      background-color: #f8fafc;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      font-style: italic;
      color: #475569;
    }
  </style>

  <!-- Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- í•œêµ­ì–´ í°íŠ¸ ì§€ì› -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/customfonts.js"></script>
  <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // Django í…œí”Œë¦¿ì—ì„œ JavaScript ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ ì „ë‹¬
    const USER_AUTHENTICATED = {% if user.is_authenticated %}true{% else %}false{% endif %};
    const USER_ID = {% if user.is_authenticated %}'{{ user.id }}'{% else %}null{% endif %};
    const CSRF_TOKEN = '{{ csrf_token }}';
  </script>

  <script>
    let currentAnalysisData = null;
    let currentRequestId = null;
    let currentSessionId = null;
    let chatSocket = null;
    let currentBotMessageElement = null;
    
    $(document).ready(function() {
      // ì´ˆê¸°í™”
      $('.result-section').hide();
      $('#analysisResults').hide();
      
      // WebSocket ì´ˆê¸°í™” (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ)
      if (USER_AUTHENTICATED) {
        initializeChatSocket();
      }

             // PIP ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ë™ì  ìƒì„± ì‹œ ì¶”ê°€ë¨
     });
     
     // WebSocket ì´ˆê¸°í™”
    function initializeChatSocket() {
      if (USER_AUTHENTICATED) {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/chatbot/`;
        
        // WebSocket ì—°ê²° ì‹œë„
        document.getElementById('chatConnectionStatus').style.display = 'block';
        
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function(e) {
          // WebSocket ì—°ê²° ì™„ë£Œ
          document.getElementById('chatConnectionStatus').style.display = 'none';
          document.getElementById('chatbotStatus').textContent = 'ì—°ê²°ë¨';
          document.getElementById('chatbotStatus').className = 'badge bg-success';
        };
        
        chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          // ì±—ë´‡ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
          
          if (data.chunk) {
            // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
            appendToCurrentBotMessage(data.chunk);
          } else if (data.done) {
            // ì‘ë‹µ ì™„ë£Œ
            finalizeBotMessage();
            if (data.session_id) {
              currentSessionId = data.session_id;
            }
          } else if (data.error) {
            // ì˜¤ë¥˜ ì²˜ë¦¬
            addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
          }
        };
        
        chatSocket.onclose = function(e) {
          // WebSocket ì—°ê²° ì¢…ë£Œ
          document.getElementById('chatbotStatus').textContent = 'ì—°ê²°ëŠê¹€';
          document.getElementById('chatbotStatus').className = 'badge bg-warning';
        };
        
        chatSocket.onerror = function(e) {
          console.error('ì±—ë´‡ WebSocket ì˜¤ë¥˜:', e);
          document.getElementById('chatbotStatus').textContent = 'ì˜¤ë¥˜';
          document.getElementById('chatbotStatus').className = 'badge bg-danger';
        };
      }
    }

    $(window).on('load', function() {
      _eventBind();
    });

    // í˜ì´ì§€ ë‚´ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function _eventBind() {

      
      // ì±—ë´‡ ì´ˆê¸° ìƒíƒœ ì„¤ì •
      initializeChatbotState();
    }
    
    // ì±—ë´‡ ì´ˆê¸° ìƒíƒœ ì„¤ì •
    function initializeChatbotState() {
      // í˜ì´ì§€ ë¡œë“œ ì‹œ í•­ìƒ ë¹„í™œì„±í™” ìƒíƒœë¡œ ì‹œì‘
      const inactiveElement = document.getElementById('chatbotInactive');
      const activeElement = document.getElementById('chatbotActive');
      
      // ë¹„í™œì„±í™” ìƒíƒœ í‘œì‹œ
      if (inactiveElement) {
        inactiveElement.style.setProperty('display', 'flex', 'important');
        inactiveElement.style.visibility = 'visible';
        inactiveElement.style.height = 'auto';
      }
      
      // í™œì„±í™” ìƒíƒœ ìˆ¨ê¸°ê¸°
      if (activeElement) {
        activeElement.style.setProperty('display', 'none', 'important');
        activeElement.style.visibility = 'hidden';
        activeElement.style.height = '0';
        activeElement.style.overflow = 'hidden';
      }
      
      document.getElementById('chatbotStatus').textContent = 'ëŒ€ê¸°ì¤‘';
      document.getElementById('chatbotStatus').className = 'badge bg-secondary';
      

    }

    // Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ PIP íŒì—… ì—´ê¸°
    function openAddressSearch() {
      new daum.Postcode({
        oncomplete: function(data) {
          // íŒì—…ì—ì„œ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œ

          
          // ê¸°ë³¸ ì£¼ì†Œ ì •ë³´
          let fullAddr = '';
          let extraAddr = '';
          
          // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
          if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œ
            fullAddr = data.roadAddress;
          } else { // ì§€ë²ˆ ì£¼ì†Œ
            fullAddr = data.jibunAddress;
          }
          
          // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€í•œë‹¤.
          if(data.buildingName !== '' && data.apartment === 'Y'){
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          // í‘œì‹œí•  ì°¸ê³ í•­ëª©ì´ ìˆì„ ê²½ìš°, ê´„í˜¸ê¹Œì§€ ì¶”ê°€í•œ ìµœì¢… ë¬¸ìì—´ì„ ë§Œë“ ë‹¤.
          if(extraAddr !== ''){
            extraAddr = ' (' + extraAddr + ')';
          }
          
          // ìµœì¢… ì£¼ì†Œ
          const finalAddress = fullAddr + extraAddr;
          
          // ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  íŒì—… ì¦‰ì‹œ ë‹«ê¸° (UX ê°œì„ )
          document.getElementById('address').value = finalAddress;
          closeAddressSearch();
          
          // ê¸°ì¡´ AI_Analyzerì˜ ì¢Œí‘œ ë³€í™˜ API ì‚¬ìš©
          const csrfToken = '{{ csrf_token }}';
          
          $.ajax({
            url: '/ai_analyzer/get-coordinates/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              address: fullAddr
            }),
            headers: {
              'X-CSRFToken': csrfToken
            },
            success: function(response) {
              if (response.success) {
                // ì¢Œí‘œ ì„¤ì • ì„±ê³µ
                document.getElementById('latitude').value = response.latitude.toFixed(6);
                document.getElementById('longitude').value = response.longitude.toFixed(6);
                document.getElementById('x_coord').value = response.x_coord.toFixed(2);
                document.getElementById('y_coord').value = response.y_coord.toFixed(2);
                

                
                // ì„±ê³µ ë©”ì‹œì§€ë¥¼ ë” ë¶€ë“œëŸ½ê²Œ í‘œì‹œ
                showSuccessMessage("ì£¼ì†Œì™€ ì¢Œí‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } else {
                console.error("ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨:", response.error);
                alert("ì¢Œí‘œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + response.error);
              }
            },
            error: function(xhr, status, error) {
              console.error("ì¢Œí‘œ ë³€í™˜ ìš”ì²­ ì‹¤íŒ¨:", error);
              console.error("ì‘ë‹µ:", xhr.responseText);
              alert("ì¢Œí‘œ ë³€í™˜ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
        },
        onclose: function(state) {
          // ì£¼ì†Œ ê²€ìƒ‰ ì°½ì´ ë‹«í ë•Œ ì‹¤í–‰ë˜ëŠ” ì½œë°±
  
        },
        // PIP íŒì—… ì„¤ì • (í˜ì´ì§€ ë‚´ íŒì—…)
        width: '100%',
        height: '100%',
        theme: {
          searchBgColor: "#0d6efd", // ê²€ìƒ‰ì°½ ë°°ê²½ìƒ‰
          queryTextColor: "#FFFFFF" // ê²€ìƒ‰ì°½ ê¸€ììƒ‰  
        }
      }).embed(document.getElementById('addressSearchContainer'));
      
      // PIP íŒì—… ì»¨í…Œì´ë„ˆ í‘œì‹œ
      const addressModal = document.getElementById('addressSearchModal');
      addressModal.style.display = 'block';
      addressModal.style.pointerEvents = 'auto';
      
      // ë‹«ê¸° ì˜¤ë²„ë ˆì´ í™œì„±í™”
      const closeOverlay = addressModal.querySelector('div[onclick="closeAddressSearch()"]');
      if (closeOverlay) {
        closeOverlay.style.display = 'block';
        closeOverlay.style.pointerEvents = 'auto';
      }
      
      document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
    }
    
    // ì£¼ì†Œ ê²€ìƒ‰ íŒì—… ë‹«ê¸° (ì•ˆì „í•œ DOM ìš”ì†Œ ì œê±° í¬í•¨)
    function closeAddressSearch() {
      try {
        const addressModal = document.getElementById('addressSearchModal');
        if (addressModal) {
          addressModal.style.display = 'none';
          addressModal.style.pointerEvents = 'none';
          
          // ë‹«ê¸° ì˜¤ë²„ë ˆì´ ë¹„í™œì„±í™”
          const closeOverlay = addressModal.querySelector('div[onclick="closeAddressSearch()"]');
          if (closeOverlay) {
            closeOverlay.style.display = 'none';
            closeOverlay.style.pointerEvents = 'none';
          }
        }
        
        // ìŠ¤í¬ë¡¤ ë³µì›
        document.body.style.overflow = 'auto';
        
        // ë‹¤ìŒ ì£¼ì†Œ API ì»¨í…Œì´ë„ˆ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
        const container = document.getElementById('addressSearchContainer');
        if (container) {
          // ê¸°ì¡´ ë‹¤ìŒ ì£¼ì†Œ API iframeì´ë‚˜ ìš”ì†Œë“¤ì„ ì•ˆì „í•˜ê²Œ ì œê±°
          const children = [...container.children];
          children.forEach(child => {
            try {
              if (child.parentNode === container) {
                container.removeChild(child);
              }
            } catch (e) {
              // removeChild ì˜¤ë¥˜ ë¬´ì‹œ
              console.warn('ì£¼ì†Œ ê²€ìƒ‰ ìš”ì†Œ ì œê±° ì¤‘ ë¬´ì‹œëœ ì˜¤ë¥˜:', e.message);
            }
          });
          
          // innerHTMLë¡œ ì™„ì „íˆ ì´ˆê¸°í™”
          container.innerHTML = '';
        }
      } catch (error) {
        console.warn('ì£¼ì†Œ ê²€ìƒ‰ íŒì—… ë‹«ê¸° ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨):', error.message);
        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ë™ì‘ì€ ìˆ˜í–‰
        document.body.style.overflow = 'auto';
      }
    }
    
    // ì£¼ì†Œ ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
    document.addEventListener('DOMContentLoaded', function() {
      const addressContainer = document.getElementById('addressSearchContainer');
      if (addressContainer) {
        addressContainer.addEventListener('click', function(e) {
          e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
        });
      }
      
      // ëª¨ë“  ëª¨ë‹¬ ì´ˆê¸°í™” í™•ì¸
      const addressModal = document.getElementById('addressSearchModal');
      if (addressModal) {
        addressModal.style.display = 'none';
        addressModal.style.pointerEvents = 'none';
      }
      

      
    });
    
    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showSuccessMessage(message) {
      // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
      const existingMessage = document.getElementById('successMessage');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // ì„±ê³µ ë©”ì‹œì§€ ìƒì„±
      const messageDiv = document.createElement('div');
      messageDiv.id = 'successMessage';
      messageDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
      messageDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      messageDiv.innerHTML = `
        <i class="bi bi-check-circle me-2"></i>${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
      `;
      
      document.body.appendChild(messageDiv);
      
      // 3ì´ˆ í›„ ìë™ ì œê±°
      setTimeout(() => {
        if (messageDiv.parentElement) {
          messageDiv.remove();
        }
      }, 3000);
    }

    // ===========================================
    // ë¶„ì„ê²°ê³¼ ì±—ë´‡ ê´€ë ¨ ê¸°ëŠ¥
    // ===========================================
    
    // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !chatSocket) return;
      
      // ìƒˆë¡œìš´ ì„¸ì…˜ì´ í•„ìš”í•œ ê²½ìš° ìƒì„±
      if (!currentSessionId) {
        try {
          await createNewChatSession();
        } catch (error) {
          console.error('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
          addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì±„íŒ… ì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
      }
      
      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      addUserMessage(message);
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      input.value = '';
      
      // ë¶„ì„ ë°ì´í„°ë¥¼ í¬í•¨í•œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
      const contextualMessage = createContextualMessage(message);
      
      // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
      chatSocket.send(JSON.stringify({
        user_id: USER_ID,
        session_id: currentSessionId,
        question: contextualMessage,
        collection: 'analysis_result_consultation'
      }));
      
      // ë´‡ ì‘ë‹µ ì¤€ë¹„
      prepareBotMessage();
    }

    // ìƒˆë¡œìš´ ì±„íŒ… ì„¸ì…˜ ìƒì„±
    async function createNewChatSession() {
      const userId = USER_ID;
      if (!userId || userId === 'None') {
        throw new Error('ì‚¬ìš©ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤');
      }

      // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
      const csrfToken = getCsrfToken();
      
      try {
        const response = await fetch(`/chatbot/sessions/${userId}/create/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({})
        });

        console.log('ì„¸ì…˜ ìƒì„± ì‘ë‹µ ìƒíƒœ:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨ ì‘ë‹µ:', errorText);
          throw new Error(`ì„¸ì…˜ ìƒì„± ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('ì„¸ì…˜ ìƒì„± ì‘ë‹µ ë°ì´í„°:', data);
        
        if (data.status !== 'ok' || !data.session_id) {
          throw new Error('ì„¸ì…˜ ìƒì„± ì‘ë‹µ ì˜¤ë¥˜: ' + JSON.stringify(data));
        }

        currentSessionId = data.session_id;
        console.log('ìƒˆë¡œìš´ ì±„íŒ… ì„¸ì…˜ ìƒì„±ë¨:', currentSessionId);
        
        // PIP íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
        setTimeout(() => {
          updatePIPChatHistory();
        }, 100);
        
      } catch (error) {
        console.error('ì„¸ì…˜ ìƒì„± ìƒì„¸ ì˜¤ë¥˜:', error);
        throw error;
      }
    }

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getCsrfToken() {
      // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ CSRF í† í° ì‹œë„
      let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
      
      if (!token) {
        // ì¿ í‚¤ì—ì„œ ì‹œë„
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'csrftoken') {
            token = value;
            break;
          }
        }
      }
      
      if (!token) {
        // Django í…œí”Œë¦¿ ë³€ìˆ˜ì—ì„œ ì‹œë„
        token = '{{ csrf_token }}';
      }
      
      console.log('CSRF í† í°:', token ? 'ì¡´ì¬í•¨' : 'ì—†ìŒ');
      return token || '';
    }
    
    // ë¶„ì„ ë°ì´í„°ë¥¼ í¬í•¨í•œ ì»¨í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒì„±
    function createContextualMessage(userMessage) {
      if (!currentAnalysisData) return userMessage;
      
      const context = `
ë‹¤ìŒì€ ë°©ê¸ˆ ì™„ë£Œëœ ìƒê¶Œ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:

**ê¸°ë³¸ ì •ë³´:**
- ì£¼ì†Œ: ${currentAnalysisData.request?.address || 'ì •ë³´ ì—†ìŒ'}
- ì—…ì¢…: ${currentAnalysisData.request?.business_type?.name || 'ì •ë³´ ì—†ìŒ'}
- ë©´ì : ${currentAnalysisData.request?.area || 'ì •ë³´ ì—†ìŒ'}ã¡

**AI ìƒì¡´ í™•ë¥ :** ${currentAnalysisData.result?.survival_percentage || 'ì •ë³´ ì—†ìŒ'}%

**í•µì‹¬ ì§€í‘œ:**
- ìƒí™œì¸êµ¬ (300m): ${Math.round(currentAnalysisData.result?.life_pop_300m || 0).toLocaleString()}ëª…
- ì§ì¥ì¸êµ¬ (300m): ${Math.round(currentAnalysisData.result?.working_pop_300m || 0).toLocaleString()}ëª…
- ê²½ìŸì—…ì²´ (300m): ${currentAnalysisData.result?.competitor_300m || 0}ê°œ
- ê³µì‹œì§€ê°€: ${formatLandValue(currentAnalysisData.result?.total_land_value || 0)}

**ê²½ìŸê°•ë„ ë¶„ì„:**
- ê²½ìŸì—…ì²´ ë¹„ìœ¨: ${(currentAnalysisData.result?.competitor_ratio_300m || 0).toFixed(1)}%
- ì—…ì¢… ë‹¤ì–‘ì„±: ${(currentAnalysisData.result?.business_diversity_300m || 0).toFixed(2)}

**ì™¸êµ­ì¸ ë¶„ì„:**
- ë‹¨ê¸°ì²´ë¥˜ ì™¸êµ­ì¸: ${Math.round(currentAnalysisData.result?.['2A_Temp_Total'] || 0).toLocaleString()}ëª…
- ì¥ê¸°ì²´ë¥˜ ì™¸êµ­ì¸: ${Math.round(currentAnalysisData.result?.['1A_Long_Total'] || 0).toLocaleString()}ëª…
- ì¤‘êµ­ì¸ ë¹„ìœ¨: ${(currentAnalysisData.result?.['2A_Long_CN'] || 0).toFixed(1)}%

**ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ (1000m ë°˜ê²½):**
- 20ëŒ€: ${(currentAnalysisData.result?.['2A_20'] || 0).toFixed(1)}%
- 30ëŒ€: ${(currentAnalysisData.result?.['2A_30'] || 0).toFixed(1)}%
- 40ëŒ€: ${(currentAnalysisData.result?.['2A_40'] || 0).toFixed(1)}%
- 50ëŒ€: ${(currentAnalysisData.result?.['2A_50'] || 0).toFixed(1)}%
- 60ëŒ€+: ${(currentAnalysisData.result?.['2A_60'] || 0).toFixed(1)}%

ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”: ${userMessage}
      `;
      
      return context;
    }
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    function addUserMessage(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'd-flex align-items-start mb-3 justify-content-end';
      messageDiv.innerHTML = `
        <div class="flex-grow-1 text-end me-2">
          <div class="bg-primary text-white rounded p-2 shadow-sm d-inline-block" style="max-width: 80%;">
            <p class="mb-0 small">${escapeHtml(message)}</p>
          </div>
        </div>
        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; min-width: 32px;">
          <i class="bi bi-person text-white" style="font-size: 14px;"></i>
        </div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // ë´‡ ì‘ë‹µ ì¤€ë¹„
    function prepareBotMessage() {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'd-flex align-items-start mb-3';
      messageDiv.id = 'currentBotMessage';
      messageDiv.innerHTML = `
        <div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; min-width: 32px;">
          <i class="bi bi-robot text-white" style="font-size: 14px;"></i>
        </div>
        <div class="flex-grow-1">
          <div class="bg-white rounded p-2 shadow-sm">
            <small class="text-muted d-block mb-1">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</small>
            <p class="mb-0 small" id="botMessageContent">
              <span class="spinner-border spinner-border-sm me-1" role="status"></span>
              ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </p>
          </div>
        </div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // ë´‡ ë©”ì‹œì§€ì— ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ ì¶”ê°€
    function appendToCurrentBotMessage(chunk) {
      const contentElement = document.getElementById('botMessageContent');
      const pipContentElement = document.getElementById('pipBotMessageContent');
      
      if (contentElement) {
        if (contentElement.innerHTML.includes('spinner-border')) {
          // ì²« ë²ˆì§¸ ì²­í¬: ìŠ¤í”¼ë„ˆ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ ì‹œì‘
          currentBotMessageText = chunk;
          contentElement.innerHTML = marked.parse(chunk);
        } else {
          // í›„ì† ì²­í¬: ê¸°ì¡´ í…ìŠ¤íŠ¸ì— ì¶”ê°€
          currentBotMessageText += chunk;
          contentElement.innerHTML = marked.parse(currentBotMessageText);
        }
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
      }

      // PIPë„ ë™ì‹œì— ì—…ë°ì´íŠ¸
      if (pipContentElement) {
        if (pipContentElement.innerHTML.includes('spinner-border')) {
          pipContentElement.innerHTML = marked.parse(chunk);
        } else {
          pipContentElement.innerHTML = marked.parse(currentBotMessageText);
        }
        document.getElementById('pipChatMessages').scrollTop = document.getElementById('pipChatMessages').scrollHeight;
      }
    }
    
    // ë´‡ ë©”ì‹œì§€ ì™„ë£Œ ì²˜ë¦¬
    function finalizeBotMessage() {
      const currentMessage = document.getElementById('currentBotMessage');
      const currentPIPMessage = document.getElementById('currentPIPBotMessage');
      
      if (currentMessage) {
        currentMessage.removeAttribute('id');
      }
      if (currentPIPMessage) {
        currentPIPMessage.removeAttribute('id');
      }
      // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
      currentBotMessageText = '';
      
      // PIP íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
      setTimeout(() => {
        updatePIPChatHistory();
      }, 100);
    }
    
    // ë´‡ ë©”ì‹œì§€ ì¶”ê°€ (ì˜¤ë¥˜ ë“±)
    function addBotMessage(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'd-flex align-items-start mb-3';
      messageDiv.innerHTML = `
        <div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; min-width: 32px;">
          <i class="bi bi-robot text-white" style="font-size: 14px;"></i>
        </div>
        <div class="flex-grow-1">
          <div class="bg-white rounded p-2 shadow-sm">
            <small class="text-muted d-block mb-1">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</small>
            <div class="mb-0 small">${marked.parse(message)}</div>
          </div>
        </div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // ì¶”ì²œ ì§ˆë¬¸ ì…ë ¥
    function fillExampleQuestion(question) {
      document.getElementById('chatInput').value = question;
      document.getElementById('chatInput').focus();
    }

    // PIP ì˜ˆì‹œ ì§ˆë¬¸ ì…ë ¥ í•¨ìˆ˜
    function fillPIPExampleQuestion(question) {
      const pipChatInput = document.getElementById('pipChatInput');
      if (pipChatInput) {
        pipChatInput.value = question;
        pipChatInput.focus();
      }
    }

    // ì±—ë´‡ PIP ì—´ê¸°
    function openChatbotPIP() {
      // ê¸°ì¡´ PIP ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
      const existingModal = document.getElementById('chatbotPIPModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // ìƒˆë¡œìš´ PIP ëª¨ë‹¬ ìƒì„±
      const pipModal = document.createElement('div');
      pipModal.id = 'chatbotPIPModal';
      pipModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        z-index: 10003;
        pointer-events: auto;
        display: block;
      `;
      
      pipModal.innerHTML = `
        <div class="d-flex flex-column h-100">
          <!-- PIP í—¤ë” -->
          <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="bg-gradient bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="bi bi-robot text-white" style="font-size: 18px;"></i>
              </div>
              <div>
                <h5 class="mb-0 text-primary">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</h5>
                <small class="text-muted">í˜„ì¬ ë¶„ì„ ì„¸ì…˜ ê¸°ë°˜ ìƒë‹´</small>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="badge bg-success-subtle text-success me-3">ì˜¨ë¼ì¸</span>
              <button class="btn btn-outline-secondary btn-sm me-2" onclick="minimizeChatbotPIP()" title="ìµœì†Œí™”">
                <i class="bi bi-dash-lg"></i>
              </button>
              <button class="btn btn-outline-danger btn-sm" onclick="closeChatbotPIP()" title="ë‹«ê¸°">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <!-- PIP ì±„íŒ… ì˜ì—­ -->
          <div class="flex-grow-1 bg-light d-flex">
            <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ ì‚¬ì´ë“œë°” -->
            <div class="bg-white border-end" style="width: 280px; min-width: 280px;">
              <div class="p-3 border-bottom">
                <h6 class="mb-0 text-primary">
                  <i class="bi bi-chat-dots me-2"></i>ì±„íŒ… íˆìŠ¤í† ë¦¬
                </h6>
              </div>
              <div class="p-2" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <div id="pipChatHistory">
                  <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-chat-square-dots" style="font-size: 2rem;"></i>
                    <p class="small mt-2 mb-0">ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
            <div class="flex-grow-1 d-flex flex-column">
              <div id="pipChatMessages" class="flex-grow-1 overflow-auto p-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); max-height: calc(100vh - 200px); min-height: 400px;"></div>

              <!-- PIP ì…ë ¥ ì˜ì—­ -->
              <div class="bg-white border-top p-4">
                <div class="input-group">
                  <input type="text" id="pipChatInput" class="form-control" placeholder="ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...">
                  <button class="btn btn-primary" id="pipChatSendBtn" type="button">
                    <i class="bi bi-send-fill me-1"></i>ì „ì†¡
                  </button>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <small class="text-muted">
                    <i class="bi bi-shield-check me-1"></i>
                    í˜„ì¬ ë¶„ì„ ì„¸ì…˜ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€
                  </small>
                  <div id="pipChatConnectionStatus" style="display: none;">
                    <small class="text-primary">
                      <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                      AI ì—°ê²° ì¤‘...
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” (ë¶„ì„ ìš”ì•½) -->
            <div class="bg-white border-start" style="width: 350px; min-width: 350px;">
              <div class="p-3 border-bottom">
                <h6 class="mb-0 text-primary">
                  <i class="bi bi-graph-up me-2"></i>ë¶„ì„ ìš”ì•½
                </h6>
              </div>
              <div class="p-3" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <!-- ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ -->
                <div class="mb-4">
                  <h6 class="text-primary mb-3">ğŸ’¡ ì¶”ì²œ ì§ˆë¬¸</h6>
                  <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="fillPIPExampleQuestion('ì´ ìƒê¶Œì˜ ìƒì¡´ í™•ë¥ ì´ ë†’ì€ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?')">
                      <i class="bi bi-graph-up me-2"></i>ìƒì¡´ í™•ë¥ 
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="fillPIPExampleQuestion('ê²½ìŸì—…ì²´ê°€ ë§ì€ í¸ì¸ê°€ìš”?')">
                      <i class="bi bi-shop me-2"></i>ê²½ìŸ í˜„í™©
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="fillPIPExampleQuestion('ì°½ì—… ì‹œ ì£¼ì˜í•´ì•¼ í•  ì ì€ ë¬´ì—‡ì¸ê°€ìš”?')">
                      <i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­
                    </button>
                  </div>
                </div>
                
                <div id="pipAnalysisSummary">
                  <!-- ë¶„ì„ ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // DOMì— ì¶”ê°€
      document.body.appendChild(pipModal);
      
      // ê¸°ì¡´ ì±„íŒ… ë©”ì‹œì§€ ë³µì‚¬
      const chatMessages = document.getElementById('chatMessages');
      const pipChatMessages = document.getElementById('pipChatMessages');
      if (chatMessages && pipChatMessages) {
        pipChatMessages.innerHTML = chatMessages.innerHTML;
      }
      
      // ì±„íŒ… íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
      updatePIPChatHistory();
      
      // ë¶„ì„ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      updatePIPAnalysisSummary();
      
      // PIP ì…ë ¥ í•„ë“œ ìƒíƒœ ë™ê¸°í™”
      const chatInput = document.getElementById('chatInput');
      const pipChatInput = document.getElementById('pipChatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      const pipChatSendBtn = document.getElementById('pipChatSendBtn');
      
      if (chatInput && pipChatInput) {
        pipChatInput.disabled = chatInput.disabled;
        pipChatInput.value = chatInput.value;
      }
      if (chatSendBtn && pipChatSendBtn) {
        pipChatSendBtn.disabled = chatSendBtn.disabled;
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      pipChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendPIPMessage();
        }
      });
      pipChatSendBtn.addEventListener('click', sendPIPMessage);
      
      // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
      setTimeout(() => {
        pipChatMessages.scrollTop = pipChatMessages.scrollHeight;
      }, 100);
    }

    // ì±—ë´‡ PIP ë‹«ê¸°
    function closeChatbotPIP() {
      const pipModal = document.getElementById('chatbotPIPModal');
      if (pipModal) {
        pipModal.remove();
      }
    }

    // ì±—ë´‡ PIP ìµœì†Œí™” (ë‹«ê¸°ì™€ ë™ì¼)
    function minimizeChatbotPIP() {
      closeChatbotPIP();
    }

    // PIP ì±„íŒ… íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ (DB ê¸°ë°˜)
    async function updatePIPChatHistory() {
      const historyDiv = document.getElementById('pipChatHistory');
      if (!historyDiv) return;

      try {
        // ì‚¬ìš©ì ID í™•ì¸
        const userId = USER_ID;
        if (!userId || userId === 'None') {
          historyDiv.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="bi bi-person-x" style="font-size: 2rem;"></i>
              <p class="small mt-2 mb-0">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
            </div>
          `;
          return;
        }

        // ë¡œë”© í‘œì‹œ
        historyDiv.innerHTML = `
          <div class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
            <p class="small mb-0">ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        `;

        // chatbot ì•±ì˜ ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ API í˜¸ì¶œ
        const response = await fetch(`/chatbot/sessions/${userId}/`);
        if (!response.ok) {
          throw new Error('ì„¸ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        const data = await response.json();
        if (data.status !== 'ok' || !data.sessions || data.sessions.length === 0) {
          historyDiv.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="bi bi-chat-square-dots" style="font-size: 2rem;"></i>
              <p class="small mt-2 mb-0">ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            </div>
          `;
          return;
        }

        // ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        let historyHTML = '';
        data.sessions.forEach((session, index) => {
          const isActive = session.session_id === currentSessionId;
          const title = session.title || `ì„¸ì…˜ ${index + 1}`;
          const preview = session.preview || 'ìƒˆë¡œìš´ ëŒ€í™”';
          const createdAt = new Date(session.created_at).toLocaleDateString('ko-KR', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          historyHTML += `
            <div class="chat-history-item mb-2 ${isActive ? 'active' : ''}" 
                 onclick="loadChatSession('${session.session_id}')" 
                 style="cursor: pointer;">
              <div class="p-2 rounded ${isActive ? 'bg-primary text-white' : 'bg-light'} hover-effect">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <h6 class="mb-0 small fw-bold text-truncate" style="max-width: 180px;" title="${title}">
                    ${title}
                  </h6>
                  <small class="${isActive ? 'text-white-50' : 'text-muted'}" style="font-size: 0.7rem;">
                    ${createdAt}
                  </small>
                </div>
                <p class="mb-0 small ${isActive ? 'text-white-50' : 'text-muted'} text-truncate" 
                   style="font-size: 0.75rem; line-height: 1.2;" title="${preview}">
                  ${preview.length > 40 ? preview.substring(0, 40) + '...' : preview}
                </p>
              </div>
            </div>
          `;
        });

        historyDiv.innerHTML = historyHTML;

        // í˜„ì¬ í™œì„± ì„¸ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        const activeItem = historyDiv.querySelector('.chat-history-item.active');
        if (activeItem) {
          activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

      } catch (error) {
        console.error('ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        historyDiv.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
            <p class="small mt-2 mb-0">ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
      }
    }

    // ì±„íŒ… ì„¸ì…˜ ë¡œë“œ í•¨ìˆ˜
    async function loadChatSession(sessionId) {
      if (!sessionId || sessionId === currentSessionId) return;

      try {
        const userId = USER_ID;
        if (!userId || userId === 'None') return;

        // ë¡œë”© í‘œì‹œ
        const pipChatMessages = document.getElementById('pipChatMessages');
        if (pipChatMessages) {
          pipChatMessages.innerHTML = `
            <div class="text-center py-4">
              <div class="spinner-border text-primary mb-3" role="status"></div>
              <p class="text-muted">ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          `;
        }

        // ì„¸ì…˜ ë°ì´í„° ë¡œë“œ
        const response = await fetch(`/chatbot/sessions/${userId}/${sessionId}/`);
        if (!response.ok) {
          throw new Error('ì„¸ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        const data = await response.json();
        if (data.status !== 'ok') {
          throw new Error('ì„¸ì…˜ ë°ì´í„° ì‘ë‹µ ì˜¤ë¥˜: ' + JSON.stringify(data));
        }

        // í˜„ì¬ ì„¸ì…˜ ID ì—…ë°ì´íŠ¸
        currentSessionId = sessionId;

        // ì±„íŒ… ë©”ì‹œì§€ ë Œë”ë§
        let messagesHTML = '';
        const chatLog = data.chat_log || data.log || [];
        
        if (chatLog && chatLog.length > 0) {
          chatLog.forEach(message => {
          if (message.role === 'user') {
            messagesHTML += `
              <div class="d-flex align-items-start mb-3">
                <div class="ms-auto d-flex align-items-start">
                  <div class="bg-primary text-white rounded-3 p-3 shadow-sm me-2" style="max-width: 70%;">
                    <p class="mb-0">${message.content}</p>
                  </div>
                  <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; min-width: 36px;">
                    <i class="bi bi-person-fill text-white" style="font-size: 16px;"></i>
                  </div>
                </div>
              </div>
            `;
          } else if (message.role === 'assistant') {
            messagesHTML += `
              <div class="d-flex align-items-start mb-3">
                <div class="bg-gradient bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; min-width: 36px;">
                  <i class="bi bi-robot text-white" style="font-size: 16px;"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="bg-white rounded-3 p-3 shadow-sm border" style="max-width: 85%;">
                    <div class="d-flex align-items-center mb-2">
                      <strong class="text-primary me-2">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</strong>
                      <span class="badge bg-success-subtle text-success">ì˜¨ë¼ì¸</span>
                    </div>
                    <div class="message-content">${message.content}</div>
                  </div>
                </div>
              </div>
            `;
            }
          });
        }

        if (messagesHTML === '') {
          messagesHTML = `
            <div class="d-flex align-items-start mb-3">
              <div class="bg-gradient bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; min-width: 36px;">
                <i class="bi bi-robot text-white" style="font-size: 16px;"></i>
              </div>
              <div class="flex-grow-1">
                <div class="bg-white rounded-3 p-3 shadow-sm border">
                  <div class="d-flex align-items-center mb-2">
                    <strong class="text-primary me-2">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</strong>
                    <span class="badge bg-success-subtle text-success">ì˜¨ë¼ì¸</span>
                  </div>
                  <p class="mb-0">ì•ˆë…•í•˜ì„¸ìš”! ğŸ¯ ë°©ê¸ˆ ì™„ë£Œëœ ìƒê¶Œ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”.<br><br>
                  <strong>ìƒë‹´ ê°€ëŠ¥í•œ ë‚´ìš©:</strong><br>
                  â€¢ ğŸ“Š AI ìƒì¡´ í™•ë¥  í•´ì„<br>
                  â€¢ ğŸ‘¥ ì¸êµ¬ ë° ê³ ê°ì¸µ ë¶„ì„<br>
                  â€¢ ğŸª ê²½ìŸì—…ì²´ í˜„í™©<br>
                  â€¢ ğŸ’° ìˆ˜ìµì„± ì „ë§<br>
                  â€¢ ğŸš€ ì°½ì—… ì „ëµ ì¡°ì–¸</p>
                </div>
              </div>
            </div>
          `;
        }

        if (pipChatMessages) {
          pipChatMessages.innerHTML = messagesHTML;
          // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
          setTimeout(() => {
            pipChatMessages.scrollTop = pipChatMessages.scrollHeight;
          }, 100);
        }

        // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ (í™œì„± ì„¸ì…˜ í‘œì‹œ)
        updatePIPChatHistory();

        // ë©”ì¸ ì±„íŒ…ë„ ë™ê¸°í™”
        const mainChatMessages = document.getElementById('chatMessages');
        if (mainChatMessages) {
          mainChatMessages.innerHTML = messagesHTML;
          setTimeout(() => {
            mainChatMessages.scrollTop = mainChatMessages.scrollHeight;
          }, 100);
        }

      } catch (error) {
        console.error('ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
        if (pipChatMessages) {
          pipChatMessages.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
              <h6>ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h6>
              <p class="text-muted">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
            </div>
          `;
        }
      }
    }

    // íˆìŠ¤í† ë¦¬ ì„¸ì…˜ HTML ìƒì„±
    function createHistorySession(session, sessionNumber) {
      const userMessage = session.find(msg => msg.type === 'user');
      const aiMessage = session.find(msg => msg.type === 'ai');
      
      if (!userMessage) return '';

      const userPreview = userMessage.text.length > 30 ? userMessage.text.substring(0, 30) + '...' : userMessage.text;
      const aiPreview = aiMessage ? (aiMessage.text.length > 40 ? aiMessage.text.substring(0, 40) + '...' : aiMessage.text) : 'ì‘ë‹µ ëŒ€ê¸° ì¤‘...';
      
      return `
        <div class="border rounded p-2 mb-2 cursor-pointer hover-bg-light" onclick="scrollToPIPMessage(${sessionNumber})">
          <div class="d-flex align-items-start">
            <div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; min-width: 24px;">
              <i class="bi bi-person-fill text-white" style="font-size: 10px;"></i>
            </div>
            <div class="flex-grow-1" style="min-width: 0;">
              <div class="small fw-bold text-primary mb-1">ì§ˆë¬¸ ${sessionNumber}</div>
              <div class="small text-dark mb-1" style="word-break: break-word;">${userPreview}</div>
              <div class="small text-muted" style="word-break: break-word;">${aiPreview}</div>
            </div>
          </div>
        </div>
      `;
    }

    // PIP ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
    function scrollToPIPMessage(sessionNumber) {
      const pipChatMessages = document.getElementById('pipChatMessages');
      if (!pipChatMessages) return;

      const messages = pipChatMessages.querySelectorAll('.d-flex.mb-3');
      let targetMessage = null;
      let currentSessionCount = 0;

      for (let message of messages) {
        const isUser = message.querySelector('.ms-auto') !== null;
        if (isUser) {
          currentSessionCount++;
          if (currentSessionCount === sessionNumber) {
            targetMessage = message;
            break;
          }
        }
      }

      if (targetMessage) {
        targetMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // ì ì‹œ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
        targetMessage.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        setTimeout(() => {
          targetMessage.style.backgroundColor = '';
        }, 2000);
      }
    }

    // PIP ë¶„ì„ ìš”ì•½ ì—…ë°ì´íŠ¸
    function updatePIPAnalysisSummary() {
      const summaryDiv = document.getElementById('pipAnalysisSummary');
      if (!summaryDiv) return;

      // í˜„ì¬ ë¶„ì„ ê²°ê³¼ì—ì„œ ì£¼ìš” ì§€í‘œ ê°€ì ¸ì˜¤ê¸°
      const address = document.getElementById('resultAddress')?.textContent || '-';
      const businessType = document.getElementById('resultBusinessType')?.textContent || '-';
      const survivalRate = document.getElementById('survivalPercentage')?.textContent || '-%';
      const lifePop = document.getElementById('lifePop300')?.textContent || '-';
      const workingPop = document.getElementById('workingPop300')?.textContent || '-';
      const competitor = document.getElementById('competitor300')?.textContent || '-';
      const landValue = document.getElementById('totalLandValue')?.innerHTML || '-';

      summaryDiv.innerHTML = `
        <div class="mb-3">
          <h6 class="text-primary mb-2">ğŸ“ ê¸°ë³¸ ì •ë³´</h6>
          <div class="small">
            <div class="mb-1"><strong>ì£¼ì†Œ:</strong> ${address}</div>
            <div class="mb-1"><strong>ì—…ì¢…:</strong> ${businessType}</div>
          </div>
        </div>

        <div class="mb-3">
          <h6 class="text-success mb-2">ğŸ¯ AI ìƒì¡´ í™•ë¥ </h6>
          <div class="text-center">
            <div class="h4 text-primary mb-1">${survivalRate}</div>
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar ${getSurvivalBarClass(survivalRate)}" style="width: ${survivalRate}"></div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <h6 class="text-info mb-2">ğŸ“Š í•µì‹¬ ì§€í‘œ</h6>
          <div class="row g-2 small">
            <div class="col-6">
              <div class="bg-light rounded p-2 text-center">
                <div class="fw-bold text-primary">${lifePop}</div>
                <div class="text-muted" style="font-size: 0.75rem;">ìƒí™œì¸êµ¬</div>
              </div>
            </div>
            <div class="col-6">
              <div class="bg-light rounded p-2 text-center">
                <div class="fw-bold text-warning">${workingPop}</div>
                <div class="text-muted" style="font-size: 0.75rem;">ì§ì¥ì¸êµ¬</div>
              </div>
            </div>
            <div class="col-6">
              <div class="bg-light rounded p-2 text-center">
                <div class="fw-bold text-danger">${competitor}</div>
                <div class="text-muted" style="font-size: 0.75rem;">ê²½ìŸì—…ì²´</div>
              </div>
            </div>
            <div class="col-6">
              <div class="bg-light rounded p-2 text-center">
                <div class="fw-bold text-secondary">${landValue}</div>
                <div class="text-muted" style="font-size: 0.75rem;">ê³µì‹œì§€ê°€</div>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info py-2 px-3">
          <small>
            <i class="bi bi-info-circle me-1"></i>
            ì¢Œì¸¡ ì±„íŒ…ì—ì„œ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ìì„¸íˆ ë¬¸ì˜í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </small>
        </div>
      `;
    }

    // ìƒì¡´ í™•ë¥ ì— ë”°ë¥¸ í”„ë¡œê·¸ë ˆìŠ¤ ë°” í´ë˜ìŠ¤ ë°˜í™˜
    function getSurvivalBarClass(survivalRate) {
      const rate = parseInt(survivalRate);
      if (rate >= 80) return 'bg-success';
      if (rate >= 60) return 'bg-warning';
      return 'bg-danger';
    }

    // PIP ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
    async function sendPIPMessage() {
      const input = document.getElementById('pipChatInput');
      const message = input.value.trim();
      
      if (!message || !chatSocket) return;
      
      // ìƒˆë¡œìš´ ì„¸ì…˜ì´ í•„ìš”í•œ ê²½ìš° ìƒì„±
      if (!currentSessionId) {
        try {
          await createNewChatSession();
        } catch (error) {
          console.error('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
          addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì±„íŒ… ì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
      }
      
      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ (PIPì™€ ì›ë³¸ ëª¨ë‘)
      addPIPUserMessage(message);
      addUserMessage(message);
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      input.value = '';
      document.getElementById('chatInput').value = '';
      
      // ë¶„ì„ ë°ì´í„°ë¥¼ í¬í•¨í•œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
      const contextualMessage = createContextualMessage(message);
      
      // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
      chatSocket.send(JSON.stringify({
        user_id: USER_ID,
        session_id: currentSessionId,
        question: contextualMessage,
        collection: 'analysis_result_consultation'
      }));
      
      // ë´‡ ì‘ë‹µ ì¤€ë¹„ (PIPì™€ ì›ë³¸ ëª¨ë‘)
      preparePIPBotMessage();
      prepareBotMessage();
      
      // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
      setTimeout(() => {
        updatePIPChatHistory();
      }, 100);
    }

    // PIP ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    function addPIPUserMessage(message) {
      const messagesContainer = document.getElementById('pipChatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'd-flex align-items-start mb-3 justify-content-end';
      messageDiv.innerHTML = `
        <div class="flex-grow-1 text-end me-2">
          <div class="bg-primary text-white rounded-3 p-3 shadow-sm d-inline-block" style="max-width: 80%;">
            <p class="mb-0">${escapeHtml(message)}</p>
          </div>
        </div>
        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
          <i class="bi bi-person text-white" style="font-size: 18px;"></i>
        </div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // PIP ë´‡ ì‘ë‹µ ì¤€ë¹„
    function preparePIPBotMessage() {
      const messagesContainer = document.getElementById('pipChatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'd-flex align-items-start mb-4';
      messageDiv.id = 'currentPIPBotMessage';
      messageDiv.innerHTML = `
        <div class="bg-gradient bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
          <i class="bi bi-robot text-white" style="font-size: 18px;"></i>
        </div>
        <div class="flex-grow-1">
          <div class="bg-white rounded-3 p-4 shadow-sm border">
            <div class="d-flex align-items-center mb-2">
              <strong class="text-primary me-2">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</strong>
              <span class="badge bg-success-subtle text-success">ì˜¨ë¼ì¸</span>
            </div>
            <div id="pipBotMessageContent">
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </div>
          </div>
        </div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ê³µì‹œì§€ê°€ í¬ë§·íŒ… í•¨ìˆ˜
    function formatLandValue(value) {
      if (value >= 100000000) {
        return `â‚©${(value / 100000000).toFixed(1)}ì–µ`;
      } else if (value >= 10000) {
        return `â‚©${(value / 10000).toFixed(0)}ë§Œ`;
      } else {
        return `â‚©${value.toLocaleString()}`;
      }
    }

    // ì…ë ¥ì •ë³´ ì „ì†¡
    function getFormData() {
      const business_type_id = $('#business_type_id').val();
      const address = $('#address').val();
      const area = $('#area').val();
      const service_type = $('#service_type').val();
      const x_coord = $('#x_coord').val();
      const y_coord = $('#y_coord').val();
      const latitude = $('#latitude').val();
      const longitude = $('#longitude').val();

      // í•„ìˆ˜ í•„ë“œ ê²€ì¦
      if (!business_type_id || !address || !area || !service_type) {
        alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      // ì¢Œí‘œê°’ ê²€ì¦
      if (!x_coord || !y_coord || x_coord === '0' || y_coord === '0' || 
          !latitude || !longitude || latitude === '0' || longitude === '0') {
        alert("ì£¼ì†Œ ê²€ìƒ‰ì„ í†µí•´ ì¢Œí‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ì¦‰ì‹œ ë¡œë”© UI í‘œì‹œ
      console.log("ğŸš€ ë¶„ì„ ì‹œì‘ - ë¡œë”© UI í‘œì‹œ");
      showAnalysisLoading();

      // ë¶„ì„ ë°ì´í„° ì „ì†¡ ì¤€ë¹„
      
      const paramData = {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      };

      $.ajax(createPostAjaxOption('analyze', paramData));
    }

    function createPostAjaxOption(requestType, paramData) {
      
      const csrfToken = '{{ csrf_token }}';
      let url;

      if ( 'analyze' === requestType ) {
        url = '/ai_analyzer/analyze-business/';
      } else if ( 'pdf' === 'pdf' ) {
        url = '/generate-pdf/';
      }
      
      // ì›ë³¸ AI_Analyzerì™€ ê°™ì´ JSONìœ¼ë¡œ ì „ì†¡
      return {
        url: url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(paramData),
        headers: {
          'X-CSRFToken': csrfToken
        },
        success: function(response) {
          // ë¶„ì„ ìš”ì²­ ì„±ê³µ
          
          if (response.success && response.is_guest) {
            console.log("ğŸ”„ ë¹„íšŒì› ë¶„ì„ ê²°ê³¼ ì§ì ‘ í‘œì‹œ");
            // ë¹„íšŒì›ì€ ë°”ë¡œ ê²°ê³¼ í‘œì‹œ (ì €ì¥ë˜ì§€ ì•ŠìŒ)
            displayAnalysisResults({
              request: {
                address: $('#address').val(),
                business_type_id: parseInt($('#business_type_id').val()),
                area: parseFloat($('#area').val()),
                service_type: parseInt($('#service_type').val()),
                created_at: new Date().toISOString()
              },
              result: response.result
            });
          } else if (response.success && response.request_id) {
            console.log(`ğŸ”„ íšŒì› ë¶„ì„ - í˜„ì¬ í˜ì´ì§€ì—ì„œ ê²°ê³¼ í‘œì‹œ ì‹œì‘ (request_id: ${response.request_id})`);
            // íšŒì›ì€ ì €ì¥ëœ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œ
            fetchAndDisplayResults(response.request_id);
          } else if (response.request_id) {
            console.log(`ğŸ”„ request_idë§Œ ìˆëŠ” ê²½ìš° (request_id: ${response.request_id})`);
            // ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œ
            fetchAndDisplayResults(response.request_id);
          } else {
            console.log("âš ï¸ request_idê°€ ì—†ëŠ” ì‘ë‹µ:", response);
            alert('ë¶„ì„ ìš”ì²­ ì„±ê³µ: ' + (response.message || 'ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”'));
          }
        },
        error: function(xhr, status, error) {
          console.error("ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:", error);
          console.error("ì‘ë‹µ:", xhr.responseText);
          alert("ìƒê¶Œ ë¶„ì„ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }
    }

    // ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function fetchAndDisplayResults(requestId) {
      console.log(`ğŸ“Š ê²°ê³¼ ì¡°íšŒ ì‹œì‘ (request_id: ${requestId})`);
      console.log(`ğŸ”— API URL: /ai_analyzer/api/result/${requestId}/`);
      
      // í˜„ì¬ ë¶„ì„ ê²°ê³¼ ID ì €ì¥ (PDF ìƒì„±ì„ ìœ„í•´)
      currentRequestId = requestId;
      
      // ë¡œë”©ì€ ì´ë¯¸ getFormDataì—ì„œ ì‹œì‘ë¨
      
      $.ajax({
        url: `/ai_analyzer/api/result/${requestId}/`,
        type: 'GET',
        success: function(data) {
          console.log("âœ… ê²°ê³¼ ì¡°íšŒ ì„±ê³µ:", data);
          console.log("ğŸ¯ í˜„ì¬ í˜ì´ì§€ì—ì„œ ê²°ê³¼ í‘œì‹œ ì‹œì‘");
          displayAnalysisResults(data);
        },
        error: function(xhr, status, error) {
          console.error("âŒ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:", error);
          console.error("ğŸ“Š ì‘ë‹µ ìƒíƒœ:", xhr.status);
          console.error("ğŸ“„ ì‘ë‹µ í…ìŠ¤íŠ¸:", xhr.responseText);
          
          // ê¶Œí•œ ì˜¤ë¥˜ ì²˜ë¦¬
          if (xhr.status === 401) {
            console.log("ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•¨");
            showAnalysisError(requestId, "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          } else if (xhr.status === 403) {
            console.log("ğŸš« ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ");
            showAnalysisError(requestId, "ì´ ë¶„ì„ ê²°ê³¼ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
          } else if (xhr.status === 404) {
            console.log("ğŸ”„ ê²°ê³¼ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ì ì‹œ í›„ ì¬ì‹œë„");
            setTimeout(() => {
              fetchAndDisplayResults(requestId);
            }, 2000); // 2ì´ˆ í›„ ì¬ì‹œë„
          } else {
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œí•˜ê³  ë‹¤ì‹œ ì‹œë„ ì˜µì…˜ ì œê³µ
            showAnalysisError(requestId, error);
          }
        }
      });
    }
    
    // ë¶„ì„ ì§„í–‰ ìƒí™© í‘œì‹œ (ê¸°ì¡´ ë‹¨ìˆœ ë¡œë”© ëŒ€ì²´)
    function showAnalysisLoading() {
      // ëŒ€ê¸° ë©”ì‹œì§€ ìˆ¨ê¸°ê³  ì§„í–‰ ìƒí™© í‘œì‹œ
      $('#analysisWaiting').hide();
      $('#analysisProgress').show();
      
      // ì§„í–‰ ë‹¨ê³„ ì •ì˜ (ì‹¤ì œ ì¸¡ì •ëœ ì²˜ë¦¬ ì‹œê°„ ê¸°ë°˜, ì´ 38ì´ˆ)
      const steps = [
        { id: 'step-population', name: 'ìƒí™œì¸êµ¬ ë¶„ì„', delay: 1000, duration: 13000 },    // 1ì´ˆ ì‹œì‘ â†’ 14ì´ˆ ì™„ë£Œ
        { id: 'step-working', name: 'ì§ì¥ì¸êµ¬ ë¶„ì„', delay: 14000, duration: 13000 },      // 14ì´ˆ ì‹œì‘ â†’ 27ì´ˆ ì™„ë£Œ  
        { id: 'step-foreign', name: 'ì™¸êµ­ì¸ ë¶„ì„', delay: 27000, duration: 6000 },         // 27ì´ˆ ì‹œì‘ â†’ 33ì´ˆ ì™„ë£Œ
        { id: 'step-facilities', name: 'ì£¼ë³€ì‹œì„¤ ë¶„ì„', delay: 33000, duration: 2500 },     // 33ì´ˆ ì‹œì‘ â†’ 35.5ì´ˆ ì™„ë£Œ
        { id: 'step-competition', name: 'ê²½ìŸì—…ì²´ ë¶„ì„', delay: 35500, duration: 2000 },    // 35.5ì´ˆ ì‹œì‘ â†’ 37.5ì´ˆ ì™„ë£Œ
        { id: 'step-land', name: 'ê³µì‹œì§€ê°€ ë¶„ì„', delay: 37500, duration: 1500 },          // 37.5ì´ˆ ì‹œì‘ â†’ 39ì´ˆ ì™„ë£Œ
        { id: 'step-ai', name: 'AI ì˜ˆì¸¡ ë¶„ì„', delay: 39000, duration: 1500 },            // 39ì´ˆ ì‹œì‘ â†’ 40.5ì´ˆ ì™„ë£Œ
        { id: 'step-complete', name: 'ë¶„ì„ ì™„ë£Œ', delay: 40500, duration: 500 }            // 40.5ì´ˆ ì‹œì‘ â†’ 41ì´ˆ ì™„ë£Œ
      ];
      
              // ê° ë‹¨ê³„ë³„ë¡œ ì§„í–‰ í‘œì‹œ (ì‹¤ì œ 38ì´ˆ ê¸°ì¤€)
        steps.forEach((step, index) => {
          // ë‹¨ê³„ ì‹œì‘
          setTimeout(() => {
          // ì´ì „ ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
          if (index > 0) {
            const prevStep = steps[index - 1];
            $(`#${prevStep.id}`).removeClass('active').addClass('completed');
          }
          
          // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
          $(`#${step.id}`).addClass('active');
          
          // ê° ë‹¨ê³„ë³„ ìƒì„¸ ë©”ì‹œì§€
          let detailMessage = `${step.name} ì§„í–‰ ì¤‘...`;
          if (step.id === 'step-population') {
            detailMessage = 'ìƒí™œì¸êµ¬ ë¶„ì„ ì¤‘... (ëŒ€ìš©ëŸ‰ ê³µê°„ ë°ì´í„° ì²˜ë¦¬)';
          } else if (step.id === 'step-working') {
            detailMessage = 'ì§ì¥ì¸êµ¬ ë¶„ì„ ì¤‘... (ë³µì¡í•œ ê³µê°„ ì¿¼ë¦¬ ìˆ˜í–‰)';
          } else if (step.id === 'step-foreign') {
            detailMessage = 'ì™¸êµ­ì¸ ë¶„ì„ ì¤‘... (ë‹¤ì¤‘ í…Œì´ë¸” ê²€ìƒ‰)';
          } else if (step.id === 'step-facilities') {
            detailMessage = 'ì£¼ë³€ì‹œì„¤ ë¶„ì„ ì¤‘...';
          } else if (step.id === 'step-competition') {
            detailMessage = 'ê²½ìŸì—…ì²´ ë¶„ì„ ì¤‘...';
          } else if (step.id === 'step-land') {
            detailMessage = 'ê³µì‹œì§€ê°€ ë¶„ì„ ì¤‘...';
          } else if (step.id === 'step-ai') {
            detailMessage = 'AI ì˜ˆì¸¡ ëª¨ë¸ ì‹¤í–‰ ì¤‘...';
          }
          
          $(`#${step.id} .progress-detail`).text(detailMessage);
          
          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì‹œì‘ ì‹œì )
          const startProgress = Math.round((index / steps.length) * 100);
          $('#overallPercent').text(startProgress + '%');
          $('#overallProgressBar').css('width', startProgress + '%');
          
          // ê¸´ ë‹¨ê³„ë“¤ì— ëŒ€í•´ ì¤‘ê°„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ìƒí™œì¸êµ¬, ì§ì¥ì¸êµ¬, ì™¸êµ­ì¸ ë¶„ì„)
          if (step.duration > 5000) {
            const midPoint = step.delay + (step.duration / 2);
            setTimeout(() => {
              if ($(`#${step.id}`).hasClass('active')) {
                const midProgress = Math.round(((index + 0.5) / steps.length) * 100);
                $('#overallPercent').text(midProgress + '%');
                $('#overallProgressBar').css('width', midProgress + '%');
                
                if (step.id === 'step-population') {
                  $(`#${step.id} .progress-detail`).text('ìƒí™œì¸êµ¬ ë¶„ì„ ì¤‘... (50% ì™„ë£Œ)');
                } else if (step.id === 'step-working') {
                  $(`#${step.id} .progress-detail`).text('ì§ì¥ì¸êµ¬ ë¶„ì„ ì¤‘... (50% ì™„ë£Œ)');
                } else if (step.id === 'step-foreign') {
                  $(`#${step.id} .progress-detail`).text('ì™¸êµ­ì¸ ë¶„ì„ ì¤‘... (50% ì™„ë£Œ)');
                }
              }
            }, midPoint);
          }
          
        }, step.delay);
        
        // ë‹¨ê³„ ì™„ë£Œ
        setTimeout(() => {
          $(`#${step.id} .progress-detail`).text(`${step.name} ì™„ë£Œ`);
          
          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì™„ë£Œ ì‹œì )
          const endProgress = Math.round(((index + 1) / steps.length) * 100);
          $('#overallPercent').text(endProgress + '%');
          $('#overallProgressBar').css('width', endProgress + '%');
          
        }, step.delay + step.duration);
      });
      
      // ì˜ˆìƒ ì™„ë£Œ ì‹œê°„ í›„ì—ë„ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('ì„œë²„ì—ì„œ ìµœì¢… ê²°ê³¼ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...');
          
          // ì§„í–‰ë¥ ì„ 95%ë¡œ ìœ ì§€ (100%ëŠ” ì‹¤ì œ ì™„ë£Œ ì‹œì—ë§Œ)
          $('#overallPercent').text('95%');
          $('#overallProgressBar').css('width', '95%');
        }
      }, 41000);  // 41ì´ˆ í›„ (ì˜ˆìƒ ì™„ë£Œ ì‹œê°„ í›„)
      
      // ë” ì˜¤ë˜ ê±¸ë¦¬ëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ì¶”ê°€ ë©”ì‹œì§€
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('ëŒ€ìš©ëŸ‰ ê³µê°„ ë°ì´í„° ì²˜ë¦¬ë¡œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤...');
        }
      }, 45000);  // 45ì´ˆ í›„
      
      // ë” ê¸´ ëŒ€ê¸°ë¥¼ ìœ„í•œ ì•ˆë‚´
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('ê³§ ì™„ë£Œë©ë‹ˆë‹¤. ì ì‹œë§Œ ë” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
        }
      }, 50000);  // 50ì´ˆ í›„
    }
    
    // ë¶„ì„ ì—ëŸ¬ í‘œì‹œ
    function showAnalysisError(requestId, error) {
      // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„ë¥¼ ì˜¤ë¥˜ ìƒíƒœë¡œ ë³€ê²½
      $('.progress-step.active').removeClass('active').addClass('error');
      $('.progress-step.error .progress-detail').text('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      
      $('#analysisProgress').hide();
      $('#analysisWaiting').html(`
        <div class="alert alert-danger">
          <h5><i class="bi bi-exclamation-triangle me-2"></i>ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h5>
          <p>ì˜¤ë¥˜ ë‚´ìš©: ${error}</p>
          <div class="mt-3">
            <button class="btn btn-primary me-2" onclick="retryAnalysis(${requestId})">
              <i class="bi bi-arrow-clockwise me-1"></i>ë‹¤ì‹œ ì‹œë„
            </button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='/result/${requestId}/'">
              <i class="bi bi-eye me-1"></i>ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        </div>
      `).show();
    }
    
    // ë¶„ì„ ì¬ì‹œë„
    function retryAnalysis(requestId) {
      showAnalysisLoading();
      setTimeout(() => {
        fetchAndDisplayResults(requestId);
      }, 1000);
    }
    
    // ë¶„ì„ ê²°ê³¼ë¥¼ í˜ì´ì§€ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function displayAnalysisResults(data) {
      // ìµœì¢… ì™„ë£Œ ìƒíƒœë¡œ í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
      $('#step-complete').removeClass('active').addClass('completed');
      $('#step-complete .progress-detail').text('ë¶„ì„ ì™„ë£Œ');
      $('#overallPercent').text('100%');
      $('#overallProgressBar').css('width', '100%');
      
      // ì ì‹œ í›„ ì§„í–‰ ìƒí™© UI ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        $('#analysisProgress').hide();
      }, 1000);
      
      const request = data.request;
      const result = data.result;
      
      // ë¹„íšŒì›ì¸ì§€ í™•ì¸ (Django í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸)
      const isGuest = USER_AUTHENTICATED ? false : true;
      
      // ê¸°ë³¸ ì •ë³´ ì„¤ì •
      document.getElementById('resultAddress').textContent = request.address;
      document.getElementById('resultBusinessType').textContent = getBusinessTypeName(request.business_type_id);
      document.getElementById('resultArea').textContent = request.area;
      document.getElementById('resultServiceType').textContent = request.service_type == 1 ? 'ì¼ë°˜ìŒì‹ì ' : 'íœ´ê²ŒìŒì‹ì ';
      
      // í•µì‹¬ ì§€í‘œ
      document.getElementById('lifePop300').textContent = Math.round(result.life_pop_300m || 0).toLocaleString();
      document.getElementById('workingPop300').textContent = Math.round(result.working_pop_300m || 0).toLocaleString();
      document.getElementById('competitor300').textContent = result.competitor_300m || 0;
      
      // ê³µì‹œì§€ê°€ë¥¼ ì›í™” í‘œì‹œë¡œ ë” ê°„ë‹¨í•˜ê²Œ í‘œí˜„
      const landValue = result.total_land_value || 0;
      if (landValue >= 100000000) { // 1ì–µ ì´ìƒ
        document.getElementById('totalLandValue').innerHTML = `â‚©${(landValue / 100000000).toFixed(1)}ì–µ`;
      } else if (landValue >= 10000) { // 1ë§Œ ì´ìƒ
        document.getElementById('totalLandValue').innerHTML = `â‚©${(landValue / 10000).toFixed(0)}ë§Œ`;
      } else {
        document.getElementById('totalLandValue').innerHTML = `â‚©${landValue.toLocaleString()}`;
      }
      
      // AI ìƒì¡´ í™•ë¥ 
      const survivalRate = Math.round(result.survival_percentage || 0);
      document.getElementById('survivalPercentage').textContent = survivalRate + '%';
      
      const survivalBar = document.getElementById('survivalBar');
      const survivalBarText = document.getElementById('survivalBarText');
      const survivalAnalysis = document.getElementById('survivalAnalysis');
      
      survivalBar.style.width = survivalRate + '%';
      
      if (survivalRate >= 80) {
        survivalBar.className = 'progress-bar bg-success';
        survivalBarText.className = 'badge bg-success fs-6';
        survivalBarText.textContent = `${survivalRate}% (ë†’ìŒ)`;
        survivalAnalysis.className = 'alert alert-success';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>
          <strong>ë†’ì€ ìƒì¡´ ê°€ëŠ¥ì„±</strong><br>
          í˜„ì¬ ìœ„ì¹˜ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ì‚¬ì—…ì„ ì§€ì†í•˜ê¸°ì— ë§¤ìš° ì¢‹ì€ ì¡°ê±´ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤.
        `;
      } else if (survivalRate >= 60) {
        survivalBar.className = 'progress-bar bg-warning';
        survivalBarText.className = 'badge bg-warning fs-6';
        survivalBarText.textContent = `${survivalRate}% (ë³´í†µ)`;
        survivalAnalysis.className = 'alert alert-warning';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>ë³´í†µ ìƒì¡´ ê°€ëŠ¥ì„±</strong><br>
          í˜„ì¬ ìœ„ì¹˜ëŠ” ì‚¬ì—… ì§€ì†ì— ì ì ˆí•œ ì¡°ê±´ì„ ê°–ì¶”ê³  ìˆìœ¼ë‚˜, ì¶”ê°€ì ì¸ ì „ëµ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        `;
      } else {
        survivalBar.className = 'progress-bar bg-danger';
        survivalBarText.className = 'badge bg-danger fs-6';
        survivalBarText.textContent = `${survivalRate}% (ë‚®ìŒ)`;
        survivalAnalysis.className = 'alert alert-danger';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-times-circle me-2"></i>
          <strong>ë‚®ì€ ìƒì¡´ ê°€ëŠ¥ì„±</strong><br>
          í˜„ì¬ ìœ„ì¹˜ëŠ” ì¥ê¸° ì‚¬ì—… ì§€ì†ì— ì–´ë ¤ì›€ì´ ì˜ˆìƒë©ë‹ˆë‹¤. ì‹ ì¤‘í•œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        `;
      }
      
      // ìƒê¶Œ ê²½ìŸ ë¶„ì„
      document.getElementById('competitorCount').textContent = result.competitor_300m || 0;
      document.getElementById('adjacentBiz').textContent = result.adjacent_biz_300m || 0;
      
      const competitorRatio = Math.round(result.competitor_ratio_300m || 0);
      document.getElementById('competitorRatio').textContent = competitorRatio + '%';
      document.getElementById('businessDiversity').textContent = (result.business_diversity_300m || 0) + 'ì¢…ë¥˜';
      
      const competitionBar = document.getElementById('competitionBar');
      const competitionLevel = document.getElementById('competitionLevel');
      
      competitionBar.style.width = competitorRatio + '%';
      
      if (competitorRatio <= 20) {
        competitionBar.className = 'progress-bar bg-success';
        competitionLevel.className = 'badge bg-success fs-6';
        competitionLevel.textContent = `ë‚®ìŒ (${competitorRatio}%)`;
      } else if (competitorRatio <= 50) {
        competitionBar.className = 'progress-bar bg-warning';
        competitionLevel.className = 'badge bg-warning fs-6';
        competitionLevel.textContent = `ë³´í†µ (${competitorRatio}%)`;
      } else {
        competitionBar.className = 'progress-bar bg-danger';
        competitionLevel.className = 'badge bg-danger fs-6';
        competitionLevel.textContent = `ë†’ìŒ (${competitorRatio}%)`;
      }
      
      // ê°•ì ê³¼ ì£¼ì˜ì‚¬í•­ ë¶„ì„
      displayStrengthsAndCautions(result);
      
      // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
      document.getElementById('analysisWaiting').style.display = 'none';
      document.getElementById('analysisResults').style.display = 'block';
      
      // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      document.getElementById('analysisResults').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
      
      // ì™¸êµ­ì¸ ê´€ë ¨ ì§€í‘œ í‘œì‹œ (í†µí•©ëœ ì„¹ì…˜)
      console.log('ì™¸êµ­ì¸ ì§€í‘œ ë°ì´í„°:', {
        '2A_Temp_Total': result['2A_Temp_Total'],
        '1A_Long_Total': result['1A_Long_Total'],
        '2A_Long_CN': result['2A_Long_CN'],
        temp_foreign_1000m: result.temp_foreign_1000m,
        long_foreign_300m: result.long_foreign_300m,
        long_foreign_cn_1000m: result.long_foreign_cn_1000m
      });
      
      // 1. ë‹¨ê¸°ì²´ë¥˜ ì™¸êµ­ì¸ (1000m) - 2A_Temp_Total ì‚¬ìš©
      const tempTotal = result['2A_Temp_Total'] || result.temp_foreign_1000m || result.temp_foreign_total_1000m || 0;
      document.getElementById('tempForeign1000').textContent = tempTotal > 0 ? Math.round(tempTotal).toLocaleString() + 'ëª…' : '0ëª…';
      
      // 2. ì¥ê¸°ì²´ë¥˜ ì™¸êµ­ì¸ (300m) - 1A_Long_Total ì‚¬ìš©
      const longTotal300 = result['1A_Long_Total'] || result.long_foreign_300m || result.long_foreign_total_300m || 0;
      document.getElementById('longForeign300').textContent = longTotal300 > 0 ? Math.round(longTotal300).toLocaleString() + 'ëª…' : '0ëª…';
      
      // 3. ì¥ê¸°ì²´ë¥˜ ì¤‘êµ­ì¸ ë¹„ìœ¨ (1000m) - 2A_Long_CN ì‚¬ìš©
      const longCNRatio1000 = result['2A_Long_CN'] || result.long_foreign_cn_1000m || result.long_foreign_cn_ratio_1000m || 0; // ì´ë¯¸ ë¹„ìœ¨(%)
      document.getElementById('longForeignCNRatio300').textContent = longCNRatio1000 > 0 ? longCNRatio1000.toFixed(1) + '%' : '0.0%';
      
      // ì¸êµ¬ êµ¬ì„± íŒŒì´ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (1000m ê¸°ì¤€)
      updateAgeChart(result);
      
      // ë¹„íšŒì›ì¼ ë•Œ PDF ë²„íŠ¼ ë¹„í™œì„±í™”
      if (isGuest) {
        document.getElementById('pdfSaveBtn').style.display = 'none';
        document.getElementById('guestPdfMessage').style.display = 'block';
      } else {
        document.getElementById('pdfSaveBtn').style.display = 'inline-block';
        document.getElementById('guestPdfMessage').style.display = 'none';
      }
      
      // ë¶„ì„ê²°ê³¼ ì±—ë´‡ í™œì„±í™” (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ)
      if (!isGuest) {
        console.log('ë¶„ì„ ì™„ë£Œ - ì±—ë´‡ í™œì„±í™”');
        activateChatbot(data);
      }
    }
    
    // ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ íŒŒì´ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    let ageChart = null;
    let previewAgeChart = null;
    
    // PDF ë¯¸ë¦¬ë³´ê¸°ìš© íŒŒì´ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePreviewAgeChart(ageData) {
      const chartData = {
        labels: ['20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€', '60ëŒ€ ì´ìƒ'],
        datasets: [{
          data: ageData,
          backgroundColor: [
            '#FF6384',  // 20ëŒ€ - í•‘í¬
            '#36A2EB',  // 30ëŒ€ - ë¸”ë£¨
            '#FFCE56',  // 40ëŒ€ - ì˜ë¡œìš°
            '#4BC0C0',  // 50ëŒ€ - ì‹œì•ˆ
            '#9966FF'   // 60ëŒ€ - í¼í”Œ
          ],
          borderColor: [
            '#FF6384',
            '#36A2EB',
            '#FFCE56',
            '#4BC0C0',
            '#9966FF'
          ],
          borderWidth: 2
        }]
      };
      
      const chartConfig = {
        type: 'pie',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 8,
                usePointStyle: true,
                font: {
                  size: 10
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return label + ': ' + value.toFixed(1) + '%';
                }
              }
            }
          },
          layout: {
            padding: 5
          }
        }
      };
      
      // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
      if (previewAgeChart) {
        previewAgeChart.destroy();
      }
      
      // ìƒˆ ì°¨íŠ¸ ìƒì„±
      const previewCtx = document.getElementById('previewAgeChart');
      if (previewCtx) {
        previewAgeChart = new Chart(previewCtx.getContext('2d'), chartConfig);
      }
    }
    
    function updateAgeChart(result) {
      // 1000m ë°˜ê²½ ì—°ë ¹ëŒ€ë³„ ë¹„ìœ¨ ë°ì´í„° (ë°±ì—”ë“œì—ì„œ ì œê³µ)
      const age20 = result['2A_20'] || result.life_pop_20_1000m || 0;
      const age30 = result['2A_30'] || result.life_pop_30_1000m || 0;
      const age40 = result['2A_40'] || result.life_pop_40_1000m || 0;
      const age50 = result['2A_50'] || result.life_pop_50_1000m || 0;
      const age60 = result['2A_60'] || result.life_pop_60_1000m || 0;
      
      // ì—°ë ¹ëŒ€ë³„ í¼ì„¼íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
      document.getElementById('age20Percent').textContent = age20.toFixed(1) + '%';
      document.getElementById('age30Percent').textContent = age30.toFixed(1) + '%';
      document.getElementById('age40Percent').textContent = age40.toFixed(1) + '%';
      document.getElementById('age50Percent').textContent = age50.toFixed(1) + '%';
      document.getElementById('age60Percent').textContent = age60.toFixed(1) + '%';
      
      // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
      const chartData = {
        labels: ['20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€', '60ëŒ€ ì´ìƒ'],
        datasets: [{
          data: [age20, age30, age40, age50, age60],
          backgroundColor: [
            '#FF6384',  // 20ëŒ€ - í•‘í¬
            '#36A2EB',  // 30ëŒ€ - ë¸”ë£¨
            '#FFCE56',  // 40ëŒ€ - ì˜ë¡œìš°
            '#4BC0C0',  // 50ëŒ€ - ì‹œì•ˆ
            '#9966FF'   // 60ëŒ€ - í¼í”Œ
          ],
          borderColor: [
            '#FF6384',
            '#36A2EB',
            '#FFCE56',
            '#4BC0C0',
            '#9966FF'
          ],
          borderWidth: 2
        }]
      };
      
      // ì°¨íŠ¸ ì„¤ì •
      const chartConfig = {
        type: 'pie',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 10,
                usePointStyle: true,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return label + ': ' + value.toFixed(1) + '%';
                }
              }
            }
          },
          layout: {
            padding: 10
          }
        }
      };
      
      // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
      if (ageChart) {
        ageChart.destroy();
      }
      
      // ìƒˆ ì°¨íŠ¸ ìƒì„±
      const ctx = document.getElementById('ageChart').getContext('2d');
      ageChart = new Chart(ctx, chartConfig);
    }
    
    // ì—…ì¢…ëª… ë°˜í™˜ í•¨ìˆ˜
    function getBusinessTypeName(businessTypeId) {
      const businessTypes = {
        0: 'ê°ì„±ì£¼ì ', 1: 'ê²½ì–‘ì‹', 2: 'ê´€ê´‘í˜¸í…”', 3: 'ê·¹ì¥', 4: 'ê¸°íƒ€',
        5: 'ê¸°íƒ€ íœ´ê²ŒìŒì‹ì ', 6: 'ê¹€ë°¥(ë„ì‹œë½)', 7: 'ê¹Œí˜', 8: 'ëƒ‰ë©´ì§‘', 9: 'ë‹¤ë°©',
        10: 'ë–¡ì¹´í˜', 11: 'ë¼ì´ë¸Œì¹´í˜', 12: 'ë°±í™”ì ', 13: 'ë³µì–´ì·¨ê¸‰', 14: 'ë¶„ì‹',
        15: 'ë·”í˜ì‹', 16: 'ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)', 17: 'ì•„ì´ìŠ¤í¬ë¦¼', 18: 'ì™¸êµ­ìŒì‹ì „ë¬¸ì (ì¸ë„, íƒœêµ­ ë“±)', 19: 'ìœ ì›ì§€',
        20: 'ì¼ë°˜ì¡°ë¦¬íŒë§¤', 21: 'ì¼ì‹', 22: 'ì „í†µì°»ì§‘', 23: 'ì •ì¢…/ëŒ€í¬ì§‘/ì†Œì£¼ë°©', 24: 'ì¤‘êµ­ì‹',
        25: 'ì² ë„ì—­êµ¬ë‚´', 26: 'ì¶œì¥ì¡°ë¦¬', 27: 'ì»¤í”¼ìˆ', 28: 'í‚¤ì¦ˆì¹´í˜', 29: 'íƒ•ë¥˜(ë³´ì‹ ìš©)',
        30: 'í†µë‹­(ì¹˜í‚¨)', 31: 'íŒ¨ë°€ë¦¬ë ˆìŠ¤í† ë‘', 32: 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', 33: 'í¸ì˜ì ', 34: 'í‘¸ë“œíŠ¸ëŸ­',
        35: 'í•œì‹', 36: 'í˜¸í”„/í†µë‹­', 37: 'íšŸì§‘'
      };
      return businessTypes[businessTypeId] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
    
    // ê°•ì ê³¼ ì£¼ì˜ì‚¬í•­ í‘œì‹œ
    function displayStrengthsAndCautions(result) {
      const strengthsList = document.getElementById('strengthsList');
      const cautionsList = document.getElementById('cautionsList');
      
      let strengths = [];
      let cautions = [];
      
      // ê°•ì  ë¶„ì„
      if (result.life_pop_300m > 5000) {
        strengths.push(`ìƒí™œì¸êµ¬ê°€ í’ë¶€í•¨ (${Math.round(result.life_pop_300m).toLocaleString()}ëª…)`);
      }
      if (result.working_pop_300m > 3000) {
        strengths.push('ì§ì¥ì¸êµ¬ê°€ ë§ì•„ ì ì‹¬ì‹œê°„ ê³ ê° í™•ë³´ ìœ ë¦¬');
      }
      if (result.competitor_ratio_300m < 30) {
        strengths.push('ê²½ìŸì—…ì²´ ë¹„ìœ¨ì´ ë‚®ì•„ ê²½ìŸ ë¶€ë‹´ ì ìŒ');
      }
      if (result.business_diversity_300m > 10) {
        strengths.push('ì—…ì¢… ë‹¤ì–‘ì„±ì´ ë†’ì•„ ìƒê¶Œì´ í™œì„±í™”ë¨');
      }
      if (result.public_building_250m > 0 || result.school_250m > 0) {
        strengths.push('ì£¼ë³€ ìœ ë™ì¸êµ¬ ìœ ë°œì‹œì„¤ ì¡´ì¬');
      }
      
      // ì£¼ì˜ì‚¬í•­ ë¶„ì„
      if (result.life_pop_300m < 2000) {
        cautions.push('ìƒí™œì¸êµ¬ê°€ ì ì–´ ê³ ê° í™•ë³´ì— ì–´ë ¤ì›€ ì˜ˆìƒ');
      }
      if (result.competitor_ratio_300m > 50) {
        cautions.push('ê²½ìŸì—…ì²´ ë¹„ìœ¨ì´ ë†’ì•„ ì¹˜ì—´í•œ ê²½ìŸ ì˜ˆìƒ');
      }
      if (result.competitor_300m > 5) {
        cautions.push(`ë™ì¼ì—…ì¢… ê²½ìŸì—…ì²´ê°€ ë§ìŒ (${result.competitor_300m}ê°œ)`);
      }
      if (result.total_land_value > 100000000) {
        cautions.push('ê³µì‹œì§€ê°€ê°€ ë†’ì•„ ì„ëŒ€ë£Œ ë¶€ë‹´ í´ ìˆ˜ ìˆìŒ');
      }
      if (result.working_pop_300m < 1000) {
        cautions.push('ì§ì¥ì¸êµ¬ê°€ ì ì–´ í‰ì¼ ì ì‹¬ ê³ ê° ë¶€ì¡± ìš°ë ¤');
      }
      
      // ê¸°ë³¸ ë©”ì‹œì§€
      if (strengths.length === 0) {
        strengths.push('ìƒê¶Œ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê²€í† í•˜ì„¸ìš”');
      }
      if (cautions.length === 0) {
        cautions.push('í˜„ì¬ ìƒê¶Œ ì¡°ê±´ì´ ì–‘í˜¸í•©ë‹ˆë‹¤');
      }
      
      // HTML ìƒì„±
      strengthsList.innerHTML = strengths.map(item => `<li>${item}</li>`).join('');
      cautionsList.innerHTML = cautions.map(item => `<li>${item}</li>`).join('');
    }
    
    function fillExampleQuestion(text) {
      document.getElementById('chatInput').value = text;
    }

    // PDF ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ (ë¶„ì„ ê¸°ë¡ìš©)
    function showPdfPreview(requestId) {
              // PDF ë¯¸ë¦¬ë³´ê¸° ìš”ì²­ ì²˜ë¦¬
      
      // ëª¨ë‹¬ í‘œì‹œ
      const previewModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
      previewModal.show();
      
             // ì´ˆê¸° ìƒíƒœ ì„¤ì •
       document.getElementById('previewLoading').style.display = 'block';
       document.getElementById('previewError').style.display = 'none';
       document.getElementById('previewContent').style.display = 'none';
       document.getElementById('previewDownloadPdfBtn').style.display = 'none';
       document.getElementById('previewDownloadLightPdfBtn').style.display = 'none';
      
      // ë¶„ì„ ê²°ê³¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetch(`/ai_analyzer/api/result/${requestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': CSRF_TOKEN
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        return response.json();
      })
      .then(data => {
        // ë¶„ì„ ê²°ê³¼ ë°ì´í„° ì²˜ë¦¬
        
                 // ë¡œë”© ìˆ¨ê¸°ê³  ë‚´ìš© í‘œì‹œ
         document.getElementById('previewLoading').style.display = 'none';
         document.getElementById('previewContent').style.display = 'block';
         document.getElementById('previewDownloadPdfBtn').style.display = 'inline-block';
         document.getElementById('previewDownloadLightPdfBtn').style.display = 'inline-block';
        
        // ë°ì´í„° ì±„ìš°ê¸°
        populatePreviewData(data, requestId);
      })
      .catch(error => {
        console.error('PDF ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('previewLoading').style.display = 'none';
        document.getElementById('previewError').style.display = 'block';
        document.getElementById('previewErrorMessage').textContent = error.message;
      });
    }

    // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì±„ìš°ê¸° í•¨ìˆ˜
    function populatePreviewData(data, requestId) {
      const request = data.request;
      const result = data.result;
      
      // ê¸°ë³¸ ì •ë³´
      document.getElementById('previewAddr').textContent = request.address || '-';
      document.getElementById('previewBizType').textContent = getBusinessTypeName(request.business_type_id) || '-';
      document.getElementById('previewAreaSize').textContent = request.area || '-';
      
      // ë¶„ì„ì¼ì‹œ
      const analysisDate = new Date(request.created_at).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('previewAnalysisDate').textContent = analysisDate;
      document.getElementById('previewReportGeneratedDate').textContent = analysisDate;
      
      // AI ìƒì¡´ í™•ë¥ 
      const survivalRate = Math.round(result.survival_percentage || 0);
      document.getElementById('previewSurvivalRate').textContent = survivalRate + '%';
      
      // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì„¤ì •
      const progressBar = document.getElementById('previewSurvivalProgressBar');
      progressBar.style.width = survivalRate + '%';
      
      // ìƒì¡´ í™•ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë° ë©”ì‹œì§€
      const survivalComment = document.getElementById('previewSurvivalComment');
      if (survivalRate >= 80) {
        progressBar.className = 'progress-bar bg-success';
        survivalComment.textContent = 'ë†’ì€ ìƒì¡´ ê°€ëŠ¥ì„± - ì¥ê¸°ì  ì‚¬ì—… ì§€ì†ì— ë§¤ìš° ì¢‹ì€ ì¡°ê±´';
        survivalComment.className = 'text-success mb-0';
      } else if (survivalRate >= 60) {
        progressBar.className = 'progress-bar bg-warning';
        survivalComment.textContent = 'ë³´í†µ ìƒì¡´ ê°€ëŠ¥ì„± - ì ì ˆí•œ ì¡°ê±´ì´ë‚˜ ì¶”ê°€ ì „ëµ ê²€í†  í•„ìš”';
        survivalComment.className = 'text-warning mb-0';
      } else {
        progressBar.className = 'progress-bar bg-danger';
        survivalComment.textContent = 'ë‚®ì€ ìƒì¡´ ê°€ëŠ¥ì„± - ì¥ê¸° ì‚¬ì—… ì§€ì†ì— ì–´ë ¤ì›€ ì˜ˆìƒ';
        survivalComment.className = 'text-danger mb-0';
      }
      
      // í•µì‹¬ ì§€í‘œ
      document.getElementById('previewLifePopulation').textContent = 
        Math.round(result.life_pop_300m || 0).toLocaleString() + 'ëª…';
      document.getElementById('previewWorkingPopulation').textContent = 
        Math.round(result.working_pop_300m || 0).toLocaleString() + 'ëª…';
      document.getElementById('previewCompetitors').textContent = 
        (result.competitor_300m || 0) + 'ê°œ';
      
      // ê³µì‹œì§€ê°€
      const landValue = result.total_land_value || 0;
      let landValueText = '';
      if (landValue >= 100000000) { // 1ì–µ ì´ìƒ
        landValueText = `â‚©${(landValue / 100000000).toFixed(1)}ì–µ`;
      } else if (landValue >= 10000) { // 1ë§Œ ì´ìƒ
        landValueText = `â‚©${(landValue / 10000).toFixed(0)}ë§Œ`;
      } else {
        landValueText = `â‚©${landValue.toLocaleString()}`;
      }
      document.getElementById('previewLandPrice').textContent = landValueText;
      
      // ê²½ìŸê°•ë„ ë¶„ì„ (ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤)
      const competitorRatio = Math.round(result.competitor_ratio_300m || 0);
      const businessDiversity = result.business_diversity_300m || 0;
      const adjacentBiz = result.adjacent_biz_300m || 0;
      
      // ê²½ìŸê°•ë„ ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì—…ë°ì´íŠ¸
      document.getElementById('previewCompetitorCount').textContent = (result.competitor_300m || 0) + 'ê°œ';
      document.getElementById('previewAdjacentBiz').textContent = adjacentBiz + 'ê°œ';
      
      // ê²½ìŸê°•ë„ ì§„í–‰ë¥  ë°” ì„¤ì •
      const previewCompetitionBar = document.getElementById('previewCompetitionBar');
      const previewCompetitionLevel = document.getElementById('previewCompetitionLevel');
      
      if (previewCompetitionBar && previewCompetitionLevel) {
        previewCompetitionBar.style.width = competitorRatio + '%';
        
        if (competitorRatio <= 20) {
          previewCompetitionBar.className = 'progress-bar bg-success';
          previewCompetitionLevel.className = 'badge bg-success fs-6';
          previewCompetitionLevel.textContent = `ë‚®ìŒ (${competitorRatio}%)`;
        } else if (competitorRatio <= 50) {
          previewCompetitionBar.className = 'progress-bar bg-warning';
          previewCompetitionLevel.className = 'badge bg-warning fs-6';
          previewCompetitionLevel.textContent = `ë³´í†µ (${competitorRatio}%)`;
        } else {
          previewCompetitionBar.className = 'progress-bar bg-danger';
          previewCompetitionLevel.className = 'badge bg-danger fs-6';
          previewCompetitionLevel.textContent = `ë†’ìŒ (${competitorRatio}%)`;
        }
      }
      
      // ì™¸êµ­ì¸ ë¶„ì„ ë°ì´í„° (ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤)
      const tempTotal = result['2A_Temp_Total'] || result.temp_foreign_1000m || 0;
      const longTotal300 = result['1A_Long_Total'] || result.long_foreign_300m || 0;
      const longCNRatio1000 = result['2A_Long_CN'] || result.long_foreign_cn_1000m || 0;
      
      // ì™¸êµ­ì¸ ë¶„ì„ ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì—…ë°ì´íŠ¸
      document.getElementById('previewTempForeign').textContent = tempTotal > 0 ? Math.round(tempTotal).toLocaleString() + 'ëª…' : '0ëª…';
      document.getElementById('previewLongForeign').textContent = longTotal300 > 0 ? Math.round(longTotal300).toLocaleString() + 'ëª…' : '0ëª…';
      document.getElementById('previewChinaRatio').textContent = longCNRatio1000 > 0 ? longCNRatio1000.toFixed(1) + '%' : '0.0%';
      
      // ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„ (ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤)
      const age20 = result['2A_20'] || result.life_pop_20_1000m || 0;
      const age30 = result['2A_30'] || result.life_pop_30_1000m || 0;
      const age40 = result['2A_40'] || result.life_pop_40_1000m || 0;
      const age50 = result['2A_50'] || result.life_pop_50_1000m || 0;
      const age60 = result['2A_60'] || result.life_pop_60_1000m || 0;
      
      // ì—°ë ¹ëŒ€ë³„ ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì—…ë°ì´íŠ¸
      document.getElementById('previewAge20').textContent = age20.toFixed(1) + '%';
      document.getElementById('previewAge30').textContent = age30.toFixed(1) + '%';
      document.getElementById('previewAge40').textContent = age40.toFixed(1) + '%';
      document.getElementById('previewAge50').textContent = age50.toFixed(1) + '%';
      document.getElementById('previewAge60').textContent = age60.toFixed(1) + '%';
      
      // PDF ë¯¸ë¦¬ë³´ê¸°ìš© íŒŒì´ì°¨íŠ¸ ìƒì„±
      const ageData = [age20, age30, age40, age50, age60];
      updatePreviewAgeChart(ageData);
      
             // ê°•ì ê³¼ ì£¼ì˜ì‚¬í•­ ë¶„ì„
       populateStrengthsAndCautions(result);
       
       // í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° ì¤‘ì¸ requestIdë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (PDF ë‹¤ìš´ë¡œë“œìš©)
       currentPreviewRequestId = requestId;
    }

    // ê°•ì ê³¼ ì£¼ì˜ì‚¬í•­ ë¶„ì„ í•¨ìˆ˜ (ë¯¸ë¦¬ë³´ê¸°ìš©)
    function populateStrengthsAndCautions(result) {
      const strengths = [];
      const cautions = [];
      
      console.log('ë¯¸ë¦¬ë³´ê¸° ê°•ì /ì£¼ì˜ì‚¬í•­ ë¶„ì„ ë°ì´í„°:', result);
      // ê°•ì /ì£¼ì˜ì‚¬í•­ ë¶„ì„ì„ ìœ„í•œ ë°ì´í„° ì²˜ë¦¬
      
      // ìƒí™œì¸êµ¬ ë¶„ì„
      const lifePop300 = result.life_pop_300m || 0;
      if (lifePop300 > 5000) {
        strengths.push('300m ë°˜ê²½ ë‚´ ìƒí™œì¸êµ¬ê°€ í’ë¶€í•©ë‹ˆë‹¤ (' + Math.round(lifePop300).toLocaleString() + 'ëª…)');
      } else if (lifePop300 < 2000) {
        cautions.push('300m ë°˜ê²½ ë‚´ ìƒí™œì¸êµ¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (' + Math.round(lifePop300).toLocaleString() + 'ëª…)');
      }
      
      // ì§ì¥ì¸êµ¬ ë¶„ì„
      const workingPop300 = result.working_pop_300m || 0;
      if (workingPop300 > 3000) {
        strengths.push('300m ë°˜ê²½ ë‚´ ì§ì¥ì¸êµ¬ê°€ ë§ì•„ ì ì‹¬/ì €ë… ìˆ˜ìš”ê°€ ê¸°ëŒ€ë©ë‹ˆë‹¤');
      } else if (workingPop300 < 1000) {
        cautions.push('300m ë°˜ê²½ ë‚´ ì§ì¥ì¸êµ¬ê°€ ì ì–´ í‰ì¼ ìˆ˜ìš”ê°€ ì œí•œì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
      }
      
      // ê²½ìŸì—…ì²´ ë¶„ì„
      const competitor300 = result.competitor_300m || 0;
      if (competitor300 < 3) {
        strengths.push('300m ë°˜ê²½ ë‚´ ê²½ìŸì—…ì²´ê°€ ì ì–´ ì‹œì¥ ì„ ì  ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤');
      } else if (competitor300 > 10) {
        cautions.push('300m ë°˜ê²½ ë‚´ ê²½ìŸì—…ì²´ê°€ ë§ì•„ ì¹˜ì—´í•œ ê²½ìŸì´ ì˜ˆìƒë©ë‹ˆë‹¤ (' + competitor300 + 'ê°œ)');
      }
      
      // ê²½ìŸê°•ë„ ë¶„ì„ (ìƒˆë¡œ ì¶”ê°€)
      const competitorRatio = result.competitor_ratio_300m || 0;
      if (competitorRatio < 20) {
        strengths.push('ê²½ìŸê°•ë„ê°€ ë‚®ì•„ ì‹œì¥ ì§„ì…ì´ ìœ ë¦¬í•©ë‹ˆë‹¤ (' + competitorRatio.toFixed(1) + '%)');
      } else if (competitorRatio > 60) {
        cautions.push('ê²½ìŸê°•ë„ê°€ ë†’ì•„ ì¹˜ì—´í•œ ê²½ìŸì´ ì˜ˆìƒë©ë‹ˆë‹¤ (' + competitorRatio.toFixed(1) + '%)');
      }
      
      // ì—…ì¢… ë‹¤ì–‘ì„± ë¶„ì„ (ìƒˆë¡œ ì¶”ê°€)
      const businessDiversity = result.business_diversity_300m || 0;
      if (businessDiversity > 15) {
        strengths.push('ì£¼ë³€ ì—…ì¢…ì´ ë‹¤ì–‘í•´ ìƒê¶Œì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
      } else if (businessDiversity < 5) {
        cautions.push('ì£¼ë³€ ì—…ì¢… ë‹¤ì–‘ì„±ì´ ë¶€ì¡±í•´ ìƒê¶Œ í™œë ¥ì´ ì œí•œì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
      }
      
      // ê³µì‹œì§€ê°€ ë¶„ì„
      const landValue = result.total_land_value || 0;
      if (landValue < 50000000) { // 5ì²œë§Œì› ë¯¸ë§Œ
        strengths.push('ìƒëŒ€ì ìœ¼ë¡œ ë‚®ì€ ê³µì‹œì§€ê°€ë¡œ ì„ëŒ€ë£Œ ë¶€ë‹´ì´ ì ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤');
      } else if (landValue > 200000000) { // 2ì–µ ì´ˆê³¼
        cautions.push('ë†’ì€ ê³µì‹œì§€ê°€ë¡œ ì¸í•œ ì„ëŒ€ë£Œ ë¶€ë‹´ì´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
      }
      
      // ì™¸êµ­ì¸ ê³ ê°ì¸µ ë¶„ì„ (ìƒˆë¡œ ì¶”ê°€)
      const tempForeign1000 = result['2A_Temp_Total'] || result.temp_foreign_1000m || 0;
      const longForeign300 = result['1A_Long_Total'] || result.long_foreign_300m || 0;
      
      if (tempForeign1000 > 3000 || longForeign300 > 1000) {
        strengths.push('ì™¸êµ­ì¸ ê³ ê°ì¸µì´ í’ë¶€í•´ ë‹¤ì–‘í•œ ê³ ê° í™•ë³´ ê°€ëŠ¥');
      }
      
      // ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„ (ìƒˆë¡œ ì¶”ê°€)
      const age20 = result['2A_20'] || result.life_pop_20_1000m || 0;
      const age30 = result['2A_30'] || result.life_pop_30_1000m || 0;
      const age40 = result['2A_40'] || result.life_pop_40_1000m || 0;
      
      if (age20 > 25 || age30 > 25) {
        strengths.push('ì Šì€ ì—°ë ¹ì¸µ ë¹„ìœ¨ì´ ë†’ì•„ íŠ¸ë Œë””í•œ ì—…ì¢…ì— ìœ ë¦¬');
      } else if (age40 > 30) {
        strengths.push('ì¤‘ì¥ë…„ì¸µ ë¹„ìœ¨ì´ ë†’ì•„ ì•ˆì •ì ì¸ ì†Œë¹„ íŒ¨í„´ ê¸°ëŒ€');
      }
      
      // ìœ ë™ì¸êµ¬ ìœ ë°œì‹œì„¤ ë¶„ì„
      const publicBuilding = result.public_building_250m || 0;
      const school = result.school_250m || 0;
      if (publicBuilding > 0 || school > 0) {
        strengths.push('ì£¼ë³€ ìœ ë™ì¸êµ¬ ìœ ë°œì‹œì„¤ì´ ìˆì–´ ê³ ê° ìœ ì…ì— ìœ ë¦¬');
      }
      
      // ìƒì¡´ í™•ë¥  ë¶„ì„
      const survivalRate = result.survival_percentage || 0;
      if (survivalRate >= 80) {
        strengths.push('AI ì˜ˆì¸¡ ìƒì¡´ í™•ë¥ ì´ ë§¤ìš° ë†’ì•„ ì•ˆì •ì ì¸ ì‚¬ì—… ìš´ì˜ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤');
      } else if (survivalRate < 50) {
        cautions.push('AI ì˜ˆì¸¡ ìƒì¡´ í™•ë¥ ì´ ë‚®ì•„ ì‹ ì¤‘í•œ ì‚¬ì—… ê³„íšì´ í•„ìš”í•©ë‹ˆë‹¤');
      }
      
      // ê¸°ë³¸ ë©”ì‹œì§€ ì¶”ê°€
      if (strengths.length === 0) {
        strengths.push('í˜„ì¬ ìƒê¶Œ ì¡°ê±´ì´ í‰ê· ì ì¸ ìˆ˜ì¤€ì…ë‹ˆë‹¤');
      }
      if (cautions.length === 0) {
        cautions.push('í˜„ì¬ ìƒê¶Œ ì¡°ê±´ì´ ì–‘í˜¸í•©ë‹ˆë‹¤');
      }
      
      // ë¶„ì„ ì™„ë£Œ
      
      // HTML ìƒì„±
      const strengthsList = document.getElementById('previewStrengthsList').querySelector('ul');
      const cautionsList = document.getElementById('previewCautionsList').querySelector('ul');
      
      if (strengthsList) {
      strengthsList.innerHTML = strengths.map(item => 
        `<li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>${item}</li>`
      ).join('');
      }
      
      if (cautionsList) {
             cautionsList.innerHTML = cautions.map(item => 
         `<li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>${item}</li>`
       ).join('');
      }
     }

    // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ì—ì„œ PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê³ í’ˆì§ˆ)
    function downloadPreviewPDF() {
      if (!currentPreviewRequestId) {
        alert('ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        const element = document.getElementById('previewContent');
        
        if (!element) {
          alert('ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>ìƒì„± ì¤‘...';
        document.getElementById('previewDownloadPdfBtn').disabled = true;
        document.getElementById('previewDownloadLightPdfBtn').disabled = true;
        
        html2canvas(element, {
          scale: 1.5,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: element.offsetWidth,
          height: element.offsetHeight,
          removeContainer: true,
          imageTimeout: 0,
          logging: false
        }).then(canvas => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          
          // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚° (A4 í¬ê¸°ì— ë§ê²Œ ì¡°ì •)
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          let heightLeft = imgHeight;
          let position = 0;
          
          // JPEG í’ˆì§ˆ ì„¤ì •ìœ¼ë¡œ ìš©ëŸ‰ ì¤„ì´ê¸°
          const imgData = canvas.toDataURL('image/jpeg', 0.8);
          
          // ì²« ë²ˆì§¸ í˜ì´ì§€
          doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          
          // ì¶”ê°€ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          
          // íŒŒì¼ëª… ìƒì„±
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_ìƒê¶Œë¶„ì„_ë³´ê³ ì„œ_${currentDate}.pdf`;
          
          // PDF ë‹¤ìš´ë¡œë“œ
          doc.save(filename);
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)';
          document.getElementById('previewDownloadPdfBtn').disabled = false;
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
          
          alert('PDF ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          
        }).catch(error => {
          console.error('html2canvas ì˜¤ë¥˜:', error);
          alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)';
          document.getElementById('previewDownloadPdfBtn').disabled = false;
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
        });
        
      } catch (error) {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)';
        document.getElementById('previewDownloadPdfBtn').disabled = false;
        document.getElementById('previewDownloadLightPdfBtn').disabled = false;
      }
    }

    // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ì—ì„œ ê²½ëŸ‰ PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (í•œê¸€ í°íŠ¸ ì§€ì›)
    function downloadPreviewLightweightPDF() {
      if (!currentPreviewRequestId) {
        alert('ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>ìƒì„± ì¤‘...';
        document.getElementById('previewDownloadLightPdfBtn').disabled = true;
        document.getElementById('previewDownloadPdfBtn').disabled = true;
        
        // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜ (ê²½ëŸ‰í™” ì˜µì…˜ ì ìš©)
        const element = document.getElementById('previewContent');
        
        if (!element) {
          alert('ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        html2canvas(element, {
          scale: 0.8, // ë‚®ì€ í•´ìƒë„ë¡œ ìš©ëŸ‰ ì ˆì•½
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: element.offsetWidth,
          height: element.offsetHeight,
          removeContainer: true,
          imageTimeout: 0,
          logging: false
        }).then(canvas => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          
          // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚° (A4 í¬ê¸°ì— ë§ê²Œ ì¡°ì •)
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          let heightLeft = imgHeight;
          let position = 0;
          
          // JPEG í’ˆì§ˆì„ ë” ë‚®ì¶°ì„œ ìš©ëŸ‰ ì ˆì•½ (ê²½ëŸ‰ ë²„ì „)
          const imgData = canvas.toDataURL('image/jpeg', 0.5); // 50% í’ˆì§ˆ
          
          // ì²« ë²ˆì§¸ í˜ì´ì§€
          doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          
          // ì¶”ê°€ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          
          // íŒŒì¼ëª… ìƒì„±
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_ìƒê¶Œë¶„ì„_ê²½ëŸ‰_${currentDate}.pdf`;
          
          // PDF ë‹¤ìš´ë¡œë“œ
          doc.save(filename);
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)';
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
          document.getElementById('previewDownloadPdfBtn').disabled = false;
          
          alert('ê²½ëŸ‰ PDF ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          
        }).catch(error => {
          console.error('html2canvas ì˜¤ë¥˜:', error);
          alert('ê²½ëŸ‰ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)';
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
          document.getElementById('previewDownloadPdfBtn').disabled = false;
        });
        
      } catch (error) {
        console.error('ê²½ëŸ‰ PDF ìƒì„± ì˜¤ë¥˜:', error);
        alert('ê²½ëŸ‰ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)';
        document.getElementById('previewDownloadLightPdfBtn').disabled = false;
        document.getElementById('previewDownloadPdfBtn').disabled = false;
      }
    }

    // ì±—ë´‡ í™œì„±í™” í•¨ìˆ˜ (ë¶„ì„ ì™„ë£Œ í›„ í˜¸ì¶œ)
    function activateChatbot(analysisData) {
      // ë¶„ì„ ë°ì´í„° ì €ì¥
      currentAnalysisData = analysisData;
      
      // UI ìƒíƒœ ì „í™˜ - ë¹„í™œì„±í™” â†’ í™œì„±í™”
      const inactiveElement = document.getElementById('chatbotInactive');
      const activeElement = document.getElementById('chatbotActive');
      
      // ë¹„í™œì„±í™” ìƒíƒœ ì™„ì „íˆ ìˆ¨ê¸°ê¸°
      if (inactiveElement) {
        inactiveElement.style.setProperty('display', 'none', 'important');
        inactiveElement.style.visibility = 'hidden';
        inactiveElement.style.height = '0';
        inactiveElement.style.overflow = 'hidden';
      }
      
      // í™œì„±í™” ìƒíƒœ í‘œì‹œ
      if (activeElement) {
        activeElement.style.setProperty('display', 'flex', 'important');
        activeElement.style.visibility = 'visible';
        activeElement.style.height = 'auto';
      }
      
      const statusElement = document.getElementById('chatbotStatus');
      if (statusElement) {
        statusElement.textContent = 'ì¤€ë¹„ì™„ë£Œ';
        statusElement.className = 'badge bg-success';
      }
      
      // ì…ë ¥ í•„ë“œ í™œì„±í™”
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      
      if (chatInput) {
        chatInput.disabled = false;
        // Enter í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
        chatInput.removeEventListener('keypress', handleChatKeyPress);
        chatInput.addEventListener('keypress', handleChatKeyPress);
      }
      
      if (chatSendBtn) {
        chatSendBtn.disabled = false;
        // ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
        chatSendBtn.removeEventListener('click', sendChatMessage);
        chatSendBtn.addEventListener('click', sendChatMessage);
      }
    }

    // ì±„íŒ… í‚¤ ì…ë ¥ í•¸ë“¤ëŸ¬
    function handleChatKeyPress(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    }

    // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë¶„ì„ ê²°ê³¼ ID ì €ì¥ (ì¤‘ë³µ ì„ ì–¸ ì œê±° - ì´ë¯¸ ìƒë‹¨ì— ì„ ì–¸ë¨)
    // let currentRequestId = null; // ì¤‘ë³µ ì„ ì–¸ ì œê±°
    let currentPreviewRequestId = null;

    // PDF ìƒì„± í•¨ìˆ˜ (ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
    function generatePDF() {
      // Django í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
      const isAuthenticated = USER_AUTHENTICATED;
      
      if (!isAuthenticated) {
        document.getElementById('guestPdfMessage').style.display = 'block';
        return;
      }
      
      // í˜„ì¬ ë¶„ì„ ê²°ê³¼ë¥¼ ì‚¬ìš©í•˜ì—¬ PDF ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      if (!currentRequestId) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ìµœì‹  PDF ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ í˜¸ì¶œ
      showPdfPreview(currentRequestId);
    }
    
    // ê¸°ì¡´ PDF ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ëŠ” ì œê±°ë¨ - ìµœì‹  showPdfPreview í•¨ìˆ˜ ì‚¬ìš©

    // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (jsPDFë¡œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ìƒì„±)
    function downloadPDF() {
      if (!currentRequestId) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      document.getElementById('pdfPreviewContainer').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfGenerating').style.display = 'block';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      document.getElementById('retryPdfBtn').style.display = 'none';
      
      // ì„œë²„ì—ì„œ PDF ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetch(`/ai_analyzer/pdf-data/${currentRequestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': CSRF_TOKEN
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('PDF ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        return response.json();
      })
      .then(data => {
        // ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ê³  PDF ìƒì„±
        document.getElementById('pdfPreviewContainer').style.display = 'block';
        // jsPDFë¡œ PDF ìƒì„±
        generatePDFWithJsPDF(data);
      })
      .catch(error => {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfPreviewContainer').style.display = 'none';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message;
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      });
    }

    // ê²½ëŸ‰ PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadLightweightPDF() {
      if (!currentRequestId) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      document.getElementById('pdfPreviewContainer').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfGenerating').style.display = 'block';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      document.getElementById('downloadLightPdfBtn').style.display = 'none';
      document.getElementById('retryPdfBtn').style.display = 'none';
      
      // ì„œë²„ì—ì„œ PDF ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetch(`/ai_analyzer/pdf-data/${currentRequestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': CSRF_TOKEN
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('PDF ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        return response.json();
      })
      .then(data => {
        // ê²½ëŸ‰ PDF ìƒì„±
        generateLightweightPDF(data);
      })
      .catch(error => {
        console.error('ê²½ëŸ‰ PDF ìƒì„± ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfPreviewContainer').style.display = 'block';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message;
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        document.getElementById('downloadLightPdfBtn').style.display = 'inline-block';
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      });
    }

    // jsPDFë¥¼ ì‚¬ìš©í•œ PDF ìƒì„± (html2canvasë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜)
    function generatePDFWithJsPDF(data) {
      try {
        // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        const element = document.getElementById('pdfPreviewContainer');
        
        // PDF ìƒì„± ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'block';
        document.getElementById('downloadPdfBtn').style.display = 'none';
        
                 html2canvas(element, {
           scale: 1.2, // í•´ìƒë„ ì¡°ì • (2 -> 1.2)
           useCORS: true,
           allowTaint: true,
           backgroundColor: '#ffffff',
           width: element.offsetWidth,
           height: element.offsetHeight,
           removeContainer: true,
           imageTimeout: 0,
           logging: false
         }).then(canvas => {
           const { jsPDF } = window.jspdf;
           const doc = new jsPDF('p', 'mm', 'a4');
           
           // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚° (A4 í¬ê¸°ì— ë§ê²Œ ì¡°ì •)
           const imgWidth = 210; // A4 width in mm
           const pageHeight = 297; // A4 height in mm
           const imgHeight = (canvas.height * imgWidth) / canvas.width;
           
           let heightLeft = imgHeight;
           let position = 0;
           
           // JPEG í’ˆì§ˆ ì„¤ì •ìœ¼ë¡œ ìš©ëŸ‰ ì¤„ì´ê¸°
           const imgData = canvas.toDataURL('image/jpeg', 0.8); // JPEG, 80% í’ˆì§ˆ
           
           // ì²« ë²ˆì§¸ í˜ì´ì§€
           doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
           heightLeft -= pageHeight;
           
           // ì¶”ê°€ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
           while (heightLeft >= 0) {
             position = heightLeft - imgHeight;
             doc.addPage();
             doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
             heightLeft -= pageHeight;
           }
          
          // íŒŒì¼ëª… ìƒì„±
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_ìƒê¶Œë¶„ì„_ë³´ê³ ì„œ_${currentDate}.pdf`;
          
          // PDF ë‹¤ìš´ë¡œë“œ
          doc.save(filename);
          
          // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
          setTimeout(() => {
            const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
            if (pdfModal) {
              pdfModal.hide();
            }
          }, 1000);
          
                 }).catch(error => {
           console.error('html2canvas ì˜¤ë¥˜:', error);
           throw new Error('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
         });
        
      } catch (error) {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message || 'PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      }
    }

    // í…ìŠ¤íŠ¸ ê¸°ë°˜ PDF ìƒì„± (ìš©ëŸ‰ ìµœì í™”)
    function generateLightweightPDF(data) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // ê¸°ë³¸ í°íŠ¸ ì‚¬ìš© (í•œêµ­ì–´ëŠ” ì˜ë¬¸ìœ¼ë¡œ í‘œê¸°)
        doc.setFont('helvetica');
        
        let yPos = 20;
        const lineHeight = 7;
        const margin = 20;
        const pageWidth = 170; // í…ìŠ¤íŠ¸ ì˜ì—­ ë„ˆë¹„
        
        // ì œëª©
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('AI Commercial District Analysis Report', margin, yPos);
        yPos += lineHeight * 2;
        
        // ë¶€ì œëª©
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('AI-based Commercial Area Analysis Results', margin, yPos);
        yPos += lineHeight * 2;
        
        // êµ¬ë¶„ì„ 
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, margin + pageWidth, yPos);
        yPos += lineHeight;
        
        // ê¸°ë³¸ ì •ë³´ ì„¹ì…˜
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('1. Basic Information', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Address: ${data.basic_info.address}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Business Type: ${data.basic_info.business_type}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Area: ${data.basic_info.area}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Service Type: ${data.basic_info.service_type}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Analysis Date: ${data.basic_info.analysis_date}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // AI ë¶„ì„ ê²°ê³¼
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('2. AI Analysis Results', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(`Survival Probability: ${data.ai_analysis.survival_rate}`, margin, yPos);
        yPos += lineHeight * 1.5;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        const analysisLines = doc.splitTextToSize(data.ai_analysis.analysis_text, pageWidth);
        analysisLines.forEach(line => {
          doc.text(line, margin, yPos);
          yPos += lineHeight;
        });
        yPos += lineHeight;
        
        // í•µì‹¬ ì§€í‘œ
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('3. Key Metrics (300m radius)', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`â€¢ Living Population: ${data.key_metrics.life_pop_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Working Population: ${data.key_metrics.working_pop_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Competitors: ${data.key_metrics.competitor_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Total Land Value: ${data.key_metrics.total_land_value}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // ê²½ìŸ ë¶„ì„
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('4. Competition Analysis', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`â€¢ Competitor Count: ${data.competition_analysis.competitor_count}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Total Business: ${data.competition_analysis.total_business}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Competitor Ratio: ${data.competition_analysis.competitor_ratio}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Business Diversity: ${data.competition_analysis.business_diversity}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // ìƒˆ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        // ìƒì„¸ ë¶„ì„
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('5. Detailed Analysis', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`â€¢ Temporary Foreign Residents (1000m): ${data.detailed_analysis.temp_foreign_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Long-term Foreign Residents (300m): ${data.detailed_analysis.long_foreign_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Long-term Foreign Residents (1000m): ${data.detailed_analysis.long_foreign_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Chinese Temporary Residents (300m): ${data.detailed_analysis.temp_foreign_cn_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Chinese Temporary Residents (1000m): ${data.detailed_analysis.temp_foreign_cn_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Chinese Long-term Residents (1000m): ${data.detailed_analysis.long_foreign_cn_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Schools (250m): ${data.detailed_analysis.school_250m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Public Buildings (250m): ${data.detailed_analysis.public_building_250m}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // í•˜ë‹¨ ì •ë³´
        yPos = 280; // í˜ì´ì§€ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.text('Generated by AI-based Commercial District Analysis System', margin, yPos);
        yPos += 4;
        doc.text(`Report Date: ${new Date().toLocaleDateString('en-US')}`, margin, yPos);
        
        // íŒŒì¼ëª… ìƒì„±
        const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const filename = `AI_Analysis_Report_Light_${currentDate}.pdf`;
        
        // PDF ë‹¤ìš´ë¡œë“œ
        doc.save(filename);
        
        // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(() => {
          const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
          if (pdfModal) {
            pdfModal.hide();
          }
        }, 1000);
        
      } catch (error) {
        console.error('ê²½ëŸ‰ PDF ìƒì„± ì˜¤ë¥˜:', error);
        throw new Error('ê²½ëŸ‰ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>

  <!-- Page Title -->
  <div class="container my-6" style="margin-top: 20px; margin-bottom: 100px; ">
    
    <!-- ìƒê¶Œ ë¶„ì„ ì •ë³´ ì…ë ¥ -->
    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card p-4 shadow-sm">
          <h3 class="mb-3">
            <span data-lang="KOR">ìƒê¶Œ ì •ë³´ì…ë ¥</span>
            <span data-lang="ENG" style="display: none;">Enter Commercial Area Info</span>
            <span data-lang="ESP" style="display: none;">Ingresar InformaciÃ³n del Ãrea Comercial</span>
          </h3>

          <form>
            <div class="row g-3">
              <!-- ì—…ì¢… ì„ íƒ -->
              <div class="col-md-3">
                <label for="business_type_id" class="form-label">
                  <span data-lang="KOR">ì—…ì¢…</span>
                  <span data-lang="ENG" style="display: none;">Industry</span>
                  <span data-lang="ESP" style="display: none;">Industria</span>
                </label>
                <select class="form-select" id="business_type_id" name="business_type_id" data-lang="KOR" required>
                  <option selected disabled>ì—…ì¢…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                  <option value="0">ê°ì„±ì£¼ì </option>
                  <option value="1">ê²½ì–‘ì‹</option>
                  <option value="2">ê´€ê´‘í˜¸í…”</option>
                  <option value="3">ê·¹ì¥</option>
                  <option value="4">ê¸°íƒ€</option>
                  <option value="5">ê¸°íƒ€ íœ´ê²ŒìŒì‹ì </option>
                  <option value="6">ê¹€ë°¥(ë„ì‹œë½)</option>
                  <option value="7">ê¹Œí˜</option>
                  <option value="8">ëƒ‰ë©´ì§‘</option>
                  <option value="9">ë‹¤ë°©</option>
                  <option value="10">ë–¡ì¹´í˜</option>
                  <option value="11">ë¼ì´ë¸Œì¹´í˜</option>
                  <option value="12">ë°±í™”ì </option>
                  <option value="13">ë³µì–´ì·¨ê¸‰</option>
                  <option value="14">ë¶„ì‹</option>
                  <option value="15">ë·”í˜ì‹</option>
                  <option value="16">ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)</option>
                  <option value="17">ì•„ì´ìŠ¤í¬ë¦¼</option>
                  <option value="18">ì™¸êµ­ìŒì‹ì „ë¬¸ì (ì¸ë„, íƒœêµ­ ë“±)</option>
                  <option value="19">ìœ ì›ì§€</option>
                  <option value="20">ì¼ë°˜ì¡°ë¦¬íŒë§¤</option>
                  <option value="21">ì¼ì‹</option>
                  <option value="22">ì „í†µì°»ì§‘</option>
                  <option value="23">ì •ì¢…/ëŒ€í¬ì§‘/ì†Œì£¼ë°©</option>
                  <option value="24">ì¤‘êµ­ì‹</option>
                  <option value="25">ì² ë„ì—­êµ¬ë‚´</option>
                  <option value="26">ì¶œì¥ì¡°ë¦¬</option>
                  <option value="27">ì»¤í”¼ìˆ</option>
                  <option value="28">í‚¤ì¦ˆì¹´í˜</option>
                  <option value="29">íƒ•ë¥˜(ë³´ì‹ ìš©)</option>
                  <option value="30">í†µë‹­(ì¹˜í‚¨)</option>
                  <option value="31">íŒ¨ë°€ë¦¬ë ˆìŠ¤í† ë‘</option>
                  <option value="32">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option>
                  <option value="33">í¸ì˜ì </option>
                  <option value="34">í‘¸ë“œíŠ¸ëŸ­</option>
                  <option value="35">í•œì‹</option>
                  <option value="36">í˜¸í”„/í†µë‹­</option>
                  <option value="37">íšŸì§‘</option>
                </select>
                
                <!-- ì˜ì–´ ì—…ì¢… ì„ íƒ -->
                <select class="form-select" id="industryEng" name="business_type_id" data-lang="ENG" style="display: none;" required>
                  <option selected disabled>Please select an industry</option>
                  <option value="0">Sentimental pub</option>
                  <option value="1">Western restaurant</option>
                  <option value="2">Tourist hotel</option>
                  <option value="3">Theatre</option>
                  <option value="4">Others</option>
                  <option value="5">Other refreshment food</option>
                  <option value="6">Kimbap(lunchbox)</option>
                  <option value="7">Cafe</option>
                  <option value="8">Cold noodle restaurant</option>
                  <option value="9">Teahouse</option>
                  <option value="10">Rice cake cafe</option>
                  <option value="11">Live cafe</option>
                  <option value="12">Department store</option>
                  <option value="13">Pufferfish handling</option>
                  <option value="14">Snack bar</option>
                  <option value="15">Buffet</option>
                  <option value="16">Meat(charcoal grill)</option>
                  <option value="17">Ice cream</option>
                  <option value="18">Foreign food specialty(Indian, Thai, etc.)</option>
                  <option value="19">Amusement park</option>
                  <option value="20">General cooking sales</option>
                  <option value="21">Japanese food</option>
                  <option value="22">Traditional tea house</option>
                  <option value="23">Rice wine/draft beer/soju bar</option>
                  <option value="24">Chinese food</option>
                  <option value="25">Railway station</option>
                  <option value="26">Catering</option>
                  <option value="27">Coffee shop</option>
                  <option value="28">Kids cafe</option>
                  <option value="29">Soup(health food)</option>
                  <option value="30">Whole chicken(fried chicken)</option>
                  <option value="31">Family restaurant</option>
                  <option value="32">Fast food</option>
                  <option value="33">Convenience store</option>
                  <option value="34">Food truck</option>
                  <option value="35">Korean food</option>
                  <option value="36">Beer/chicken pub</option>
                  <option value="37">Raw fish restaurant</option>
                </select>
                
                <!-- ìŠ¤í˜ì¸ì–´ ì—…ì¢… ì„ íƒ -->
                <select class="form-select" id="industryEsp" name="business_type_id" data-lang="ESP" style="display: none;" required>
                  <option selected disabled>Por favor seleccione una industria</option>
                  <option value="0">Pub sentimental</option>
                  <option value="1">Restaurante occidental</option>
                  <option value="2">Hotel turÃ­stico</option>
                  <option value="3">Teatro</option>
                  <option value="4">Otros</option>
                  <option value="5">Otra comida refrescante</option>
                  <option value="6">Kimbap(fiambrera)</option>
                  <option value="7">CafÃ©</option>
                  <option value="8">Restaurante de fideos frÃ­os</option>
                  <option value="9">Casa de tÃ©</option>
                  <option value="10">CafÃ© de pastel de arroz</option>
                  <option value="11">CafÃ© en vivo</option>
                  <option value="12">Grandes almacenes</option>
                  <option value="13">Manejo de pez globo</option>
                  <option value="14">Bar de aperitivos</option>
                  <option value="15">Buffet</option>
                  <option value="16">Carne(parrilla de carbÃ³n)</option>
                  <option value="17">Helado</option>
                  <option value="18">Especialidad de comida extranjera(India, Tailandia, etc.)</option>
                  <option value="19">Parque de atracciones</option>
                  <option value="20">Ventas de cocina general</option>
                  <option value="21">Comida japonesa</option>
                  <option value="22">Casa de tÃ© tradicional</option>
                  <option value="23">Vino de arroz/cerveza de barril/bar de soju</option>
                  <option value="24">Comida china</option>
                  <option value="25">EstaciÃ³n de ferrocarril</option>
                  <option value="26">Catering</option>
                  <option value="27">CafeterÃ­a</option>
                  <option value="28">CafÃ© para niÃ±os</option>
                  <option value="29">Sopa(comida saludable)</option>
                  <option value="30">Pollo entero(pollo frito)</option>
                  <option value="31">Restaurante familiar</option>
                  <option value="32">Comida rÃ¡pida</option>
                  <option value="33">Tienda de conveniencia</option>
                  <option value="34">CamiÃ³n de comida</option>
                  <option value="35">Comida coreana</option>
                  <option value="36">Pub de cerveza/pollo</option>
                  <option value="37">Restaurante de pescado crudo</option>
                </select>
              </div>

              <!-- ì£¼ì†Œ ì…ë ¥ -->
              <div class="col-md-3">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="x_coord" name="x_coord">
                <input type="hidden" id="y_coord" name="y_coord">
                
                <label for="address" class="form-label" data-lang="KOR">ì£¼ì†Œ</label>
                <label for="address" class="form-label" data-lang="ENG" style="display: none;">Address</label>
                <label for="address" class="form-label" data-lang="ESP" style="display: none;">DirecciÃ³n</label>
                
                <div class="input-group">
                  <input type="text" class="form-control lang-input" id="address" name="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" data-lang="KOR">
                  <button class="btn btn-outline-secondary lang-btn" type="button" onclick="openAddressSearch()" data-lang="KOR">ê²€ìƒ‰</button>
                  
                  <input type="text" class="form-control lang-input" id="addressEng" name="address" placeholder="Please enter your address" data-lang="ENG" style="display: none;">
                  <button class="btn btn-outline-secondary lang-btn" type="button" onclick="openAddressSearch()" data-lang="ENG" style="display: none;">Search</button>
                  
                  <input type="text" class="form-control lang-input" id="addressEsp" name="address" placeholder="Por favor ingrese la direcciÃ³n" data-lang="ESP" style="display: none;">
                  <button class="btn btn-outline-secondary lang-btn" type="button" onclick="openAddressSearch()" data-lang="ESP" style="display: none;">Buscar</button>
                </div>
              </div>

              <!-- ì í¬ ë©´ì  ì…ë ¥ -->
              <div class="col-md-3">
                <label for="area" class="form-label" data-lang="KOR">ì í¬ ë©´ì  (ã¡)</label>
                <label for="area" class="form-label" data-lang="ENG" style="display: none;">Store Area (ã¡)</label>
                <label for="area" class="form-label" data-lang="ESP" style="display: none;">Ãrea del local (ã¡)</label>
                <input type="number" class="form-control" id="area" name="area" placeholder="ì˜ˆ: 33.2" required>
              </div>

              <!-- ì£¼ë¥˜ íŒë§¤ ì—¬ë¶€ ì„ íƒ -->
              <div class="col-md-3">
                <label for="service_type" class="form-label">
                  <span data-lang="KOR">ì£¼ë¥˜ íŒë§¤ ì—¬ë¶€</span>
                  <span data-lang="ENG" style="display: none;">Alcohol Sale</span>
                  <span data-lang="ESP" style="display: none;">Venta de alcohol</span>
                </label>
                <select class="form-select" id="service_type" name="service_type" required>
                  <option selected disabled data-lang="KOR">ì„ íƒ</option>
                  <option disabled style="display: none;" data-lang="ENG">Choose</option>
                  <option disabled style="display: none;" data-lang="ESP">Seleccionar</option>
                  
                  <option value="1" data-lang="KOR">íŒë§¤í•¨</option>
                  <option value="1" data-lang="ENG" style="display: none;">Yes</option>
                  <option value="1" data-lang="ESP" style="display: none;">SÃ­</option>
                  
                  <option value="0" data-lang="KOR">íŒë§¤ ì•ˆí•¨</option>
                  <option value="0" data-lang="ENG" style="display: none;">No</option>
                  <option value="0" data-lang="ESP" style="display: none;">No</option>
                </select>
              </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-primary custom px-5" onclick="getFormData();">
                <span data-lang="KOR">ìƒê¶Œ ë¶„ì„í•˜ê¸°</span>
                <span data-lang="ENG" style="display: none;">Analyze Commercial Area</span>
                <span data-lang="ESP" style="display: none;">Analizar Zona Comercial</span>
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>  <!-- ìƒê¶Œ ì •ë³´ ì…ë ¥ ì¹´ë“œ ë -->

    <!-- ğŸ“ ìµœê·¼ ë¶„ì„ ê²°ê³¼ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ) -->
    {% if user.is_authenticated %}
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="accordion mb-4" id="analysisHistoryAccordion">
          <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="analysisHistoryHeading">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#analysisHistoryCollapse" aria-expanded="false" aria-controls="analysisHistoryCollapse">
                <i class="bi bi-person-check me-2"></i>
                <strong>
                  <span data-lang="KOR">ğŸ“ ë‚´ ìµœê·¼ ë¶„ì„ ê¸°ë¡</span>
                  <span data-lang="ENG" style="display: none;">ğŸ“ My Recent Analyses</span>
                  <span data-lang="ESP" style="display: none;">ğŸ“ Mis anÃ¡lisis recientes</span>
                </strong>
                <small class="text-muted ms-2">({{ user.username }}ë‹˜ì˜ ê°œì¸ ê¸°ë¡{% if previous_docs %} - {{ previous_docs|length }}ê°œ{% endif %})</small>
              </button>
            </h2>
            <div id="analysisHistoryCollapse" class="accordion-collapse collapse" aria-labelledby="analysisHistoryHeading" data-bs-parent="#analysisHistoryAccordion">
              <div class="accordion-body">
          {% if previous_docs %}
                  <ul class="list-group list-group-flush">
              {% for doc in previous_docs %}
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                  <div>
                          <strong>ë¶„ì„ ID: {{ doc.request.id }}</strong>
                          <span class="badge bg-{% if doc.survival_percentage >= 80 %}success{% elif doc.survival_percentage >= 60 %}warning{% else %}danger{% endif %} ms-2">
                            {{ doc.survival_percentage|floatformat:1 }}%
                          </span>
                          <br>
                          <small class="text-muted">
                            <i class="bi bi-geo-alt me-1"></i>{{ doc.request.address|truncatechars:50 }}
                          </small><br>
                          <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>{{ doc.created_at|date:"Y-m-d H:i" }}
                            <i class="bi bi-shop ms-3 me-1"></i>{{ doc.request.business_type.name }}
                          </small>
                  </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="showPdfPreview({{ doc.request.id }})">
                          <i class="bi bi-eye me-1"></i>ê²°ê³¼ë³´ê¸°
                        </button>
                </li>
              {% endfor %}
            </ul>
                  {% if previous_docs|length > 5 %}
                    <div class="text-center mt-3">
                      <small class="text-muted">ìµœê·¼ {{ previous_docs|length }}ê°œ ê¸°ë¡ ì¤‘ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</small>
                    </div>
                  {% endif %}
          {% else %}
                  <div class="text-center p-3">
                    <i class="bi bi-folder2-open text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">ì•„ì§ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-muted small">ìœ„ì˜ ì–‘ì‹ì„ ì‘ì„±í•˜ì—¬ ì²« ë²ˆì§¸ ìƒê¶Œ ë¶„ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                  </div>
          {% endif %}
        </div>
      </div>
    </div>
        </div>
      </div>
    </div>
    {% else %}
    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì•ˆë‚´ -->
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="card p-4 shadow-sm mb-4 border-warning">
          <h4 class="mb-3 text-warning">
            <i class="bi bi-person-x me-2"></i>ê°œì¸ ë¶„ì„ ê¸°ë¡
          </h4>
          <div class="text-center p-3">
            <i class="bi bi-lock text-warning" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">ë¶„ì„ ê¸°ë¡ì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <a href="{% url 'custom_auth:login' %}?next={{ request.get_full_path }}" class="btn btn-warning">
              <i class="bi bi-box-arrow-in-right me-1"></i>ë¡œê·¸ì¸í•˜ê¸°
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  
    <!-- ë³¸ë¬¸: ë¶„ì„ ê²°ê³¼ + ì±—ë´‡ -->
    <div class="row">
      <!-- ì™¼ìª½: ë¶„ì„ ë¦¬í¬íŠ¸ -->
      <div class="col-lg-8 mb-4 analysis-container">
        <div class="card p-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">
              <span data-lang="KOR">ìƒê¶Œ ë¶„ì„ ê²°ê³¼</span>
              <span data-lang="ENG" style="display: none;">Commercial Area Analysis Result</span>
              <span data-lang="ESP" style="display: none;">Resultado del AnÃ¡lisis Comercial</span>
            </h4>
            <!-- ëª¨ë‹¬ ë²„íŠ¼ -->
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#explanationModal">
              ìƒê¶Œ ë¶„ì„ ë„ì›€ë§
            </button>
            
            <!-- Bootstrap ëª¨ë‹¬ -->
            <div class="modal fade" id="explanationModal" tabindex="-1" aria-labelledby="explanationModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="explanationModalLabel">ìƒê¶Œ ë¶„ì„ì´ë€ ë¬´ì—‡ì¸ê°€?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                  </div>
                  <div class="modal-body">
                    ìƒê¶Œë¶„ì„ì€ íŠ¹ì • ì§€ì—­ ë‚´ ì í¬ë‚˜ ì‚¬ì—…ì¥ì˜ ê²½ì œì  í™˜ê²½ê³¼ ì†Œë¹„ì íŠ¹ì„±ì„ ì²´ê³„ì ìœ¼ë¡œ ì¡°ì‚¬í•˜ì—¬<br>
                    ì‚¬ì—… ì„±ê³µ ê°€ëŠ¥ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ì¤‘ìš”í•œ ê³¼ì •ì…ë‹ˆë‹¤.<br><br>
            
                    <strong>ì™œ ìƒê¶Œë¶„ì„ì´ í•„ìš”í•œê°€ìš”?</strong><br>
                    - ìƒê¶Œì˜ ì†Œë¹„ íŒ¨í„´ê³¼ ìœ ë™ ì¸êµ¬ë¥¼ íŒŒì•…í•˜ì—¬ íš¨ìœ¨ì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ì„¸ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    - ê²½ìŸ ì—…ì²´ í˜„í™©ê³¼ ê³ ê° ìˆ˜ìš”ë¥¼ ë¶„ì„í•´ ì ì ˆí•œ ì…ì§€ì™€ ì„œë¹„ìŠ¤ë¥¼ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    - íˆ¬ì ìœ„í—˜ì„ ìµœì†Œí™”í•˜ê³  ì•ˆì •ì ì¸ ë§¤ì¶œì„ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
            
                    <strong>AI ê¸°ë°˜ ìƒê¶Œë¶„ì„ì€ ë‹¤ìŒì„ ì œê³µí•©ë‹ˆë‹¤:</strong><br>
                    - ì í¬ì˜ ìƒì¡´ í™•ë¥  ì˜ˆì¸¡<br>
                    - SHAP ìš”ì¸ ë¶„ì„<br><br>
            
                    ì„±ê³µì ì¸ ì°½ì—…ê³¼ ìš´ì˜ì„ ìœ„í•´<br>
                    ì •í™•í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ëµì„ ì„¸ì›Œë³´ì„¸ìš”!
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë¶„ì„ ëŒ€ê¸° ë©”ì‹œì§€ -->
          <div id="analysisWaiting">
            <div class="text-center p-4">
              <i class="bi bi-analytics text-muted" style="font-size: 3rem;"></i>
              <h5 class="mt-3 text-muted">ìƒê¶Œ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</h5>
              <p class="text-muted">ìœ„ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  'ìƒê¶Œ ë¶„ì„í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>ì´ ì˜ì—­ì— ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
              <button class="btn btn-outline-secondary mt-3" disabled>
                <i class="bi bi-file-earmark-pdf me-2"></i>PDFë¡œ ì €ì¥
              </button>
            </div>
          </div>
          
          <!-- ë¶„ì„ ì§„í–‰ ìƒí™© UI -->
          <div id="analysisProgress" class="analysis-progress" style="display: none;">
            <h5 class="text-center mb-4">
              <i class="bi bi-cpu me-2"></i>
              AIê°€ ìƒê¶Œì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </h5>
            
            <div class="overall-progress">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">ì „ì²´ ì§„í–‰ë¥ </span>
                <span id="overallPercent">0%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-primary" id="overallProgressBar" style="width: 0%"></div>
              </div>
            </div>
            
            <div id="progressSteps">
              <div class="progress-step" id="step-population">
                <div class="progress-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ìƒí™œì¸êµ¬ ë¶„ì„</div>
                  <div class="progress-detail">300m/1000m ë°˜ê²½ ë‚´ ìƒí™œì¸êµ¬ ë° ì—°ë ¹ëŒ€ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-working">
                <div class="progress-icon">
                  <i class="bi bi-briefcase"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ì§ì¥ì¸êµ¬ ë¶„ì„</div>
                  <div class="progress-detail">300m ë°˜ê²½ ë‚´ ì§ì¥ì¸êµ¬ ë¶„í¬ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-foreign">
                <div class="progress-icon">
                  <i class="bi bi-globe"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ì™¸êµ­ì¸ ë¶„ì„</div>
                  <div class="progress-detail">ë‹¨ê¸°/ì¥ê¸°ì²´ë¥˜ì™¸êµ­ì¸ ë¶„í¬ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-facilities">
                <div class="progress-icon">
                  <i class="bi bi-building"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ì£¼ë³€ì‹œì„¤ ë¶„ì„</div>
                  <div class="progress-detail">í•™êµ, ê³µê³µê±´ë¬¼ ë“± ìœ ë™ì¸êµ¬ ì‹œì„¤ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-competition">
                <div class="progress-icon">
                  <i class="bi bi-shop"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ê²½ìŸì—…ì²´ ë¶„ì„</div>
                  <div class="progress-detail">ë™ì¼ì—…ì¢… ë° ìš”ì‹ì—…ì²´ ê²½ìŸê°•ë„ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-land">
                <div class="progress-icon">
                  <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ê³µì‹œì§€ê°€ ë¶„ì„</div>
                  <div class="progress-detail">í† ì§€ê°€ì¹˜ ë° ì„ëŒ€ë£Œ ì¶”ì •</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-ai">
                <div class="progress-icon">
                  <i class="bi bi-cpu"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">AI ì˜ˆì¸¡ ë¶„ì„</div>
                  <div class="progress-detail">ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ í†µí•œ ìƒì¡´í™•ë¥  ì˜ˆì¸¡</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-complete">
                <div class="progress-icon">
                  <i class="bi bi-check-lg"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ë¶„ì„ ì™„ë£Œ</div>
                  <div class="progress-detail">ê²°ê³¼ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë¶„ì„ ê²°ê³¼ ë‚´ìš© (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
          <div id="analysisResults" style="display: none;">
            
            <!-- ìœ„ì¹˜ ì •ë³´ -->
            <div class="alert alert-info mb-4">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-2">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    <span id="resultAddress"></span>
                  </h5>
                  <div class="row">
                    <div class="col-md-4">
                      <strong>ì—…ì¢…:</strong> <span id="resultBusinessType"></span>
                    </div>
                    <div class="col-md-4">
                      <strong>ë©´ì :</strong> <span id="resultArea"></span>ã¡
                    </div>
                    <div class="col-md-4">
                      <strong>ìœ í˜•:</strong> <span id="resultServiceType"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <small class="text-muted">ë¶„ì„ì™„ë£Œ</small>
                </div>
              </div>
            </div>

            <!-- í•µì‹¬ ì§€í‘œ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-speedometer me-2"></i>í•µì‹¬ ì§€í‘œ
              </h5>
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="lifePop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m ë‚´ ìƒí™œì¸êµ¬</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="workingPop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m ë‚´ ì§ì¥ì¸êµ¬</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="competitor300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">ë™ì¼ì—…ì¢… ê²½ìŸì—…ì²´</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="totalLandValue" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">ì´ ê³µì‹œì§€ê°€</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI ì˜ˆì¸¡ ìƒì¡´ í™•ë¥  -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-cpu me-2"></i>AI ì˜ˆì¸¡ ë¶„ì„
              </h5>
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="text-center">
                    <div class="display-1 fw-bold mb-3" id="survivalPercentage">-%</div>
                    <h4 class="mb-3">ì¥ê¸° ìƒì¡´ í™•ë¥ </h4>
                    <div class="progress" style="height: 25px;">
                      <div id="survivalBar" class="progress-bar" style="width: 0%; transition: width 0.6s ease;"></div>
                    </div>
                    <div class="mt-2">
                      <span id="survivalBarText" class="badge fs-6" style="font-size: 1rem; font-weight: 500;">ë¶„ì„ì¤‘...</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="p-3">
                    <h6 class="mb-3">AI ë¶„ì„ ê²°ê³¼</h6>
                    <div id="survivalAnalysis" class="alert">
                      <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      AI ëª¨ë¸ì´ 25ê°œ ì§€í‘œë¥¼ ì¢…í•© ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- ìƒê¶Œ ê²½ìŸ ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-shop me-2"></i>ìƒê¶Œ ê²½ìŸ ë¶„ì„ (300m ë°˜ê²½)
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-3">
                  <h6>ê²½ìŸì—…ì²´ ìˆ˜</h6>
                  <div class="h4 text-danger" id="competitorCount">-</div>
                </div>
                <div class="col-md-3">
                  <h6>ì „ì²´ ìš”ì‹ì—…ì²´</h6>
                  <div class="h4 text-info" id="adjacentBiz">-</div>
                </div>
                <div class="col-md-3">
                  <h6>ê²½ìŸì—…ì²´ ë¹„ìœ¨</h6>
                  <div class="h4 text-warning" id="competitorRatio">-%</div>
                </div>
                <div class="col-md-3">
                  <h6>ì—…ì¢… ë‹¤ì–‘ì„±</h6>
                  <div class="h4 text-success" id="businessDiversity">-</div>
                </div>
              </div>
              
              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">ê²½ìŸ ê°•ë„ ë¶„ì„</h6>
                  <span id="competitionLevel" class="badge fs-6" style="font-size: 1.1rem; font-weight: 500;">ë¶„ì„ì¤‘...</span>
                  </div>
                <div class="progress" style="height: 40px;">
                  <div id="competitionBar" class="progress-bar" style="width: 0%; transition: width 0.6s ease;"></div>
                </div>
                <small class="text-muted mt-2 d-block">
                  ê²½ìŸì—…ì²´ ë¹„ìœ¨ì´ 20% ì´í•˜ë©´ ë‚®ìŒ, 20-50%ëŠ” ë³´í†µ, 50% ì´ìƒì€ ë†’ìŒìœ¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
                </small>
              </div>
            </div>

            <!-- ì¸êµ¬ êµ¬ì„± ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-people me-2"></i>ì¸êµ¬ êµ¬ì„± ë¶„ì„ (1000m ë°˜ê²½)
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-3">ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¹„ìœ¨</h6>
                      <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="ageChart" style="max-height: 300px; max-width: 100%;"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title mb-3">ì—°ë ¹ëŒ€ë³„ ìƒì„¸ ì •ë³´</h6>
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FF6384;" id="age20Percent">-%</div>
                            <small class="text-muted">20ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #36A2EB;" id="age30Percent">-%</div>
                            <small class="text-muted">30ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FFCE56;" id="age40Percent">-%</div>
                            <small class="text-muted">40ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #4BC0C0;" id="age50Percent">-%</div>
                            <small class="text-muted">50ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #9966FF;" id="age60Percent">-%</div>
                            <small class="text-muted">60ëŒ€ ì´ìƒ</small>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3 text-center">
                        <small class="text-muted">
                          <i class="bi bi-info-circle me-1"></i>
                          1000m ë°˜ê²½ ë‚´ ìƒí™œì¸êµ¬ ê¸°ì¤€
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì™¸êµ­ì¸ ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-globe me-2"></i>ì™¸êµ­ì¸ ë¶„ì„
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-airplane text-primary mb-2" style="font-size: 2rem;"></i>
                      <h6>ë‹¨ê¸°ì²´ë¥˜ ì™¸êµ­ì¸</h6>
                      <div class="h4 text-primary" id="tempForeign1000">-</div>
                      <small class="text-muted">1000m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-house text-success mb-2" style="font-size: 2rem;"></i>
                      <h6>ì¥ê¸°ì²´ë¥˜ ì™¸êµ­ì¸</h6>
                      <div class="h4 text-success" id="longForeign300">-</div>
                      <small class="text-muted">300m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-flag text-warning mb-2" style="font-size: 2rem;"></i>
                      <h6>ì¥ê¸°ì²´ë¥˜ ì¤‘êµ­ì¸ ë¹„ìœ¨</h6>
                      <div class="h4 text-warning" id="longForeignCNRatio300">-</div>
                      <small class="text-muted">1000m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ë¶„ì„ ìš”ì•½ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-lightbulb me-2"></i>AI ë¶„ì„ ìš”ì•½
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">
                    <i class="bi bi-check-circle me-2"></i>ê°•ì 
                  </h6>
                  <ul id="strengthsList">
                    <!-- ê°•ì  ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­
                  </h6>
                  <ul id="cautionsList">
                    <!-- ì£¼ì˜ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                  </ul>
                </div>
              </div>
            </div>

            <!-- PDF ì €ì¥ ë²„íŠ¼ -->
            <div class="text-center">
              <button id="pdfSaveBtn" class="btn btn-primary" onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>PDFë¡œ ì €ì¥
              </button>
              <div id="guestPdfMessage" style="display: none;" class="alert alert-info mt-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>ë¹„íšŒì› ì œí•œ:</strong> PDF ì €ì¥ ê¸°ëŠ¥ì€ íšŒì›ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                <a href="{% url 'custom_auth:login' %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-primary ms-2">ë¡œê·¸ì¸í•˜ê¸°</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ë¶„ì„ê²°ê³¼ ì±—ë´‡ -->
      <div class="col-lg-4">
        <div class="card p-4 shadow-sm chatbot-sticky" style="height: 750px; max-height: 750px; overflow: hidden;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ë¶„ì„ê²°ê³¼ ìƒë‹´</h5>
            <span class="badge bg-secondary" id="chatbotStatus">ëŒ€ê¸°ì¤‘</span>
          </div>
          
          <!-- ì±—ë´‡ ì»¨í…Œì´ë„ˆ -->
          <div id="chatbotContainer" class="d-flex flex-column h-100">
            
            <!-- ë¹„í™œì„±í™” ìƒíƒœ (ê¸°ë³¸) - ê°„ë‹¨í•œ ì•ˆë‚´ë§Œ -->
            <div id="chatbotInactive" class="text-center d-flex flex-column justify-content-center h-100">
              <i class="bi bi-chat-dots text-muted mb-3" style="font-size: 4rem;"></i>
              <h5 class="text-muted mb-3">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</h5>
              {% if not user.is_authenticated %}
                <p class="text-muted mb-3">ìƒê¶Œ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´<br>AIì™€ ìƒë‹´í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <a href="{% url 'custom_auth:login' %}?next={{ request.get_full_path }}" class="btn btn-primary btn-sm">
                  <i class="bi bi-box-arrow-in-right me-2"></i>ë¡œê·¸ì¸í•˜ê¸°
                </a>
              {% else %}
                <p class="text-muted mb-3">ìƒê¶Œ ë¶„ì„ì„ ì™„ë£Œí•˜ë©´<br>AI ìƒë‹´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="d-flex align-items-center justify-content-center">
                  <i class="bi bi-lock me-2 text-secondary"></i>
                  <span class="text-secondary small">ë¶„ì„ ì™„ë£Œ í›„ ìë™ í™œì„±í™”</span>
                </div>
              {% endif %}
          </div>

            <!-- í™œì„±í™” ìƒíƒœ (ë¶„ì„ ì™„ë£Œ í›„) - ì™„ì „í•œ ì±—ë´‡ UI -->
            <div id="chatbotActive" class="d-flex flex-column h-100" style="display: none !important;">
              
              <!-- ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ -->
              <div class="mb-3">
                <small class="text-muted">ğŸ’¡ ì¶”ì²œ ì§ˆë¬¸</small>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-primary me-1 mb-1" onclick="fillExampleQuestion('ì´ ìƒê¶Œì˜ ìƒì¡´ í™•ë¥ ì´ ë†’ì€ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?')">
                    <i class="bi bi-graph-up me-1"></i>ìƒì¡´ í™•ë¥ 
                  </button>
                  <button class="btn btn-sm btn-outline-warning me-1 mb-1" onclick="fillExampleQuestion('ê²½ìŸì—…ì²´ê°€ ë§ì€ í¸ì¸ê°€ìš”?')">
                    <i class="bi bi-shop me-1"></i>ê²½ìŸ í˜„í™©
                  </button>
                  <button class="btn btn-sm btn-outline-success me-1 mb-1" onclick="fillExampleQuestion('ì°½ì—… ì‹œ ì£¼ì˜í•´ì•¼ í•  ì ì€ ë¬´ì—‡ì¸ê°€ìš”?')">
                    <i class="bi bi-exclamation-triangle me-1"></i>ì£¼ì˜ì‚¬í•­
                  </button>
                </div>
          </div>

              <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
              <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3 border rounded p-3" style="background-color: #f8f9fa; min-height: 420px;">
                <div class="d-flex align-items-start mb-3">
                  <div class="bg-gradient bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; min-width: 36px;">
                    <i class="bi bi-robot text-white" style="font-size: 16px;"></i>
        </div>
                  <div class="flex-grow-1">
                    <div class="bg-white rounded-3 p-3 shadow-sm border">
                      <div class="d-flex align-items-center mb-2">
                        <strong class="text-primary me-2">ë¶„ì„ê²°ê³¼ ìƒë‹´ AI</strong>
                        <span class="badge bg-success-subtle text-success">ì˜¨ë¼ì¸</span>
                      </div>
                      <p class="mb-0">ì•ˆë…•í•˜ì„¸ìš”! ğŸ¯ ë°©ê¸ˆ ì™„ë£Œëœ ìƒê¶Œ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”.<br><br>
                      <strong>ìƒë‹´ ê°€ëŠ¥í•œ ë‚´ìš©:</strong><br>
                      â€¢ ğŸ“Š AI ìƒì¡´ í™•ë¥  í•´ì„<br>
                      â€¢ ğŸ‘¥ ì¸êµ¬ ë° ê³ ê°ì¸µ ë¶„ì„<br>
                      â€¢ ğŸª ê²½ìŸì—…ì²´ í˜„í™©<br>
                      â€¢ ğŸ’° ìˆ˜ìµì„± ì „ë§<br>
                      â€¢ ğŸš€ ì°½ì—… ì „ëµ ì¡°ì–¸</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ì…ë ¥ ì˜ì—­ -->
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">
                    <i class="bi bi-shield-check me-1"></i>
                    í˜„ì¬ ë¶„ì„ ì„¸ì…˜ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€
                  </small>
                  <button class="btn btn-sm btn-outline-secondary" onclick="openChatbotPIP()" title="í™•ëŒ€ ë³´ê¸°">
                    <i class="bi bi-arrows-fullscreen"></i>
                  </button>
                </div>
                <div class="input-group">
                  <input type="text" id="chatInput" class="form-control" placeholder="ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”..." disabled>
                  <button class="btn btn-primary" id="chatSendBtn" type="button" disabled>
                    <i class="bi bi-send-fill"></i>
                  </button>
                </div>
                <div id="chatConnectionStatus" class="mt-2" style="display: none;">
                  <small class="text-primary">
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    AI ì—°ê²° ì¤‘...
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (ë¶„ì„ ê¸°ë¡ìš©) -->
  <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfPreviewModalLabel">
            <i class="bi bi-file-earmark-pdf me-2"></i>ë¶„ì„ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
          <div id="previewLoading" class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
            </div>
            <h6>ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</h6>
            <p class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
          </div>
          
          <div id="previewError" style="display: none;" class="text-center">
            <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h6>ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h6>
            <p class="text-muted" id="previewErrorMessage">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
          </div>
          
          <!-- PDF ìŠ¤íƒ€ì¼ ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© -->
          <div id="previewContent" style="display: none; background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Nanum Gothic', Arial, sans-serif;">
            <!-- í—¤ë” -->
            <div class="text-center mb-4" style="border-bottom: 3px solid #1e3a8a; padding-bottom: 20px;">
              <h2 class="text-primary mb-1" style="font-weight: 800; font-size: 24px;">AI ìƒê¶Œë¶„ì„ ë³´ê³ ì„œ</h2>
              <p class="text-muted mb-0" style="font-size: 14px;">ì¸ê³µì§€ëŠ¥ ê¸°ë°˜ ìƒì—…ì§€êµ¬ ë¶„ì„ ê²°ê³¼</p>
            </div>
            
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="mb-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #1e3a8a;">
              <h5 class="text-primary mb-3"><i class="bi bi-geo-alt me-2"></i>ë¶„ì„ ëŒ€ìƒ ì •ë³´</h5>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>ì£¼ì†Œ:</strong> <span id="previewAddr">-</span></p>
                  <p><strong>ì—…ì¢…:</strong> <span id="previewBizType">-</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>ë©´ì :</strong> <span id="previewAreaSize">-</span>ã¡</p>
                  <p><strong>ë¶„ì„ì¼ì‹œ:</strong> <span id="previewAnalysisDate">-</span></p>
                </div>
              </div>
            </div>
            
            <!-- AI ìƒì¡´ í™•ë¥  -->
            <div class="mb-4" style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <h5 class="text-success mb-3"><i class="bi bi-robot me-2"></i>AI ìƒì¡´ í™•ë¥ </h5>
              <div class="display-4 mb-3 text-primary" id="previewSurvivalRate" style="font-weight: 800;">-%</div>
              <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar" id="previewSurvivalProgressBar" role="progressbar" style="width: 0%"></div>
              </div>
              <p class="text-muted mb-0" id="previewSurvivalComment">ë¶„ì„ ì¤‘...</p>
            </div>
            
            <!-- í•µì‹¬ ì§€í‘œ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-speedometer me-2"></i>í•µì‹¬ ì§€í‘œ</h5>
              <div class="row">
                <div class="col-md-3">
                  <div class="card border-info h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">ìƒí™œì¸êµ¬</h6>
                      <p class="card-text fw-bold text-primary" id="previewLifePopulation">-</p>
                      <small class="text-muted">300m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-warning h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">ì§ì¥ì¸êµ¬</h6>
                      <p class="card-text fw-bold text-primary" id="previewWorkingPopulation">-</p>
                      <small class="text-muted">300m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-danger h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">ê²½ìŸì—…ì²´</h6>
                      <p class="card-text fw-bold text-primary" id="previewCompetitors">-</p>
                      <small class="text-muted">300m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-secondary h-100 text-center">
                    <div class="card-body">
                      <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                      <h6 class="card-title">ê³µì‹œì§€ê°€</h6>
                      <p class="card-text fw-bold text-primary" id="previewLandPrice">-</p>
                      <small class="text-muted">ì´ ê³µì‹œì§€ê°€</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê²½ìŸê°•ë„ ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-shop me-2"></i>ê²½ìŸê°•ë„ ë¶„ì„</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title">ê²½ìŸì—…ì²´ í˜„í™©</h6>
                      <div class="row g-2 text-center">
                        <div class="col-6">
                          <div class="p-2 border rounded">
                            <div class="h5 text-danger" id="previewCompetitorCount">-</div>
                            <small class="text-muted">ë™ì¼ì—…ì¢…</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="p-2 border rounded">
                            <div class="h5 text-warning" id="previewAdjacentBiz">-</div>
                            <small class="text-muted">ì¸ì ‘ì—…ì²´</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title">ê²½ìŸ ê°•ë„</h6>
                      <div class="progress mb-2" style="height: 30px;">
                                                 <div id="previewCompetitionBar" class="progress-bar" style="width: 0%;"></div>
                      </div>
                      <div class="text-center">
                        <span id="previewCompetitionLevel" class="badge fs-6">ë¶„ì„ì¤‘...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì™¸êµ­ì¸ ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-globe me-2"></i>ì™¸êµ­ì¸ ë¶„ì„</h5>
              <div class="row g-3 text-center">
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-airplane text-primary mb-2" style="font-size: 1.5rem;"></i>
                      <h6>ë‹¨ê¸°ì²´ë¥˜ ì™¸êµ­ì¸</h6>
                      <div class="h5 text-primary" id="previewTempForeign">-</div>
                      <small class="text-muted">1000m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-house text-success mb-2" style="font-size: 1.5rem;"></i>
                      <h6>ì¥ê¸°ì²´ë¥˜ ì™¸êµ­ì¸</h6>
                      <div class="h5 text-success" id="previewLongForeign">-</div>
                      <small class="text-muted">300m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-body">
                      <i class="bi bi-flag text-warning mb-2" style="font-size: 1.5rem;"></i>
                      <h6>ì¤‘êµ­ì¸ ë¹„ìœ¨</h6>
                      <div class="h5 text-warning" id="previewChinaRatio">-</div>
                      <small class="text-muted">1000m ë°˜ê²½</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-people me-2"></i>ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„ (1000m ë°˜ê²½)</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-3">ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¹„ìœ¨</h6>
                      <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="previewAgeChart" style="max-height: 250px; max-width: 100%;"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title mb-3">ì—°ë ¹ëŒ€ë³„ ìƒì„¸ ì •ë³´</h6>
                      <div class="row g-2">
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FF6384;" id="previewAge20">-%</div>
                            <small class="text-muted">20ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #36A2EB;" id="previewAge30">-%</div>
                            <small class="text-muted">30ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #FFCE56;" id="previewAge40">-%</div>
                            <small class="text-muted">40ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #4BC0C0;" id="previewAge50">-%</div>
                            <small class="text-muted">50ëŒ€</small>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="text-center p-2 border rounded">
                            <div class="fw-bold" style="color: #9966FF;" id="previewAge60">-%</div>
                            <small class="text-muted">60ëŒ€ ì´ìƒ</small>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3 text-center">
                        <small class="text-muted">
                          <i class="bi bi-info-circle me-1"></i>
                          1000m ë°˜ê²½ ë‚´ ìƒí™œì¸êµ¬ ê¸°ì¤€
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê°•ì /ì£¼ì˜ì‚¬í•­ -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>ê°•ì </h6>
                  </div>
                  <div class="card-body" id="previewStrengthsList">
                    <ul class="list-unstyled mb-0">
                      <li class="text-muted">ë¶„ì„ ì¤‘...</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­</h6>
                  </div>
                  <div class="card-body" id="previewCautionsList">
                    <ul class="list-unstyled mb-0">
                      <li class="text-muted">ë¶„ì„ ì¤‘...</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ë³´ê³ ì„œ í•˜ë‹¨ -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ìƒê¶Œë¶„ì„ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                ë¶„ì„ ê¸°ì¤€ì¼: <span id="previewReportGeneratedDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="previewDownloadPdfBtn" onclick="downloadPreviewPDF()" style="display: none;">
              <i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)
            </button>
            <button type="button" class="btn btn-outline-primary" id="previewDownloadLightPdfBtn" onclick="downloadPreviewLightweightPDF()" style="display: none;">
              <i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel">
            <i class="bi bi-file-earmark-pdf me-2"></i>AI ìƒê¶Œë¶„ì„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="pdfGenerating" style="display: none;" class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">ìƒì„± ì¤‘...</span>
            </div>
            <h6>PDF ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h6>
            <p class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
          </div>
          
          <div id="pdfError" style="display: none;" class="text-center">
            <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h6>PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h6>
            <p class="text-muted" id="pdfErrorMessage">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
          </div>
          
          <!-- PDF ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© -->
          <div id="pdfPreviewContainer" style="background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="text-center mb-4">
              <h2 class="text-primary mb-1" style="font-weight: 700;">AI ìƒê¶Œë¶„ì„ ë³´ê³ ì„œ</h2>
              <p class="text-muted mb-0">ì¸ê³µì§€ëŠ¥ ê¸°ë°˜ ìƒì—…ì§€êµ¬ ë¶„ì„ ê²°ê³¼</p>
              <hr class="my-3" style="border-color: #1e3a8a; border-width: 2px;">
            </div>
            
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>ë¶„ì„ ëŒ€ìƒ ì •ë³´</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>ì£¼ì†Œ:</strong> <span id="previewAddress">-</span></p>
                        <p><strong>ì—…ì¢…:</strong> <span id="previewBusinessType">-</span></p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>ë©´ì :</strong> <span id="previewArea">-</span></p>
                        <p><strong>ë¶„ì„ì¼ì‹œ:</strong> <span id="previewDate">-</span></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- AI ìƒì¡´ í™•ë¥  -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-success">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI ìƒì¡´ í™•ë¥ </h5>
                  </div>
                  <div class="card-body text-center">
                    <div class="display-4 mb-3" id="previewSurvival">-%</div>
                    <div class="progress mb-3" style="height: 20px;">
                      <div class="progress-bar" id="previewSurvivalBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-muted mb-0" id="previewSurvivalText">ë¶„ì„ ì¤‘...</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- í•µì‹¬ ì§€í‘œ -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card border-info h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ìƒí™œì¸êµ¬</h6>
                    <p class="card-text fw-bold" id="previewLifePop">-</p>
                    <small class="text-muted">300m ë°˜ê²½</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-warning h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ì§ì¥ì¸êµ¬</h6>
                    <p class="card-text fw-bold" id="previewWorkingPop">-</p>
                    <small class="text-muted">300m ë°˜ê²½</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-danger h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ê²½ìŸì—…ì²´</h6>
                    <p class="card-text fw-bold" id="previewCompetitor">-</p>
                    <small class="text-muted">300m ë°˜ê²½</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-secondary h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ê³µì‹œì§€ê°€</h6>
                    <p class="card-text fw-bold" id="previewLandValue">-</p>
                    <small class="text-muted">ì´ ê³µì‹œì§€ê°€</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê²½ìŸê°•ë„ ë¶„ì„ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-warning">
                  <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-shop me-2"></i>ê²½ìŸê°•ë„ ë¶„ì„</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>ê²½ìŸì—…ì²´ í˜„í™©</h6>
                        <div class="row g-2 text-center mb-3">
                          <div class="col-6">
                            <div class="p-2 border rounded">
                              <div class="h6 text-danger" id="pdfPreviewCompetitorCount">-</div>
                              <small class="text-muted">ë™ì¼ì—…ì¢…</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="p-2 border rounded">
                              <div class="h6 text-warning" id="pdfPreviewAdjacentBiz">-</div>
                              <small class="text-muted">ì¸ì ‘ì—…ì²´</small>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <h6>ê²½ìŸ ê°•ë„</h6>
                        <div class="progress mb-2" style="height: 25px;">
                                                     <div id="pdfPreviewCompetitionBar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="text-center">
                          <span id="pdfPreviewCompetitionLevel" class="badge fs-6">ë¶„ì„ì¤‘...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì™¸êµ­ì¸ ë¶„ì„ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-info">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-globe me-2"></i>ì™¸êµ­ì¸ ë¶„ì„</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3 text-center">
                      <div class="col-md-4">
                        <div class="p-3 border rounded">
                          <i class="bi bi-airplane text-primary mb-2" style="font-size: 1.5rem;"></i>
                          <h6>ë‹¨ê¸°ì²´ë¥˜ ì™¸êµ­ì¸</h6>
                          <div class="h6 text-primary" id="pdfPreviewTempForeign">-</div>
                          <small class="text-muted">1000m ë°˜ê²½</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="p-3 border rounded">
                          <i class="bi bi-house text-success mb-2" style="font-size: 1.5rem;"></i>
                          <h6>ì¥ê¸°ì²´ë¥˜ ì™¸êµ­ì¸</h6>
                          <div class="h6 text-success" id="pdfPreviewLongForeign">-</div>
                          <small class="text-muted">300m ë°˜ê²½</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="p-3 border rounded">
                          <i class="bi bi-flag text-warning mb-2" style="font-size: 1.5rem;"></i>
                          <h6>ì¤‘êµ­ì¸ ë¹„ìœ¨</h6>
                          <div class="h6 text-warning" id="pdfPreviewChinaRatio">-</div>
                          <small class="text-muted">1000m ë°˜ê²½</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-secondary">
                  <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„ (1000m ë°˜ê²½)</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-2 text-center">
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-danger" id="pdfPreviewAge20">-%</div>
                          <small class="text-muted">20ëŒ€</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-primary" id="pdfPreviewAge30">-%</div>
                          <small class="text-muted">30ëŒ€</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-warning" id="pdfPreviewAge40">-%</div>
                          <small class="text-muted">40ëŒ€</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-info" id="pdfPreviewAge50">-%</div>
                          <small class="text-muted">50ëŒ€</small>
                        </div>
                      </div>
                      <div class="col">
                        <div class="p-2 border rounded">
                          <div class="fw-bold text-secondary" id="pdfPreviewAge60">-%</div>
                          <small class="text-muted">60ëŒ€+</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê°•ì /ì£¼ì˜ì‚¬í•­ -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>ê°•ì </h6>
                  </div>
                  <div class="card-body" id="previewStrengths">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­</h6>
                  </div>
                  <div class="card-body" id="previewCautions">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ë³´ê³ ì„œ í•˜ë‹¨ -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ìƒê¶Œë¶„ì„ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                ë¶„ì„ ê¸°ì¤€ì¼: <span id="previewReportDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="downloadPdfBtn" onclick="downloadPDF()">
              <i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)
            </button>
            <button type="button" class="btn btn-outline-primary" id="downloadLightPdfBtn" onclick="downloadLightweightPDF()">
              <i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)
            </button>
          </div>
          <button type="button" class="btn btn-primary" id="retryPdfBtn" onclick="downloadPDF()" style="display: none;">
            <i class="bi bi-arrow-clockwise me-2"></i>ë‹¤ì‹œ ì‹œë„
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì£¼ì†Œ ê²€ìƒ‰ PIP íŒì—… ëª¨ë‹¬ -->
  <div id="addressSearchModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; pointer-events: none;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
      <!-- ëª¨ë‹¬ í—¤ë” -->
      <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; background: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h5 style="margin: 0; color: #333;">
          <i class="bi bi-search me-2"></i>ì£¼ì†Œ ê²€ìƒ‰
          <button onclick="closeAddressSearch()" style="float: right; background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; margin-left: 20px;">&times;</button>
        </h5>
      </div>
      
      <!-- ì£¼ì†Œ ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ -->
      <div id="addressSearchContainer" style="width: 90%; max-width: 600px; height: 80%; max-height: 500px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin-top: 60px; z-index: 10002; position: relative; pointer-events: auto;"></div>
      
      <!-- ë‹«ê¸° ë²„íŠ¼ (ë°°ê²½ í´ë¦­) -->
      <div onclick="closeAddressSearch()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; display: none;"></div>
    </div>
  </div>

  <!-- ì±—ë´‡ PIP í™•ëŒ€ ëª¨ë‹¬ (ë™ì  ìƒì„±) -->
  
{% endblock %}  