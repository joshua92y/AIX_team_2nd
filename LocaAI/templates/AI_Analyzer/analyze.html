{% extends 'base.html' %}
{% load static %}

<<<<<<< HEAD
{% block title %}상권분석 LocaAI{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/chat_styles.css' %}">
{% endblock css %}

{% block header %}
{% include 'includes/header.html' %}
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.0/marked.min.js"></script>
{% endblock header %}

{% block analyzes_list %}
<div class="container-fluid mt-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">LocaAI 상권분석</h3>
    <div class="btn-group" id="navigationButtons" style="display: none;">
      <button type="button" class="btn btn-outline-secondary" onclick="backToAnalysisList()">
        <i class="fas fa-arrow-left me-1"></i>목록으로
      </button>
      <button type="button" class="btn btn-outline-primary" onclick="startNewAnalysis()">
        <i class="fas fa-plus me-1"></i>새 분석
      </button>
    </div>
  </div>
  
  <div id="main-analysis-container">
    <div id="user-check-section" style="display: none">
      <div id="analysis-list-section" style="display: none">
        <h5 class="mb-3">📊 최근 분석 목록</h5>
        <ul id="analysisList" class="list-group mb-3"></ul>
        <nav id="analysisPagination" aria-label="분석 리스트 페이지네이션"></nav>
      </div>
    </div>
  </div>
</div>
{% endblock analyzes_list %}

{% block analysis_report %}
<div id="analysis-report-section" style="display: none">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-8">
        <div id="analysisReportContainer" class="card p-3"></div>
      </div>
      <div class="col-lg-4">
        <div class="chat-interface-container">
          <div class="chat-messages-area" id="chatMessagesArea"></div>
          <div id="typingIndicator" class="message-entry typing-indicator-message" style="display: none;">
            <div class="message-bubble">
              답변을 생성 중입니다...
              <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
            </div>
          </div>
          <div class="chat-input-area">
            <textarea id="messageInput" class="form-control" placeholder="메시지를 입력하세요..." rows="1"></textarea>
            <button id="sendButton" class="btn btn-primary" type="button">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock analysis_report %}

{% block chat_history %}
<div id="analysis-chat-section" style="display: none">
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">💬 관련 대화 내용</h6>
            <div class="btn-group">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="exportChatBtn">
                <i class="fas fa-download me-1"></i>내보내기
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm" id="addSearchBtn">
                <i class="fas fa-search me-1"></i>검색
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="chatHistoryContainer" class="chat-messages-area"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock chat_history %}

{% block new_analysis %}
<div id="new-analysis-sequence" style="display: none">
  <!-- 입력 폼: 업종/주소/면적/주류 여부/시작 버튼 -->
</div>
{% endblock new_analysis %}

{% block chatbot %}
<!-- 채팅 인터페이스는 analysis_report 섹션에 통합됨 -->
{% endblock chatbot %}

{% block footer %}
{% csrf_token %}
<script type="application/json" id="user-info-data">{{ user_info_json|safe }}</script>
<script type="application/json" id="previous-docs-data">{{ previous_docs_json|safe }}</script>
{% endblock footer %}

{% block js %}
<script type="module" src="{% static 'js/main_service.js' %}"></script>
<script>
  // 전역 함수들 (모듈에서 export한 함수들을 전역으로 노출)
  document.addEventListener('DOMContentLoaded', function() {
    // 네비게이션 버튼 표시/숨김 함수
    window.showNavigationButtons = function(show = true) {
      const navButtons = document.getElementById('navigationButtons');
      if (navButtons) {
        navButtons.style.display = show ? 'block' : 'none';
      }
    };
    
    // 채팅 히스토리 내보내기 버튼 이벤트
    const exportChatBtn = document.getElementById('exportChatBtn');
    if (exportChatBtn) {
      exportChatBtn.addEventListener('click', function() {
        const currentSession = window.stateManager?.getStateValue('currentSession');
        if (currentSession?.id) {
          window.exportChatHistory?.(currentSession.id);
        } else {
          alert('내보낼 채팅 히스토리가 없습니다.');
        }
      });
    }
    
    // 채팅 히스토리 검색 버튼 이벤트
    const addSearchBtn = document.getElementById('addSearchBtn');
    if (addSearchBtn) {
      addSearchBtn.addEventListener('click', function() {
        window.addChatHistorySearch?.();
      });
    }
  });
</script>
{% endblock js %}