{% extends 'base.html' %}
{% load static %}

{% block title %}상권 분석{% endblock %}

{% block content %}
{% include 'includes/header.html' %}

  <style>
    /* 기본 primary 버튼 disabled 시 커스텀 스타일 */
    .btn-primary.custom {
      color: #fff;
      background-color: #0d6efd; /* 원래 primary 색 */
      opacity: 0.65;  /* 투명도 조절로 흐릿하게 표시 */
    }
    
    /* 분석 진행 상황 스타일 */
    .analysis-progress {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      margin-top: 1rem;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .progress-step.active {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .progress-step.completed {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #22c55e;
    }
    
    .progress-step.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }
    
    .progress-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
    }
    
    .progress-step.active .progress-icon {
      background: #667eea;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .progress-step.completed .progress-icon {
      background: #22c55e;
      color: white;
    }
    
    .progress-step.error .progress-icon {
      background: #ef4444;
      color: white;
    }
    
    .progress-step:not(.active):not(.completed):not(.error) .progress-icon {
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .progress-text {
      flex: 1;
    }
    
    .progress-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .progress-detail {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .overall-progress {
      margin-bottom: 1.5rem;
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* 공시지가 카드 폰트 크기 조정 */
    #totalLandValue {
      font-size: 1.8rem !important;
      line-height: 1.2;
    }
    
    @media (max-width: 768px) {
      #totalLandValue {
        font-size: 1.5rem !important;
      }
    }

    /* 챗봇 스타일 */
    .chat-interface-container {
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .chat-messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .chat-welcome-message {
      text-align: center;
      padding: 1rem;
    }

    .message-entry {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
    }

    .message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: 80%;
      word-wrap: break-word;
    }

    .user-message {
      align-items: flex-end;
    }

    .user-message .message-bubble {
      background-color: #007bff;
      color: white;
    }

    .bot-message {
      align-items: flex-start;
    }

    .bot-message .message-bubble {
      background-color: #e9ecef;
      color: #212529;
    }

    .typing-indicator-message .message-bubble {
      background-color: #e9ecef;
      color: #6c757d;
    }

    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background-color: white;
      border-radius: 0.5rem;
    }

    .chat-input-area textarea {
      resize: none;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }

    .chat-input-area button {
      padding: 0.5rem 1rem;
    }
  </style>

  <!-- Daum 우편번호 서비스 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <!-- jsPDF 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- 한국어 폰트 지원 -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/customfonts.js"></script>
  <!-- html2canvas 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    $(window).on('load', function() {
      _eventBind();
    });

    // 페이지 내 이벤트 바인딩
    function _eventBind() {
      console.log("이벤트 바인딩 시작");
    }

    // Daum 우편번호 서비스 팝업 열기
    function openAddressSearch() {
      new daum.Postcode({
        oncomplete: function(data) {
          // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드
          console.log("선택된 주소 데이터:", data);
          
          // 기본 주소 정보
          let fullAddr = '';
          let extraAddr = '';
          
          // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
          if (data.userSelectedType === 'R') { // 도로명 주소
            fullAddr = data.roadAddress;
          } else { // 지번 주소
            fullAddr = data.jibunAddress;
          }
          
          // 건물명이 있고, 공동주택일 경우 추가한다.
          if(data.buildingName !== '' && data.apartment === 'Y'){
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
          if(extraAddr !== ''){
            extraAddr = ' (' + extraAddr + ')';
          }
          
          // 최종 주소
          const finalAddress = fullAddr + extraAddr;
          
          // 주소를 입력하고 좌표 변환 시작
          document.getElementById('address').value = finalAddress;
          
          // 기존 AI_Analyzer의 좌표 변환 API 사용
          const csrfToken = '{{ csrf_token }}';
          
          $.ajax({
            url: '/ai_analyzer/get-coordinates/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              address: fullAddr
            }),
            headers: {
              'X-CSRFToken': csrfToken
            },
            success: function(response) {
              if (response.success) {
                // 좌표 설정 성공
                document.getElementById('latitude').value = response.latitude.toFixed(6);
                document.getElementById('longitude').value = response.longitude.toFixed(6);
                document.getElementById('x_coord').value = response.x_coord.toFixed(2);
                document.getElementById('y_coord').value = response.y_coord.toFixed(2);
                
                console.log("좌표 변환 완료:", {
                  address: finalAddress,
                  latitude: response.latitude,
                  longitude: response.longitude,
                  x_coord: response.x_coord,
                  y_coord: response.y_coord
                });
                
                alert("주소와 좌표가 설정되었습니다.");
              } else {
                console.error("좌표 변환 실패:", response.error);
                alert("좌표 변환에 실패했습니다: " + response.error);
              }
            },
            error: function(xhr, status, error) {
              console.error("좌표 변환 요청 실패:", error);
              console.error("응답:", xhr.responseText);
              alert("좌표 변환 요청에 실패했습니다.");
            }
          });
        },
        theme: {
          searchBgColor: "#0d6efd", // 검색창 배경색
          queryTextColor: "#FFFFFF" // 검색창 글자색  
        }
      }).open();
    }

    // 입력정보 전송
    function getFormData() {
      const business_type_id = $('#business_type_id').val();
      const address = $('#address').val();
      const area = $('#area').val();
      const service_type = $('#service_type').val();
      const x_coord = $('#x_coord').val();
      const y_coord = $('#y_coord').val();
      const latitude = $('#latitude').val();
      const longitude = $('#longitude').val();

      // 필수 필드 검증
      if (!business_type_id || !address || !area || !service_type) {
        alert("모든 필드를 입력해주세요.");
        return;
      }
      
      // 좌표값 검증
      if (!x_coord || !y_coord || x_coord === '0' || y_coord === '0' || 
          !latitude || !longitude || latitude === '0' || longitude === '0') {
        alert("주소 검색을 통해 좌표를 설정해주세요.");
        return;
      }

      // 즉시 로딩 UI 표시
      console.log("🚀 분석 시작 - 로딩 UI 표시");
      showAnalysisLoading();

      console.log("전송할 데이터:", {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      });
      
      const paramData = {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      };

      $.ajax(createPostAjaxOption('analyze', paramData));
    }

    function createPostAjaxOption(requestType, paramData) {
      
      const csrfToken = '{{ csrf_token }}';
      let url;

      if ( 'analyze' === requestType ) {
        url = '/ai_analyzer/analyze-business/';
      } else if ( 'pdf' === 'pdf' ) {
        url = '/generate-pdf/';
      }
      
      // 원본 AI_Analyzer와 같이 JSON으로 전송
      return {
        url: url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(paramData),
        headers: {
          'X-CSRFToken': csrfToken
        },
        success: function(response) {
          console.log("✅ 분석 요청 성공 응답:", response);
          
          if (response.success && response.request_id) {
            console.log(`🔄 현재 페이지에서 결과 표시 시작 (request_id: ${response.request_id})`);
            // 분석 결과를 가져와서 현재 페이지에 표시
            fetchAndDisplayResults(response.request_id);
          } else if (response.request_id) {
            console.log(`🔄 request_id만 있는 경우 (request_id: ${response.request_id})`);
            // 분석 결과를 가져와서 현재 페이지에 표시
            fetchAndDisplayResults(response.request_id);
          } else {
            console.log("⚠️ request_id가 없는 응답:", response);
            alert('분석 요청 성공: ' + (response.message || '결과를 확인해주세요'));
          }
        },
        error: function(xhr, status, error) {
          console.error("분석 요청 실패:", error);
          console.error("응답:", xhr.responseText);
          alert("상권 분석 요청에 실패했습니다.");
        }
      }
    }

    // 분석 결과를 가져와서 표시하는 함수
    function fetchAndDisplayResults(requestId) {
      console.log(`📊 결과 조회 시작 (request_id: ${requestId})`);
      console.log(`🔗 API URL: /ai_analyzer/api/result/${requestId}/`);
      
      // 현재 분석 결과 ID 저장 (PDF 생성을 위해)
      currentRequestId = requestId;
      
      // 로딩은 이미 getFormData에서 시작됨
      
      $.ajax({
        url: `/ai_analyzer/api/result/${requestId}/`,
        type: 'GET',
        success: function(data) {
          console.log("✅ 결과 조회 성공:", data);
          console.log("🎯 현재 페이지에서 결과 표시 시작");
          displayAnalysisResults(data);
        },
        error: function(xhr, status, error) {
          console.error("❌ 결과 조회 실패:", error);
          console.error("📊 응답 상태:", xhr.status);
          console.error("📄 응답 텍스트:", xhr.responseText);
          
          // 404 오류가 아닌 경우에만 재시도 옵션 제공
          if (xhr.status === 404) {
            console.log("🔄 결과가 아직 준비되지 않음, 잠시 후 재시도");
            setTimeout(() => {
              fetchAndDisplayResults(requestId);
            }, 2000); // 2초 후 재시도
          } else {
            // 에러 메시지 표시하고 다시 시도 옵션 제공
            showAnalysisError(requestId, error);
          }
        }
      });
    }
    
    // 분석 진행 상황 표시 (기존 단순 로딩 대체)
    function showAnalysisLoading() {
      // 대기 메시지 숨기고 진행 상황 표시
      $('#analysisWaiting').hide();
      $('#analysisProgress').show();
      
      // 진행 단계 정의 (실제 측정된 처리 시간 기반, 총 38초)
      const steps = [
        { id: 'step-population', name: '생활인구 분석', delay: 1000, duration: 13000 },    // 1초 시작 → 14초 완료
        { id: 'step-working', name: '직장인구 분석', delay: 14000, duration: 13000 },      // 14초 시작 → 27초 완료  
        { id: 'step-foreign', name: '외국인 분석', delay: 27000, duration: 6000 },         // 27초 시작 → 33초 완료
        { id: 'step-facilities', name: '주변시설 분석', delay: 33000, duration: 2500 },     // 33초 시작 → 35.5초 완료
        { id: 'step-competition', name: '경쟁업체 분석', delay: 35500, duration: 2000 },    // 35.5초 시작 → 37.5초 완료
        { id: 'step-land', name: '공시지가 분석', delay: 37500, duration: 1500 },          // 37.5초 시작 → 39초 완료
        { id: 'step-ai', name: 'AI 예측 분석', delay: 39000, duration: 1500 },            // 39초 시작 → 40.5초 완료
        { id: 'step-complete', name: '분석 완료', delay: 40500, duration: 500 }            // 40.5초 시작 → 41초 완료
      ];
      
              // 각 단계별로 진행 표시 (실제 38초 기준)
        steps.forEach((step, index) => {
          // 단계 시작
          setTimeout(() => {
          // 이전 단계 완료 표시
          if (index > 0) {
            const prevStep = steps[index - 1];
            $(`#${prevStep.id}`).removeClass('active').addClass('completed');
          }
          
          // 현재 단계 활성화
          $(`#${step.id}`).addClass('active');
          
          // 각 단계별 상세 메시지
          let detailMessage = `${step.name} 진행 중...`;
          if (step.id === 'step-population') {
            detailMessage = '생활인구 분석 중... (대용량 공간 데이터 처리)';
          } else if (step.id === 'step-working') {
            detailMessage = '직장인구 분석 중... (복잡한 공간 쿼리 수행)';
          } else if (step.id === 'step-foreign') {
            detailMessage = '외국인 분석 중... (다중 테이블 검색)';
          } else if (step.id === 'step-facilities') {
            detailMessage = '주변시설 분석 중...';
          } else if (step.id === 'step-competition') {
            detailMessage = '경쟁업체 분석 중...';
          } else if (step.id === 'step-land') {
            detailMessage = '공시지가 분석 중...';
          } else if (step.id === 'step-ai') {
            detailMessage = 'AI 예측 모델 실행 중...';
          }
          
          $(`#${step.id} .progress-detail`).text(detailMessage);
          
          // 진행률 업데이트 (시작 시점)
          const startProgress = Math.round((index / steps.length) * 100);
          $('#overallPercent').text(startProgress + '%');
          $('#overallProgressBar').css('width', startProgress + '%');
          
          // 긴 단계들에 대해 중간 진행률 업데이트 (생활인구, 직장인구, 외국인 분석)
          if (step.duration > 5000) {
            const midPoint = step.delay + (step.duration / 2);
            setTimeout(() => {
              if ($(`#${step.id}`).hasClass('active')) {
                const midProgress = Math.round(((index + 0.5) / steps.length) * 100);
                $('#overallPercent').text(midProgress + '%');
                $('#overallProgressBar').css('width', midProgress + '%');
                
                if (step.id === 'step-population') {
                  $(`#${step.id} .progress-detail`).text('생활인구 분석 중... (50% 완료)');
                } else if (step.id === 'step-working') {
                  $(`#${step.id} .progress-detail`).text('직장인구 분석 중... (50% 완료)');
                } else if (step.id === 'step-foreign') {
                  $(`#${step.id} .progress-detail`).text('외국인 분석 중... (50% 완료)');
                }
              }
            }, midPoint);
          }
          
        }, step.delay);
        
        // 단계 완료
        setTimeout(() => {
          $(`#${step.id} .progress-detail`).text(`${step.name} 완료`);
          
          // 진행률 업데이트 (완료 시점)
          const endProgress = Math.round(((index + 1) / steps.length) * 100);
          $('#overallPercent').text(endProgress + '%');
          $('#overallProgressBar').css('width', endProgress + '%');
          
        }, step.delay + step.duration);
      });
      
      // 예상 완료 시간 후에도 결과가 없으면 대기 메시지 표시
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('서버에서 최종 결과를 처리 중입니다...');
          
          // 진행률을 95%로 유지 (100%는 실제 완료 시에만)
          $('#overallPercent').text('95%');
          $('#overallProgressBar').css('width', '95%');
        }
      }, 41000);  // 41초 후 (예상 완료 시간 후)
      
      // 더 오래 걸리는 경우를 위한 추가 메시지
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('대용량 공간 데이터 처리로 시간이 오래 걸립니다...');
        }
      }, 45000);  // 45초 후
      
      // 더 긴 대기를 위한 안내
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('곧 완료됩니다. 잠시만 더 기다려주세요');
        }
      }, 50000);  // 50초 후
    }
    
    // 분석 에러 표시
    function showAnalysisError(requestId, error) {
      // 현재 진행 중인 단계를 오류 상태로 변경
      $('.progress-step.active').removeClass('active').addClass('error');
      $('.progress-step.error .progress-detail').text('분석 중 오류 발생');
      
      $('#analysisProgress').hide();
      $('#analysisWaiting').html(`
        <div class="alert alert-danger">
          <h5><i class="bi bi-exclamation-triangle me-2"></i>분석 중 오류가 발생했습니다</h5>
          <p>오류 내용: ${error}</p>
          <div class="mt-3">
            <button class="btn btn-primary me-2" onclick="retryAnalysis(${requestId})">
              <i class="bi bi-arrow-clockwise me-1"></i>다시 시도
            </button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='/result/${requestId}/'">
              <i class="bi bi-eye me-1"></i>결과 페이지로 이동
            </button>
          </div>
        </div>
      `).show();
    }
    
    // 분석 재시도
    function retryAnalysis(requestId) {
      showAnalysisLoading();
      setTimeout(() => {
        fetchAndDisplayResults(requestId);
      }, 1000);
    }
    
    // 분석 결과를 페이지에 표시하는 함수
    function displayAnalysisResults(data) {
      // 최종 완료 상태로 프로그레스 업데이트
      $('#step-complete').removeClass('active').addClass('completed');
      $('#step-complete .progress-detail').text('분석 완료');
      $('#overallPercent').text('100%');
      $('#overallProgressBar').css('width', '100%');
      
      // 잠시 후 진행 상황 UI 숨기기
      setTimeout(() => {
        $('#analysisProgress').hide();
      }, 1000);
      
      const request = data.request;
      const result = data.result;
      
      // 기본 정보 설정
      document.getElementById('resultAddress').textContent = request.address;
      document.getElementById('resultBusinessType').textContent = getBusinessTypeName(request.business_type_id);
      document.getElementById('resultArea').textContent = request.area;
      document.getElementById('resultServiceType').textContent = request.service_type == 1 ? '일반음식점' : '휴게음식점';
      
      // 핵심 지표
      document.getElementById('lifePop300').textContent = Math.round(result.life_pop_300m || 0).toLocaleString();
      document.getElementById('workingPop300').textContent = Math.round(result.working_pop_300m || 0).toLocaleString();
      document.getElementById('competitor300').textContent = result.competitor_300m || 0;
      
      // 공시지가를 원화 표시로 더 간단하게 표현
      const landValue = result.total_land_value || 0;
      if (landValue >= 100000000) { // 1억 이상
        document.getElementById('totalLandValue').innerHTML = `₩${(landValue / 100000000).toFixed(1)}억`;
      } else if (landValue >= 10000) { // 1만 이상
        document.getElementById('totalLandValue').innerHTML = `₩${(landValue / 10000).toFixed(0)}만`;
      } else {
        document.getElementById('totalLandValue').innerHTML = `₩${landValue.toLocaleString()}`;
      }
      
      // AI 생존 확률
      const survivalRate = Math.round(result.survival_percentage || 0);
      document.getElementById('survivalPercentage').textContent = survivalRate + '%';
      
      const survivalBar = document.getElementById('survivalBar');
      const survivalAnalysis = document.getElementById('survivalAnalysis');
      
      survivalBar.style.width = survivalRate + '%';
      
      if (survivalRate >= 80) {
        survivalBar.className = 'progress-bar bg-success';
        survivalAnalysis.className = 'alert alert-success';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>
          <strong>높은 생존 가능성</strong><br>
          현재 위치는 장기적으로 사업을 지속하기에 매우 좋은 조건을 갖추고 있습니다.
        `;
      } else if (survivalRate >= 60) {
        survivalBar.className = 'progress-bar bg-warning';
        survivalAnalysis.className = 'alert alert-warning';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>보통 생존 가능성</strong><br>
          현재 위치는 사업 지속에 적절한 조건을 갖추고 있으나, 추가적인 전략 검토가 필요합니다.
        `;
      } else {
        survivalBar.className = 'progress-bar bg-danger';
        survivalAnalysis.className = 'alert alert-danger';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-times-circle me-2"></i>
          <strong>낮은 생존 가능성</strong><br>
          현재 위치는 장기 사업 지속에 어려움이 예상됩니다. 신중한 검토가 필요합니다.
        `;
      }
      
      // 상권 경쟁 분석
      document.getElementById('competitorCount').textContent = result.competitor_300m || 0;
      document.getElementById('adjacentBiz').textContent = result.adjacent_biz_300m || 0;
      
      const competitorRatio = Math.round(result.competitor_ratio_300m || 0);
      document.getElementById('competitorRatio').textContent = competitorRatio + '%';
      document.getElementById('businessDiversity').textContent = (result.business_diversity_300m || 0) + '종류';
      
      const competitionBar = document.getElementById('competitionBar');
      const competitionLevel = document.getElementById('competitionLevel');
      
      competitionBar.style.width = competitorRatio + '%';
      
      if (competitorRatio <= 20) {
        competitionBar.className = 'progress-bar bg-success';
        competitionLevel.textContent = `낮음 (${competitorRatio}%)`;
      } else if (competitorRatio <= 50) {
        competitionBar.className = 'progress-bar bg-warning';
        competitionLevel.textContent = `보통 (${competitorRatio}%)`;
      } else {
        competitionBar.className = 'progress-bar bg-danger';
        competitionLevel.textContent = `높음 (${competitorRatio}%)`;
      }
      
      // 강점과 주의사항 분석
      displayStrengthsAndCautions(result);
      
      // 결과 영역 표시
      document.getElementById('analysisWaiting').style.display = 'none';
      document.getElementById('analysisResults').style.display = 'block';
      
      // 결과 영역으로 스크롤
      document.getElementById('analysisResults').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
    
    // 업종명 반환 함수
    function getBusinessTypeName(businessTypeId) {
      const businessTypes = {
        0: '감성주점', 1: '경양식', 2: '관광호텔', 3: '극장', 4: '기타',
        5: '기타 휴게음식점', 6: '김밥(도시락)', 7: '까페', 8: '냉면집', 9: '다방',
        10: '떡카페', 11: '라이브카페', 12: '백화점', 13: '복어취급', 14: '분식',
        15: '뷔페식', 16: '식육(숯불구이)', 17: '아이스크림', 18: '외국음식전문점(인도, 태국 등)', 19: '유원지',
        20: '일반조리판매', 21: '일식', 22: '전통찻집', 23: '정종/대포집/소주방', 24: '중국식',
        25: '철도역구내', 26: '출장조리', 27: '커피숍', 28: '키즈카페', 29: '탕류(보신용)',
        30: '통닭(치킨)', 31: '패밀리레스토랑', 32: '패스트푸드', 33: '편의점', 34: '푸드트럭',
        35: '한식', 36: '호프/통닭', 37: '횟집'
      };
      return businessTypes[businessTypeId] || '알 수 없음';
    }
    
    // 강점과 주의사항 표시
    function displayStrengthsAndCautions(result) {
      const strengthsList = document.getElementById('strengthsList');
      const cautionsList = document.getElementById('cautionsList');
      
      let strengths = [];
      let cautions = [];
      
      // 강점 분석
      if (result.life_pop_300m > 5000) {
        strengths.push(`생활인구가 풍부함 (${Math.round(result.life_pop_300m).toLocaleString()}명)`);
      }
      if (result.working_pop_300m > 3000) {
        strengths.push('직장인구가 많아 점심시간 고객 확보 유리');
      }
      if (result.competitor_ratio_300m < 30) {
        strengths.push('경쟁업체 비율이 낮아 경쟁 부담 적음');
      }
      if (result.business_diversity_300m > 10) {
        strengths.push('업종 다양성이 높아 상권이 활성화됨');
      }
      if (result.public_building_250m > 0 || result.school_250m > 0) {
        strengths.push('주변 유동인구 유발시설 존재');
      }
      
      // 주의사항 분석
      if (result.life_pop_300m < 2000) {
        cautions.push('생활인구가 적어 고객 확보에 어려움 예상');
      }
      if (result.competitor_ratio_300m > 50) {
        cautions.push('경쟁업체 비율이 높아 치열한 경쟁 예상');
      }
      if (result.competitor_300m > 5) {
        cautions.push(`동일업종 경쟁업체가 많음 (${result.competitor_300m}개)`);
      }
      if (result.total_land_value > 100000000) {
        cautions.push('공시지가가 높아 임대료 부담 클 수 있음');
      }
      if (result.working_pop_300m < 1000) {
        cautions.push('직장인구가 적어 평일 점심 고객 부족 우려');
      }
      
      // 기본 메시지
      if (strengths.length === 0) {
        strengths.push('상권 분석 결과를 종합적으로 검토하세요');
      }
      if (cautions.length === 0) {
        cautions.push('현재 상권 조건이 양호합니다');
      }
      
      // HTML 생성
      strengthsList.innerHTML = strengths.map(item => `<li>${item}</li>`).join('');
      cautionsList.innerHTML = cautions.map(item => `<li>${item}</li>`).join('');
    }
    
    function fillExampleQuestion(text) {
      document.getElementById('chatInput').value = text;
    }

    // PDF 미리보기 모달 표시 함수 (분석 기록용)
    function showPdfPreview(requestId) {
      console.log('PDF 미리보기 요청:', requestId);
      
      // 모달 표시
      const previewModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
      previewModal.show();
      
             // 초기 상태 설정
       document.getElementById('previewLoading').style.display = 'block';
       document.getElementById('previewError').style.display = 'none';
       document.getElementById('previewContent').style.display = 'none';
       document.getElementById('previewDownloadPdfBtn').style.display = 'none';
       document.getElementById('previewDownloadLightPdfBtn').style.display = 'none';
      
      // 분석 결과 데이터 가져오기
      fetch(`/ai_analyzer/api/result/${requestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('분석 결과를 불러올 수 없습니다.');
        }
        return response.json();
      })
      .then(data => {
        console.log('분석 결과 데이터:', data);
        
                 // 로딩 숨기고 내용 표시
         document.getElementById('previewLoading').style.display = 'none';
         document.getElementById('previewContent').style.display = 'block';
         document.getElementById('previewDownloadPdfBtn').style.display = 'inline-block';
         document.getElementById('previewDownloadLightPdfBtn').style.display = 'inline-block';
        
        // 데이터 채우기
        populatePreviewData(data, requestId);
      })
      .catch(error => {
        console.error('PDF 미리보기 오류:', error);
        
        // 오류 상태 표시
        document.getElementById('previewLoading').style.display = 'none';
        document.getElementById('previewError').style.display = 'block';
        document.getElementById('previewErrorMessage').textContent = error.message;
      });
    }

    // 미리보기 데이터 채우기 함수
    function populatePreviewData(data, requestId) {
      const request = data.request;
      const result = data.result;
      
      // 기본 정보
      document.getElementById('previewAddr').textContent = request.address || '-';
      document.getElementById('previewBizType').textContent = getBusinessTypeName(request.business_type_id) || '-';
      document.getElementById('previewAreaSize').textContent = request.area || '-';
      
      // 분석일시
      const analysisDate = new Date(request.created_at).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('previewAnalysisDate').textContent = analysisDate;
      document.getElementById('previewReportGeneratedDate').textContent = analysisDate;
      
      // AI 생존 확률
      const survivalRate = Math.round(result.survival_percentage || 0);
      document.getElementById('previewSurvivalRate').textContent = survivalRate + '%';
      
      // 프로그레스 바 설정
      const progressBar = document.getElementById('previewSurvivalProgressBar');
      progressBar.style.width = survivalRate + '%';
      
      // 생존 확률에 따른 색상 및 메시지
      const survivalComment = document.getElementById('previewSurvivalComment');
      if (survivalRate >= 80) {
        progressBar.className = 'progress-bar bg-success';
        survivalComment.textContent = '높은 생존 가능성 - 장기적 사업 지속에 매우 좋은 조건';
        survivalComment.className = 'text-success mb-0';
      } else if (survivalRate >= 60) {
        progressBar.className = 'progress-bar bg-warning';
        survivalComment.textContent = '보통 생존 가능성 - 적절한 조건이나 추가 전략 검토 필요';
        survivalComment.className = 'text-warning mb-0';
      } else {
        progressBar.className = 'progress-bar bg-danger';
        survivalComment.textContent = '낮은 생존 가능성 - 장기 사업 지속에 어려움 예상';
        survivalComment.className = 'text-danger mb-0';
      }
      
      // 핵심 지표
      document.getElementById('previewLifePopulation').textContent = 
        Math.round(result.life_pop_300m || 0).toLocaleString() + '명';
      document.getElementById('previewWorkingPopulation').textContent = 
        Math.round(result.working_pop_300m || 0).toLocaleString() + '명';
      document.getElementById('previewCompetitors').textContent = 
        (result.competitor_300m || 0) + '개';
      
      // 공시지가
      const landValue = result.total_land_value || 0;
      let landValueText = '';
      if (landValue >= 100000000) { // 1억 이상
        landValueText = `₩${(landValue / 100000000).toFixed(1)}억`;
      } else if (landValue >= 10000) { // 1만 이상
        landValueText = `₩${(landValue / 10000).toFixed(0)}만`;
      } else {
        landValueText = `₩${landValue.toLocaleString()}`;
      }
      document.getElementById('previewLandPrice').textContent = landValueText;
      
             // 강점과 주의사항 분석
       populateStrengthsAndCautions(result);
       
       // 현재 미리보기 중인 requestId를 전역 변수에 저장 (PDF 다운로드용)
       currentPreviewRequestId = requestId;
    }

    // 강점과 주의사항 분석 함수 (미리보기용)
    function populateStrengthsAndCautions(result) {
      const strengths = [];
      const cautions = [];
      
      // 생활인구 분석
      const lifePop300 = result.life_pop_300m || 0;
      if (lifePop300 > 5000) {
        strengths.push('300m 반경 내 생활인구가 풍부합니다 (' + Math.round(lifePop300).toLocaleString() + '명)');
      } else if (lifePop300 < 2000) {
        cautions.push('300m 반경 내 생활인구가 부족합니다 (' + Math.round(lifePop300).toLocaleString() + '명)');
      }
      
      // 직장인구 분석
      const workingPop300 = result.working_pop_300m || 0;
      if (workingPop300 > 3000) {
        strengths.push('300m 반경 내 직장인구가 많아 점심/저녁 수요가 기대됩니다');
      } else if (workingPop300 < 1000) {
        cautions.push('300m 반경 내 직장인구가 적어 평일 수요가 제한적일 수 있습니다');
      }
      
      // 경쟁업체 분석
      const competitor300 = result.competitor_300m || 0;
      if (competitor300 < 3) {
        strengths.push('300m 반경 내 경쟁업체가 적어 시장 선점 기회가 있습니다');
      } else if (competitor300 > 10) {
        cautions.push('300m 반경 내 경쟁업체가 많아 치열한 경쟁이 예상됩니다 (' + competitor300 + '개)');
      }
      
      // 공시지가 분석
      const landValue = result.total_land_value || 0;
      if (landValue < 50000000) { // 5천만원 미만
        strengths.push('상대적으로 낮은 공시지가로 임대료 부담이 적을 것으로 예상됩니다');
      } else if (landValue > 200000000) { // 2억 초과
        cautions.push('높은 공시지가로 인한 임대료 부담이 클 수 있습니다');
      }
      
      // 생존 확률 분석
      const survivalRate = result.survival_percentage || 0;
      if (survivalRate >= 80) {
        strengths.push('AI 예측 생존 확률이 매우 높아 안정적인 사업 운영이 기대됩니다');
      } else if (survivalRate < 50) {
        cautions.push('AI 예측 생존 확률이 낮아 신중한 사업 계획이 필요합니다');
      }
      
      // 기본 메시지 추가
      if (strengths.length === 0) {
        strengths.push('현재 상권 조건이 평균적인 수준입니다');
      }
      if (cautions.length === 0) {
        cautions.push('현재 상권 조건이 양호합니다');
      }
      
      // HTML 생성
      const strengthsList = document.getElementById('previewStrengthsList').querySelector('ul');
      const cautionsList = document.getElementById('previewCautionsList').querySelector('ul');
      
      strengthsList.innerHTML = strengths.map(item => 
        `<li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>${item}</li>`
      ).join('');
      
             cautionsList.innerHTML = cautions.map(item => 
         `<li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>${item}</li>`
       ).join('');
     }

    // 미리보기 모달에서 PDF 다운로드 함수 (고품질)
    function downloadPreviewPDF() {
      if (!currentPreviewRequestId) {
        alert('미리보기 데이터가 없습니다.');
        return;
      }
      
      try {
        // 미리보기 컨테이너를 이미지로 변환
        const element = document.getElementById('previewContent');
        
        if (!element) {
          alert('미리보기 내용을 찾을 수 없습니다.');
          return;
        }
        
        // 로딩 상태 표시
        document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>생성 중...';
        document.getElementById('previewDownloadPdfBtn').disabled = true;
        document.getElementById('previewDownloadLightPdfBtn').disabled = true;
        
        html2canvas(element, {
          scale: 1.5,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: element.offsetWidth,
          height: element.offsetHeight,
          removeContainer: true,
          imageTimeout: 0,
          logging: false
        }).then(canvas => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          
          // 이미지 크기 계산 (A4 크기에 맞게 조정)
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          let heightLeft = imgHeight;
          let position = 0;
          
          // JPEG 품질 설정으로 용량 줄이기
          const imgData = canvas.toDataURL('image/jpeg', 0.8);
          
          // 첫 번째 페이지
          doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          
          // 추가 페이지가 필요한 경우
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          
          // 파일명 생성
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_상권분석_보고서_${currentDate}.pdf`;
          
          // PDF 다운로드
          doc.save(filename);
          
          // 버튼 상태 복원
          document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="bi bi-download me-2"></i>고품질 PDF (이미지)';
          document.getElementById('previewDownloadPdfBtn').disabled = false;
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
          
          alert('PDF 다운로드가 완료되었습니다.');
          
        }).catch(error => {
          console.error('html2canvas 오류:', error);
          alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
          
          // 버튼 상태 복원
          document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="bi bi-download me-2"></i>고품질 PDF (이미지)';
          document.getElementById('previewDownloadPdfBtn').disabled = false;
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
        });
        
      } catch (error) {
        console.error('PDF 생성 오류:', error);
        alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
        
        // 버튼 상태 복원
        document.getElementById('previewDownloadPdfBtn').innerHTML = '<i class="bi bi-download me-2"></i>고품질 PDF (이미지)';
        document.getElementById('previewDownloadPdfBtn').disabled = false;
        document.getElementById('previewDownloadLightPdfBtn').disabled = false;
      }
    }

    // 미리보기 모달에서 경량 PDF 다운로드 함수 (한글 폰트 지원)
    function downloadPreviewLightweightPDF() {
      if (!currentPreviewRequestId) {
        alert('미리보기 데이터가 없습니다.');
        return;
      }
      
      try {
        // 로딩 상태 표시
        document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>생성 중...';
        document.getElementById('previewDownloadLightPdfBtn').disabled = true;
        document.getElementById('previewDownloadPdfBtn').disabled = true;
        
        // 미리보기 컨테이너를 이미지로 변환 (경량화 옵션 적용)
        const element = document.getElementById('previewContent');
        
        if (!element) {
          alert('미리보기 내용을 찾을 수 없습니다.');
          return;
        }
        
        html2canvas(element, {
          scale: 0.8, // 낮은 해상도로 용량 절약
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: element.offsetWidth,
          height: element.offsetHeight,
          removeContainer: true,
          imageTimeout: 0,
          logging: false
        }).then(canvas => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          
          // 이미지 크기 계산 (A4 크기에 맞게 조정)
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          let heightLeft = imgHeight;
          let position = 0;
          
          // JPEG 품질을 더 낮춰서 용량 절약 (경량 버전)
          const imgData = canvas.toDataURL('image/jpeg', 0.5); // 50% 품질
          
          // 첫 번째 페이지
          doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          
          // 추가 페이지가 필요한 경우
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          
          // 파일명 생성
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_상권분석_경량_${currentDate}.pdf`;
          
          // PDF 다운로드
          doc.save(filename);
          
          // 버튼 상태 복원
          document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)';
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
          document.getElementById('previewDownloadPdfBtn').disabled = false;
          
          alert('경량 PDF 다운로드가 완료되었습니다.');
          
        }).catch(error => {
          console.error('html2canvas 오류:', error);
          alert('경량 PDF 생성 중 오류가 발생했습니다: ' + error.message);
          
          // 버튼 상태 복원
          document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)';
          document.getElementById('previewDownloadLightPdfBtn').disabled = false;
          document.getElementById('previewDownloadPdfBtn').disabled = false;
        });
        
      } catch (error) {
        console.error('경량 PDF 생성 오류:', error);
        alert('경량 PDF 생성 중 오류가 발생했습니다: ' + error.message);
        
        // 버튼 상태 복원
        document.getElementById('previewDownloadLightPdfBtn').innerHTML = '<i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)';
        document.getElementById('previewDownloadLightPdfBtn').disabled = false;
        document.getElementById('previewDownloadPdfBtn').disabled = false;
      }
    }

    // 전역 변수로 현재 분석 결과 ID 저장
    let currentRequestId = null;
    let currentPreviewRequestId = null;

    // PDF 생성 함수 (jsPDF 사용)
    function generatePDF() {
      if (!currentRequestId) {
        alert('분석 결과가 없습니다. 먼저 상권 분석을 진행해주세요.');
        return;
      }
      
      // 미리보기 데이터 채우기
      updatePdfPreview();
      
      // PDF 모달 표시
      const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
      pdfModal.show();
      
      // 초기 상태로 설정 - 미리보기 표시
      document.getElementById('pdfPreviewContainer').style.display = 'block';
      document.getElementById('pdfGenerating').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('downloadPdfBtn').style.display = 'inline-block';
      document.getElementById('retryPdfBtn').style.display = 'none';
    }
    
    // PDF 미리보기 데이터 업데이트
    function updatePdfPreview() {
      // 현재 화면에 표시된 데이터를 사용
      document.getElementById('previewAddress').textContent = 
        document.getElementById('resultAddress').textContent || '-';
      document.getElementById('previewBusinessType').textContent = 
        document.getElementById('resultBusinessType').textContent || '-';
      document.getElementById('previewArea').textContent = 
        document.getElementById('resultArea').textContent + '㎡' || '-';
      document.getElementById('previewSurvival').textContent = 
        document.getElementById('survivalPercentage').textContent || '-%';
      document.getElementById('previewLifePop').textContent = 
        document.getElementById('lifePop300').textContent + '명' || '-';
      document.getElementById('previewWorkingPop').textContent = 
        document.getElementById('workingPop300').textContent + '명' || '-';
      document.getElementById('previewCompetitor').textContent = 
        document.getElementById('competitor300').textContent + '개' || '-';
      
      // 공시지가 추가
      const landValueElement = document.getElementById('totalLandValue');
      if (landValueElement) {
        document.getElementById('previewLandValue').textContent = landValueElement.textContent || '-';
      }
      
      // 분석일시 추가
      const currentDate = new Date().toLocaleDateString('ko-KR');
      document.getElementById('previewDate').textContent = currentDate;
      document.getElementById('previewReportDate').textContent = currentDate;
        
      // 생존 확률에 따른 색상 및 프로그레스 바 변경
      const survivalText = document.getElementById('survivalPercentage').textContent;
      const survivalRate = parseInt(survivalText.replace('%', ''));
      const previewSurvival = document.getElementById('previewSurvival');
      const previewSurvivalBar = document.getElementById('previewSurvivalBar');
      const previewSurvivalText = document.getElementById('previewSurvivalText');
      
      // 프로그레스 바 설정
      previewSurvivalBar.style.width = survivalRate + '%';
      
      if (survivalRate >= 80) {
        previewSurvival.className = 'display-4 mb-3 text-success';
        previewSurvivalBar.className = 'progress-bar bg-success';
        previewSurvivalText.textContent = '높은 생존 가능성 - 장기적 사업 지속에 매우 좋은 조건';
      } else if (survivalRate >= 60) {
        previewSurvival.className = 'display-4 mb-3 text-warning';
        previewSurvivalBar.className = 'progress-bar bg-warning';
        previewSurvivalText.textContent = '보통 생존 가능성 - 적절한 조건이나 추가 전략 검토 필요';
      } else {
        previewSurvival.className = 'display-4 mb-3 text-danger';
        previewSurvivalBar.className = 'progress-bar bg-danger';
        previewSurvivalText.textContent = '낮은 생존 가능성 - 장기 사업 지속에 어려움 예상';
      }
      
      // 강점/주의사항 업데이트
      const strengthsList = document.getElementById('strengthsList');
      const cautionsList = document.getElementById('cautionsList');
      
      if (strengthsList && strengthsList.children.length > 0) {
        const previewStrengths = document.getElementById('previewStrengths').querySelector('ul');
        previewStrengths.innerHTML = '';
        Array.from(strengthsList.children).forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = '<i class="bi bi-check-circle-fill text-success me-2"></i>' + item.textContent;
          li.className = 'mb-2';
          previewStrengths.appendChild(li);
        });
      }
      
      if (cautionsList && cautionsList.children.length > 0) {
        const previewCautions = document.getElementById('previewCautions').querySelector('ul');
        previewCautions.innerHTML = '';
        Array.from(cautionsList.children).forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>' + item.textContent;
          li.className = 'mb-2';
          previewCautions.appendChild(li);
        });
      }
    }

    // PDF 다운로드 함수 (jsPDF로 클라이언트 사이드 생성)
    function downloadPDF() {
      if (!currentRequestId) {
        alert('분석 결과가 없습니다.');
        return;
      }
      
      // 로딩 상태 표시
      document.getElementById('pdfPreviewContainer').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfGenerating').style.display = 'block';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      document.getElementById('retryPdfBtn').style.display = 'none';
      
      // 서버에서 PDF 데이터 가져오기
      fetch(`/ai_analyzer/pdf-data/${currentRequestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('PDF 데이터를 가져올 수 없습니다.');
        }
        return response.json();
      })
      .then(data => {
        // 미리보기를 다시 표시하고 PDF 생성
        document.getElementById('pdfPreviewContainer').style.display = 'block';
        // jsPDF로 PDF 생성
        generatePDFWithJsPDF(data);
      })
      .catch(error => {
        console.error('PDF 생성 오류:', error);
        
        // 오류 상태 표시
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfPreviewContainer').style.display = 'none';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message;
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      });
    }

    // 경량 PDF 다운로드 함수
    function downloadLightweightPDF() {
      if (!currentRequestId) {
        alert('분석 결과가 없습니다.');
        return;
      }
      
      // 로딩 상태 표시
      document.getElementById('pdfPreviewContainer').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfGenerating').style.display = 'block';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      document.getElementById('downloadLightPdfBtn').style.display = 'none';
      document.getElementById('retryPdfBtn').style.display = 'none';
      
      // 서버에서 PDF 데이터 가져오기
      fetch(`/ai_analyzer/pdf-data/${currentRequestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('PDF 데이터를 가져올 수 없습니다.');
        }
        return response.json();
      })
      .then(data => {
        // 경량 PDF 생성
        generateLightweightPDF(data);
      })
      .catch(error => {
        console.error('경량 PDF 생성 오류:', error);
        
        // 오류 상태 표시
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfPreviewContainer').style.display = 'block';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message;
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        document.getElementById('downloadLightPdfBtn').style.display = 'inline-block';
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      });
    }

    // jsPDF를 사용한 PDF 생성 (html2canvas로 미리보기를 이미지로 변환)
    function generatePDFWithJsPDF(data) {
      try {
        // 미리보기 컨테이너를 이미지로 변환
        const element = document.getElementById('pdfPreviewContainer');
        
        // PDF 생성 상태 표시
        document.getElementById('pdfGenerating').style.display = 'block';
        document.getElementById('downloadPdfBtn').style.display = 'none';
        
                 html2canvas(element, {
           scale: 1.2, // 해상도 조정 (2 -> 1.2)
           useCORS: true,
           allowTaint: true,
           backgroundColor: '#ffffff',
           width: element.offsetWidth,
           height: element.offsetHeight,
           removeContainer: true,
           imageTimeout: 0,
           logging: false
         }).then(canvas => {
           const { jsPDF } = window.jspdf;
           const doc = new jsPDF('p', 'mm', 'a4');
           
           // 이미지 크기 계산 (A4 크기에 맞게 조정)
           const imgWidth = 210; // A4 width in mm
           const pageHeight = 297; // A4 height in mm
           const imgHeight = (canvas.height * imgWidth) / canvas.width;
           
           let heightLeft = imgHeight;
           let position = 0;
           
           // JPEG 품질 설정으로 용량 줄이기
           const imgData = canvas.toDataURL('image/jpeg', 0.8); // JPEG, 80% 품질
           
           // 첫 번째 페이지
           doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
           heightLeft -= pageHeight;
           
           // 추가 페이지가 필요한 경우
           while (heightLeft >= 0) {
             position = heightLeft - imgHeight;
             doc.addPage();
             doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
             heightLeft -= pageHeight;
           }
          
          // 파일명 생성
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_상권분석_보고서_${currentDate}.pdf`;
          
          // PDF 다운로드
          doc.save(filename);
          
          // 성공 시 모달 닫기
          setTimeout(() => {
            const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
            if (pdfModal) {
              pdfModal.hide();
            }
          }, 1000);
          
                 }).catch(error => {
           console.error('html2canvas 오류:', error);
           throw new Error('PDF 생성 중 오류가 발생했습니다.');
         });
        
      } catch (error) {
        console.error('PDF 생성 오류:', error);
        
        // 오류 상태 표시
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message || 'PDF 생성 중 오류가 발생했습니다.';
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      }
    }

    // 텍스트 기반 PDF 생성 (용량 최적화)
    function generateLightweightPDF(data) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // 기본 폰트 사용 (한국어는 영문으로 표기)
        doc.setFont('helvetica');
        
        let yPos = 20;
        const lineHeight = 7;
        const margin = 20;
        const pageWidth = 170; // 텍스트 영역 너비
        
        // 제목
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('AI Commercial District Analysis Report', margin, yPos);
        yPos += lineHeight * 2;
        
        // 부제목
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('AI-based Commercial Area Analysis Results', margin, yPos);
        yPos += lineHeight * 2;
        
        // 구분선
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, margin + pageWidth, yPos);
        yPos += lineHeight;
        
        // 기본 정보 섹션
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('1. Basic Information', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Address: ${data.basic_info.address}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Business Type: ${data.basic_info.business_type}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Area: ${data.basic_info.area}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Service Type: ${data.basic_info.service_type}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Analysis Date: ${data.basic_info.analysis_date}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // AI 분석 결과
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('2. AI Analysis Results', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(`Survival Probability: ${data.ai_analysis.survival_rate}`, margin, yPos);
        yPos += lineHeight * 1.5;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        const analysisLines = doc.splitTextToSize(data.ai_analysis.analysis_text, pageWidth);
        analysisLines.forEach(line => {
          doc.text(line, margin, yPos);
          yPos += lineHeight;
        });
        yPos += lineHeight;
        
        // 핵심 지표
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('3. Key Metrics (300m radius)', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`• Living Population: ${data.key_metrics.life_pop_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Working Population: ${data.key_metrics.working_pop_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Competitors: ${data.key_metrics.competitor_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Total Land Value: ${data.key_metrics.total_land_value}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // 경쟁 분석
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('4. Competition Analysis', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`• Competitor Count: ${data.competition_analysis.competitor_count}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Total Business: ${data.competition_analysis.total_business}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Competitor Ratio: ${data.competition_analysis.competitor_ratio}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Business Diversity: ${data.competition_analysis.business_diversity}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // 새 페이지가 필요한 경우
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        // 상세 분석
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('5. Detailed Analysis', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`• Temporary Foreign Residents (1000m): ${data.detailed_analysis.temp_foreign_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Long-term Foreign Residents (300m): ${data.detailed_analysis.long_foreign_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Long-term Foreign Residents (1000m): ${data.detailed_analysis.long_foreign_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Chinese Temporary Residents (300m): ${data.detailed_analysis.temp_foreign_cn_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Chinese Temporary Residents (1000m): ${data.detailed_analysis.temp_foreign_cn_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Chinese Long-term Residents (1000m): ${data.detailed_analysis.long_foreign_cn_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Schools (250m): ${data.detailed_analysis.school_250m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`• Public Buildings (250m): ${data.detailed_analysis.public_building_250m}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // 하단 정보
        yPos = 280; // 페이지 하단으로 이동
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.text('Generated by AI-based Commercial District Analysis System', margin, yPos);
        yPos += 4;
        doc.text(`Report Date: ${new Date().toLocaleDateString('en-US')}`, margin, yPos);
        
        // 파일명 생성
        const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const filename = `AI_Analysis_Report_Light_${currentDate}.pdf`;
        
        // PDF 다운로드
        doc.save(filename);
        
        // 성공 시 모달 닫기
        setTimeout(() => {
          const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
          if (pdfModal) {
            pdfModal.hide();
          }
        }, 1000);
        
      } catch (error) {
        console.error('경량 PDF 생성 오류:', error);
        throw new Error('경량 PDF 생성 중 오류가 발생했습니다.');
      }
    }
  </script>

  <!-- Page Title -->
  <div class="container my-6" style="margin-top: 20px; margin-bottom: 100px; ">
    
    <!-- 상권 분석 정보 입력 -->
    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card p-4 shadow-sm">
          <h3 class="mb-3">
            <span data-lang="KOR">상권 정보입력</span>
            <span data-lang="ENG">Enter Commercial Area Info</span>
            <span data-lang="ESP">Ingresar Información del Área Comercial</span>
          </h3>

          <form>
            <div class="row g-3">
              <!-- 업종 선택 -->
              <div class="col-md-3">
                <label for="industry" class="form-label">
                  <span data-lang="KOR">업종</span>
                  <span data-lang="ENG">Industry</span>
                  <span data-lang="ESP">Industria</span>
                </label>
                <!-- 한국어 업종 선택 -->
                <select class="form-select" id="industryKor" name="industry" data-lang="KOR" required>
                  <option selected disabled>업종을 선택해주세요</option>
                  <option value="0">감성주점</option>
                  <option value="1">경양식</option>
                  <option value="2">관광호텔</option>
                  <option value="3">극장</option>
                  <option value="4">기타</option>
                  <option value="5">기타 휴게음식점</option>
                  <option value="6">김밥(도시락)</option>
                  <option value="7">까페</option>
                  <option value="8">냉면집</option>
                  <option value="9">다방</option>
                  <option value="10">떡카페</option>
                  <option value="11">라이브카페</option>
                  <option value="12">백화점</option>
                  <option value="13">복어취급</option>
                  <option value="14">분식</option>
                  <option value="15">뷔페식</option>
                  <option value="16">식육(숯불구이)</option>
                  <option value="17">아이스크림</option>
                  <option value="18">외국음식전문점(인도, 태국 등)</option>
                  <option value="19">유원지</option>
                  <option value="20">일반조리판매</option>
                  <option value="21">일식</option>
                  <option value="22">전통찻집</option>
                  <option value="23">정종/대포집/소주방</option>
                  <option value="24">중국식</option>
                  <option value="25">철도역구내</option>
                  <option value="26">출장조리</option>
                  <option value="27">커피숍</option>
                  <option value="28">키즈카페</option>
                  <option value="29">탕류(보신용)</option>
                  <option value="30">통닭(치킨)</option>
                  <option value="31">패밀리레스토랑</option>
                  <option value="32">패스트푸드</option>
                  <option value="33">편의점</option>
                  <option value="34">푸드트럭</option>
                  <option value="35">한식</option>
                  <option value="36">호프/통닭</option>
                  <option value="37">횟집</option>
                </select>

                <!-- 영어 업종 선택 -->
                <select class="form-select" id="industryEng" name="industry" data-lang="ENG" style="display: none;" required>
                  <option selected disabled>Please select industry</option>
                  <option value="0">Emotional Pub</option>
                  <option value="1">Western-style</option>
                  <option value="2">Tourist Hotel</option>
                  <option value="3">Theater</option>
                  <option value="4">Other</option>
                  <option value="5">Other Snack Bar</option>
                  <option value="6">Gimbap (Lunchbox)</option>
                  <option value="7">Café</option>
                  <option value="8">Naengmyeon House</option>
                  <option value="9">Coffeehouse</option>
                  <option value="10">Rice Cake Café</option>
                  <option value="11">Live Café</option>
                  <option value="12">Department Store</option>
                  <option value="13">Blowfish Cuisine</option>
                  <option value="14">Snack Bar</option>
                  <option value="15">Buffet</option>
                  <option value="16">Meat Grill (Charcoal)</option>
                  <option value="17">Ice Cream</option>
                  <option value="18">Foreign Cuisine (India, Thailand, etc.)</option>
                  <option value="19">Amusement Area</option>
                  <option value="20">General Food Sale</option>
                  <option value="21">Japanese</option>
                  <option value="22">Traditional Tea House</option>
                  <option value="23">Soju Pub</option>
                  <option value="24">Chinese</option>
                  <option value="25">Train Station Interior</option>
                  <option value="26">Catering</option>
                  <option value="27">Coffee Shop</option>
                  <option value="28">Kids Café</option>
                  <option value="29">Health Soup</option>
                  <option value="30">Fried Chicken</option>
                  <option value="31">Family Restaurant</option>
                  <option value="32">Fast Food</option>
                  <option value="33">Convenience Store</option>
                  <option value="34">Food Truck</option>
                  <option value="35">Korean</option>
                  <option value="36">Pub/Chicken</option>
                  <option value="37">Sashimi House</option>
                </select>

                <!-- 스페인어 업종 선택 -->
                <select class="form-select" id="industryEsp" name="industry" data-lang="ESP" style="display: none;" required>
                  <option selected disabled>Seleccione una industria</option>
                  <option value="0">Pub Emocional</option>
                  <option value="1">Estilo Occidental</option>
                  <option value="2">Hotel Turístico</option>
                  <option value="3">Teatro</option>
                  <option value="4">Otro</option>
                  <option value="5">Otros Bares de Refrigerios</option>
                  <option value="6">Gimbap (Lonchera)</option>
                  <option value="7">Café</option>
                  <option value="8">Restaurante de Naengmyeon</option>
                  <option value="9">Casa de Café</option>
                  <option value="10">Café de Pastel de Arroz</option>
                  <option value="11">Café en Vivo</option>
                  <option value="12">Grandes Almacenes</option>
                  <option value="13">Comida de Pez Globo</option>
                  <option value="14">Comida Rápida Coreana</option>
                  <option value="15">Buffet</option>
                  <option value="16">Carne a la Parrilla (Carbón)</option>
                  <option value="17">Helado</option>
                  <option value="18">Comida Extranjera (India, Tailandia, etc.)</option>
                  <option value="19">Zona de Recreo</option>
                  <option value="20">Venta General de Alimentos</option>
                  <option value="21">Japonesa</option>
                  <option value="22">Casa de Té Tradicional</option>
                  <option value="23">Bar de Soju</option>
                  <option value="24">China</option>
                  <option value="25">Interior de Estación de Tren</option>
                  <option value="26">Catering</option>
                  <option value="27">Tienda de Café</option>
                  <option value="28">Café Infantil</option>
                  <option value="29">Sopa Medicinal</option>
                  <option value="30">Pollo Frito</option>
                  <option value="31">Restaurante Familiar</option>
                  <option value="32">Comida Rápida</option>
                  <option value="33">Tienda de Conveniencia</option>
                  <option value="34">Camión de Comida</option>
                  <option value="35">Coreana</option>
                  <option value="36">Pub/Pollo</option>
                  <option value="37">Restaurante de Pescado Crudo</option>
                </select>
              </div>

              <!-- 주소 입력 -->
              <div class="col-md-5">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="x_coord" name="x_coord">
                <input type="hidden" id="y_coord" name="y_coord">
                <!-- 한국어 주소 라벨 -->
                <label for="address" class="form-label" data-lang="KOR">주소</label>

                <!-- 영어 주소 라벨 -->
                <label for="address" class="form-label" data-lang="ENG" style="display: none;">Address</label>

                <!-- 스페인어 주소 라벨 -->
                <label for="address" class="form-label" data-lang="ESP" style="display: none;">Dirección</label>

                <div class="input-group">
                  <!-- 한국어 -->
                  <input type="text" class="form-control" id="address-kor" name="address" placeholder="주소를 입력해주세요" data-lang="KOR">
                  <button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()" data-lang="KOR">검색</button>

                  <!-- 영어 -->
                  <input type="text" class="form-control" id="address-eng" name="address" placeholder="Please enter your address" data-lang="ENG" style="display: none;">
                  <button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()" data-lang="ENG" style="display: none;">Search</button>

                  <!-- 스페인어 -->
                  <input type="text" class="form-control" id="address-esp" name="address" placeholder="Por favor ingrese la dirección" data-lang="ESP" style="display: none;">
                  <button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()" data-lang="ESP" style="display: none;">Buscar</button>
                </div>
              </div>

              <!-- 점포 면적 입력 -->
              <div class="col-md-2">
                  <!-- 라벨 (Label) -->
                  <label for="area" class="form-label" data-lang="KOR">점포 면적 (㎡)</label>
                  <label for="area" class="form-label" data-lang="ENG" style="display: none;">Store Area (㎡)</label>
                  <label for="area" class="form-label" data-lang="ESP" style="display: none;">Área del local (㎡)</label>
                <input type="number" class="form-control" id="area" name="area" placeholder="예: 33.2" required>
              </div>

              <!-- 주류 판매 여부 선택 -->
              <div class="col-md-2">
                <!-- 라벨 -->
                <label for="service" class="form-label" data-lang="KOR">주류 판매 여부</label>
                <label for="service" class="form-label" data-lang="ENG" style="display: none;">Alcohol Sale</label>
                <label for="service" class="form-label" data-lang="ESP" style="display: none;">Venta de alcohol</label>

                <!-- 셀렉트박스 -->
                <select class="form-select" id="service" name="service" required data-lang="KOR">
                  <option selected disabled>선택</option>
                  <option value="1">판매함</option>
                  <option value="0">판매 안함</option>
                </select>

                <select class="form-select" name="service" required data-lang="ENG" style="display: none;">
                  <option selected disabled>Choose</option>
                  <option value="1">Yes</option>
                  <option value="0">No</option>
                </select>

                <select class="form-select" name="service" required data-lang="ESP" style="display: none;">
                  <option selected disabled>Seleccionar</option>
                  <option value="1">Sí</option>
                  <option value="0">No</option>
                </select>
              </div>
            </div>

            <!-- 버튼 -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-primary custom px-5" onclick="getFormData();">
                <span data-lang="KOR">상권 분석하기</span>
                <span data-lang="ENG" style="display: none;">Analyze Commercial Area</span>
                <span data-lang="ESP" style="display: none;">Analizar Zona Comercial</span>
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>  <!-- 상권 정보 입력 카드 끝 -->

    <!-- 📁 최근 분석 결과 -->
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="card p-4 shadow-sm mb-4">
          <h4 class="mb-3">
            <span data-lang="KOR">📁 내 최근 분석 기록</span>
            <span data-lang="ENG" style="display: none;">📁 My Recent Analyses</span>
            <span data-lang="ESP" style="display: none;">📁 Mis análisis recientes</span>
          </h4>
          {% if previous_docs %}
            <ul class="list-group">
              {% for doc in previous_docs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>
                      <span data-lang="KOR">분석 ID: </span>
                      <span data-lang="ENG" style="display: none;">Analysis ID: </span>
                      <span data-lang="ESP" style="display: none;">ID de Análisis: </span>
                      {{ doc.request.id }}
                    </strong>
                    <br>

                    <small>
                      <span data-lang="KOR">주소: </span>
                      <span data-lang="ENG" style="display: none;">Address: </span>
                      <span data-lang="ESP" style="display: none;">Dirección: </span>
                      {{ doc.request.address }}
                    </small>
                    <br>

                    <small>
                      <span data-lang="KOR">분석일: </span>
                      <span data-lang="ENG" style="display: none;">Date: </span>
                      <span data-lang="ESP" style="display: none;">Fecha: </span>
                      {{ doc.created_at|date:"Y-m-d H:i" }}
                    </small>
                    <br>

                    <small>
                      <span data-lang="KOR">생존 확률: </span>
                      <span data-lang="ENG" style="display: none;">Survival Rate: </span>
                      <span data-lang="ESP" style="display: none;">Probabilidad de Supervivencia: </span>
                      {{ doc.survival_percentage }}%
                    </small>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" onclick="showPdfPreview({{ doc.request.id }})">
                    <span data-lang="KOR">결과보기</span>
                    <span data-lang="ENG" style="display: none;">View Result</span>
                    <span data-lang="ESP" style="display: none;">Ver Resultado</span>
                  </button>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">
              <span data-lang="KOR">아직 분석 결과가 없습니다.</span>
              <span data-lang="ENG" style="display: none;">No analysis results yet.</span>
              <span data-lang="ESP" style="display: none;">Aún no hay resultados de análisis.</span>
            </p>
          {% endif %}
        </div>
      </div>
    </div>

  
    <!-- 본문: 분석 결과 + 챗봇 -->
    <div class="row">
      <!-- 왼쪽: 분석 리포트 -->
      <div class="col-lg-8 mb-4">
        <div class="card p-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">
              <span data-lang="KOR">상권 분석 결과</span>
              <span data-lang="ENG">Commercial Area Analysis Result</span>
              <span data-lang="ESP">Resultado del Análisis Comercial</span>
            </h4>
            <!-- 모달 버튼 -->
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#explanationModal">
              <span data-lang="KOR">상권 분석 도움말</span>
              <span data-lang="ENG" style="display: none;">Commercial Analysis Guide</span>
              <span data-lang="ESP" style="display: none;">Guía de Análisis Comercial</span>
            </button>
                      
            <!-- Bootstrap 모달 -->
            <div class="modal fade" id="explanationModal" tabindex="-1" aria-labelledby="explanationModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">

                  <!-- 🇰🇷 한국어 -->
                  <div data-lang="KOR">
                    <div class="modal-header">
                      <h5 class="modal-title">상권 분석이란 무엇인가?</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                    </div>
                    <div class="modal-body">
                      상권분석은 특정 지역 내 점포나 사업장의 경제적 환경과 소비자 특성을 체계적으로 조사하여<br>
                      사업 성공 가능성을 높이기 위한 중요한 과정입니다.<br><br>

                      <strong>왜 상권분석이 필요한가요?</strong><br>
                      - 상권의 소비 패턴과 유동 인구를 파악하여 효율적인 마케팅 전략을 세울 수 있습니다.<br>
                      - 경쟁 업체 현황과 고객 수요를 분석해 적절한 입지와 서비스를 결정할 수 있습니다.<br>
                      - 투자 위험을 최소화하고 안정적인 매출을 기대할 수 있습니다.<br><br>

                      <strong>AI 기반 상권분석은 다음을 제공합니다:</strong><br>
                      - 점포의 생존 확률 예측<br>
                      - SHAP 요인 분석<br><br>

                      성공적인 창업과 운영을 위해<br>
                      정확한 정보를 바탕으로 전략을 세워보세요!
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>
                  </div>

                  <!-- 🇺🇸 영어 -->
                  <div data-lang="ENG" style="display: none;">
                    <div class="modal-header">
                      <h5 class="modal-title">What is Commercial Area Analysis?</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      Commercial area analysis systematically investigates the economic environment and consumer characteristics
                      of a specific region to increase the success rate of businesses.<br><br>

                      <strong>Why is commercial analysis necessary?</strong><br>
                      - Understand consumption patterns and foot traffic for effective marketing strategies.<br>
                      - Analyze competitors and demand to determine optimal location and services.<br>
                      - Minimize investment risks and expect stable revenue.<br><br>

                      <strong>AI-based commercial analysis offers:</strong><br>
                      - Prediction of store survival rate<br>
                      - SHAP factor analysis<br><br>

                      For a successful business,<br>
                      develop strategies based on accurate data!
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>

                  <!-- 🇪🇸 스페인어 -->
                  <div data-lang="ESP" style="display: none;">
                    <div class="modal-header">
                      <h5 class="modal-title">¿Qué es el análisis comercial?</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                      El análisis comercial investiga sistemáticamente el entorno económico y las características del consumidor
                      en una región específica para aumentar las posibilidades de éxito del negocio.<br><br>

                      <strong>¿Por qué es necesario el análisis comercial?</strong><br>
                      - Comprender los patrones de consumo y el flujo de personas para estrategias de marketing efectivas.<br>
                      - Analizar la competencia y la demanda para determinar la ubicación y los servicios óptimos.<br>
                      - Minimizar los riesgos de inversión y esperar ingresos estables.<br><br>

                      <strong>El análisis comercial basado en IA ofrece:</strong><br>
                      - Predicción de la tasa de supervivencia de la tienda<br>
                      - Análisis de factores SHAP<br><br>

                      ¡Para un negocio exitoso,<br>
                      desarrolle estrategias basadas en datos precisos!
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>

                </div>

              </div>
            </div>
          </div>
          
          <!-- 분석 대기 메시지 -->
          <div id="analysisWaiting">
            <div class="text-center p-4">
              <i class="bi bi-analytics text-muted" style="font-size: 3rem;"></i>

              <h5 class="mt-3 text-muted">
                <span data-lang="KOR">상권 분석을 시작하세요</span>
                <span data-lang="ENG" style="display: none;">Start Commercial Analysis</span>
                <span data-lang="ESP" style="display: none;">Inicie el análisis comercial</span>
              </h5>

              <p class="text-muted">
                <span data-lang="KOR">
                  위의 정보를 입력하고 '상권 분석하기' 버튼을 클릭하면<br>
                  이 영역에 분석 결과가 표시됩니다.
                </span>
                <span data-lang="ENG" style="display: none;">
                  Enter the information above and click the "Analyze" button<br>
                  to see the result here.
                </span>
                <span data-lang="ESP" style="display: none;">
                  Ingrese la información arriba y haga clic en el botón "Analizar"<br>
                  para ver el resultado aquí.
                </span>
              </p>

              <button class="btn btn-outline-secondary mt-3" disabled>
                <i class="bi bi-file-earmark-pdf me-2"></i>
                <span data-lang="KOR">PDF로 저장</span>
                <span data-lang="ENG" style="display: none;">Save as PDF</span>
                <span data-lang="ESP" style="display: none;">Guardar como PDF</span>
              </button>
            </div>
          </div>
          
          <!-- 분석 진행 상황 UI -->
          <div id="analysisProgress" class="analysis-progress" style="display: none;">
            <h5 class="text-center mb-4">
              <i class="bi bi-cpu me-2"></i>
              AI가 상권을 분석하고 있습니다...
            </h5>
            
            <div class="overall-progress">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">전체 진행률</span>
                <span id="overallPercent">0%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-primary" id="overallProgressBar" style="width: 0%"></div>
              </div>
            </div>
            
            <div id="progressSteps">
              <div class="progress-step" id="step-population">
                <div class="progress-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">생활인구 분석</div>
                  <div class="progress-detail">300m/1000m 반경 내 생활인구 및 연령대 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-working">
                <div class="progress-icon">
                  <i class="bi bi-briefcase"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">직장인구 분석</div>
                  <div class="progress-detail">300m 반경 내 직장인구 분포 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-foreign">
                <div class="progress-icon">
                  <i class="bi bi-globe"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">외국인 분석</div>
                  <div class="progress-detail">단기/장기체류외국인 분포 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-facilities">
                <div class="progress-icon">
                  <i class="bi bi-building"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">주변시설 분석</div>
                  <div class="progress-detail">학교, 공공건물 등 유동인구 시설 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-competition">
                <div class="progress-icon">
                  <i class="bi bi-shop"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">경쟁업체 분석</div>
                  <div class="progress-detail">동일업종 및 요식업체 경쟁강도 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-land">
                <div class="progress-icon">
                  <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">공시지가 분석</div>
                  <div class="progress-detail">토지가치 및 임대료 추정</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-ai">
                <div class="progress-icon">
                  <i class="bi bi-cpu"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">AI 예측 분석</div>
                  <div class="progress-detail">머신러닝 모델을 통한 생존확률 예측</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-complete">
                <div class="progress-icon">
                  <i class="bi bi-check-lg"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">분석 완료</div>
                  <div class="progress-detail">결과를 표시하고 있습니다...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 분석 결과 내용 (초기에는 숨김) -->
          <div id="analysisResults" style="display: none;">
            
            <!-- 위치 정보 -->
            <div class="alert alert-info mb-4">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-2">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    <span id="resultAddress"></span>
                  </h5>
                  <div class="row">
                    <div class="col-md-4">
                      <strong>업종:</strong> <span id="resultBusinessType"></span>
                    </div>
                    <div class="col-md-4">
                      <strong>면적:</strong> <span id="resultArea"></span>㎡
                    </div>
                    <div class="col-md-4">
                      <strong>유형:</strong> <span id="resultServiceType"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <small class="text-muted">분석완료</small>
                </div>
              </div>
            </div>

            <!-- 핵심 지표 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-speedometer me-2"></i>핵심 지표
              </h5>
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="lifePop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m 내 생활인구</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="workingPop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m 내 직장인구</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="competitor300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">동일업종 경쟁업체</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="totalLandValue" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">총 공시지가</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI 예측 생존 확률 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-cpu me-2"></i>AI 예측 분석
              </h5>
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="text-center">
                    <div class="display-1 fw-bold mb-3" id="survivalPercentage">-%</div>
                    <h4 class="mb-3">장기 생존 확률</h4>
                    <div class="progress" style="height: 20px;">
                      <div id="survivalBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="p-3">
                    <h6 class="mb-3">AI 분석 결과</h6>
                    <div id="survivalAnalysis" class="alert">
                      <!-- AI 분석 결과가 여기에 표시됩니다 -->
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      AI 모델이 25개 지표를 종합 분석한 결과입니다.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- 상권 경쟁 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-shop me-2"></i>상권 경쟁 분석 (300m 반경)
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-3">
                  <h6>경쟁업체 수</h6>
                  <div class="h4 text-danger" id="competitorCount">-</div>
                </div>
                <div class="col-md-3">
                  <h6>전체 요식업체</h6>
                  <div class="h4 text-info" id="adjacentBiz">-</div>
                </div>
                <div class="col-md-3">
                  <h6>경쟁업체 비율</h6>
                  <div class="h4 text-warning" id="competitorRatio">-%</div>
                </div>
                <div class="col-md-3">
                  <h6>업종 다양성</h6>
                  <div class="h4 text-success" id="businessDiversity">-</div>
                </div>
              </div>
              
              <div class="mt-4">
                <h6>경쟁 강도 분석</h6>
                <div class="progress" style="height: 25px;">
                  <div id="competitionBar" class="progress-bar" style="width: 0%">
                    <span id="competitionLevel">분석중...</span>
                  </div>
                </div>
                <small class="text-muted mt-2 d-block">
                  경쟁업체 비율이 20% 이하면 낮음, 20-50%는 보통, 50% 이상은 높음으로 분류됩니다.
                </small>
              </div>
            </div>

            <!-- 분석 요약 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-lightbulb me-2"></i>AI 분석 요약
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">
                    <i class="bi bi-check-circle me-2"></i>강점
                  </h6>
                  <ul id="strengthsList">
                    <!-- 강점 목록이 여기에 표시됩니다 -->
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>주의사항
                  </h6>
                  <ul id="cautionsList">
                    <!-- 주의사항 목록이 여기에 표시됩니다 -->
                  </ul>
                </div>
              </div>
            </div>

            <!-- PDF 저장 버튼 -->
            <div class="text-center">
              <button class="btn btn-primary" onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>PDF로 저장
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 챗봇 -->
      <div class="col-lg-4">
        <div class="card p-4 shadow-sm">
          <div class="chat-interface-container">
            <div class="chat-messages-area" id="chatMessagesArea">
              <!-- 메시지가 여기에 동적으로 추가됩니다 -->
              <div class="chat-welcome-message text-center py-3">
                <div class="mb-2">
                  <i class="fas fa-robot fa-2x text-primary"></i>
                </div>
                <h5 class="text-primary mb-2">분석 결과 챗봇</h5>
                <p class="text-muted mb-3">상권 분석과 관련된 질문을 자유롭게 해보세요.</p>

                <!-- 예시 질문 버튼 -->
                <div class="mb-3">
                  <span class="text-muted">추천 질문</span><br>
                  <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('이 상권의 유동 인구 특징은 어떤가요?')">유동 인구</button>
                  <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('이 지역의 경쟁 업체 수는 얼마나 되나요?')">경쟁 업체</button>
                  <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('이 지역은 창업 위험이 높은 편인가요?')">창업 위험</button>
                  <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('주변 상권 중 가장 활발한 업종은 무엇인가요?')">인기 업종</button>
                </div>
              </div>
            </div>

            <div id="typingIndicator" class="message-entry typing-indicator-message" style="display: none;">
              <div class="message-bubble">
                답변을 생성 중입니다... 
                <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
              </div>
            </div>

            <div class="chat-input-area">
              <textarea
                id="messageInput"
                class="form-control"
                placeholder="메시지를 입력하세요..."
                rows="1"
                aria-label="메시지 입력"
              ></textarea>
              <button id="sendButton" class="btn btn-primary" type="button" aria-label="메시지 전송">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CSRF 토큰 (API 호출용) -->
  {% csrf_token %}

  <!-- 사용자 정보 JSON 데이터 -->
  {{ user_info|json_script:"user-info-data" }}

  <!-- DEBUG 확인용 콘솔 로그 -->
  <script>
    console.log("🧪 Template user_id:", "{{ request.user.id|safe }}");
    console.log("🧪 User info:", JSON.parse(document.getElementById('user-info-data').textContent));
  </script>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/chat_main.js' %}"></script>
<script src="{% static 'js/chat_list.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  // chatListManager 초기화 (chat_list.js에 정의되어 있음)
  document.addEventListener('DOMContentLoaded', function() {
    window.chatListManager = new ChatListManager();

    // fillExampleQuestion 함수 정의: 챗봇 입력 필드(messageInput)에 질문을 채움
    window.fillExampleQuestion = function(text) {
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.value = text;
        messageInput.focus();
      }
    };
  });
</script>
{% endblock extra_js %}
{% block pdf %}
<!-- PDF 미리보기 모달 (분석 기록용) -->
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pdfPreviewModalLabel">
          <i class="bi bi-file-earmark-pdf me-2"></i>분석 결과 미리보기
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
        <div id="previewLoading" class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">로딩 중...</span>
          </div>
          <h6>분석 결과를 불러오고 있습니다...</h6>
          <p class="text-muted">잠시만 기다려 주세요.</p>
        </div>
        
        <div id="previewError" style="display: none;" class="text-center">
          <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
          <h6>분석 결과를 불러올 수 없습니다</h6>
          <p class="text-muted" id="previewErrorMessage">잠시 후 다시 시도해 주세요.</p>
        </div>
        
        <!-- PDF 스타일 미리보기 내용 -->
        <div id="previewContent" style="display: none; background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Nanum Gothic', Arial, sans-serif;">
          <!-- 헤더 -->
          <div class="text-center mb-4" style="border-bottom: 3px solid #1e3a8a; padding-bottom: 20px;">
            <h2 class="text-primary mb-1" style="font-weight: 800; font-size: 24px;">AI 상권분석 보고서</h2>
            <p class="text-muted mb-0" style="font-size: 14px;">인공지능 기반 상업지구 분석 결과</p>
          </div>
          
          <!-- 기본 정보 -->
          <div class="mb-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #1e3a8a;">
            <h5 class="text-primary mb-3"><i class="bi bi-geo-alt me-2"></i>분석 대상 정보</h5>
            <div class="row">
              <div class="col-md-6">
                <p><strong>주소:</strong> <span id="previewAddr">-</span></p>
                <p><strong>업종:</strong> <span id="previewBizType">-</span></p>
              </div>
              <div class="col-md-6">
                <p><strong>면적:</strong> <span id="previewAreaSize">-</span>㎡</p>
                <p><strong>분석일시:</strong> <span id="previewAnalysisDate">-</span></p>
              </div>
            </div>
          </div>
          
          <!-- AI 생존 확률 -->
          <div class="mb-4" style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
            <h5 class="text-success mb-3"><i class="bi bi-robot me-2"></i>AI 생존 확률</h5>
            <div class="display-4 mb-3 text-primary" id="previewSurvivalRate" style="font-weight: 800;">-%</div>
            <div class="progress mb-3" style="height: 20px;">
              <div class="progress-bar" id="previewSurvivalProgressBar" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="text-muted mb-0" id="previewSurvivalComment">분석 중...</p>
          </div>
          
          <!-- 핵심 지표 -->
          <div class="mb-4">
            <h5 class="text-primary border-bottom border-primary pb-2 mb-3"><i class="bi bi-speedometer me-2"></i>핵심 지표</h5>
            <div class="row">
              <div class="col-md-3">
                <div class="card border-info h-100 text-center">
                  <div class="card-body">
                    <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">생활인구</h6>
                    <p class="card-text fw-bold text-primary" id="previewLifePopulation">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-warning h-100 text-center">
                  <div class="card-body">
                    <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">직장인구</h6>
                    <p class="card-text fw-bold text-primary" id="previewWorkingPopulation">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-danger h-100 text-center">
                  <div class="card-body">
                    <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">경쟁업체</h6>
                    <p class="card-text fw-bold text-primary" id="previewCompetitors">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-secondary h-100 text-center">
                  <div class="card-body">
                    <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">공시지가</h6>
                    <p class="card-text fw-bold text-primary" id="previewLandPrice">-</p>
                    <small class="text-muted">총 공시지가</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 강점/주의사항 -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>강점</h6>
                  </div>
                  <div class="card-body" id="previewStrengthsList">
                    <ul class="list-unstyled mb-0">
                      <li class="text-muted">분석 중...</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>주의사항</h6>
                  </div>
                  <div class="card-body" id="previewCautionsList">
                    <ul class="list-unstyled mb-0">
                      <li class="text-muted">분석 중...</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 보고서 하단 -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                본 보고서는 AI 기반 상권분석 시스템에 의해 생성되었습니다.<br>
                분석 기준일: <span id="previewReportGeneratedDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="previewDownloadPdfBtn" onclick="downloadPreviewPDF()" style="display: none;">
              <i class="bi bi-download me-2"></i>고품질 PDF (이미지)
            </button>
            <button type="button" class="btn btn-outline-primary" id="previewDownloadLightPdfBtn" onclick="downloadPreviewLightweightPDF()" style="display: none;">
              <i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF 다운로드 모달 -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel">
            <i class="bi bi-file-earmark-pdf me-2"></i>AI 상권분석 보고서 미리보기
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="pdfGenerating" style="display: none;" class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">생성 중...</span>
            </div>
            <h6>PDF 보고서를 생성하고 있습니다...</h6>
            <p class="text-muted">잠시만 기다려 주세요.</p>
          </div>
          
          <div id="pdfError" style="display: none;" class="text-center">
            <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h6>PDF 생성 중 오류가 발생했습니다</h6>
            <p class="text-muted" id="pdfErrorMessage">잠시 후 다시 시도해 주세요.</p>
          </div>
          
          <!-- PDF 미리보기 내용 -->
          <div id="pdfPreviewContainer" style="background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="text-center mb-4">
              <h2 class="text-primary mb-1" style="font-weight: 700;">AI 상권분석 보고서</h2>
              <p class="text-muted mb-0">인공지능 기반 상업지구 분석 결과</p>
              <hr class="my-3" style="border-color: #1e3a8a; border-width: 2px;">
            </div>
            
            <!-- 기본 정보 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>분석 대상 정보</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>주소:</strong> <span id="previewAddress">-</span></p>
                        <p><strong>업종:</strong> <span id="previewBusinessType">-</span></p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>면적:</strong> <span id="previewArea">-</span></p>
                        <p><strong>분석일시:</strong> <span id="previewDate">-</span></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- AI 생존 확률 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-success">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI 생존 확률</h5>
                  </div>
                  <div class="card-body text-center">
                    <div class="display-4 mb-3" id="previewSurvival">-%</div>
                    <div class="progress mb-3" style="height: 20px;">
                      <div class="progress-bar" id="previewSurvivalBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-muted mb-0" id="previewSurvivalText">분석 중...</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 핵심 지표 -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card border-info h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">생활인구</h6>
                    <p class="card-text fw-bold" id="previewLifePop">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-warning h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">직장인구</h6>
                    <p class="card-text fw-bold" id="previewWorkingPop">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-danger h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">경쟁업체</h6>
                    <p class="card-text fw-bold" id="previewCompetitor">-</p>
                    <small class="text-muted">300m 반경</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-secondary h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">공시지가</h6>
                    <p class="card-text fw-bold" id="previewLandValue">-</p>
                    <small class="text-muted">총 공시지가</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 강점/주의사항 -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>강점</h6>
                  </div>
                  <div class="card-body" id="previewStrengths">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>주의사항</h6>
                  </div>
                  <div class="card-body" id="previewCautions">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 보고서 하단 -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                본 보고서는 AI 기반 상권분석 시스템에 의해 생성되었습니다.<br>
                분석 기준일: <span id="previewReportDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="downloadPdfBtn" onclick="downloadPDF()">
              <i class="bi bi-download me-2"></i>고품질 PDF (이미지)
            </button>
            <button type="button" class="btn btn-outline-primary" id="downloadLightPdfBtn" onclick="downloadLightweightPDF()">
              <i class="bi bi-file-text me-2"></i>경량 PDF (텍스트)
            </button>
          </div>
          <button type="button" class="btn btn-primary" id="retryPdfBtn" onclick="downloadPDF()" style="display: none;">
            <i class="bi bi-arrow-clockwise me-2"></i>다시 시도
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock pdf %}  