{% extends 'base.html' %} {% block title %} 상권분석 LocaAI 챗봇 {% endblock %}
{% block css %}
<style>
  .chat-container {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
  }

  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 20px;
  }

  .message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
  }

  .message.user {
    align-items: flex-end;
  }

  .message.assistant {
    align-items: flex-start;
  }

  .message-content {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 15px;
    margin: 5px 0;
  }

  .user .message-content {
    background-color: #007bff;
    color: white;
  }

  .assistant .message-content {
    background-color: #e9ecef;
    color: #212529;
  }

  .message-time {
    font-size: 0.8em;
    color: #6c757d;
    margin: 0 5px;
  }

  .chat-input {
    display: flex;
    gap: 10px;
    padding: 20px;
    background-color: white;
    border-top: 1px solid #dee2e6;
  }

  .chat-input textarea {
    flex-grow: 1;
    resize: none;
    border-radius: 20px;
    padding: 10px 15px;
    border: 1px solid #ced4da;
  }

  .chat-input button {
    border-radius: 20px;
    padding: 10px 20px;
  }

  .typing-indicator {
    display: none;
    padding: 10px 15px;
    background-color: #e9ecef;
    border-radius: 15px;
    margin: 5px 0;
    color: #6c757d;
  }

  .typing-indicator.active {
    display: block;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <textarea
        id="messageInput"
        class="form-control"
        placeholder="메시지를 입력하세요..."
        rows="1"
      ></textarea>
      <button id="sendButton" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    let ws = null;
    let sessionId = null;

    function connectWebSocket() {
      const wsScheme = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${wsScheme}//${window.location.host}/ws/chatbot/`;
      ws = new WebSocket(wsUrl);

      ws.onopen = function () {
        console.log("WebSocket 연결됨");
        sessionId = localStorage.getItem("session_id") || generateSessionId();
        localStorage.setItem("session_id", sessionId);
      };

      let assistantMessageInitialized = false; // 추가

      ws.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.error) {
          showError(data.error);
        } else if (data.chunk) {
          if (!assistantMessageInitialized) {
            addMessage("", "assistant"); // 빈 assistant 메시지 먼저 추가
            assistantMessageInitialized = true;
          }
          appendToLastAssistantMessage(data.chunk);
        } else if (data.done) {
          hideTypingIndicator();
          assistantMessageInitialized = false; // 초기화
          const last = chatMessages.querySelector(
            ".message.assistant:last-child .message-content"
          );
          if (last && !last.textContent.endsWith("\n")) {
            last.textContent += "\n";
          }
        }
      };

      ws.onclose = function () {
        console.log("WebSocket 연결 종료");
        setTimeout(connectWebSocket, 1000);
      };

      ws.onerror = function (error) {
        console.error("WebSocket 에러:", error);
        showError("연결 오류가 발생했습니다.");
      };
    }

    function appendToLastAssistantMessage(text) {
      const lastAssistant = [
        ...chatMessages.querySelectorAll(".message.assistant"),
      ].pop();
      const contentDiv = lastAssistant?.querySelector(".message-content");
      if (contentDiv) {
        contentDiv.textContent += text;
      } else {
        addMessage(text, "assistant");
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      if (ws && ws.readyState === WebSocket.OPEN) {
        const data = {
          user_id: "{{ user.id }}",
          session_id: sessionId,
          question: message,
        };
        ws.send(JSON.stringify(data));
        addMessage(message, "user");
        showTypingIndicator();
        messageInput.value = "";
      } else {
        showError("서버와의 연결이 끊어졌습니다.");
      }
    }

    function addMessage(content, type) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${type}`;
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      contentDiv.textContent = content;
      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      timeDiv.textContent = new Date().toLocaleTimeString();
      messageDiv.appendChild(contentDiv);
      messageDiv.appendChild(timeDiv);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
      const indicator = document.createElement("div");
      indicator.className = "message assistant typing-indicator active";
      indicator.innerHTML =
        '<div class="message-content">답변을 생성중입니다...</div>';
      chatMessages.appendChild(indicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
      const indicator = document.querySelector(".typing-indicator");
      if (indicator) indicator.remove();
    }

    function showError(message) {
      const errorDiv = document.createElement("div");
      errorDiv.className = "alert alert-danger alert-dismissible fade show";
      errorDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      chatMessages.appendChild(errorDiv);
    }

    function generateSessionId() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
        /[xy]/g,
        function (c) {
          const r = (Math.random() * 16) | 0;
          const v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        }
      );
    }

    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    messageInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });

    connectWebSocket();
  });
</script>
{% endblock %}
