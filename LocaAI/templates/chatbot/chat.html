{% extends 'chatbot/base_chatbot.html' %}
{% load static %}

{% block title %}ìƒê¶Œë¶„ì„ LocaAI ì±—ë´‡{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/chat_styles.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-3 mb-3">
  <h3 class="text-center mb-3">LocaAI ì±—ë´‡</h3>

  <div class="chat-main-container">
    <!-- ì±„íŒ… ë¦¬ìŠ¤íŠ¸ ì‚¬ì´ë“œë°” -->
    <div class="chat-list-sidebar">
      <div class="chat-list-header">
        <h5 class="mb-0">ì±„íŒ… íˆìŠ¤í† ë¦¬</h5>
        <button id="newChatButton" class="btn btn-outline-primary btn-sm" type="button" title="ìƒˆ ì±„íŒ… ì‹œì‘">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      
      <div class="chat-list-container">
        <div class="chat-list-search">
          <input type="text" id="chatSearchInput" class="form-control form-control-sm" placeholder="ì±„íŒ… ê²€ìƒ‰...">
        </div>
        
        <div class="chat-list-items" id="chatListItems">
          <!-- ì±„íŒ… ë¦¬ìŠ¤íŠ¸ê°€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
          <div class="chat-list-loading text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">ë¡œë”©ì¤‘...</span>
            </div>
            <small class="d-block mt-2 text-muted">ì±„íŒ… íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</small>
          </div>
        </div>
      </div>
      
      <!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ (ëª¨ë°”ì¼ìš©) -->
      <button id="toggleSidebar" class="btn btn-primary sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <div class="chat-interface-container">
      <div class="chat-messages-area" id="chatMessagesArea">
        <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        <div class="chat-welcome-message text-center py-5">
          <div class="mb-3">
            <i class="fas fa-robot fa-3x text-primary"></i>
          </div>
          <h4 class="text-primary mb-3">LocaAI ì±—ë´‡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h4>
          <p class="text-muted mb-4">ìƒê¶Œ ë¶„ì„ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ í•´ë³´ì„¸ìš”.</p>
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <h6 class="card-title text-primary mb-2">ğŸ’¡ ì˜ˆì‹œ ì§ˆë¬¸ë“¤</h6>
                  <ul class="list-unstyled mb-0 text-start">
                    <li class="mb-1">â€¢ "ê°•ë‚¨ì—­ ì£¼ë³€ ìƒê¶Œ ë¶„ì„í•´ì¤˜"</li>
                    <li class="mb-1">â€¢ "í™ëŒ€ ê·¼ì²˜ ì¹´í˜ ì°½ì—…í•˜ë ¤ëŠ”ë° ì–´ë•Œ?"</li>
                    <li class="mb-1">â€¢ "ëª…ë™ ìœ ë™ì¸êµ¬ ë°ì´í„° ì•Œë ¤ì¤˜"</li>
                    <li>â€¢ "ì„œìš¸ í•«í”Œë ˆì´ìŠ¤ ì¶”ì²œí•´ì¤˜"</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="typingIndicator" class="message-entry typing-indicator-message" style="display: none;">
        <div class="message-bubble">
          ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... 
          <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>
        </div>
      </div>

      <div class="chat-input-area">
        <!-- ëª¨ë“œ ì„ íƒ í† ê¸€ ì¶”ê°€ -->
        <div class="mode-toggle-container mb-2">
          <div class="d-flex align-items-center justify-content-center">
            <span class="me-2 text-muted">ëª¨ë“œ:</span>
            <div class="btn-group btn-group-sm" role="group" aria-label="ì±—ë´‡ ëª¨ë“œ ì„ íƒ">
              <input type="radio" class="btn-check" name="chatMode" id="llmMode" value="llm" checked autocomplete="off">
              <label class="btn btn-outline-primary" for="llmMode">
                <i class="fas fa-brain me-1"></i>LLM
              </label>
              
              <input type="radio" class="btn-check" name="chatMode" id="ragMode" value="rag" autocomplete="off">
              <label class="btn btn-outline-success" for="ragMode">
                <i class="fas fa-database me-1"></i>RAG
              </label>
            </div>
            <span class="ms-2">
              <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                 title="LLM: ì¼ë°˜ ëŒ€í™”í˜• AI | RAG: ë²¡í„°DB ê¸°ë°˜ ì •ë³´ ê²€ìƒ‰"></i>
            </span>
          </div>
        </div>
        
        <textarea
          id="messageInput"
          class="form-control"
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          rows="1"
          aria-label="ë©”ì‹œì§€ ì…ë ¥"
        ></textarea>
        <button id="sendButton" class="btn btn-primary" type="button" aria-label="ë©”ì‹œì§€ ì „ì†¡">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CSRF í† í° (API í˜¸ì¶œìš©) -->
{% csrf_token %}

<!-- ì‚¬ìš©ì ì •ë³´ JSON ë°ì´í„° -->
{{ user_info|json_script:"user-info-data" }}

<!-- DEBUG í™•ì¸ìš© ì½˜ì†” ë¡œê·¸ -->
<script>
  console.log("ğŸ§ª Template user_id:", "{{ request.user.id|safe }}");
  console.log("ğŸ§ª User info:", JSON.parse(document.getElementById('user-info-data').textContent));
</script>
{% endblock %}

{% block js %}
<script src="{% static 'js/chat_main.js' %}"></script>
<script src="{% static 'js/chat_list.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}
