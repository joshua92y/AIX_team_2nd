{% extends 'base.html' %}
{% load static %}

{% block title %}{{ user.username }}님의 마이페이지{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    --success-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.15);
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .mypage-wrapper {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 2rem 0;
  }

  .container-custom {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  /* 프로필 헤더 */
  .profile-section {
    background: var(--primary-gradient);
    border-radius: var(--border-radius);
    padding: 3rem;
    margin-bottom: 3rem;
    color: white;
    position: relative;
    overflow: hidden;
  }

  .profile-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    backdrop-filter: blur(10px);
  }

  .profile-avatar {
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin-bottom: 1.5rem;
    border: 4px solid rgba(255, 255, 255, 0.3);
  }

  .profile-info h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .profile-meta {
    opacity: 0.9;
    font-size: 1.1rem;
  }

  /* 통계 카드 그리드 */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .stat-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .stat-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--card-shadow-hover);
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
  }

  .stat-number {
    font-size: 3rem;
    font-weight: 800;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }

  .stat-label {
    color: #6b7280;
    font-size: 1rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-icon {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 50px;
    height: 50px;
    background: var(--primary-gradient);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
  }

  /* 메인 콘텐츠 그리드 */
  .content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 3rem;
    margin-bottom: 3rem;
  }

  .section-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 2.5rem;
    box-shadow: var(--card-shadow);
    height: fit-content;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-title i {
    width: 40px;
    height: 40px;
    background: var(--primary-gradient);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
  }

  /* 활동 아이템 */
  .activity-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    transition: var(--transition);
    border: 1px solid #f3f4f6;
  }

  .activity-item:hover {
    background: #f9fafb;
    border-color: #e5e7eb;
    transform: translateX(8px);
  }

  .activity-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    flex-shrink: 0;
  }

  .activity-analysis { background: var(--primary-gradient); color: white; }
  .activity-chat { background: var(--secondary-gradient); color: #8b4513; }
  .activity-analysis_chat { background: var(--success-gradient); color: #2c3e50; }
  .activity-inquiry { background: linear-gradient(135deg, #d299c2, #fef9d7); color: #8b4513; }

  .activity-content h6 {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
    font-size: 1rem;
  }

  .activity-subtitle {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
  }

  .activity-time {
    color: #9ca3af;
    font-size: 0.75rem;
  }

  /* 성과 분석 섹션 */
  .performance-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
  }

  .performance-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--card-shadow-hover);
  }

  .performance-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .performance-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }

  .icon-best { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
  .icon-avg { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }

  .performance-title {
    font-weight: 600;
    color: #1f2937;
    margin: 0;
  }

  .performance-value {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
  }

  .performance-subtitle {
    color: #6b7280;
    font-size: 0.875rem;
  }

  /* 빠른 액션 */
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    text-decoration: none;
    color: #374151;
    font-weight: 500;
    transition: var(--transition);
  }

  .action-btn:hover {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
    box-shadow: var(--card-shadow);
  }

  .action-btn i {
    font-size: 1.25rem;
  }

  /* 빈 상태 */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state h4 {
    margin-bottom: 0.5rem;
    color: #374151;
  }

  /* 반응형 */
  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    
    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .container-custom {
      padding: 0 1rem;
    }
    
    .profile-section {
      padding: 2rem;
      text-align: center;
    }
    
    .profile-info h1 {
      font-size: 2rem;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    .section-card {
      padding: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="mypage-wrapper">
  <div class="container-custom">
    <!-- 프로필 헤더 -->
    <div class="profile-section">
      <div class="row align-items-center">
        <div class="col-md-auto">
          <div class="profile-avatar">
            <i class="bi bi-person-fill"></i>
          </div>
        </div>
        <div class="col-md">
          <div class="profile-info">
            <h1>{{ user.username }}님, 안녕하세요! 👋</h1>
            <div class="profile-meta">
              <i class="bi bi-envelope me-2"></i>{{ user.email }}
              <span class="mx-3">•</span>
              <i class="bi bi-calendar-check me-2"></i>{{ user.date_joined|date:"Y년 m월 d일" }} 가입
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 통계 카드 -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number">{{ total_analyses }}</div>
        <div class="stat-label">상권 분석</div>
        <div class="stat-icon">
          <i class="bi bi-graph-up"></i>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ total_chat_sessions }}</div>
        <div class="stat-label">AI 상담</div>
        <div class="stat-icon">
          <i class="bi bi-chat-dots"></i>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ total_inquiries }}</div>
        <div class="stat-label">문의 작성</div>
        <div class="stat-icon">
          <i class="bi bi-question-circle"></i>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ total_activities }}</div>
        <div class="stat-label">총 활동</div>
        <div class="stat-icon">
          <i class="bi bi-activity"></i>
        </div>
      </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="content-grid">
      <!-- 왼쪽: 최근 활동 -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="bi bi-clock-history"></i>
          최근 활동
        </h2>
        
        {% if recent_activities %}
          {% for activity in recent_activities %}
          <div class="activity-item">
            <div class="activity-icon activity-{{ activity.type }}">
              <i class="{{ activity.icon }}"></i>
            </div>
            <div class="activity-content flex-grow-1">
              <h6>
                <a href="{{ activity.url }}" class="text-decoration-none text-dark">
                  {{ activity.title }}
                </a>
              </h6>
              <div class="activity-subtitle">{{ activity.subtitle }}</div>
              <div class="activity-time">{{ activity.date|date:"m월 d일 H:i" }}</div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h4>아직 활동 기록이 없습니다</h4>
            <p>첫 번째 상권 분석을 시작해보세요!</p>
          </div>
        {% endif %}
      </div>

      <!-- 오른쪽: 성과 & 액션 -->
      <div>
        <!-- 성과 분석 -->
        {% if total_analyses > 0 %}
        <div class="section-card">
          <h3 class="section-title">
            <i class="bi bi-trophy"></i>
            나의 성과
          </h3>
          
          <div class="performance-card">
            <div class="performance-header">
              <div class="performance-icon icon-avg">
                <i class="bi bi-graph-up-arrow"></i>
              </div>
              <h4 class="performance-title">평균 생존율</h4>
            </div>
            <div class="performance-value text-primary">{{ analysis_stats.avg_survival|floatformat:1 }}%</div>
            <div class="performance-subtitle">전체 {{ total_analyses }}건 분석 평균</div>
          </div>

          {% if best_analysis %}
          <div class="performance-card">
            <div class="performance-header">
              <div class="performance-icon icon-best">
                <i class="bi bi-star-fill"></i>
              </div>
              <h4 class="performance-title">최고 성과</h4>
            </div>
                                            <div class="performance-value text-success">{{ best_analysis.survival_percentage|floatformat:1 }}%</div>
            <div class="performance-subtitle">{{ best_analysis.request.address }}</div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- 빠른 액션 -->
        <div class="section-card">
          <h3 class="section-title">
            <i class="bi bi-lightning"></i>
            빠른 액션
          </h3>
          
          <div class="quick-actions">
            <a href="{% url 'AI_Analyzer:analyze_page' %}" class="action-btn">
              <i class="bi bi-plus-circle"></i>
              새 분석
            </a>
            <a href="/chatbot/" class="action-btn">
              <i class="bi bi-chat-dots"></i>
              AI 상담
            </a>
            <a href="{% url 'shopdash:dashboard' %}" class="action-btn">
              <i class="bi bi-bar-chart"></i>
              데이터 대시보드
            </a>
            <a href="{% url 'border:inquiry_list' %}" class="action-btn">
              <i class="bi bi-headset"></i>
              고객 지원
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- 상세 활동 그리드 -->
    {% if analysis_results or chat_sessions or inquiries %}
    <div class="content-grid">
      <!-- 분석 기록 -->
      {% if analysis_results %}
      <div class="section-card">
        <h3 class="section-title">
          <i class="bi bi-graph-up"></i>
          최근 분석 기록
        </h3>
        
        {% for result in analysis_results %}
        <div class="activity-item">
          <div class="activity-icon activity-analysis">
            <i class="bi bi-geo-alt"></i>
          </div>
          <div class="activity-content flex-grow-1">
            <h6>
              <a href="/ai_analyzer/result/{{ result.request.id }}/" class="text-decoration-none text-dark">
                {{ result.request.address }}
              </a>
            </h6>
            <div class="activity-subtitle">
              {{ result.request.business_type.name }} • {{ result.request.area|floatformat:0 }}㎡
            </div>
            <div class="activity-time">
                                      생존율: <strong class="text-success">{{ result.survival_percentage|floatformat:1 }}%</strong> • 
              {{ result.created_at|date:"m월 d일" }}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- 상담 기록 -->
      {% if chat_sessions or analysis_sessions %}
      <div class="section-card">
        <h3 class="section-title">
          <i class="bi bi-chat-square-text"></i>
          최근 상담 기록
        </h3>
        
        {% for session in chat_sessions %}
        <div class="activity-item">
          <div class="activity-icon activity-chat">
            <i class="bi bi-robot"></i>
          </div>
          <div class="activity-content">
            <h6>
              <a href="/chatbot/?session={{ session.session_id }}" class="text-decoration-none text-dark">
                {{ session.title|default:"AI 상담" }}
              </a>
            </h6>
            <div class="activity-subtitle">일반 상담</div>
            <div class="activity-time">{{ session.lastload_at|date:"m월 d일" }}</div>
          </div>
        </div>
        {% endfor %}

        {% for session in analysis_sessions %}
        <div class="activity-item">
          <div class="activity-icon activity-analysis_chat">
            <i class="bi bi-chat-square-dots"></i>
          </div>
          <div class="activity-content">
            <h6>
              <a href="/ai_analyzer/analysis-session-log/{{ user.id }}/{{ session.session_id }}/" class="text-decoration-none text-dark">
                {{ session.title|default:"분석 상담" }}
              </a>
            </h6>
            <div class="activity-subtitle">분석 기반 상담</div>
            <div class="activity-time">{{ session.lastload_at|date:"m월 d일" }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 카드 애니메이션
  const cards = document.querySelectorAll('.stat-card, .performance-card');
  
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);
  
  cards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
    observer.observe(card);
  });
});
</script>
{% endblock %} 