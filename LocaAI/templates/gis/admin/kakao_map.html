{% load i18n %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ë§µ - {{ name }}</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #{{ id }}_map {
            width: {{ map_width }}px;
            height: {{ map_height }}px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        
        .kakao-map-controls {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .kakao-map-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .kakao-map-coords {
            font-size: 11px;
            color: #28a745;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .kakao-map-help {
            font-size: 11px;
            color: #6c757d;
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 3px;
            border-left: 3px solid #28a745;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="{{ id }}_map"></div>
    
    <div class="kakao-map-controls">
        <div class="kakao-map-info">
            ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ (í•œêµ­ ì§€ì—­ ìµœì í™”)
        </div>
        <div id="{{ id }}_coords" class="kakao-map-coords"></div>
        <div class="kakao-map-help">
            ğŸ’¡ ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”. ì„¤ì •ëœ ì¢Œí‘œëŠ” EPSG:5186 í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
        </div>
    </div>
    
    <!-- ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&autoload=false&libraries=services"></script>
    
    <script>
        (function() {
            // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ í™•ì¸
            if (typeof kakao === 'undefined') {
                document.getElementById('{{ id }}_map').innerHTML = 
                    '<div class="error-message">ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
            kakao.maps.load(function() {
                initKakaoMap();
            });
            
            function initKakaoMap() {
                // ì§€ë„ ì»¨í…Œì´ë„ˆì™€ ì˜µì…˜ ì„¤ì •
                const container = document.getElementById('{{ id }}_map');
                const options = {
                    center: new kakao.maps.LatLng({{ default_lat }}, {{ default_lon }}), // ì„œìš¸ ì¤‘ì‹¬
                    level: {{ default_zoom }}, // ì§€ë„ í™•ëŒ€ ë ˆë²¨
                    draggable: true,
                    scrollwheel: true,
                    disableDoubleClick: false,
                    disableDoubleClickZoom: false,
                    keyboardShortcuts: true
                };
                
                // ì§€ë„ ìƒì„±
                const map = new kakao.maps.Map(container, options);
                
                // ì§€ë„ ì»¨íŠ¸ë¡¤ ì¶”ê°€
                const zoomControl = new kakao.maps.ZoomControl();
                map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
                
                const mapTypeControl = new kakao.maps.MapTypeControl();
                map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
                
                // ë§ˆì»¤ ë³€ìˆ˜
                let currentMarker = null;
                
                // ê¸°ì¡´ ì§€ì˜¤ë©”íŠ¸ë¦¬ ë°ì´í„° ë¡œë“œ
                const existingGeometry = '{{ geometry_wkt|safe }}';
                if (existingGeometry && existingGeometry.includes('POINT')) {
                    loadExistingGeometry(existingGeometry);
                }
                
                // ê¸°ì¡´ ì§€ì˜¤ë©”íŠ¸ë¦¬ ë¡œë“œ í•¨ìˆ˜
                function loadExistingGeometry(wkt) {
                    try {
                        // WKTì—ì„œ ì¢Œí‘œ ì¶”ì¶œ
                        const coords = wkt.match(/POINT\s*\(\s*([\d.-]+)\s+([\d.-]+)\s*\)/);
                        if (coords && coords.length >= 3) {
                            const x = parseFloat(coords[1]);
                            const y = parseFloat(coords[2]);
                            
                            // EPSG:5186 â†’ WGS84 ë³€í™˜ (ì„œë²„ì—ì„œ ë³€í™˜ëœ ì¢Œí‘œ ì‚¬ìš©)
                            {% if initial_lat and initial_lng %}
                                const lat = {{ initial_lat }};
                                const lng = {{ initial_lng }};
                                const position = new kakao.maps.LatLng(lat, lng);
                                
                                // ë§ˆì»¤ ìƒì„±
                                currentMarker = new kakao.maps.Marker({
                                    position: position,
                                    map: map,
                                    draggable: true
                                });
                                
                                // ì§€ë„ ì¤‘ì‹¬ì„ ë§ˆì»¤ ìœ„ì¹˜ë¡œ ì´ë™
                                map.setCenter(position);
                                
                                // ë§ˆì»¤ ë“œë˜ê·¸ ì´ë²¤íŠ¸
                                kakao.maps.event.addListener(currentMarker, 'dragend', function() {
                                    const position = currentMarker.getPosition();
                                    updateCoordinates(position.getLat(), position.getLng());
                                });
                                
                                // ì¢Œí‘œ ì •ë³´ í‘œì‹œ
                                updateCoordinatesDisplay(lat, lng);
                            {% endif %}
                        }
                    } catch (e) {
                        console.warn('ê¸°ì¡´ ì§€ì˜¤ë©”íŠ¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', e);
                    }
                }
                
                // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                    const latLng = mouseEvent.latLng;
                    const lat = latLng.getLat();
                    const lng = latLng.getLng();
                    
                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    if (currentMarker) {
                        currentMarker.setMap(null);
                    }
                    
                    // ìƒˆ ë§ˆì»¤ ìƒì„±
                    currentMarker = new kakao.maps.Marker({
                        position: latLng,
                        map: map,
                        draggable: true
                    });
                    
                    // ë§ˆì»¤ ë“œë˜ê·¸ ì´ë²¤íŠ¸
                    kakao.maps.event.addListener(currentMarker, 'dragend', function() {
                        const position = currentMarker.getPosition();
                        updateCoordinates(position.getLat(), position.getLng());
                    });
                    
                    // ì¢Œí‘œ ì—…ë°ì´íŠ¸
                    updateCoordinates(lat, lng);
                });
                
                // ì¢Œí‘œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
                function updateCoordinates(lat, lng) {
                    // ì¢Œí‘œ ë³€í™˜ API í˜¸ì¶œ
                    fetch('/admin/geodb/transform-coordinates/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            'lng': lng,
                            'lat': lat,
                            'from_srid': 4326,
                            'to_srid': 5186
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // EPSG:5186 ì¢Œí‘œë¡œ WKT ìƒì„±
                            const wkt = `POINT(${data.x} ${data.y})`;
                            
                            // Django í¼ í•„ë“œì— ê°’ ì„¤ì •
                            const inputElement = document.getElementById('id_{{ name }}');
                            if (inputElement) {
                                inputElement.value = wkt;
                                
                                // ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ
                                const event = new Event('change', { bubbles: true });
                                inputElement.dispatchEvent(event);
                            }
                            
                            // ì¢Œí‘œ ì •ë³´ í‘œì‹œ
                            updateCoordinatesDisplay(lat, lng, data.x, data.y);
                        } else {
                            console.error('ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨:', data.error);
                            // ë³€í™˜ ì‹¤íŒ¨ ì‹œ WGS84 ì¢Œí‘œë¡œ ì €ì¥
                            const wkt = `POINT(${lng} ${lat})`;
                            const inputElement = document.getElementById('id_{{ name }}');
                            if (inputElement) {
                                inputElement.value = wkt;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('ì¢Œí‘œ ë³€í™˜ ìš”ì²­ ì‹¤íŒ¨:', error);
                    });
                }
                
                // ì¢Œí‘œ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
                function updateCoordinatesDisplay(lat, lng, x5186, y5186) {
                    const coordsDiv = document.getElementById('{{ id }}_coords');
                    if (coordsDiv) {
                        let html = `WGS84: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        if (x5186 && y5186) {
                            html += ` | EPSG:5186: ${x5186.toFixed(2)}, ${y5186.toFixed(2)}`;
                        }
                        coordsDiv.innerHTML = html;
                    }
                }
                
                // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                function getCSRFToken() {
                    const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
                    return tokenElement ? tokenElement.value : '';
                }
                
                console.log('ì¹´ì¹´ì˜¤ë§µì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        })();
    </script>
</body>
</html> 