{% extends 'base.html' %}
{% load static %}

{% block title %}ìƒê¶Œ ë¶„ì„{% endblock %}

{% block content %}
{% include 'includes/header.html' %}

  <style>
    /* ê¸°ë³¸ primary ë²„íŠ¼ disabled ì‹œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .btn-primary.custom {
      color: #fff;
      background-color: #0d6efd; /* ì›ë˜ primary ìƒ‰ */
      opacity: 0.65;  /* íˆ¬ëª…ë„ ì¡°ì ˆë¡œ íë¦¿í•˜ê²Œ í‘œì‹œ */
    }
    
    /* ë¶„ì„ ì§„í–‰ ìƒí™© ìŠ¤íƒ€ì¼ */
    .analysis-progress {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      margin-top: 1rem;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .progress-step.active {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .progress-step.completed {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #22c55e;
    }
    
    .progress-step.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }
    
    .progress-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
    }
    
    .progress-step.active .progress-icon {
      background: #667eea;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .progress-step.completed .progress-icon {
      background: #22c55e;
      color: white;
    }
    
    .progress-step.error .progress-icon {
      background: #ef4444;
      color: white;
    }
    
    .progress-step:not(.active):not(.completed):not(.error) .progress-icon {
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .progress-text {
      flex: 1;
    }
    
    .progress-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .progress-detail {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .overall-progress {
      margin-bottom: 1.5rem;
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* ê³µì‹œì§€ê°€ ì¹´ë“œ í°íŠ¸ í¬ê¸° ì¡°ì • */
    #totalLandValue {
      font-size: 1.8rem !important;
      line-height: 1.2;
    }
    
    @media (max-width: 768px) {
      #totalLandValue {
        font-size: 1.5rem !important;
      }
    }
  </style>

  <!-- Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- í•œêµ­ì–´ í°íŠ¸ ì§€ì› -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/jspdf-customfonts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-customfonts@0.0.4/dist/customfonts.js"></script>
  <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    $(window).on('load', function() {
      _eventBind();
    });

    // í˜ì´ì§€ ë‚´ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function _eventBind() {
      console.log("ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘");
    }

    // Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ íŒì—… ì—´ê¸°
    function openAddressSearch() {
      new daum.Postcode({
        oncomplete: function(data) {
          // íŒì—…ì—ì„œ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œ
          console.log("ì„ íƒëœ ì£¼ì†Œ ë°ì´í„°:", data);
          
          // ê¸°ë³¸ ì£¼ì†Œ ì •ë³´
          let fullAddr = '';
          let extraAddr = '';
          
          // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
          if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œ
            fullAddr = data.roadAddress;
          } else { // ì§€ë²ˆ ì£¼ì†Œ
            fullAddr = data.jibunAddress;
          }
          
          // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€í•œë‹¤.
          if(data.buildingName !== '' && data.apartment === 'Y'){
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          // í‘œì‹œí•  ì°¸ê³ í•­ëª©ì´ ìˆì„ ê²½ìš°, ê´„í˜¸ê¹Œì§€ ì¶”ê°€í•œ ìµœì¢… ë¬¸ìì—´ì„ ë§Œë“ ë‹¤.
          if(extraAddr !== ''){
            extraAddr = ' (' + extraAddr + ')';
          }
          
          // ìµœì¢… ì£¼ì†Œ
          const finalAddress = fullAddr + extraAddr;
          
          // ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  ì¢Œí‘œ ë³€í™˜ ì‹œì‘
          document.getElementById('address').value = finalAddress;
          
          // ê¸°ì¡´ AI_Analyzerì˜ ì¢Œí‘œ ë³€í™˜ API ì‚¬ìš©
          const csrfToken = '{{ csrf_token }}';
          
          $.ajax({
            url: '/get-coordinates/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              address: fullAddr
            }),
            headers: {
              'X-CSRFToken': csrfToken
            },
            success: function(response) {
              if (response.success) {
                // ì¢Œí‘œ ì„¤ì • ì„±ê³µ
                document.getElementById('latitude').value = response.latitude.toFixed(6);
                document.getElementById('longitude').value = response.longitude.toFixed(6);
                document.getElementById('x_coord').value = response.x_coord.toFixed(2);
                document.getElementById('y_coord').value = response.y_coord.toFixed(2);
                
                console.log("ì¢Œí‘œ ë³€í™˜ ì™„ë£Œ:", {
                  address: finalAddress,
                  latitude: response.latitude,
                  longitude: response.longitude,
                  x_coord: response.x_coord,
                  y_coord: response.y_coord
                });
                
                alert("ì£¼ì†Œì™€ ì¢Œí‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } else {
                console.error("ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨:", response.error);
                alert("ì¢Œí‘œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + response.error);
              }
            },
            error: function(xhr, status, error) {
              console.error("ì¢Œí‘œ ë³€í™˜ ìš”ì²­ ì‹¤íŒ¨:", error);
              console.error("ì‘ë‹µ:", xhr.responseText);
              alert("ì¢Œí‘œ ë³€í™˜ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
        },
        theme: {
          searchBgColor: "#0d6efd", // ê²€ìƒ‰ì°½ ë°°ê²½ìƒ‰
          queryTextColor: "#FFFFFF" // ê²€ìƒ‰ì°½ ê¸€ììƒ‰  
        }
      }).open();
    }

    // ì…ë ¥ì •ë³´ ì „ì†¡
    function getFormData() {
      const business_type_id = $('#business_type_id').val();
      const address = $('#address').val();
      const area = $('#area').val();
      const service_type = $('#service_type').val();
      const x_coord = $('#x_coord').val();
      const y_coord = $('#y_coord').val();
      const latitude = $('#latitude').val();
      const longitude = $('#longitude').val();

      // í•„ìˆ˜ í•„ë“œ ê²€ì¦
      if (!business_type_id || !address || !area || !service_type) {
        alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      // ì¢Œí‘œê°’ ê²€ì¦
      if (!x_coord || !y_coord || x_coord === '0' || y_coord === '0' || 
          !latitude || !longitude || latitude === '0' || longitude === '0') {
        alert("ì£¼ì†Œ ê²€ìƒ‰ì„ í†µí•´ ì¢Œí‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ì¦‰ì‹œ ë¡œë”© UI í‘œì‹œ
      console.log("ğŸš€ ë¶„ì„ ì‹œì‘ - ë¡œë”© UI í‘œì‹œ");
      showAnalysisLoading();

      console.log("ì „ì†¡í•  ë°ì´í„°:", {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      });
      
      const paramData = {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      };

      $.ajax(createPostAjaxOption('analyze', paramData));
    }

    function createPostAjaxOption(requestType, paramData) {
      
      const csrfToken = '{{ csrf_token }}';
      let url;

      if ( 'analyze' === requestType ) {
        url = '/analyze-business/';
      } else if ( 'pdf' === 'pdf' ) {
        url = '/generate-pdf/';
      }
      
      // ì›ë³¸ AI_Analyzerì™€ ê°™ì´ JSONìœ¼ë¡œ ì „ì†¡
      return {
        url: url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(paramData),
        headers: {
          'X-CSRFToken': csrfToken
        },
        success: function(response) {
          console.log("âœ… ë¶„ì„ ìš”ì²­ ì„±ê³µ ì‘ë‹µ:", response);
          
          if (response.success && response.request_id) {
            console.log(`ğŸ”„ í˜„ì¬ í˜ì´ì§€ì—ì„œ ê²°ê³¼ í‘œì‹œ ì‹œì‘ (request_id: ${response.request_id})`);
            // ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œ
            fetchAndDisplayResults(response.request_id);
          } else if (response.request_id) {
            console.log(`ğŸ”„ request_idë§Œ ìˆëŠ” ê²½ìš° (request_id: ${response.request_id})`);
            // ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œ
            fetchAndDisplayResults(response.request_id);
          } else {
            console.log("âš ï¸ request_idê°€ ì—†ëŠ” ì‘ë‹µ:", response);
            alert('ë¶„ì„ ìš”ì²­ ì„±ê³µ: ' + (response.message || 'ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”'));
          }
        },
        error: function(xhr, status, error) {
          console.error("ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:", error);
          console.error("ì‘ë‹µ:", xhr.responseText);
          alert("ìƒê¶Œ ë¶„ì„ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }
    }

    // ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function fetchAndDisplayResults(requestId) {
      console.log(`ğŸ“Š ê²°ê³¼ ì¡°íšŒ ì‹œì‘ (request_id: ${requestId})`);
      console.log(`ğŸ”— API URL: /api/result/${requestId}/`);
      
      // í˜„ì¬ ë¶„ì„ ê²°ê³¼ ID ì €ì¥ (PDF ìƒì„±ì„ ìœ„í•´)
      currentRequestId = requestId;
      
      // ë¡œë”©ì€ ì´ë¯¸ getFormDataì—ì„œ ì‹œì‘ë¨
      
      $.ajax({
        url: `/api/result/${requestId}/`,
        type: 'GET',
        success: function(data) {
          console.log("âœ… ê²°ê³¼ ì¡°íšŒ ì„±ê³µ:", data);
          console.log("ğŸ¯ í˜„ì¬ í˜ì´ì§€ì—ì„œ ê²°ê³¼ í‘œì‹œ ì‹œì‘");
          displayAnalysisResults(data);
        },
        error: function(xhr, status, error) {
          console.error("âŒ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:", error);
          console.error("ğŸ“Š ì‘ë‹µ ìƒíƒœ:", xhr.status);
          console.error("ğŸ“„ ì‘ë‹µ í…ìŠ¤íŠ¸:", xhr.responseText);
          
          // 404 ì˜¤ë¥˜ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¬ì‹œë„ ì˜µì…˜ ì œê³µ
          if (xhr.status === 404) {
            console.log("ğŸ”„ ê²°ê³¼ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ì ì‹œ í›„ ì¬ì‹œë„");
            setTimeout(() => {
              fetchAndDisplayResults(requestId);
            }, 2000); // 2ì´ˆ í›„ ì¬ì‹œë„
          } else {
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œí•˜ê³  ë‹¤ì‹œ ì‹œë„ ì˜µì…˜ ì œê³µ
            showAnalysisError(requestId, error);
          }
        }
      });
    }
    
    // ë¶„ì„ ì§„í–‰ ìƒí™© í‘œì‹œ (ê¸°ì¡´ ë‹¨ìˆœ ë¡œë”© ëŒ€ì²´)
    function showAnalysisLoading() {
      // ëŒ€ê¸° ë©”ì‹œì§€ ìˆ¨ê¸°ê³  ì§„í–‰ ìƒí™© í‘œì‹œ
      $('#analysisWaiting').hide();
      $('#analysisProgress').show();
      
      // ì§„í–‰ ë‹¨ê³„ ì •ì˜ (ì‹¤ì œ ì¸¡ì •ëœ ì²˜ë¦¬ ì‹œê°„ ê¸°ë°˜, ì´ 38ì´ˆ)
      const steps = [
        { id: 'step-population', name: 'ìƒí™œì¸êµ¬ ë¶„ì„', delay: 1000, duration: 13000 },    // 1ì´ˆ ì‹œì‘ â†’ 14ì´ˆ ì™„ë£Œ
        { id: 'step-working', name: 'ì§ì¥ì¸êµ¬ ë¶„ì„', delay: 14000, duration: 13000 },      // 14ì´ˆ ì‹œì‘ â†’ 27ì´ˆ ì™„ë£Œ  
        { id: 'step-foreign', name: 'ì™¸êµ­ì¸ ë¶„ì„', delay: 27000, duration: 6000 },         // 27ì´ˆ ì‹œì‘ â†’ 33ì´ˆ ì™„ë£Œ
        { id: 'step-facilities', name: 'ì£¼ë³€ì‹œì„¤ ë¶„ì„', delay: 33000, duration: 2500 },     // 33ì´ˆ ì‹œì‘ â†’ 35.5ì´ˆ ì™„ë£Œ
        { id: 'step-competition', name: 'ê²½ìŸì—…ì²´ ë¶„ì„', delay: 35500, duration: 2000 },    // 35.5ì´ˆ ì‹œì‘ â†’ 37.5ì´ˆ ì™„ë£Œ
        { id: 'step-land', name: 'ê³µì‹œì§€ê°€ ë¶„ì„', delay: 37500, duration: 1500 },          // 37.5ì´ˆ ì‹œì‘ â†’ 39ì´ˆ ì™„ë£Œ
        { id: 'step-ai', name: 'AI ì˜ˆì¸¡ ë¶„ì„', delay: 39000, duration: 1500 },            // 39ì´ˆ ì‹œì‘ â†’ 40.5ì´ˆ ì™„ë£Œ
        { id: 'step-complete', name: 'ë¶„ì„ ì™„ë£Œ', delay: 40500, duration: 500 }            // 40.5ì´ˆ ì‹œì‘ â†’ 41ì´ˆ ì™„ë£Œ
      ];
      
              // ê° ë‹¨ê³„ë³„ë¡œ ì§„í–‰ í‘œì‹œ (ì‹¤ì œ 38ì´ˆ ê¸°ì¤€)
        steps.forEach((step, index) => {
          // ë‹¨ê³„ ì‹œì‘
          setTimeout(() => {
          // ì´ì „ ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
          if (index > 0) {
            const prevStep = steps[index - 1];
            $(`#${prevStep.id}`).removeClass('active').addClass('completed');
          }
          
          // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
          $(`#${step.id}`).addClass('active');
          
          // ê° ë‹¨ê³„ë³„ ìƒì„¸ ë©”ì‹œì§€
          let detailMessage = `${step.name} ì§„í–‰ ì¤‘...`;
          if (step.id === 'step-population') {
            detailMessage = 'ìƒí™œì¸êµ¬ ë¶„ì„ ì¤‘... (ëŒ€ìš©ëŸ‰ ê³µê°„ ë°ì´í„° ì²˜ë¦¬)';
          } else if (step.id === 'step-working') {
            detailMessage = 'ì§ì¥ì¸êµ¬ ë¶„ì„ ì¤‘... (ë³µì¡í•œ ê³µê°„ ì¿¼ë¦¬ ìˆ˜í–‰)';
          } else if (step.id === 'step-foreign') {
            detailMessage = 'ì™¸êµ­ì¸ ë¶„ì„ ì¤‘... (ë‹¤ì¤‘ í…Œì´ë¸” ê²€ìƒ‰)';
          } else if (step.id === 'step-facilities') {
            detailMessage = 'ì£¼ë³€ì‹œì„¤ ë¶„ì„ ì¤‘...';
          } else if (step.id === 'step-competition') {
            detailMessage = 'ê²½ìŸì—…ì²´ ë¶„ì„ ì¤‘...';
          } else if (step.id === 'step-land') {
            detailMessage = 'ê³µì‹œì§€ê°€ ë¶„ì„ ì¤‘...';
          } else if (step.id === 'step-ai') {
            detailMessage = 'AI ì˜ˆì¸¡ ëª¨ë¸ ì‹¤í–‰ ì¤‘...';
          }
          
          $(`#${step.id} .progress-detail`).text(detailMessage);
          
          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì‹œì‘ ì‹œì )
          const startProgress = Math.round((index / steps.length) * 100);
          $('#overallPercent').text(startProgress + '%');
          $('#overallProgressBar').css('width', startProgress + '%');
          
          // ê¸´ ë‹¨ê³„ë“¤ì— ëŒ€í•´ ì¤‘ê°„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ìƒí™œì¸êµ¬, ì§ì¥ì¸êµ¬, ì™¸êµ­ì¸ ë¶„ì„)
          if (step.duration > 5000) {
            const midPoint = step.delay + (step.duration / 2);
            setTimeout(() => {
              if ($(`#${step.id}`).hasClass('active')) {
                const midProgress = Math.round(((index + 0.5) / steps.length) * 100);
                $('#overallPercent').text(midProgress + '%');
                $('#overallProgressBar').css('width', midProgress + '%');
                
                if (step.id === 'step-population') {
                  $(`#${step.id} .progress-detail`).text('ìƒí™œì¸êµ¬ ë¶„ì„ ì¤‘... (50% ì™„ë£Œ)');
                } else if (step.id === 'step-working') {
                  $(`#${step.id} .progress-detail`).text('ì§ì¥ì¸êµ¬ ë¶„ì„ ì¤‘... (50% ì™„ë£Œ)');
                } else if (step.id === 'step-foreign') {
                  $(`#${step.id} .progress-detail`).text('ì™¸êµ­ì¸ ë¶„ì„ ì¤‘... (50% ì™„ë£Œ)');
                }
              }
            }, midPoint);
          }
          
        }, step.delay);
        
        // ë‹¨ê³„ ì™„ë£Œ
        setTimeout(() => {
          $(`#${step.id} .progress-detail`).text(`${step.name} ì™„ë£Œ`);
          
          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì™„ë£Œ ì‹œì )
          const endProgress = Math.round(((index + 1) / steps.length) * 100);
          $('#overallPercent').text(endProgress + '%');
          $('#overallProgressBar').css('width', endProgress + '%');
          
        }, step.delay + step.duration);
      });
      
      // ì˜ˆìƒ ì™„ë£Œ ì‹œê°„ í›„ì—ë„ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('ì„œë²„ì—ì„œ ìµœì¢… ê²°ê³¼ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...');
          
          // ì§„í–‰ë¥ ì„ 95%ë¡œ ìœ ì§€ (100%ëŠ” ì‹¤ì œ ì™„ë£Œ ì‹œì—ë§Œ)
          $('#overallPercent').text('95%');
          $('#overallProgressBar').css('width', '95%');
        }
      }, 41000);  // 41ì´ˆ í›„ (ì˜ˆìƒ ì™„ë£Œ ì‹œê°„ í›„)
      
      // ë” ì˜¤ë˜ ê±¸ë¦¬ëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ì¶”ê°€ ë©”ì‹œì§€
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('ëŒ€ìš©ëŸ‰ ê³µê°„ ë°ì´í„° ì²˜ë¦¬ë¡œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤...');
        }
      }, 45000);  // 45ì´ˆ í›„
      
      // ë” ê¸´ ëŒ€ê¸°ë¥¼ ìœ„í•œ ì•ˆë‚´
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('ê³§ ì™„ë£Œë©ë‹ˆë‹¤. ì ì‹œë§Œ ë” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
        }
      }, 50000);  // 50ì´ˆ í›„
    }
    
    // ë¶„ì„ ì—ëŸ¬ í‘œì‹œ
    function showAnalysisError(requestId, error) {
      // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„ë¥¼ ì˜¤ë¥˜ ìƒíƒœë¡œ ë³€ê²½
      $('.progress-step.active').removeClass('active').addClass('error');
      $('.progress-step.error .progress-detail').text('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      
      $('#analysisProgress').hide();
      $('#analysisWaiting').html(`
        <div class="alert alert-danger">
          <h5><i class="bi bi-exclamation-triangle me-2"></i>ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h5>
          <p>ì˜¤ë¥˜ ë‚´ìš©: ${error}</p>
          <div class="mt-3">
            <button class="btn btn-primary me-2" onclick="retryAnalysis(${requestId})">
              <i class="bi bi-arrow-clockwise me-1"></i>ë‹¤ì‹œ ì‹œë„
            </button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='/result/${requestId}/'">
              <i class="bi bi-eye me-1"></i>ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        </div>
      `).show();
    }
    
    // ë¶„ì„ ì¬ì‹œë„
    function retryAnalysis(requestId) {
      showAnalysisLoading();
      setTimeout(() => {
        fetchAndDisplayResults(requestId);
      }, 1000);
    }
    
    // ë¶„ì„ ê²°ê³¼ë¥¼ í˜ì´ì§€ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function displayAnalysisResults(data) {
      // ìµœì¢… ì™„ë£Œ ìƒíƒœë¡œ í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
      $('#step-complete').removeClass('active').addClass('completed');
      $('#step-complete .progress-detail').text('ë¶„ì„ ì™„ë£Œ');
      $('#overallPercent').text('100%');
      $('#overallProgressBar').css('width', '100%');
      
      // ì ì‹œ í›„ ì§„í–‰ ìƒí™© UI ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        $('#analysisProgress').hide();
      }, 1000);
      
      const request = data.request;
      const result = data.result;
      
      // ê¸°ë³¸ ì •ë³´ ì„¤ì •
      document.getElementById('resultAddress').textContent = request.address;
      document.getElementById('resultBusinessType').textContent = getBusinessTypeName(request.business_type_id);
      document.getElementById('resultArea').textContent = request.area;
      document.getElementById('resultServiceType').textContent = request.service_type == 1 ? 'ì¼ë°˜ìŒì‹ì ' : 'íœ´ê²ŒìŒì‹ì ';
      
      // í•µì‹¬ ì§€í‘œ
      document.getElementById('lifePop300').textContent = Math.round(result.life_pop_300m || 0).toLocaleString();
      document.getElementById('workingPop300').textContent = Math.round(result.working_pop_300m || 0).toLocaleString();
      document.getElementById('competitor300').textContent = result.competitor_300m || 0;
      
      // ê³µì‹œì§€ê°€ë¥¼ ì›í™” í‘œì‹œë¡œ ë” ê°„ë‹¨í•˜ê²Œ í‘œí˜„
      const landValue = result.total_land_value || 0;
      if (landValue >= 100000000) { // 1ì–µ ì´ìƒ
        document.getElementById('totalLandValue').innerHTML = `â‚©${(landValue / 100000000).toFixed(1)}ì–µ`;
      } else if (landValue >= 10000) { // 1ë§Œ ì´ìƒ
        document.getElementById('totalLandValue').innerHTML = `â‚©${(landValue / 10000).toFixed(0)}ë§Œ`;
      } else {
        document.getElementById('totalLandValue').innerHTML = `â‚©${landValue.toLocaleString()}`;
      }
      
      // AI ìƒì¡´ í™•ë¥ 
      const survivalRate = Math.round(result.survival_percentage || 0);
      document.getElementById('survivalPercentage').textContent = survivalRate + '%';
      
      const survivalBar = document.getElementById('survivalBar');
      const survivalAnalysis = document.getElementById('survivalAnalysis');
      
      survivalBar.style.width = survivalRate + '%';
      
      if (survivalRate >= 80) {
        survivalBar.className = 'progress-bar bg-success';
        survivalAnalysis.className = 'alert alert-success';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>
          <strong>ë†’ì€ ìƒì¡´ ê°€ëŠ¥ì„±</strong><br>
          í˜„ì¬ ìœ„ì¹˜ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ì‚¬ì—…ì„ ì§€ì†í•˜ê¸°ì— ë§¤ìš° ì¢‹ì€ ì¡°ê±´ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤.
        `;
      } else if (survivalRate >= 60) {
        survivalBar.className = 'progress-bar bg-warning';
        survivalAnalysis.className = 'alert alert-warning';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>ë³´í†µ ìƒì¡´ ê°€ëŠ¥ì„±</strong><br>
          í˜„ì¬ ìœ„ì¹˜ëŠ” ì‚¬ì—… ì§€ì†ì— ì ì ˆí•œ ì¡°ê±´ì„ ê°–ì¶”ê³  ìˆìœ¼ë‚˜, ì¶”ê°€ì ì¸ ì „ëµ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        `;
      } else {
        survivalBar.className = 'progress-bar bg-danger';
        survivalAnalysis.className = 'alert alert-danger';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-times-circle me-2"></i>
          <strong>ë‚®ì€ ìƒì¡´ ê°€ëŠ¥ì„±</strong><br>
          í˜„ì¬ ìœ„ì¹˜ëŠ” ì¥ê¸° ì‚¬ì—… ì§€ì†ì— ì–´ë ¤ì›€ì´ ì˜ˆìƒë©ë‹ˆë‹¤. ì‹ ì¤‘í•œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        `;
      }
      
      // ìƒê¶Œ ê²½ìŸ ë¶„ì„
      document.getElementById('competitorCount').textContent = result.competitor_300m || 0;
      document.getElementById('adjacentBiz').textContent = result.adjacent_biz_300m || 0;
      
      const competitorRatio = Math.round(result.competitor_ratio_300m || 0);
      document.getElementById('competitorRatio').textContent = competitorRatio + '%';
      document.getElementById('businessDiversity').textContent = (result.business_diversity_300m || 0) + 'ì¢…ë¥˜';
      
      const competitionBar = document.getElementById('competitionBar');
      const competitionLevel = document.getElementById('competitionLevel');
      
      competitionBar.style.width = competitorRatio + '%';
      
      if (competitorRatio <= 20) {
        competitionBar.className = 'progress-bar bg-success';
        competitionLevel.textContent = `ë‚®ìŒ (${competitorRatio}%)`;
      } else if (competitorRatio <= 50) {
        competitionBar.className = 'progress-bar bg-warning';
        competitionLevel.textContent = `ë³´í†µ (${competitorRatio}%)`;
      } else {
        competitionBar.className = 'progress-bar bg-danger';
        competitionLevel.textContent = `ë†’ìŒ (${competitorRatio}%)`;
      }
      
      // ê°•ì ê³¼ ì£¼ì˜ì‚¬í•­ ë¶„ì„
      displayStrengthsAndCautions(result);
      
      // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
      document.getElementById('analysisWaiting').style.display = 'none';
      document.getElementById('analysisResults').style.display = 'block';
      
      // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      document.getElementById('analysisResults').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
    
    // ì—…ì¢…ëª… ë°˜í™˜ í•¨ìˆ˜
    function getBusinessTypeName(businessTypeId) {
      const businessTypes = {
        0: 'ê°ì„±ì£¼ì ', 1: 'ê²½ì–‘ì‹', 2: 'ê´€ê´‘í˜¸í…”', 3: 'ê·¹ì¥', 4: 'ê¸°íƒ€',
        5: 'ê¸°íƒ€ íœ´ê²ŒìŒì‹ì ', 6: 'ê¹€ë°¥(ë„ì‹œë½)', 7: 'ê¹Œí˜', 8: 'ëƒ‰ë©´ì§‘', 9: 'ë‹¤ë°©',
        10: 'ë–¡ì¹´í˜', 11: 'ë¼ì´ë¸Œì¹´í˜', 12: 'ë°±í™”ì ', 13: 'ë³µì–´ì·¨ê¸‰', 14: 'ë¶„ì‹',
        15: 'ë·”í˜ì‹', 16: 'ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)', 17: 'ì•„ì´ìŠ¤í¬ë¦¼', 18: 'ì™¸êµ­ìŒì‹ì „ë¬¸ì (ì¸ë„, íƒœêµ­ ë“±)', 19: 'ìœ ì›ì§€',
        20: 'ì¼ë°˜ì¡°ë¦¬íŒë§¤', 21: 'ì¼ì‹', 22: 'ì „í†µì°»ì§‘', 23: 'ì •ì¢…/ëŒ€í¬ì§‘/ì†Œì£¼ë°©', 24: 'ì¤‘êµ­ì‹',
        25: 'ì² ë„ì—­êµ¬ë‚´', 26: 'ì¶œì¥ì¡°ë¦¬', 27: 'ì»¤í”¼ìˆ', 28: 'í‚¤ì¦ˆì¹´í˜', 29: 'íƒ•ë¥˜(ë³´ì‹ ìš©)',
        30: 'í†µë‹­(ì¹˜í‚¨)', 31: 'íŒ¨ë°€ë¦¬ë ˆìŠ¤í† ë‘', 32: 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', 33: 'í¸ì˜ì ', 34: 'í‘¸ë“œíŠ¸ëŸ­',
        35: 'í•œì‹', 36: 'í˜¸í”„/í†µë‹­', 37: 'íšŸì§‘'
      };
      return businessTypes[businessTypeId] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
    
    // ê°•ì ê³¼ ì£¼ì˜ì‚¬í•­ í‘œì‹œ
    function displayStrengthsAndCautions(result) {
      const strengthsList = document.getElementById('strengthsList');
      const cautionsList = document.getElementById('cautionsList');
      
      let strengths = [];
      let cautions = [];
      
      // ê°•ì  ë¶„ì„
      if (result.life_pop_300m > 5000) {
        strengths.push(`ìƒí™œì¸êµ¬ê°€ í’ë¶€í•¨ (${Math.round(result.life_pop_300m).toLocaleString()}ëª…)`);
      }
      if (result.working_pop_300m > 3000) {
        strengths.push('ì§ì¥ì¸êµ¬ê°€ ë§ì•„ ì ì‹¬ì‹œê°„ ê³ ê° í™•ë³´ ìœ ë¦¬');
      }
      if (result.competitor_ratio_300m < 30) {
        strengths.push('ê²½ìŸì—…ì²´ ë¹„ìœ¨ì´ ë‚®ì•„ ê²½ìŸ ë¶€ë‹´ ì ìŒ');
      }
      if (result.business_diversity_300m > 10) {
        strengths.push('ì—…ì¢… ë‹¤ì–‘ì„±ì´ ë†’ì•„ ìƒê¶Œì´ í™œì„±í™”ë¨');
      }
      if (result.public_building_250m > 0 || result.school_250m > 0) {
        strengths.push('ì£¼ë³€ ìœ ë™ì¸êµ¬ ìœ ë°œì‹œì„¤ ì¡´ì¬');
      }
      
      // ì£¼ì˜ì‚¬í•­ ë¶„ì„
      if (result.life_pop_300m < 2000) {
        cautions.push('ìƒí™œì¸êµ¬ê°€ ì ì–´ ê³ ê° í™•ë³´ì— ì–´ë ¤ì›€ ì˜ˆìƒ');
      }
      if (result.competitor_ratio_300m > 50) {
        cautions.push('ê²½ìŸì—…ì²´ ë¹„ìœ¨ì´ ë†’ì•„ ì¹˜ì—´í•œ ê²½ìŸ ì˜ˆìƒ');
      }
      if (result.competitor_300m > 5) {
        cautions.push(`ë™ì¼ì—…ì¢… ê²½ìŸì—…ì²´ê°€ ë§ìŒ (${result.competitor_300m}ê°œ)`);
      }
      if (result.total_land_value > 100000000) {
        cautions.push('ê³µì‹œì§€ê°€ê°€ ë†’ì•„ ì„ëŒ€ë£Œ ë¶€ë‹´ í´ ìˆ˜ ìˆìŒ');
      }
      if (result.working_pop_300m < 1000) {
        cautions.push('ì§ì¥ì¸êµ¬ê°€ ì ì–´ í‰ì¼ ì ì‹¬ ê³ ê° ë¶€ì¡± ìš°ë ¤');
      }
      
      // ê¸°ë³¸ ë©”ì‹œì§€
      if (strengths.length === 0) {
        strengths.push('ìƒê¶Œ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê²€í† í•˜ì„¸ìš”');
      }
      if (cautions.length === 0) {
        cautions.push('í˜„ì¬ ìƒê¶Œ ì¡°ê±´ì´ ì–‘í˜¸í•©ë‹ˆë‹¤');
      }
      
      // HTML ìƒì„±
      strengthsList.innerHTML = strengths.map(item => `<li>${item}</li>`).join('');
      cautionsList.innerHTML = cautions.map(item => `<li>${item}</li>`).join('');
    }
    
    function fillExampleQuestion(text) {
      document.getElementById('chatInput').value = text;
    }

    // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë¶„ì„ ê²°ê³¼ ID ì €ì¥
    let currentRequestId = null;

    // PDF ìƒì„± í•¨ìˆ˜ (jsPDF ì‚¬ìš©)
    function generatePDF() {
      if (!currentRequestId) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒê¶Œ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì±„ìš°ê¸°
      updatePdfPreview();
      
      // PDF ëª¨ë‹¬ í‘œì‹œ
      const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
      pdfModal.show();
      
      // ì´ˆê¸° ìƒíƒœë¡œ ì„¤ì • - ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      document.getElementById('pdfPreviewContainer').style.display = 'block';
      document.getElementById('pdfGenerating').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('downloadPdfBtn').style.display = 'inline-block';
      document.getElementById('retryPdfBtn').style.display = 'none';
    }
    
    // PDF ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì—…ë°ì´íŠ¸
    function updatePdfPreview() {
      // í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©
      document.getElementById('previewAddress').textContent = 
        document.getElementById('resultAddress').textContent || '-';
      document.getElementById('previewBusinessType').textContent = 
        document.getElementById('resultBusinessType').textContent || '-';
      document.getElementById('previewArea').textContent = 
        document.getElementById('resultArea').textContent + 'ã¡' || '-';
      document.getElementById('previewSurvival').textContent = 
        document.getElementById('survivalPercentage').textContent || '-%';
      document.getElementById('previewLifePop').textContent = 
        document.getElementById('lifePop300').textContent + 'ëª…' || '-';
      document.getElementById('previewWorkingPop').textContent = 
        document.getElementById('workingPop300').textContent + 'ëª…' || '-';
      document.getElementById('previewCompetitor').textContent = 
        document.getElementById('competitor300').textContent + 'ê°œ' || '-';
      
      // ê³µì‹œì§€ê°€ ì¶”ê°€
      const landValueElement = document.getElementById('totalLandValue');
      if (landValueElement) {
        document.getElementById('previewLandValue').textContent = landValueElement.textContent || '-';
      }
      
      // ë¶„ì„ì¼ì‹œ ì¶”ê°€
      const currentDate = new Date().toLocaleDateString('ko-KR');
      document.getElementById('previewDate').textContent = currentDate;
      document.getElementById('previewReportDate').textContent = currentDate;
        
      // ìƒì¡´ í™•ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë° í”„ë¡œê·¸ë ˆìŠ¤ ë°” ë³€ê²½
      const survivalText = document.getElementById('survivalPercentage').textContent;
      const survivalRate = parseInt(survivalText.replace('%', ''));
      const previewSurvival = document.getElementById('previewSurvival');
      const previewSurvivalBar = document.getElementById('previewSurvivalBar');
      const previewSurvivalText = document.getElementById('previewSurvivalText');
      
      // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì„¤ì •
      previewSurvivalBar.style.width = survivalRate + '%';
      
      if (survivalRate >= 80) {
        previewSurvival.className = 'display-4 mb-3 text-success';
        previewSurvivalBar.className = 'progress-bar bg-success';
        previewSurvivalText.textContent = 'ë†’ì€ ìƒì¡´ ê°€ëŠ¥ì„± - ì¥ê¸°ì  ì‚¬ì—… ì§€ì†ì— ë§¤ìš° ì¢‹ì€ ì¡°ê±´';
      } else if (survivalRate >= 60) {
        previewSurvival.className = 'display-4 mb-3 text-warning';
        previewSurvivalBar.className = 'progress-bar bg-warning';
        previewSurvivalText.textContent = 'ë³´í†µ ìƒì¡´ ê°€ëŠ¥ì„± - ì ì ˆí•œ ì¡°ê±´ì´ë‚˜ ì¶”ê°€ ì „ëµ ê²€í†  í•„ìš”';
      } else {
        previewSurvival.className = 'display-4 mb-3 text-danger';
        previewSurvivalBar.className = 'progress-bar bg-danger';
        previewSurvivalText.textContent = 'ë‚®ì€ ìƒì¡´ ê°€ëŠ¥ì„± - ì¥ê¸° ì‚¬ì—… ì§€ì†ì— ì–´ë ¤ì›€ ì˜ˆìƒ';
      }
      
      // ê°•ì /ì£¼ì˜ì‚¬í•­ ì—…ë°ì´íŠ¸
      const strengthsList = document.getElementById('strengthsList');
      const cautionsList = document.getElementById('cautionsList');
      
      if (strengthsList && strengthsList.children.length > 0) {
        const previewStrengths = document.getElementById('previewStrengths').querySelector('ul');
        previewStrengths.innerHTML = '';
        Array.from(strengthsList.children).forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = '<i class="bi bi-check-circle-fill text-success me-2"></i>' + item.textContent;
          li.className = 'mb-2';
          previewStrengths.appendChild(li);
        });
      }
      
      if (cautionsList && cautionsList.children.length > 0) {
        const previewCautions = document.getElementById('previewCautions').querySelector('ul');
        previewCautions.innerHTML = '';
        Array.from(cautionsList.children).forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>' + item.textContent;
          li.className = 'mb-2';
          previewCautions.appendChild(li);
        });
      }
    }

    // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (jsPDFë¡œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ìƒì„±)
    function downloadPDF() {
      if (!currentRequestId) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      document.getElementById('pdfPreviewContainer').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfGenerating').style.display = 'block';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      document.getElementById('retryPdfBtn').style.display = 'none';
      
      // ì„œë²„ì—ì„œ PDF ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetch(`/pdf-data/${currentRequestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('PDF ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        return response.json();
      })
      .then(data => {
        // ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ê³  PDF ìƒì„±
        document.getElementById('pdfPreviewContainer').style.display = 'block';
        // jsPDFë¡œ PDF ìƒì„±
        generatePDFWithJsPDF(data);
      })
      .catch(error => {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfPreviewContainer').style.display = 'none';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message;
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      });
    }

    // ê²½ëŸ‰ PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadLightweightPDF() {
      if (!currentRequestId) {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      document.getElementById('pdfPreviewContainer').style.display = 'none';
      document.getElementById('pdfError').style.display = 'none';
      document.getElementById('pdfGenerating').style.display = 'block';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      document.getElementById('downloadLightPdfBtn').style.display = 'none';
      document.getElementById('retryPdfBtn').style.display = 'none';
      
      // ì„œë²„ì—ì„œ PDF ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetch(`/pdf-data/${currentRequestId}/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('PDF ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        return response.json();
      })
      .then(data => {
        // ê²½ëŸ‰ PDF ìƒì„±
        generateLightweightPDF(data);
      })
      .catch(error => {
        console.error('ê²½ëŸ‰ PDF ìƒì„± ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfPreviewContainer').style.display = 'block';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message;
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        document.getElementById('downloadLightPdfBtn').style.display = 'inline-block';
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      });
    }

    // jsPDFë¥¼ ì‚¬ìš©í•œ PDF ìƒì„± (html2canvasë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜)
    function generatePDFWithJsPDF(data) {
      try {
        // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        const element = document.getElementById('pdfPreviewContainer');
        
        // PDF ìƒì„± ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'block';
        document.getElementById('downloadPdfBtn').style.display = 'none';
        
                 html2canvas(element, {
           scale: 1.2, // í•´ìƒë„ ì¡°ì • (2 -> 1.2)
           useCORS: true,
           allowTaint: true,
           backgroundColor: '#ffffff',
           width: element.offsetWidth,
           height: element.offsetHeight,
           removeContainer: true,
           imageTimeout: 0,
           logging: false
         }).then(canvas => {
           const { jsPDF } = window.jspdf;
           const doc = new jsPDF('p', 'mm', 'a4');
           
           // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚° (A4 í¬ê¸°ì— ë§ê²Œ ì¡°ì •)
           const imgWidth = 210; // A4 width in mm
           const pageHeight = 297; // A4 height in mm
           const imgHeight = (canvas.height * imgWidth) / canvas.width;
           
           let heightLeft = imgHeight;
           let position = 0;
           
           // JPEG í’ˆì§ˆ ì„¤ì •ìœ¼ë¡œ ìš©ëŸ‰ ì¤„ì´ê¸°
           const imgData = canvas.toDataURL('image/jpeg', 0.8); // JPEG, 80% í’ˆì§ˆ
           
           // ì²« ë²ˆì§¸ í˜ì´ì§€
           doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
           heightLeft -= pageHeight;
           
           // ì¶”ê°€ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
           while (heightLeft >= 0) {
             position = heightLeft - imgHeight;
             doc.addPage();
             doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
             heightLeft -= pageHeight;
           }
          
          // íŒŒì¼ëª… ìƒì„±
          const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const filename = `AI_ìƒê¶Œë¶„ì„_ë³´ê³ ì„œ_${currentDate}.pdf`;
          
          // PDF ë‹¤ìš´ë¡œë“œ
          doc.save(filename);
          
          // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
          setTimeout(() => {
            const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
            if (pdfModal) {
              pdfModal.hide();
            }
          }, 1000);
          
                 }).catch(error => {
           console.error('html2canvas ì˜¤ë¥˜:', error);
           throw new Error('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
         });
        
      } catch (error) {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
        document.getElementById('pdfGenerating').style.display = 'none';
        document.getElementById('pdfError').style.display = 'block';
        document.getElementById('pdfErrorMessage').textContent = error.message || 'PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        document.getElementById('retryPdfBtn').style.display = 'inline-block';
      }
    }

    // í…ìŠ¤íŠ¸ ê¸°ë°˜ PDF ìƒì„± (ìš©ëŸ‰ ìµœì í™”)
    function generateLightweightPDF(data) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // ê¸°ë³¸ í°íŠ¸ ì‚¬ìš© (í•œêµ­ì–´ëŠ” ì˜ë¬¸ìœ¼ë¡œ í‘œê¸°)
        doc.setFont('helvetica');
        
        let yPos = 20;
        const lineHeight = 7;
        const margin = 20;
        const pageWidth = 170; // í…ìŠ¤íŠ¸ ì˜ì—­ ë„ˆë¹„
        
        // ì œëª©
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('AI Commercial District Analysis Report', margin, yPos);
        yPos += lineHeight * 2;
        
        // ë¶€ì œëª©
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('AI-based Commercial Area Analysis Results', margin, yPos);
        yPos += lineHeight * 2;
        
        // êµ¬ë¶„ì„ 
        doc.setLineWidth(0.5);
        doc.line(margin, yPos, margin + pageWidth, yPos);
        yPos += lineHeight;
        
        // ê¸°ë³¸ ì •ë³´ ì„¹ì…˜
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('1. Basic Information', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Address: ${data.basic_info.address}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Business Type: ${data.basic_info.business_type}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Area: ${data.basic_info.area}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Service Type: ${data.basic_info.service_type}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Analysis Date: ${data.basic_info.analysis_date}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // AI ë¶„ì„ ê²°ê³¼
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('2. AI Analysis Results', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(`Survival Probability: ${data.ai_analysis.survival_rate}`, margin, yPos);
        yPos += lineHeight * 1.5;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        const analysisLines = doc.splitTextToSize(data.ai_analysis.analysis_text, pageWidth);
        analysisLines.forEach(line => {
          doc.text(line, margin, yPos);
          yPos += lineHeight;
        });
        yPos += lineHeight;
        
        // í•µì‹¬ ì§€í‘œ
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('3. Key Metrics (300m radius)', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`â€¢ Living Population: ${data.key_metrics.life_pop_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Working Population: ${data.key_metrics.working_pop_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Competitors: ${data.key_metrics.competitor_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Total Land Value: ${data.key_metrics.total_land_value}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // ê²½ìŸ ë¶„ì„
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('4. Competition Analysis', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`â€¢ Competitor Count: ${data.competition_analysis.competitor_count}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Total Business: ${data.competition_analysis.total_business}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Competitor Ratio: ${data.competition_analysis.competitor_ratio}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Business Diversity: ${data.competition_analysis.business_diversity}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // ìƒˆ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš°
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        // ìƒì„¸ ë¶„ì„
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('5. Detailed Analysis', margin, yPos);
        yPos += lineHeight;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`â€¢ Temporary Foreign Residents (1000m): ${data.detailed_analysis.temp_foreign_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Long-term Foreign Residents (300m): ${data.detailed_analysis.long_foreign_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Long-term Foreign Residents (1000m): ${data.detailed_analysis.long_foreign_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Chinese Temporary Residents (300m): ${data.detailed_analysis.temp_foreign_cn_300m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Chinese Temporary Residents (1000m): ${data.detailed_analysis.temp_foreign_cn_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Chinese Long-term Residents (1000m): ${data.detailed_analysis.long_foreign_cn_1000m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Schools (250m): ${data.detailed_analysis.school_250m}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`â€¢ Public Buildings (250m): ${data.detailed_analysis.public_building_250m}`, margin, yPos);
        yPos += lineHeight * 2;
        
        // í•˜ë‹¨ ì •ë³´
        yPos = 280; // í˜ì´ì§€ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.text('Generated by AI-based Commercial District Analysis System', margin, yPos);
        yPos += 4;
        doc.text(`Report Date: ${new Date().toLocaleDateString('en-US')}`, margin, yPos);
        
        // íŒŒì¼ëª… ìƒì„±
        const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const filename = `AI_Analysis_Report_Light_${currentDate}.pdf`;
        
        // PDF ë‹¤ìš´ë¡œë“œ
        doc.save(filename);
        
        // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(() => {
          const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
          if (pdfModal) {
            pdfModal.hide();
          }
        }, 1000);
        
      } catch (error) {
        console.error('ê²½ëŸ‰ PDF ìƒì„± ì˜¤ë¥˜:', error);
        throw new Error('ê²½ëŸ‰ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>

  <!-- Page Title -->
  <div class="container my-6" style="margin-top: 20px; margin-bottom: 100px; ">
    
    <!-- ìƒê¶Œ ë¶„ì„ ì •ë³´ ì…ë ¥ -->
    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card p-4 shadow-sm">
          <h3 class="mb-3">ìƒê¶Œ ì •ë³´ì…ë ¥</h3>

          <form>
            <div class="row g-3">
              <!-- ì—…ì¢… ì„ íƒ -->
              <div class="col-md-3">
                <label for="business_type_id" class="form-label">ì—…ì¢…</label>
                <select class="form-select" id="business_type_id" name="business_type_id" required>
                  <option selected disabled>ì—…ì¢…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                  <option value="0">ê°ì„±ì£¼ì </option>
                  <option value="1">ê²½ì–‘ì‹</option>
                  <option value="2">ê´€ê´‘í˜¸í…”</option>
                  <option value="3">ê·¹ì¥</option>
                  <option value="4">ê¸°íƒ€</option>
                  <option value="5">ê¸°íƒ€ íœ´ê²ŒìŒì‹ì </option>
                  <option value="6">ê¹€ë°¥(ë„ì‹œë½)</option>
                  <option value="7">ê¹Œí˜</option>
                  <option value="8">ëƒ‰ë©´ì§‘</option>
                  <option value="9">ë‹¤ë°©</option>
                  <option value="10">ë–¡ì¹´í˜</option>
                  <option value="11">ë¼ì´ë¸Œì¹´í˜</option>
                  <option value="12">ë°±í™”ì </option>
                  <option value="13">ë³µì–´ì·¨ê¸‰</option>
                  <option value="14">ë¶„ì‹</option>
                  <option value="15">ë·”í˜ì‹</option>
                  <option value="16">ì‹ìœ¡(ìˆ¯ë¶ˆêµ¬ì´)</option>
                  <option value="17">ì•„ì´ìŠ¤í¬ë¦¼</option>
                  <option value="18">ì™¸êµ­ìŒì‹ì „ë¬¸ì (ì¸ë„, íƒœêµ­ ë“±)</option>
                  <option value="19">ìœ ì›ì§€</option>
                  <option value="20">ì¼ë°˜ì¡°ë¦¬íŒë§¤</option>
                  <option value="21">ì¼ì‹</option>
                  <option value="22">ì „í†µì°»ì§‘</option>
                  <option value="23">ì •ì¢…/ëŒ€í¬ì§‘/ì†Œì£¼ë°©</option>
                  <option value="24">ì¤‘êµ­ì‹</option>
                  <option value="25">ì² ë„ì—­êµ¬ë‚´</option>
                  <option value="26">ì¶œì¥ì¡°ë¦¬</option>
                  <option value="27">ì»¤í”¼ìˆ</option>
                  <option value="28">í‚¤ì¦ˆì¹´í˜</option>
                  <option value="29">íƒ•ë¥˜(ë³´ì‹ ìš©)</option>
                  <option value="30">í†µë‹­(ì¹˜í‚¨)</option>
                  <option value="31">íŒ¨ë°€ë¦¬ë ˆìŠ¤í† ë‘</option>
                  <option value="32">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option>
                  <option value="33">í¸ì˜ì </option>
                  <option value="34">í‘¸ë“œíŠ¸ëŸ­</option>
                  <option value="35">í•œì‹</option>
                  <option value="36">í˜¸í”„/í†µë‹­</option>
                  <option value="37">íšŸì§‘</option>
                </select>
              </div>

              <!-- ì£¼ì†Œ ì…ë ¥ -->
              <div class="col-md-3">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="x_coord" name="x_coord">
                <input type="hidden" id="y_coord" name="y_coord">
                <label for="address" class="form-label">ì£¼ì†Œ</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="address" name="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" readonly>
                  <button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()">ê²€ìƒ‰</button>
                </div>
              </div>

              <!-- ì í¬ ë©´ì  ì…ë ¥ -->
              <div class="col-md-3">
                <label for="area" class="form-label">ì í¬ ë©´ì  (ã¡)</label>
                <input type="number" class="form-control" id="area" name="area" placeholder="ì˜ˆ: 33.2" required>
              </div>

              <!-- ì£¼ë¥˜ íŒë§¤ ì—¬ë¶€ ì„ íƒ -->
              <div class="col-md-3">
                <label for="service_type" class="form-label">ì£¼ë¥˜ íŒë§¤ ì—¬ë¶€</label>
                <select class="form-select" id="service_type" name="service_type" required>
                  <option selected disabled>ì„ íƒ</option>
                  <option value="1">íŒë§¤í•¨</option>
                  <option value="0">íŒë§¤ ì•ˆí•¨</option>
                </select>
              </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-primary custom px-5" onclick="getFormData();">ìƒê¶Œ ë¶„ì„í•˜ê¸°</button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- ë³¸ë¬¸: ë¶„ì„ ê²°ê³¼ + ì±—ë´‡ -->
    <div class="row">
      <!-- ì™¼ìª½: ë¶„ì„ ë¦¬í¬íŠ¸ -->
      <div class="col-lg-8 mb-4">
        <div class="card p-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">ìƒê¶Œ ë¶„ì„ ê²°ê³¼</h4>
            <!-- ëª¨ë‹¬ ë²„íŠ¼ -->
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#explanationModal">
              ìƒê¶Œ ë¶„ì„ ë„ì›€ë§
            </button>
            
            <!-- Bootstrap ëª¨ë‹¬ -->
            <div class="modal fade" id="explanationModal" tabindex="-1" aria-labelledby="explanationModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="explanationModalLabel">ìƒê¶Œ ë¶„ì„ì´ë€ ë¬´ì—‡ì¸ê°€?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                  </div>
                  <div class="modal-body">
                    ìƒê¶Œë¶„ì„ì€ íŠ¹ì • ì§€ì—­ ë‚´ ì í¬ë‚˜ ì‚¬ì—…ì¥ì˜ ê²½ì œì  í™˜ê²½ê³¼ ì†Œë¹„ì íŠ¹ì„±ì„ ì²´ê³„ì ìœ¼ë¡œ ì¡°ì‚¬í•˜ì—¬<br>
                    ì‚¬ì—… ì„±ê³µ ê°€ëŠ¥ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ì¤‘ìš”í•œ ê³¼ì •ì…ë‹ˆë‹¤.<br><br>
            
                    <strong>ì™œ ìƒê¶Œë¶„ì„ì´ í•„ìš”í•œê°€ìš”?</strong><br>
                    - ìƒê¶Œì˜ ì†Œë¹„ íŒ¨í„´ê³¼ ìœ ë™ ì¸êµ¬ë¥¼ íŒŒì•…í•˜ì—¬ íš¨ìœ¨ì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ì„¸ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    - ê²½ìŸ ì—…ì²´ í˜„í™©ê³¼ ê³ ê° ìˆ˜ìš”ë¥¼ ë¶„ì„í•´ ì ì ˆí•œ ì…ì§€ì™€ ì„œë¹„ìŠ¤ë¥¼ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    - íˆ¬ì ìœ„í—˜ì„ ìµœì†Œí™”í•˜ê³  ì•ˆì •ì ì¸ ë§¤ì¶œì„ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
            
                    <strong>AI ê¸°ë°˜ ìƒê¶Œë¶„ì„ì€ ë‹¤ìŒì„ ì œê³µí•©ë‹ˆë‹¤:</strong><br>
                    - ì í¬ì˜ ìƒì¡´ í™•ë¥  ì˜ˆì¸¡<br>
                    - SHAP ìš”ì¸ ë¶„ì„<br><br>
            
                    ì„±ê³µì ì¸ ì°½ì—…ê³¼ ìš´ì˜ì„ ìœ„í•´<br>
                    ì •í™•í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ëµì„ ì„¸ì›Œë³´ì„¸ìš”!
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë¶„ì„ ëŒ€ê¸° ë©”ì‹œì§€ -->
          <div id="analysisWaiting">
            <div class="text-center p-4">
              <i class="bi bi-analytics text-muted" style="font-size: 3rem;"></i>
              <h5 class="mt-3 text-muted">ìƒê¶Œ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</h5>
              <p class="text-muted">ìœ„ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  'ìƒê¶Œ ë¶„ì„í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>ì´ ì˜ì—­ì— ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
              <button class="btn btn-outline-secondary mt-3" disabled>
                <i class="bi bi-file-earmark-pdf me-2"></i>PDFë¡œ ì €ì¥
              </button>
            </div>
          </div>
          
          <!-- ë¶„ì„ ì§„í–‰ ìƒí™© UI -->
          <div id="analysisProgress" class="analysis-progress" style="display: none;">
            <h5 class="text-center mb-4">
              <i class="bi bi-cpu me-2"></i>
              AIê°€ ìƒê¶Œì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </h5>
            
            <div class="overall-progress">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">ì „ì²´ ì§„í–‰ë¥ </span>
                <span id="overallPercent">0%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-primary" id="overallProgressBar" style="width: 0%"></div>
              </div>
            </div>
            
            <div id="progressSteps">
              <div class="progress-step" id="step-population">
                <div class="progress-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ìƒí™œì¸êµ¬ ë¶„ì„</div>
                  <div class="progress-detail">300m/1000m ë°˜ê²½ ë‚´ ìƒí™œì¸êµ¬ ë° ì—°ë ¹ëŒ€ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-working">
                <div class="progress-icon">
                  <i class="bi bi-briefcase"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ì§ì¥ì¸êµ¬ ë¶„ì„</div>
                  <div class="progress-detail">300m ë°˜ê²½ ë‚´ ì§ì¥ì¸êµ¬ ë¶„í¬ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-foreign">
                <div class="progress-icon">
                  <i class="bi bi-globe"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ì™¸êµ­ì¸ ë¶„ì„</div>
                  <div class="progress-detail">ë‹¨ê¸°/ì¥ê¸°ì²´ë¥˜ì™¸êµ­ì¸ ë¶„í¬ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-facilities">
                <div class="progress-icon">
                  <i class="bi bi-building"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ì£¼ë³€ì‹œì„¤ ë¶„ì„</div>
                  <div class="progress-detail">í•™êµ, ê³µê³µê±´ë¬¼ ë“± ìœ ë™ì¸êµ¬ ì‹œì„¤ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-competition">
                <div class="progress-icon">
                  <i class="bi bi-shop"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ê²½ìŸì—…ì²´ ë¶„ì„</div>
                  <div class="progress-detail">ë™ì¼ì—…ì¢… ë° ìš”ì‹ì—…ì²´ ê²½ìŸê°•ë„ ë¶„ì„</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-land">
                <div class="progress-icon">
                  <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ê³µì‹œì§€ê°€ ë¶„ì„</div>
                  <div class="progress-detail">í† ì§€ê°€ì¹˜ ë° ì„ëŒ€ë£Œ ì¶”ì •</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-ai">
                <div class="progress-icon">
                  <i class="bi bi-cpu"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">AI ì˜ˆì¸¡ ë¶„ì„</div>
                  <div class="progress-detail">ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ í†µí•œ ìƒì¡´í™•ë¥  ì˜ˆì¸¡</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-complete">
                <div class="progress-icon">
                  <i class="bi bi-check-lg"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">ë¶„ì„ ì™„ë£Œ</div>
                  <div class="progress-detail">ê²°ê³¼ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë¶„ì„ ê²°ê³¼ ë‚´ìš© (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
          <div id="analysisResults" style="display: none;">
            
            <!-- ìœ„ì¹˜ ì •ë³´ -->
            <div class="alert alert-info mb-4">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-2">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    <span id="resultAddress"></span>
                  </h5>
                  <div class="row">
                    <div class="col-md-4">
                      <strong>ì—…ì¢…:</strong> <span id="resultBusinessType"></span>
                    </div>
                    <div class="col-md-4">
                      <strong>ë©´ì :</strong> <span id="resultArea"></span>ã¡
                    </div>
                    <div class="col-md-4">
                      <strong>ìœ í˜•:</strong> <span id="resultServiceType"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <small class="text-muted">ë¶„ì„ì™„ë£Œ</small>
                </div>
              </div>
            </div>

            <!-- í•µì‹¬ ì§€í‘œ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-speedometer me-2"></i>í•µì‹¬ ì§€í‘œ
              </h5>
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="lifePop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m ë‚´ ìƒí™œì¸êµ¬</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="workingPop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m ë‚´ ì§ì¥ì¸êµ¬</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="competitor300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">ë™ì¼ì—…ì¢… ê²½ìŸì—…ì²´</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="totalLandValue" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">ì´ ê³µì‹œì§€ê°€</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI ì˜ˆì¸¡ ìƒì¡´ í™•ë¥  -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-cpu me-2"></i>AI ì˜ˆì¸¡ ë¶„ì„
              </h5>
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="text-center">
                    <div class="display-1 fw-bold mb-3" id="survivalPercentage">-%</div>
                    <h4 class="mb-3">ì¥ê¸° ìƒì¡´ í™•ë¥ </h4>
                    <div class="progress" style="height: 20px;">
                      <div id="survivalBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="p-3">
                    <h6 class="mb-3">AI ë¶„ì„ ê²°ê³¼</h6>
                    <div id="survivalAnalysis" class="alert">
                      <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      AI ëª¨ë¸ì´ 25ê°œ ì§€í‘œë¥¼ ì¢…í•© ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- ìƒê¶Œ ê²½ìŸ ë¶„ì„ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-shop me-2"></i>ìƒê¶Œ ê²½ìŸ ë¶„ì„ (300m ë°˜ê²½)
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-3">
                  <h6>ê²½ìŸì—…ì²´ ìˆ˜</h6>
                  <div class="h4 text-danger" id="competitorCount">-</div>
                </div>
                <div class="col-md-3">
                  <h6>ì „ì²´ ìš”ì‹ì—…ì²´</h6>
                  <div class="h4 text-info" id="adjacentBiz">-</div>
                </div>
                <div class="col-md-3">
                  <h6>ê²½ìŸì—…ì²´ ë¹„ìœ¨</h6>
                  <div class="h4 text-warning" id="competitorRatio">-%</div>
                </div>
                <div class="col-md-3">
                  <h6>ì—…ì¢… ë‹¤ì–‘ì„±</h6>
                  <div class="h4 text-success" id="businessDiversity">-</div>
                </div>
              </div>
              
              <div class="mt-4">
                <h6>ê²½ìŸ ê°•ë„ ë¶„ì„</h6>
                <div class="progress" style="height: 25px;">
                  <div id="competitionBar" class="progress-bar" style="width: 0%">
                    <span id="competitionLevel">ë¶„ì„ì¤‘...</span>
                  </div>
                </div>
                <small class="text-muted mt-2 d-block">
                  ê²½ìŸì—…ì²´ ë¹„ìœ¨ì´ 20% ì´í•˜ë©´ ë‚®ìŒ, 20-50%ëŠ” ë³´í†µ, 50% ì´ìƒì€ ë†’ìŒìœ¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
                </small>
              </div>
            </div>

            <!-- ë¶„ì„ ìš”ì•½ -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-lightbulb me-2"></i>AI ë¶„ì„ ìš”ì•½
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">
                    <i class="bi bi-check-circle me-2"></i>ê°•ì 
                  </h6>
                  <ul id="strengthsList">
                    <!-- ê°•ì  ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­
                  </h6>
                  <ul id="cautionsList">
                    <!-- ì£¼ì˜ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                  </ul>
                </div>
              </div>
            </div>

            <!-- PDF ì €ì¥ ë²„íŠ¼ -->
            <div class="text-center">
              <button class="btn btn-primary" onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>PDFë¡œ ì €ì¥
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ì±—ë´‡ -->
      <div class="col-lg-4">
        <div class="card p-4 shadow-sm">
          <h5>ë¶„ì„ ê²°ê³¼ ì±—ë´‡</h5>

          <!-- ì˜ˆì‹œ ì§ˆë¬¸ ë²„íŠ¼ -->
          <div style="margin-bottom: 10px;">
            <span class="text-muted">ì¶”ì²œ ì§ˆë¬¸</span><br>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('ì´ ìƒê¶Œì˜ ìœ ë™ ì¸êµ¬ íŠ¹ì§•ì€ ì–´ë–¤ê°€ìš”?')">ìœ ë™ ì¸êµ¬</button>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('ì´ ì§€ì—­ì˜ ê²½ìŸ ì—…ì²´ ìˆ˜ëŠ” ì–¼ë§ˆë‚˜ ë˜ë‚˜ìš”?')">ê²½ìŸ ì—…ì²´</button>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('ì´ ì§€ì—­ì€ ì°½ì—… ìœ„í—˜ì´ ë†’ì€ í¸ì¸ê°€ìš”?')">ì°½ì—… ìœ„í—˜</button>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('ì£¼ë³€ ìƒê¶Œ ì¤‘ ê°€ì¥ í™œë°œí•œ ì—…ì¢…ì€ ë¬´ì—‡ì¸ê°€ìš”?')">ì¸ê¸° ì—…ì¢…</button>
          </div>

          <!-- ì§ˆë¬¸ ì¶œë ¥ ì˜ì—­ -->
          <div class="border rounded p-2 mb-2" style="height: 250px; overflow-y: auto;">
            <p class="text-muted">ì—¬ê¸°ì— ì§ˆë¬¸/ì‘ë‹µì´ ì¶œë ¥ë©ë‹ˆë‹¤.</p>
          </div>

          <!-- ì§ˆë¬¸ ì…ë ¥ ë° ì „ì†¡ -->
          <input type="text" class="form-control mb-2" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
          <button type="button" class="btn btn-outline-primary w-100">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel">
            <i class="bi bi-file-earmark-pdf me-2"></i>AI ìƒê¶Œë¶„ì„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="pdfGenerating" style="display: none;" class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">ìƒì„± ì¤‘...</span>
            </div>
            <h6>PDF ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h6>
            <p class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
          </div>
          
          <div id="pdfError" style="display: none;" class="text-center">
            <i class="bi bi-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
            <h6>PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h6>
            <p class="text-muted" id="pdfErrorMessage">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
          </div>
          
          <!-- PDF ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© -->
          <div id="pdfPreviewContainer" style="background: white; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="text-center mb-4">
              <h2 class="text-primary mb-1" style="font-weight: 700;">AI ìƒê¶Œë¶„ì„ ë³´ê³ ì„œ</h2>
              <p class="text-muted mb-0">ì¸ê³µì§€ëŠ¥ ê¸°ë°˜ ìƒì—…ì§€êµ¬ ë¶„ì„ ê²°ê³¼</p>
              <hr class="my-3" style="border-color: #1e3a8a; border-width: 2px;">
            </div>
            
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>ë¶„ì„ ëŒ€ìƒ ì •ë³´</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>ì£¼ì†Œ:</strong> <span id="previewAddress">-</span></p>
                        <p><strong>ì—…ì¢…:</strong> <span id="previewBusinessType">-</span></p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>ë©´ì :</strong> <span id="previewArea">-</span></p>
                        <p><strong>ë¶„ì„ì¼ì‹œ:</strong> <span id="previewDate">-</span></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- AI ìƒì¡´ í™•ë¥  -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card border-success">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI ìƒì¡´ í™•ë¥ </h5>
                  </div>
                  <div class="card-body text-center">
                    <div class="display-4 mb-3" id="previewSurvival">-%</div>
                    <div class="progress mb-3" style="height: 20px;">
                      <div class="progress-bar" id="previewSurvivalBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-muted mb-0" id="previewSurvivalText">ë¶„ì„ ì¤‘...</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- í•µì‹¬ ì§€í‘œ -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card border-info h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ìƒí™œì¸êµ¬</h6>
                    <p class="card-text fw-bold" id="previewLifePop">-</p>
                    <small class="text-muted">300m ë°˜ê²½</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-warning h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-briefcase text-warning mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ì§ì¥ì¸êµ¬</h6>
                    <p class="card-text fw-bold" id="previewWorkingPop">-</p>
                    <small class="text-muted">300m ë°˜ê²½</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-danger h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-shop text-danger mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ê²½ìŸì—…ì²´</h6>
                    <p class="card-text fw-bold" id="previewCompetitor">-</p>
                    <small class="text-muted">300m ë°˜ê²½</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-secondary h-100">
                  <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-secondary mb-2" style="font-size: 2rem;"></i>
                    <h6 class="card-title">ê³µì‹œì§€ê°€</h6>
                    <p class="card-text fw-bold" id="previewLandValue">-</p>
                    <small class="text-muted">ì´ ê³µì‹œì§€ê°€</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ê°•ì /ì£¼ì˜ì‚¬í•­ -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-success h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>ê°•ì </h6>
                  </div>
                  <div class="card-body" id="previewStrengths">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-warning h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>ì£¼ì˜ì‚¬í•­</h6>
                  </div>
                  <div class="card-body" id="previewCautions">
                    <ul class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ë³´ê³ ì„œ í•˜ë‹¨ -->
            <div class="text-center text-muted" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
              <small>
                ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ìƒê¶Œë¶„ì„ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                ë¶„ì„ ê¸°ì¤€ì¼: <span id="previewReportDate"></span>
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" id="downloadPdfBtn" onclick="downloadPDF()">
              <i class="bi bi-download me-2"></i>ê³ í’ˆì§ˆ PDF (ì´ë¯¸ì§€)
            </button>
            <button type="button" class="btn btn-outline-primary" id="downloadLightPdfBtn" onclick="downloadLightweightPDF()">
              <i class="bi bi-file-text me-2"></i>ê²½ëŸ‰ PDF (í…ìŠ¤íŠ¸)
            </button>
          </div>
          <button type="button" class="btn btn-primary" id="retryPdfBtn" onclick="downloadPDF()" style="display: none;">
            <i class="bi bi-arrow-clockwise me-2"></i>ë‹¤ì‹œ ì‹œë„
          </button>
        </div>
      </div>
    </div>
  </div>
  
{% endblock %} 