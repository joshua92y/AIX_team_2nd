{% extends 'base.html' %}
{% load static %}

{% block title %}상권 분석{% endblock %}

{% block content %}
{% include 'includes/header.html' %}

  <style>
    /* 기본 primary 버튼 disabled 시 커스텀 스타일 */
    .btn-primary.custom {
      color: #fff;
      background-color: #0d6efd; /* 원래 primary 색 */
      opacity: 0.65;  /* 투명도 조절로 흐릿하게 표시 */
    }
    
    /* 분석 진행 상황 스타일 */
    .analysis-progress {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      margin-top: 1rem;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .progress-step.active {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .progress-step.completed {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #22c55e;
    }
    
    .progress-step.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }
    
    .progress-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
    }
    
    .progress-step.active .progress-icon {
      background: #667eea;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .progress-step.completed .progress-icon {
      background: #22c55e;
      color: white;
    }
    
    .progress-step.error .progress-icon {
      background: #ef4444;
      color: white;
    }
    
    .progress-step:not(.active):not(.completed):not(.error) .progress-icon {
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .progress-text {
      flex: 1;
    }
    
    .progress-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .progress-detail {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .overall-progress {
      margin-bottom: 1.5rem;
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* 공시지가 카드 폰트 크기 조정 */
    #totalLandValue {
      font-size: 1.8rem !important;
      line-height: 1.2;
    }
    
    @media (max-width: 768px) {
      #totalLandValue {
        font-size: 1.5rem !important;
      }
    }
  </style>

  <!-- Daum 우편번호 서비스 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <script>
    $(window).on('load', function() {
      _eventBind();
    });

    // 페이지 내 이벤트 바인딩
    function _eventBind() {
      console.log("이벤트 바인딩 시작");
    }

    // Daum 우편번호 서비스 팝업 열기
    function openAddressSearch() {
      new daum.Postcode({
        oncomplete: function(data) {
          // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드
          console.log("선택된 주소 데이터:", data);
          
          // 기본 주소 정보
          let fullAddr = '';
          let extraAddr = '';
          
          // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
          if (data.userSelectedType === 'R') { // 도로명 주소
            fullAddr = data.roadAddress;
          } else { // 지번 주소
            fullAddr = data.jibunAddress;
          }
          
          // 건물명이 있고, 공동주택일 경우 추가한다.
          if(data.buildingName !== '' && data.apartment === 'Y'){
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
          if(extraAddr !== ''){
            extraAddr = ' (' + extraAddr + ')';
          }
          
          // 최종 주소
          const finalAddress = fullAddr + extraAddr;
          
          // 주소를 입력하고 좌표 변환 시작
          document.getElementById('address').value = finalAddress;
          
          // 기존 AI_Analyzer의 좌표 변환 API 사용
          const csrfToken = '{{ csrf_token }}';
          
          $.ajax({
            url: '/get-coordinates/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              address: fullAddr
            }),
            headers: {
              'X-CSRFToken': csrfToken
            },
            success: function(response) {
              if (response.success) {
                // 좌표 설정 성공
                document.getElementById('latitude').value = response.latitude.toFixed(6);
                document.getElementById('longitude').value = response.longitude.toFixed(6);
                document.getElementById('x_coord').value = response.x_coord.toFixed(2);
                document.getElementById('y_coord').value = response.y_coord.toFixed(2);
                
                console.log("좌표 변환 완료:", {
                  address: finalAddress,
                  latitude: response.latitude,
                  longitude: response.longitude,
                  x_coord: response.x_coord,
                  y_coord: response.y_coord
                });
                
                alert("주소와 좌표가 설정되었습니다.");
              } else {
                console.error("좌표 변환 실패:", response.error);
                alert("좌표 변환에 실패했습니다: " + response.error);
              }
            },
            error: function(xhr, status, error) {
              console.error("좌표 변환 요청 실패:", error);
              console.error("응답:", xhr.responseText);
              alert("좌표 변환 요청에 실패했습니다.");
            }
          });
        },
        theme: {
          searchBgColor: "#0d6efd", // 검색창 배경색
          queryTextColor: "#FFFFFF" // 검색창 글자색  
        }
      }).open();
    }

    // 입력정보 전송
    function getFormData() {
      const business_type_id = $('#business_type_id').val();
      const address = $('#address').val();
      const area = $('#area').val();
      const service_type = $('#service_type').val();
      const x_coord = $('#x_coord').val();
      const y_coord = $('#y_coord').val();
      const latitude = $('#latitude').val();
      const longitude = $('#longitude').val();

      // 필수 필드 검증
      if (!business_type_id || !address || !area || !service_type) {
        alert("모든 필드를 입력해주세요.");
        return;
      }
      
      // 좌표값 검증
      if (!x_coord || !y_coord || x_coord === '0' || y_coord === '0' || 
          !latitude || !longitude || latitude === '0' || longitude === '0') {
        alert("주소 검색을 통해 좌표를 설정해주세요.");
        return;
      }

      // 즉시 로딩 UI 표시
      console.log("🚀 분석 시작 - 로딩 UI 표시");
      showAnalysisLoading();

      console.log("전송할 데이터:", {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      });
      
      const paramData = {
        business_type_id: parseInt(business_type_id),
        address: address,
        area: parseFloat(area),
        service_type: parseInt(service_type),
        x_coord: parseFloat(x_coord),
        y_coord: parseFloat(y_coord),
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      };

      $.ajax(createPostAjaxOption('analyze', paramData));
    }

    function createPostAjaxOption(requestType, paramData) {
      
      const csrfToken = '{{ csrf_token }}';
      let url;

      if ( 'analyze' === requestType ) {
        url = '/analyze-business/';
      } else if ( 'pdf' === 'pdf' ) {
        url = '/generate-pdf/';
      }
      
      // 원본 AI_Analyzer와 같이 JSON으로 전송
      return {
        url: url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(paramData),
        headers: {
          'X-CSRFToken': csrfToken
        },
        success: function(response) {
          console.log("✅ 분석 요청 성공 응답:", response);
          
          if (response.success && response.request_id) {
            console.log(`🔄 현재 페이지에서 결과 표시 시작 (request_id: ${response.request_id})`);
            // 분석 결과를 가져와서 현재 페이지에 표시
            fetchAndDisplayResults(response.request_id);
          } else if (response.request_id) {
            console.log(`🔄 request_id만 있는 경우 (request_id: ${response.request_id})`);
            // 분석 결과를 가져와서 현재 페이지에 표시
            fetchAndDisplayResults(response.request_id);
          } else {
            console.log("⚠️ request_id가 없는 응답:", response);
            alert('분석 요청 성공: ' + (response.message || '결과를 확인해주세요'));
          }
        },
        error: function(xhr, status, error) {
          console.error("분석 요청 실패:", error);
          console.error("응답:", xhr.responseText);
          alert("상권 분석 요청에 실패했습니다.");
        }
      }
    }

    // 분석 결과를 가져와서 표시하는 함수
    function fetchAndDisplayResults(requestId) {
      console.log(`📊 결과 조회 시작 (request_id: ${requestId})`);
      console.log(`🔗 API URL: /api/result/${requestId}/`);
      
      // 로딩은 이미 getFormData에서 시작됨
      
      $.ajax({
        url: `/api/result/${requestId}/`,
        type: 'GET',
        success: function(data) {
          console.log("✅ 결과 조회 성공:", data);
          console.log("🎯 현재 페이지에서 결과 표시 시작");
          displayAnalysisResults(data);
        },
        error: function(xhr, status, error) {
          console.error("❌ 결과 조회 실패:", error);
          console.error("📊 응답 상태:", xhr.status);
          console.error("📄 응답 텍스트:", xhr.responseText);
          
          // 404 오류가 아닌 경우에만 재시도 옵션 제공
          if (xhr.status === 404) {
            console.log("🔄 결과가 아직 준비되지 않음, 잠시 후 재시도");
            setTimeout(() => {
              fetchAndDisplayResults(requestId);
            }, 2000); // 2초 후 재시도
          } else {
            // 에러 메시지 표시하고 다시 시도 옵션 제공
            showAnalysisError(requestId, error);
          }
        }
      });
    }
    
    // 분석 진행 상황 표시 (기존 단순 로딩 대체)
    function showAnalysisLoading() {
      // 대기 메시지 숨기고 진행 상황 표시
      $('#analysisWaiting').hide();
      $('#analysisProgress').show();
      
      // 진행 단계 정의 (더 현실적인 시간으로 조정)
      const steps = [
        { id: 'step-population', name: '생활인구 분석', delay: 1000 },
        { id: 'step-working', name: '직장인구 분석', delay: 3000 },
        { id: 'step-foreign', name: '외국인 분석', delay: 5000 },
        { id: 'step-facilities', name: '주변시설 분석', delay: 7000 },
        { id: 'step-competition', name: '경쟁업체 분석', delay: 9000 },
        { id: 'step-land', name: '공시지가 분석', delay: 11000 },
        { id: 'step-ai', name: 'AI 예측 분석', delay: 13000 },
        { id: 'step-complete', name: '분석 완료', delay: 15000 }
      ];
      
      // 각 단계별로 진행 표시
      steps.forEach((step, index) => {
        setTimeout(() => {
          // 이전 단계 완료 표시
          if (index > 0) {
            const prevStep = steps[index - 1];
            $(`#${prevStep.id}`).removeClass('active').addClass('completed');
          }
          
          // 현재 단계 활성화
          $(`#${step.id}`).addClass('active');
          
          // 전체 진행률 업데이트
          const progress = Math.round(((index + 1) / steps.length) * 100);
          $('#overallPercent').text(progress + '%');
          $('#overallProgressBar').css('width', progress + '%');
          
        }, step.delay);
      });
      
      // 마지막 단계는 실제 결과가 나올 때까지 유지
      setTimeout(() => {
        if ($('#step-complete').hasClass('active') && !$('#step-complete').hasClass('completed')) {
          $('#step-complete .progress-detail').text('분석이 거의 완료되었습니다...');
        }
      }, 15000);
    }
    
    // 분석 에러 표시
    function showAnalysisError(requestId, error) {
      $('#analysisProgress').hide();
      $('#analysisWaiting').html(`
        <div class="alert alert-danger">
          <h5><i class="bi bi-exclamation-triangle me-2"></i>분석 중 오류가 발생했습니다</h5>
          <p>오류 내용: ${error}</p>
          <div class="mt-3">
            <button class="btn btn-primary me-2" onclick="retryAnalysis(${requestId})">
              <i class="bi bi-arrow-clockwise me-1"></i>다시 시도
            </button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='/result/${requestId}/'">
              <i class="bi bi-eye me-1"></i>결과 페이지로 이동
            </button>
          </div>
        </div>
      `).show();
    }
    
    // 분석 재시도
    function retryAnalysis(requestId) {
      showAnalysisLoading();
      setTimeout(() => {
        fetchAndDisplayResults(requestId);
      }, 1000);
    }
    
    // 분석 결과를 페이지에 표시하는 함수
    function displayAnalysisResults(data) {
      // 진행 상황 UI 숨기기
      $('#analysisProgress').hide();
      
      const request = data.request;
      const result = data.result;
      
      // 기본 정보 설정
      document.getElementById('resultAddress').textContent = request.address;
      document.getElementById('resultBusinessType').textContent = getBusinessTypeName(request.business_type_id);
      document.getElementById('resultArea').textContent = request.area;
      document.getElementById('resultServiceType').textContent = request.service_type == 1 ? '일반음식점' : '휴게음식점';
      
      // 핵심 지표
      document.getElementById('lifePop300').textContent = Math.round(result.life_pop_300m || 0).toLocaleString();
      document.getElementById('workingPop300').textContent = Math.round(result.working_pop_300m || 0).toLocaleString();
      document.getElementById('competitor300').textContent = result.competitor_300m || 0;
      
      // 공시지가를 원화 표시로 더 간단하게 표현
      const landValue = result.total_land_value || 0;
      if (landValue >= 100000000) { // 1억 이상
        document.getElementById('totalLandValue').innerHTML = `₩${(landValue / 100000000).toFixed(1)}억`;
      } else if (landValue >= 10000) { // 1만 이상
        document.getElementById('totalLandValue').innerHTML = `₩${(landValue / 10000).toFixed(0)}만`;
      } else {
        document.getElementById('totalLandValue').innerHTML = `₩${landValue.toLocaleString()}`;
      }
      
      // AI 생존 확률
      const survivalRate = Math.round(result.survival_percentage || 0);
      document.getElementById('survivalPercentage').textContent = survivalRate + '%';
      
      const survivalBar = document.getElementById('survivalBar');
      const survivalAnalysis = document.getElementById('survivalAnalysis');
      
      survivalBar.style.width = survivalRate + '%';
      
      if (survivalRate >= 80) {
        survivalBar.className = 'progress-bar bg-success';
        survivalAnalysis.className = 'alert alert-success';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>
          <strong>높은 생존 가능성</strong><br>
          현재 위치는 장기적으로 사업을 지속하기에 매우 좋은 조건을 갖추고 있습니다.
        `;
      } else if (survivalRate >= 60) {
        survivalBar.className = 'progress-bar bg-warning';
        survivalAnalysis.className = 'alert alert-warning';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>보통 생존 가능성</strong><br>
          현재 위치는 사업 지속에 적절한 조건을 갖추고 있으나, 추가적인 전략 검토가 필요합니다.
        `;
      } else {
        survivalBar.className = 'progress-bar bg-danger';
        survivalAnalysis.className = 'alert alert-danger';
        survivalAnalysis.innerHTML = `
          <i class="bi bi-times-circle me-2"></i>
          <strong>낮은 생존 가능성</strong><br>
          현재 위치는 장기 사업 지속에 어려움이 예상됩니다. 신중한 검토가 필요합니다.
        `;
      }
      
      // 상권 경쟁 분석
      document.getElementById('competitorCount').textContent = result.competitor_300m || 0;
      document.getElementById('adjacentBiz').textContent = result.adjacent_biz_300m || 0;
      
      const competitorRatio = Math.round(result.competitor_ratio_300m || 0);
      document.getElementById('competitorRatio').textContent = competitorRatio + '%';
      document.getElementById('businessDiversity').textContent = (result.business_diversity_300m || 0) + '종류';
      
      const competitionBar = document.getElementById('competitionBar');
      const competitionLevel = document.getElementById('competitionLevel');
      
      competitionBar.style.width = competitorRatio + '%';
      
      if (competitorRatio <= 20) {
        competitionBar.className = 'progress-bar bg-success';
        competitionLevel.textContent = `낮음 (${competitorRatio}%)`;
      } else if (competitorRatio <= 50) {
        competitionBar.className = 'progress-bar bg-warning';
        competitionLevel.textContent = `보통 (${competitorRatio}%)`;
      } else {
        competitionBar.className = 'progress-bar bg-danger';
        competitionLevel.textContent = `높음 (${competitorRatio}%)`;
      }
      
      // 강점과 주의사항 분석
      displayStrengthsAndCautions(result);
      
      // 결과 영역 표시
      document.getElementById('analysisWaiting').style.display = 'none';
      document.getElementById('analysisResults').style.display = 'block';
      
      // 결과 영역으로 스크롤
      document.getElementById('analysisResults').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
    
    // 업종명 반환 함수
    function getBusinessTypeName(businessTypeId) {
      const businessTypes = {
        1: '감성주점', 2: '경양식', 3: '관광호텔', 4: '극장', 5: '기타',
        6: '기타 휴게음식점', 7: '김밥(도시락)', 8: '까페', 9: '냉면집', 10: '다방',
        11: '떡카페', 12: '라이브카페', 13: '백화점', 14: '복어취급', 15: '분식',
        16: '뷔페식', 17: '식육(숯불구이)', 18: '아이스크림', 19: '외국음식전문점(인도, 태국 등)', 20: '유원지',
        21: '일반조리판매', 22: '일식', 23: '전통찻집', 24: '정종/대포집/소주방', 25: '중국식',
        26: '철도역구내', 27: '출장조리', 28: '커피숍', 29: '키즈카페', 30: '탕류(보신용)',
        31: '통닭(치킨)', 32: '패밀리레스토랑', 33: '패스트푸드', 34: '편의점', 35: '푸드트럭',
        36: '한식', 37: '호프/통닭', 38: '횟집'
      };
      return businessTypes[businessTypeId] || '알 수 없음';
    }
    
    // 강점과 주의사항 표시
    function displayStrengthsAndCautions(result) {
      const strengthsList = document.getElementById('strengthsList');
      const cautionsList = document.getElementById('cautionsList');
      
      let strengths = [];
      let cautions = [];
      
      // 강점 분석
      if (result.life_pop_300m > 5000) {
        strengths.push(`생활인구가 풍부함 (${Math.round(result.life_pop_300m).toLocaleString()}명)`);
      }
      if (result.working_pop_300m > 3000) {
        strengths.push('직장인구가 많아 점심시간 고객 확보 유리');
      }
      if (result.competitor_ratio_300m < 30) {
        strengths.push('경쟁업체 비율이 낮아 경쟁 부담 적음');
      }
      if (result.business_diversity_300m > 10) {
        strengths.push('업종 다양성이 높아 상권이 활성화됨');
      }
      if (result.public_building_250m > 0 || result.school_250m > 0) {
        strengths.push('주변 유동인구 유발시설 존재');
      }
      
      // 주의사항 분석
      if (result.life_pop_300m < 2000) {
        cautions.push('생활인구가 적어 고객 확보에 어려움 예상');
      }
      if (result.competitor_ratio_300m > 50) {
        cautions.push('경쟁업체 비율이 높아 치열한 경쟁 예상');
      }
      if (result.competitor_300m > 5) {
        cautions.push(`동일업종 경쟁업체가 많음 (${result.competitor_300m}개)`);
      }
      if (result.total_land_value > 100000000) {
        cautions.push('공시지가가 높아 임대료 부담 클 수 있음');
      }
      if (result.working_pop_300m < 1000) {
        cautions.push('직장인구가 적어 평일 점심 고객 부족 우려');
      }
      
      // 기본 메시지
      if (strengths.length === 0) {
        strengths.push('상권 분석 결과를 종합적으로 검토하세요');
      }
      if (cautions.length === 0) {
        cautions.push('현재 상권 조건이 양호합니다');
      }
      
      // HTML 생성
      strengthsList.innerHTML = strengths.map(item => `<li>${item}</li>`).join('');
      cautionsList.innerHTML = cautions.map(item => `<li>${item}</li>`).join('');
    }
    
    // PDF 생성 함수
    function generatePDF() {
      alert('PDF 생성 기능은 준비 중입니다.');
    }

    function fillExampleQuestion(text) {
      document.getElementById('chatInput').value = text;
    }
  </script>

  <!-- Page Title -->
  <div class="container my-6" style="margin-top: 20px; margin-bottom: 100px; ">
    
    <!-- 상권 분석 정보 입력 -->
    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card p-4 shadow-sm">
          <h3 class="mb-3">상권 정보입력</h3>

          <form>
            <div class="row g-3">
              <!-- 업종 선택 -->
              <div class="col-md-3">
                <label for="business_type_id" class="form-label">업종</label>
                <select class="form-select" id="business_type_id" name="business_type_id" required>
                  <option selected disabled>업종을 선택해주세요</option>
                  <option value="1">감성주점</option>
                  <option value="2">경양식</option>
                  <option value="3">관광호텔</option>
                  <option value="4">극장</option>
                  <option value="5">기타</option>
                  <option value="6">기타 휴게음식점</option>
                  <option value="7">김밥(도시락)</option>
                  <option value="8">까페</option>
                  <option value="9">냉면집</option>
                  <option value="10">다방</option>
                  <option value="11">떡카페</option>
                  <option value="12">라이브카페</option>
                  <option value="13">백화점</option>
                  <option value="14">복어취급</option>
                  <option value="15">분식</option>
                  <option value="16">뷔페식</option>
                  <option value="17">식육(숯불구이)</option>
                  <option value="18">아이스크림</option>
                  <option value="19">외국음식전문점(인도, 태국 등)</option>
                  <option value="20">유원지</option>
                  <option value="21">일반조리판매</option>
                  <option value="22">일식</option>
                  <option value="23">전통찻집</option>
                  <option value="24">정종/대포집/소주방</option>
                  <option value="25">중국식</option>
                  <option value="26">철도역구내</option>
                  <option value="27">출장조리</option>
                  <option value="28">커피숍</option>
                  <option value="29">키즈카페</option>
                  <option value="30">탕류(보신용)</option>
                  <option value="31">통닭(치킨)</option>
                  <option value="32">패밀리레스토랑</option>
                  <option value="33">패스트푸드</option>
                  <option value="34">편의점</option>
                  <option value="35">푸드트럭</option>
                  <option value="36">한식</option>
                  <option value="37">호프/통닭</option>
                  <option value="38">횟집</option>
                </select>
              </div>

              <!-- 주소 입력 -->
              <div class="col-md-3">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="x_coord" name="x_coord">
                <input type="hidden" id="y_coord" name="y_coord">
                <label for="address" class="form-label">주소</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="address" name="address" placeholder="주소를 입력해주세요" readonly>
                  <button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()">검색</button>
                </div>
              </div>

              <!-- 점포 면적 입력 -->
              <div class="col-md-3">
                <label for="area" class="form-label">점포 면적 (㎡)</label>
                <input type="number" class="form-control" id="area" name="area" placeholder="예: 33.2" required>
              </div>

              <!-- 주류 판매 여부 선택 -->
              <div class="col-md-3">
                <label for="service_type" class="form-label">주류 판매 여부</label>
                <select class="form-select" id="service_type" name="service_type" required>
                  <option selected disabled>선택</option>
                  <option value="1">판매함</option>
                  <option value="0">판매 안함</option>
                </select>
              </div>
            </div>

            <!-- 버튼 -->
            <div class="text-center mt-4">
              <button type="button" class="btn btn-primary custom px-5" onclick="getFormData();">상권 분석하기</button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- 본문: 분석 결과 + 챗봇 -->
    <div class="row">
      <!-- 왼쪽: 분석 리포트 -->
      <div class="col-lg-8 mb-4">
        <div class="card p-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">상권 분석 결과</h4>
            <!-- 모달 버튼 -->
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#explanationModal">
              상권 분석 도움말
            </button>
            
            <!-- Bootstrap 모달 -->
            <div class="modal fade" id="explanationModal" tabindex="-1" aria-labelledby="explanationModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="explanationModalLabel">상권 분석이란 무엇인가?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                  </div>
                  <div class="modal-body">
                    상권분석은 특정 지역 내 점포나 사업장의 경제적 환경과 소비자 특성을 체계적으로 조사하여<br>
                    사업 성공 가능성을 높이기 위한 중요한 과정입니다.<br><br>
            
                    <strong>왜 상권분석이 필요한가요?</strong><br>
                    - 상권의 소비 패턴과 유동 인구를 파악하여 효율적인 마케팅 전략을 세울 수 있습니다.<br>
                    - 경쟁 업체 현황과 고객 수요를 분석해 적절한 입지와 서비스를 결정할 수 있습니다.<br>
                    - 투자 위험을 최소화하고 안정적인 매출을 기대할 수 있습니다.<br><br>
            
                    <strong>AI 기반 상권분석은 다음을 제공합니다:</strong><br>
                    - 점포의 생존 확률 예측<br>
                    - SHAP 요인 분석<br><br>
            
                    성공적인 창업과 운영을 위해<br>
                    정확한 정보를 바탕으로 전략을 세워보세요!
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 분석 대기 메시지 -->
          <div id="analysisWaiting">
            <div class="text-center p-4">
              <i class="bi bi-analytics text-muted" style="font-size: 3rem;"></i>
              <h5 class="mt-3 text-muted">상권 분석을 시작하세요</h5>
              <p class="text-muted">위의 정보를 입력하고 '상권 분석하기' 버튼을 클릭하면<br>이 영역에 분석 결과가 표시됩니다.</p>
              <button class="btn btn-outline-secondary mt-3" disabled>
                <i class="bi bi-file-earmark-pdf me-2"></i>PDF로 저장
              </button>
            </div>
          </div>
          
          <!-- 분석 진행 상황 UI -->
          <div id="analysisProgress" class="analysis-progress" style="display: none;">
            <h5 class="text-center mb-4">
              <i class="bi bi-cpu me-2"></i>
              AI가 상권을 분석하고 있습니다...
            </h5>
            
            <div class="overall-progress">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">전체 진행률</span>
                <span id="overallPercent">0%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-primary" id="overallProgressBar" style="width: 0%"></div>
              </div>
            </div>
            
            <div id="progressSteps">
              <div class="progress-step" id="step-population">
                <div class="progress-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">생활인구 분석</div>
                  <div class="progress-detail">300m/1000m 반경 내 생활인구 및 연령대 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-working">
                <div class="progress-icon">
                  <i class="bi bi-briefcase"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">직장인구 분석</div>
                  <div class="progress-detail">300m 반경 내 직장인구 분포 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-foreign">
                <div class="progress-icon">
                  <i class="bi bi-globe"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">외국인 분석</div>
                  <div class="progress-detail">단기/장기체류외국인 분포 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-facilities">
                <div class="progress-icon">
                  <i class="bi bi-building"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">주변시설 분석</div>
                  <div class="progress-detail">학교, 공공건물 등 유동인구 시설 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-competition">
                <div class="progress-icon">
                  <i class="bi bi-shop"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">경쟁업체 분석</div>
                  <div class="progress-detail">동일업종 및 요식업체 경쟁강도 분석</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-land">
                <div class="progress-icon">
                  <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">공시지가 분석</div>
                  <div class="progress-detail">토지가치 및 임대료 추정</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-ai">
                <div class="progress-icon">
                  <i class="bi bi-cpu"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">AI 예측 분석</div>
                  <div class="progress-detail">머신러닝 모델을 통한 생존확률 예측</div>
                </div>
              </div>
              
              <div class="progress-step" id="step-complete">
                <div class="progress-icon">
                  <i class="bi bi-check-lg"></i>
                </div>
                <div class="progress-text">
                  <div class="progress-title">분석 완료</div>
                  <div class="progress-detail">결과를 표시하고 있습니다...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 분석 결과 내용 (초기에는 숨김) -->
          <div id="analysisResults" style="display: none;">
            
            <!-- 위치 정보 -->
            <div class="alert alert-info mb-4">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-2">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    <span id="resultAddress"></span>
                  </h5>
                  <div class="row">
                    <div class="col-md-4">
                      <strong>업종:</strong> <span id="resultBusinessType"></span>
                    </div>
                    <div class="col-md-4">
                      <strong>면적:</strong> <span id="resultArea"></span>㎡
                    </div>
                    <div class="col-md-4">
                      <strong>유형:</strong> <span id="resultServiceType"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <small class="text-muted">분석완료</small>
                </div>
              </div>
            </div>

            <!-- 핵심 지표 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-speedometer me-2"></i>핵심 지표
              </h5>
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="lifePop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m 내 생활인구</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="workingPop300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">300m 내 직장인구</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="competitor300" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">동일업종 경쟁업체</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border text-center" style="background-color: white; border-color: #dee2e6;">
                    <div class="card-body">
                      <h3 id="totalLandValue" class="fw-bold" style="color: #1e3a8a;">-</h3>
                      <small style="color: #1e3a8a;">총 공시지가</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI 예측 생존 확률 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-cpu me-2"></i>AI 예측 분석
              </h5>
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="text-center">
                    <div class="display-1 fw-bold mb-3" id="survivalPercentage">-%</div>
                    <h4 class="mb-3">장기 생존 확률</h4>
                    <div class="progress" style="height: 20px;">
                      <div id="survivalBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="p-3">
                    <h6 class="mb-3">AI 분석 결과</h6>
                    <div id="survivalAnalysis" class="alert">
                      <!-- AI 분석 결과가 여기에 표시됩니다 -->
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      AI 모델이 25개 지표를 종합 분석한 결과입니다.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- 상권 경쟁 분석 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-shop me-2"></i>상권 경쟁 분석 (300m 반경)
              </h5>
              <div class="row g-3 text-center">
                <div class="col-md-3">
                  <h6>경쟁업체 수</h6>
                  <div class="h4 text-danger" id="competitorCount">-</div>
                </div>
                <div class="col-md-3">
                  <h6>전체 요식업체</h6>
                  <div class="h4 text-info" id="adjacentBiz">-</div>
                </div>
                <div class="col-md-3">
                  <h6>경쟁업체 비율</h6>
                  <div class="h4 text-warning" id="competitorRatio">-%</div>
                </div>
                <div class="col-md-3">
                  <h6>업종 다양성</h6>
                  <div class="h4 text-success" id="businessDiversity">-</div>
                </div>
              </div>
              
              <div class="mt-4">
                <h6>경쟁 강도 분석</h6>
                <div class="progress" style="height: 25px;">
                  <div id="competitionBar" class="progress-bar" style="width: 0%">
                    <span id="competitionLevel">분석중...</span>
                  </div>
                </div>
                <small class="text-muted mt-2 d-block">
                  경쟁업체 비율이 20% 이하면 낮음, 20-50%는 보통, 50% 이상은 높음으로 분류됩니다.
                </small>
              </div>
            </div>

            <!-- 분석 요약 -->
            <div class="mb-4">
              <h5 class="text-primary border-bottom border-primary pb-2 mb-3">
                <i class="bi bi-lightbulb me-2"></i>AI 분석 요약
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">
                    <i class="bi bi-check-circle me-2"></i>강점
                  </h6>
                  <ul id="strengthsList">
                    <!-- 강점 목록이 여기에 표시됩니다 -->
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>주의사항
                  </h6>
                  <ul id="cautionsList">
                    <!-- 주의사항 목록이 여기에 표시됩니다 -->
                  </ul>
                </div>
              </div>
            </div>

            <!-- PDF 저장 버튼 -->
            <div class="text-center">
              <button class="btn btn-primary" onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>PDF로 저장
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 챗봇 -->
      <div class="col-lg-4">
        <div class="card p-4 shadow-sm">
          <h5>분석 결과 챗봇</h5>

          <!-- 예시 질문 버튼 -->
          <div style="margin-bottom: 10px;">
            <span class="text-muted">추천 질문</span><br>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('이 상권의 유동 인구 특징은 어떤가요?')">유동 인구</button>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('이 지역의 경쟁 업체 수는 얼마나 되나요?')">경쟁 업체</button>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('이 지역은 창업 위험이 높은 편인가요?')">창업 위험</button>
            <button class="btn btn-sm btn-outline-secondary me-1 mt-1" onclick="fillExampleQuestion('주변 상권 중 가장 활발한 업종은 무엇인가요?')">인기 업종</button>
          </div>

          <!-- 질문 출력 영역 -->
          <div class="border rounded p-2 mb-2" style="height: 250px; overflow-y: auto;">
            <p class="text-muted">여기에 질문/응답이 출력됩니다.</p>
          </div>

          <!-- 질문 입력 및 전송 -->
          <input type="text" class="form-control mb-2" id="chatInput" placeholder="질문을 입력하세요">
          <button type="button" class="btn btn-outline-primary w-100">보내기</button>
        </div>
      </div>
    </div>
  </div>
  
{% endblock %} 